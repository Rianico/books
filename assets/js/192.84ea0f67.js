(window.webpackJsonp=window.webpackJsonp||[]).push([[192],{915:function(s,t,a){"use strict";a.r(t);var e=a(70),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"clickhouse-编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clickhouse-编译"}},[s._v("#")]),s._v(" ClickHouse 编译")]),s._v(" "),a("p",[s._v("应同事请求协助帮忙编译 ClickHouse，虽然个人对 ClickHouse 及 C++ 语言不熟悉，但编译其实万变不离其宗，把控好网络、组件版本、环境变量，再严格遵循官网编译步骤，其实可以解决绝大部分的软件编译问题。")]),s._v(" "),a("p",[s._v("PS：Docker 可以很好的解决编译环境的问题，这或许也是近年来越来越多项目提供 docker 编译方式的原因吧。")]),s._v(" "),a("h2",{attrs:{id:"_1-版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-版本"}},[s._v("#")]),s._v(" 1. 版本")]),s._v(" "),a("h3",{attrs:{id:"_1-1-clickhouse"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-clickhouse"}},[s._v("#")]),s._v(" 1.1 ClickHouse")]),s._v(" "),a("p",[s._v("拉取 ClickHouse 镜像，这里使用码云上的镜像进行加速："),a("code",[s._v("git clone https://gitee.com/mirrors/clickhouse.git")]),s._v("，并切换为 20.6.6.7 分支。")]),s._v(" "),a("h3",{attrs:{id:"_1-2-安装-ninja"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-安装-ninja"}},[s._v("#")]),s._v(" 1.2 安装 ninja")]),s._v(" "),a("p",[s._v("这里安装 ninja 1.9，参考ninja 官网：http://blog.fpliu.com/it/software/ninja 。\nClickHouse 20.6.6.7 要求至少 1.8，这里直接按照 ninja 官网首页来：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("curl -LO https://github.com/ninja-build/ninja/releases/download/v1.9.0/ninja-linux.zip\nunzip ninja-linux.zip -d ~/bin\nexport PATH=$PATH:~/bin\n# 此处建立软连接，否则编译时会提示找不到 ninja\nln -s ~/bin/ninja /usr/bin/ninja-build\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_1-3-安装-gcc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-安装-gcc"}},[s._v("#")]),s._v(" 1.3 安装 gcc")]),s._v(" "),a("p",[s._v("根据官网教程，ck 20.6.6.7 版本应使用 gcc-9，这里使用 devtoolset 来进行 gcc 版本的切换。")]),s._v(" "),a("p",[s._v("如果 gcc 版本不为 9，且安装了其他版本的 devtoolset，记得先卸载掉 devtoolset。")]),s._v(" "),a("p",[s._v("安装 devtoolset-9，并切换为 gcc-9，参照 https://www.cnblogs.com/52fhy/p/12547521.html ：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" centos-release-scl\nyum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils\nscl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" devtoolset-9 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_1-4-安装-cmake"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-安装-cmake"}},[s._v("#")]),s._v(" 1.4 安装 cmake")]),s._v(" "),a("p",[s._v("cmake 版本至少 3 以上：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("$ cmake --version\ncmake version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.14")]),s._v(".5\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_2-编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-编译"}},[s._v("#")]),s._v(" 2. 编译")]),s._v(" "),a("h3",{attrs:{id:"_2-1-x86-平台"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-x86-平台"}},[s._v("#")]),s._v(" 2.1 x86 平台")]),s._v(" "),a("p",[a("strong",[s._v("重点")]),s._v("：在前面规整了各编译组件的版本后，本质上还出现编译错误的原因都是 "),a("strong",[s._v("ClickHouse 的依赖包下载不全或者下载错误")]),s._v("，这里通过修改 ClickHouse 依赖的子模块为码云 gitee 仓库解决。")]),s._v(" "),a("ul",[a("li",[s._v("码云为编译 ClickHouse 所建的镜像仓库（优先使用）：https://gitee.com/organizations/ClickHouse-Build/projects")]),s._v(" "),a("li",[s._v("码云为绝大部分 github 项目建立的镜像仓库：https://gitee.com/organizations/mirrors/projects")]),s._v(" "),a("li",[s._v("码云为 apache 项目建立的镜像仓库：https://gitee.com/organizations/mirrors_apache/projects")])]),s._v(" "),a("p",[s._v("上述几个仓库，都是码云官方拉取了 github 上的仓库，为国内提供加速的。")]),s._v(" "),a("p",[s._v("知道这上面三个仓库后，我们需要做的就是将 ClickHouse 依赖的子项目配置及其子项目依赖的子项目（部分子项目也有自身依赖的子项目）替换为码云上的仓库："),a("code",[s._v('sed -i -r "s/github.com\\/.+\\//gitee.com\\/ClickHouse-Build\\//g" .gitmodules')]),s._v("。")]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：上述命令只是举个例子，实际上需要根据具体场景，将各个 git 项目下的 github 路径替换为 gitee 路径。之所以列出三个镜像仓库，是因为部分子项目在 ClickHouse-Build 中也没有，此时需要到剩余两个仓库中寻找并手动替换。当然更好的方法是能够搭建一个 vpn，这样就无需自己手动替换了。")])]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：子项目的含义请自行了解 git 的 submodule 概念。")])]),s._v(" "),a("p",[s._v("替换完成后，在 ClickHouse 顶级目录执行 "),a("code",[s._v("git submodule sync --recursive")]),s._v(" 同步修改的子项目配置，之后再执行 "),a("code",[s._v("git submodule update --init --recursive")]),s._v(" 拉取子项目，根据报错提示，逐个修改子模块的仓库路径。")]),s._v(" "),a("p",[s._v("需要注意的是，有部分子项目的项目命名在 gitee 跟 github 上有一点区别，这里逐个列出：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim $ClickHouse_HOME/.gitmodules")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("submodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contrib/aws"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\tpath "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" contrib/aws\n\turl "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" https://github.com/ClickHouse-Extras/aws-sdk-cpp.git\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换为")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("submodule "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contrib/aws"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" contrib/aws\n        url "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" https://gitee.com/ClickHouse-Build/aws.git\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("最后在 ClickHouse 顶级目录执行下列命令进行编译：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参考：https://clickhouse.tech/docs/v20.3/en/development/build/")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CC")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gcc-9\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CXX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("g++-9\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ClickHouse\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" build\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" build\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行 cmake 的时候，一定要仔细观察输出信息，详见下述文字详细说明")]),s._v("\n$ cmake "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n$ ninja clickhouse\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("执行 cmake 的时候，一定要仔细观察输出信息，若出现下述信息：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n-- The following OPTIONAL packages have not been found:\n\n * Arrow\n * Parquet\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("那么需要仔细检查 "),a("code",[s._v("$ClickHouse_HOME/contrib")]),s._v(" 下对应的模块是否存在，以及 .gitmodules 对应模块的配置是否正确，否则会导致编译失败。\n如果发现模块拉取失败，则可以删除 "),a("code",[s._v("$ClickHouse_HOME/contrib/模块")]),s._v(" 的文件夹，然后重新执行 "),a("code",[s._v("git submodule sync --recursive")]),s._v(" 以及 "),a("code",[s._v("git submodule update --init --recursive")]),s._v(" 重新拉取模块。")]),s._v(" "),a("p",[s._v("最后会生成  "),a("code",[s._v("$ClickHouse_HOME/build/programs/clickhouse")]),s._v(" 可执行文件，用于启动 client、server 等。")]),s._v(" "),a("p",[s._v("官网教程： https://gitee.com/ClickHouse-Build/aws.git")]),s._v(" "),a("h3",{attrs:{id:"_2-2-鲲鹏服务器-arm-平台"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-鲲鹏服务器-arm-平台"}},[s._v("#")]),s._v(" 2.2 鲲鹏服务器 + ARM 平台")]),s._v(" "),a("p",[s._v("对于 鲲鹏服务器 + ARM 平台，通过华为的技术人员得知，在编译时需要执行一些额外步骤：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("修改contrib/CMakeLists.txt，WITH 1修改为WITH 0："),a("code",[s._v("sed -i 's!WITH_ACLE 1!WITH_ACLE 0!g' contrib/CMakeLists.txt")])])]),s._v(" "),a("li",[a("p",[s._v("关闭 WERROE："),a("code",[s._v('sed -i \'s!WERROR "Enable -Werror compiler option" ON!WERROR "Enable -Werror compiler option" OFF!g\' CMakeLists.txt')])])]),s._v(" "),a("li",[a("p",[s._v("对于 GCC 9.1 以上，可以添加 ARM 独有优化，"),a("code",[s._v("vim cmake/cpu_features.cmake")]),s._v(" 添加如下内容：")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ARCH_AARCH64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("COMPILER_FLAGS "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${COMPILER_FLAGS}   -march=armv8.2-a+fp+simd+crc+lse  -mtune=tsv110 -fPIC "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("endif")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("执行 cmake 时需要关闭 unwind（ARM 不支持，且仅在异常测试的时候使用）："),a("code",[s._v("cmake3 .. -DENABLE_TCMALLOC=OFF -DUSE_UNWIND=OFF -DENABLE_JEMALLOC=OFF -DCMAKE_INSTALL_PREFIX")])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);