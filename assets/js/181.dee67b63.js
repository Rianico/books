(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{904:function(t,s,a){"use strict";a.r(s);var n=a(70),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"_1-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-前言"}},[t._v("#")]),t._v(" 1. 前言")]),t._v(" "),a("p",[t._v("先说下结论，这个问题存在于 Spark "),a("strong",[t._v("2.1.0.cloudera1")]),t._v(" 版本的（其他 cdh 相关版本未验证），再加上 Kerberos 凭据过期时间点正好与 checkpoint 的时间点重合。")]),t._v(" "),a("h2",{attrs:{id:"_2-排查过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-排查过程"}},[t._v("#")]),t._v(" 2. 排查过程")]),t._v(" "),a("p",[t._v("查看 5 月 29 号当天 HDFS 数据，发现在 15:35 分后就没有数据了：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/Avator/image-20210601160601675.png",alt:"image-20210601160601675"}}),t._v("查看作业 Driver 端，日志如下：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO JobScheduler: Added "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("jobs")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO JobGenerator: Checkpointing graph "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO DStreamGraph: Updating checkpoint data "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO DStreamGraph: Updated checkpoint data "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO CheckpointWriter: Submitted checkpoint of "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms to writer queue\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO CheckpointWriter: Saving checkpoint "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hdfs://nzj-cluster-gdyd/zkx_deploy/xdrhub_jiake/checkpoint/cyw/https/CY_HTTPS_JIAKE_GZ_XDR/all/checkpoint-1622432000000'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 WARN UserGroupInformation: PriviledgedActionException as:zkx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("auth:SIMPLE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" cause:org.apache.hadoop.ipc.RemoteException"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("org.apache.hadoop.security.token.SecretManager"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$InvalidToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": token "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" zkx: HDFS_DELEGATION_TOKEN "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("zkx, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("renewer")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("yarn, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("realUser")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("oozie/service2.nzj.gdyd@NZJ.GDYD, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("issueDate")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1619681808569")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("maxDate")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622273808569")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sequenceNumber")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("370742481")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("masterKeyId")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("803")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" can"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'t be found in cache\n21/05/31 11:33:20 WARN Client: Exception encountered while connecting to the server : org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.token.SecretManager"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$InvalidToken")]),t._v("): token (token for zkx: HDFS_DELEGATION_TOKEN owner=zkx, renewer=yarn, realUser=oozie/service2.nzj.gdyd@NZJ.GDYD, issueDate=1619681808569, maxDate=1622273808569, sequenceNumber=370742481, masterKeyId=803) can'")]),t._v("t be found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" cache\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 WARN UserGroupInformation: PriviledgedActionException as:zkx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("auth:SIMPLE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" cause:org.apache.hadoop.ipc.RemoteException"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("org.apache.hadoop.security.token.SecretManager"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$InvalidToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": token "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" zkx: HDFS_DELEGATION_TOKEN "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("zkx, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("renewer")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("yarn, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("realUser")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("oozie/service2.nzj.gdyd@NZJ.GDYD, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("issueDate")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1619681808569")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("maxDate")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622273808569")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sequenceNumber")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("370742481")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("masterKeyId")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("803")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" can"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'t be found in cache\n21/05/31 11:33:20 WARN CheckpointWriter: Error in attempt 1 of writing checkpoint to '")]),t._v("hdfs://nzj-cluster-gdyd/zkx_deploy/xdrhub_jiake/checkpoint/cyw/https/CY_HTTPS_JIAKE_GZ_XDR/all/checkpoint-1622432000000"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\norg.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.token.SecretManager"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$InvalidToken")]),t._v("): token (token for zkx: HDFS_DELEGATION_TOKEN owner=zkx, renewer=yarn, realUser=oozie/service2.nzj.gdyd@NZJ.GDYD, issueDate=1619681808569, maxDate=1622273808569, sequenceNumber=370742481, masterKeyId=803) can'")]),t._v("t be found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" cache\n    at org.apache.hadoop.ipc.Client.call"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Client.java:1504"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.ipc.Client.call"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Client.java:1441"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.ipc.ProtobufRpcEngine"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Invoker")]),t._v(".invoke"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ProtobufRpcEngine.java:230"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at com.sun.proxy."),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Proxy10")]),t._v(".delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Unknown Source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ClientNamenodeProtocolTranslatorPB.java:535"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at sun.reflect.GeneratedMethodAccessor81.invoke"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Unknown Source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DelegatingMethodAccessorImpl.java:43"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.lang.reflect.Method.invoke"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Method.java:498"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("RetryInvocationHandler.java:260"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("RetryInvocationHandler.java:104"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at com.sun.proxy."),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Proxy11")]),t._v(".delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Unknown Source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.hdfs.DFSClient.delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DFSClient.java:2062"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.hdfs.DistributedFileSystem"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$13")]),t._v(".doCall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DistributedFileSystem.java:684"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.hdfs.DistributedFileSystem"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$13")]),t._v(".doCall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DistributedFileSystem.java:680"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.fs.FileSystemLinkResolver.resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("FileSystemLinkResolver.java:81"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.hadoop.hdfs.DistributedFileSystem.delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DistributedFileSystem.java:680"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at org.apache.spark.streaming.CheckpointWriter"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CheckpointWriteHandler")]),t._v(".run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Checkpoint.scala:233"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.util.concurrent.ThreadPoolExecutor.runWorker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ThreadPoolExecutor.java:1149"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.util.concurrent.ThreadPoolExecutor"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Worker")]),t._v(".run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ThreadPoolExecutor.java:624"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.lang.Thread.run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread.java:748"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("/05/31 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":33:20 INFO CheckpointWriter: Saving checkpoint "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1622432000000")]),t._v(" ms to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hdfs://nzj-cluster-gdyd/zkx_deploy/xdrhub_jiake/checkpoint/cyw/https/CY_HTTPS_JIAKE_GZ_XDR/all/checkpoint-1622432000000'")]),t._v("\nException "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" thread "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pool-20-thread-1582"')]),t._v(" java.lang.NullPointerException\n    at org.apache.spark.streaming.CheckpointWriter"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CheckpointWriteHandler")]),t._v(".run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Checkpoint.scala:233"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.util.concurrent.ThreadPoolExecutor.runWorker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ThreadPoolExecutor.java:1149"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.util.concurrent.ThreadPoolExecutor"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Worker")]),t._v(".run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ThreadPoolExecutor.java:624"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at java.lang.Thread.run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread.java:748"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br")])]),a("p",[t._v("可以看到，Driver 并未挂掉，而是持续抛出异常，重点关注 "),a("code",[t._v("org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.token.SecretManager$InvalidToken): token (token for zkx: HDFS_DELEGATION_TOKEN owner=zkx, renewer=yarn, realUser=oozie/service2.nzj.gdyd@NZJ.GDYD, issueDate=1619681808569, maxDate=1622273808569, sequenceNumber=370742481, masterKeyId=803) can't be found")]),t._v(" 这句，其中  "),a("code",[t._v("maxDate=1622273808569")]),t._v(" 对应时间点为 "),a("code",[t._v("2021-05-29 15:36:48")]),t._v("，正好在数据中断后的第一个 batch 里，接着后面又抛出了一个空异常：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("Exception "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" thread "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pool-20-thread-1582"')]),t._v(" java.lang.NullPointerException\n    at org.apache.spark.streaming.CheckpointWriter"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CheckpointWriteHandler")]),t._v(".run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Checkpoint.scala:233"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("从空异常的相关日志也可以看到，该空异常是从在一个线程池里执行的，再结合 "),a("code",[t._v("pool-20-thread-1582")]),t._v(" 的线程 ID 可以推导出，在每次抛出空异常后，Spark 并没有对该异常做任何处理，而是简单的让线程挂掉并新建一个线程，所以才能看到这么大的线程 ID。")]),t._v(" "),a("p",[t._v("根据空异常的提示，查看 "),a("code",[t._v("Checkpoint.scala:233")]),t._v(" 处的 Spark 源码（版本 "),a("strong",[t._v("2.1.0.cloudera1")]),t._v("）：")]),t._v(" "),a("div",{staticClass:"language-scala line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-scala"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("latestCheckpointTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" latestCheckpointTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" checkpointTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        latestCheckpointTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" checkpointTime\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" Path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getFileSystem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hadoopConf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" attempts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" startTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("currentTimeMillis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" tempFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" Path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"temp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// We will do checkpoint when generating a batch and completing a batch. When the processing")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// time of a batch is greater than the batch interval, checkpointing for completing an old")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// batch may run after checkpointing of a new batch. If this happens, checkpoint of an old")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// batch actually has the latest information, so we want to recovery from it. Therefore, we")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// also use the latest checkpoint time as the file name, so that we can recover from the")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// latest checkpoint file.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note: there is only one thread writing the checkpoint files, so we don't need to worry")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// about thread-safety.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" checkpointFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Checkpoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("checkpointFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" latestCheckpointTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" backupFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Checkpoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("checkpointBackupFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" latestCheckpointTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attempts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" MAX_ATTEMPTS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("stopped"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        attempts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          logInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Saving checkpoint for time $checkpointTime to file '$checkpointFile'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Write checkpoint to temp file")]),t._v("\n          fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tempFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// just in case it exists")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" fos "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tempFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          Utils"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tryWithSafeFinally "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("write"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If the checkpoint file exists, back it up")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If the backup exists as well, just delete it, otherwise rename will fail")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("backupFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// just in case it exists")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" backupFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              logWarning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Could not rename $checkpointFile to $backupFile"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Rename temp file to the final checkpoint file")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tempFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checkpointFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            logWarning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Could not rename $tempFile to $checkpointFile"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Delete old checkpoint files")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" allCheckpointFiles "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Checkpoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getCheckpointFiles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Some"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("allCheckpointFiles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            allCheckpointFiles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("take"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("allCheckpointFiles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("foreach "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" file "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n              logInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Deleting $file"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// All done, print success")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" finishTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("currentTimeMillis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          logInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Checkpoint for time $checkpointTime saved to file '$checkpointFile'\"")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('", took ${bytes.length} bytes and ${finishTime - startTime} ms"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          jobGenerator"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onCheckpointCompletion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" clearCheckpointDataLater"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" ioe"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" IOException "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Error in attempt $attempts of writing checkpoint to '$checkpointFile'\"")]),t._v("\n            logWarning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ioe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      logWarning"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Could not write checkpoint for time $checkpointTime to file '$checkpointFile'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br"),a("span",{staticClass:"line-number"},[t._v("73")]),a("br"),a("span",{staticClass:"line-number"},[t._v("74")]),a("br"),a("span",{staticClass:"line-number"},[t._v("75")]),a("br")])]),a("p",[t._v("可以看到，run 方法中主要是一个有限次数的循环，结合日志 "),a("code",[t._v("Error in attempt 1 of writing checkpoint to...")]),t._v(" 可以看到第一次循环捕获异常后会把 fs 设置为 null，进入第二轮循环，而空异常正好是在 "),a("code",[t._v("fs.delete(tempFile, true) // just in case it exists")]),t._v(" 处抛出的，而 run 方法中没有对空异常进行捕获，导致线程直接挂掉。同时 Spark 也无法感知到任何异常的发生。")]),t._v(" "),a("p",[t._v("查看原生 Spark 2.1 相同处的源码，发现 fs 有对 null 进行了处理：")]),t._v(" "),a("div",{staticClass:"language-scala line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-scala"}},[a("code",[t._v("          logInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Saving checkpoint for time $checkpointTime to file '$checkpointFile'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" Path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("checkpointDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getFileSystem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hadoopConf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("也就是说，起码从 Spark 2.1 开始，不存在该问题。")]),t._v(" "),a("h2",{attrs:{id:"_3-出现问题的原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-出现问题的原因"}},[t._v("#")]),t._v(" 3. 出现问题的原因")]),t._v(" "),a("p",[t._v("从日志来看，当 Kerberos 过期，而 Spark Driver 端又正好在写 checkpoint 的时候，就会出现以上异常。")]),t._v(" "),a("p",[t._v("Kerberos 的有效间隔为 30 天整，一旦我们启动 Spark 作业的时间点正好撞上 checkpoint 时间点，就会重复出现这个问题，但概率较小，具有随机性。")]),t._v(" "),a("p",[t._v("由于近期为了提高资源利用率缩短了 batch 间隔，所以以上问题发生的概率增加了，虽然概率仍然很小，但随着处理间隔越短，发生该问题的概率越高。")]),t._v(" "),a("p",[t._v("可以考虑通过升级 Spark 版本的方式来彻底解决该问题。")])])}),[],!1,null,null,null);s.default=e.exports}}]);