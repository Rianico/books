(window.webpackJsonp=window.webpackJsonp||[]).push([[196],{920:function(t,s,a){"use strict";a.r(s);var e=a(70),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"ambari-自定义告警"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ambari-自定义告警"}},[t._v("#")]),t._v(" Ambari 自定义告警")]),t._v(" "),a("p",[t._v("Ambari 的告警体系，首先要明确三个概念：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Alert")]),t._v("：定义了监控的方式，包括 alert 类型、检查间隔以及阈值，用于监控集群组件、机器的状态。如果满足条件，则会产生一个 alert 实例 ，不包含推送动作。\n"),a("ul",[a("li",[a("strong",[t._v("alert 的几种状态")]),t._v("：OK、 WARNING、 CRITICAL、 UNKNOWN（少见，通常在服务安装过程中才会见到）。")]),t._v(" "),a("li",[a("strong",[t._v("alert 的几种类型")]),t._v("：web、port、metric、aggreate、script、server、recover。")])])]),t._v(" "),a("li",[a("strong",[t._v("Notification")]),t._v("：对 alert 实例进行推送，支持 EMAIL/SNMP/自定义脚本方式推送 alert。")]),t._v(" "),a("li",[a("strong",[t._v("Group")]),t._v("：分组，一个分组可以关联多个 alert 及多个 notification。")])]),t._v(" "),a("p",[t._v("举例：定义一个 hdfs 相关的 gourp；group关联多个 hdfs 相关的 alert 类型；group 关联多个 notification，每个 notification 推送对象为 hdfs 维护人员，从而实现按需通知。")]),t._v(" "),a("p",[t._v("alerts, notifications 以及 notification 这三个抽象可以让必要的人员只关注必要的告警。")]),t._v(" "),a("p",[t._v("通常只有在状态发生变化时，才会产生推送动作，这个取决于 notification 关注哪些 alert 状态。")]),t._v(" "),a("h2",{attrs:{id:"alert-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#alert-type"}},[t._v("#")]),t._v(" Alert Type")]),t._v(" "),a("p",[t._v("alert 的几种状态：OK、 WARNING、 CRITICAL、 UNKNOWN。 alert 支持以下几种监控方式：")]),t._v(" "),a("ul",[a("li",[t._v("web：监控组件的 web 状态，alert 的状态取决于 web 的响应码：\n"),a("ul",[a("li",[t._v("OK：web 响应码 < 400.")]),t._v(" "),a("li",[t._v("WARNING：web 响应码 ≥ 400.")]),t._v(" "),a("li",[t._v("CRITICAL：无法连接上 web 或者连接超时，单位为秒。")])])]),t._v(" "),a("li",[t._v("port：测试端口是否连通，超时时间单位为秒。")]),t._v(" "),a("li",[t._v("metric：可以检查一个或者多个 metric (需要定义计算方式)，这些 metric 可以从一个组件暴露的端点获取（比如 JMX）。当获取 metric 超市的时候 alert 状态为 CRITICAL 。不同的 metric 单位也不同，比如 CPU 利用率的 alert 单位为百分比，RPC 延迟的 alert 单位为毫秒。")]),t._v(" "),a("li",[t._v("aggregate：聚合多个 alert 实例，并计算出所占百分比，比如聚合所有 HDFS 进程的 alert，并统计出处于各个 alert 状态的百分比。")]),t._v(" "),a("li",[t._v("script：通过执行一个脚本并返回如 OK、WARNING 或者 CRITICAL 状态，同时也可以自定义脚本返回的响应内容、properties、阈值。")]),t._v(" "),a("li",[t._v("server：会执行服务端的一个 class，这个类会返回如 OK、WARNING 或者 CRITICAL 状态。")]),t._v(" "),a("li",[t._v("recovery：由 Ambari Agents 监控服务进程重启的时候触发。alert 状态中的 OK、WARNING 或者 CRITICAL 取决于进程自动重启的次数。可以用于了解进程挂掉的时间点以及 Ambari 自动拉起服务的时间点。")])]),t._v(" "),a("h2",{attrs:{id:"alert-相关-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#alert-相关-api"}},[t._v("#")]),t._v(" Alert 相关 API")]),t._v(" "),a("p",[t._v("Alert 提供了一套查询 alert 的 API：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查询所有的 alert 定义")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# curl -u ${ambari_user}:${ambari_passwd} -H "X-Requested-By: ambari" -X GET http://${ambari_host}:8080/api/v1/clusters/${cluster_name}/alert_definitions')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -u admin:admin -H "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"X-Requested-By: ambari"')]),t._v(" -X GET http://server1:8080/api/v1/clusters/cluster1/alert_definitions\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 根据服务组件查询 alert 定义")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -u admin:admin -H "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"X-Requested-By: ambari"')]),t._v(" -X GET http://server1:8080/api/v1/clusters/cluster1/alert_definitions?AlertDefinition/service_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("MAPREDUCE2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("其余更加详细的 API 详见 "),a("a",{attrs:{href:"https://github.com/apache/ambari/blob/trunk/ambari-server/docs/api/v1/index.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"alert-的定义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#alert-的定义"}},[t._v("#")]),t._v(" Alert 的定义")]),t._v(" "),a("p",[t._v("Ambari 自身集成的组件都已经预定义了一套 alert，详见 "),a("a",{attrs:{href:"https://docs.cloudera.com/HDPDocuments/Ambari-2.7.5.0/managing-and-monitoring-ambari/content/amb_predefined_alerts.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Predefined Alerts"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("如果需要注册自定义脚本 alert，可以参考："),a("a",{attrs:{href:"https://community.cloudera.com/t5/Community-Articles/How-to-create-and-register-custom-ambari-alerts/ta-p/246436",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to create and register custom ambari alerts ?"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("通常服务的相关 alert，在开发集成插件的时候就需要定义 alert 了，这里详见 "),a("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/AMBARI/Custom+Services",target:"_blank",rel:"noopener noreferrer"}},[t._v("Custom Services"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"自定义-notification-脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自定义-notification-脚本"}},[t._v("#")]),t._v(" 自定义 Notification 脚本")]),t._v(" "),a("p",[t._v("Notification 默认支持 EMAIL/SNMP/Script 方式，其中 EMAIL 跟 SNMP 按照界面填写即可，较为简单，这里不做介绍，而且也不符合我们当前现网的告警场景，这里主要介绍如何通过自定义脚本，调用我们的巡检接口。")]),t._v(" "),a("p",[t._v("通过自定义脚本也可以达到解耦的目的，一旦注册了自定义脚本后，后续可以灵活修改脚本内容，而无需其他操作，参考 "),a("a",{attrs:{href:"https://risdenk.github.io/2018/03/25/apache-ambari-custom-alert-dispatch-script.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Ambari - Custom Alert Dispatch Script"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("ol",[a("li",[t._v("首先定义一个脚本 "),a("code",[t._v("vim /path/to/alert1.py")]),t._v("，并定义告警内容输出到 "),a("code",[t._v("/var/log/ambari-server/ambari-alerts-custom.log")]),t._v("，内容如下：")])]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/usr/bin/env python")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" datetime "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" datetime\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" sys\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" os\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" logging\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handle_alert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v("'''\n     # handle_alert method which is called from Ambari\n     # :param definitionName: the alert definition unique ID\n     # :param definitionLabel: the human readable alert definition label\n     # :param serviceName: the service that the alert definition belongs to\n     # :param alertState: the state of the alert (OK, WARNING, etc)\n     # :param alertText: the text of the alert\n     # :param alertTimestamp: the timestamp the alert went off - Added in AMBARI-20291\n     # :param hostname: the hostname the alert fired off for - Added in AMBARI-20291\n     '''")]),t._v("\n\n    definitionName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    definitionLabel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    serviceName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    alertState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    alertText "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# AMBARI-20291")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        alertTimestamp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        hostname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            alertTimestamp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'N/A'")]),t._v("\n            hostname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'N/A'")]),t._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# set logging config")]),t._v("\n            logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("basicConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/var/log/ambari-server/ambari-alerts-custom.log'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[%(asctime)s-%(filename)s-%(levelname)s]: %(message)s'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" level"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filemode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" datefmt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%Y-%m-%d %H:%M:%S'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add custom logic here to handle the alert")]),t._v("\n            logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            logging"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"definitionName:%s, definitionLabel:%s, serviceName:%s, alertState:%s, alertText:%s, alertTimestamp:%s, hostname:%s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" definitionName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" definitionLabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" serviceName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" alertState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" alertText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" alertTimestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hostname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \thandle_alert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Incorrect number of arguments"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br")])]),a("ol",[a("li",[t._v("编辑 ambari-server 属性文件，添加一个自定义属性，并指向我们的自定义脚本文件：")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("   cn.com.haohan.alert.test.script=/path/to/alert1.py\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[t._v("重启 Ambari："),a("code",[t._v("ambari-server restart")]),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("进入 Ambari 的告警配置界面："),a("em",[t._v("Alerts-Actions-Manage Alert Groups")]),t._v("：")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103146557.png",alt:"image-20210702103146557"}})]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("添加 group，并在 group 下添加关注的 alert：")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103216265.png",alt:"image-20210702103216265"}})]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("点击"),a("em",[t._v("Alerts-Actions-Manage Notifications")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103238560.png",alt:"image-20210702103238560"}})]),t._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[t._v("点击 "),a("em",[t._v("+")]),t._v(" 添加 notification 方式，这里选择脚本方式（Alert Script），并在 Script Dispatch Property 处填入我们前面自定义的属性 "),a("code",[t._v("cn.com.haohan.alert.test.script")]),t._v("：")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/blog/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16251931783567.png",alt:"img"}})]),t._v(" "),a("ol",{attrs:{start:"7"}},[a("li",[a("p",[t._v("接着我们去到 SamrtSense 部署的机器上，kill 掉 9000 端口上的 SmartSense 进程。")])]),t._v(" "),a("li",[a("p",[t._v("查看 "),a("code",[t._v("/var/log/ambari-server/ambari-alerts-custom.log")]),t._v("，发现脚本的告警内容已输出")])])]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-10-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":37:19-alert1.py-INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/ambari-qa/alert_scripts/alert1.py'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'smartsense_gateway_status'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SmartSense Gateway Status'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SMARTSENSE'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UNKNOWN'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[Alert][smartsense_gateway_status] Unable to extract JSON from JMX response'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1603337720095'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'server1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-10-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":37:19-alert1.py-INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": definitionName:smartsense_gateway_status, definitionLabel:SmartSense Gateway Status, serviceName:SMARTSENSE, alertState:UNKNOWN, alertText:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Alert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("smartsense_gateway_status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Unable to extract JSON from JMX response, alertTimestamp:1603337720095, hostname:server1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-10-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":37:19-alert1.py-INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/ambari-qa/alert_scripts/alert1.py'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'smartsense_server_process'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SmartSense Server Process'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SMARTSENSE'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CRITICAL'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SmartSense HST Server connection failed: [Errno 111] Connection refused to server1:9000'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1603337720166'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'server1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("-10-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":37:19-alert1.py-INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": definitionName:smartsense_server_process, definitionLabel:SmartSense Server Process, serviceName:SMARTSENSE, alertState:CRITICAL, alertText\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])])])}),[],!1,null,null,null);s.default=n.exports}}]);