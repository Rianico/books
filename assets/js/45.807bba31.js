(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{770:function(s,t,a){"use strict";a.r(t);var n=a(70),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-相关概念（微观）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-相关概念（微观）"}},[s._v("#")]),s._v(" 1. 相关概念（微观）")]),s._v(" "),a("p",[s._v("线程不安全的三个源头性问题：")]),s._v(" "),a("ol",[a("li",[a("p",[a("strong",[s._v("可见性")]),s._v("，一个线程对数据的修改，另一个线程能够立刻看到。")]),s._v(" "),a("ul",[a("li",[s._v("多核以及缓存（工作内存）带来了可见性问题")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("原子性")]),s._v("，一个或者多个操作在 CPU 执行的过程中不被中断。")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("多线程切换会带来原子性问题")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("CPU 保证的原子性是一条 CPU 指令，而非一行代码。")])]),s._v(" "),a("li",[a("p",[s._v("原子性是为了保障中间状态不暴露给外界，避免被破坏。")])])])]),s._v(" "),a("li",[a("p",[s._v("有序性，CPU 优化、编译器优化等可能会对指令进行重排序，实际执行顺序可能并非代码所写的那样。")])])]),s._v(" "),a("p",[s._v("Java 内存模型，在解决上述问题的前提下，通过"),a("strong",[s._v("按需禁用缓存和编译优化")]),s._v("，以及 happens-before 原则实现了线程安全。")]),s._v(" "),a("p",[s._v("happens-before 是 Java 实现线程安全的理论基础，对"),a("strong",[s._v("线程之间")]),s._v("指定了以下几个原则：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("程序的顺序性")]),s._v("，程序前面的操作先行于后面的操作。")]),s._v(" "),a("li",[a("strong",[s._v("volatile")]),s._v("，对一个 volatile 变量的写操作，先行于后续对这个 volatile 的读操作（禁用缓存，JDK5 增强了语义）。")]),s._v(" "),a("li",[a("strong",[s._v("传递性")]),s._v("，如果 A 先行发生于 B，B 先行发生于 C，那么 A 先行发生于 B。")]),s._v(" "),a("li",[s._v("对一个锁的解锁，先行发生于后续对这个锁的加锁（前面做的操作对后面获取锁的线程可见）。")]),s._v(" "),a("li",[s._v("对象的初始化先行于对象的 finalize()。")]),s._v(" "),a("li",[s._v("线程的开始前的操作（"),a("code",[s._v("start()")]),s._v("）先行发生于线程中的动作。")]),s._v(" "),a("li",[s._v("线程中发生的的动作先行于线程的结束。")]),s._v(" "),a("li",[s._v("线程的中断操作，先行于线程检测到中断信号（"),a("code",[s._v("Thread.interrupted()")]),s._v("）。")]),s._v(" "),a("li",[s._v("一个线程调用 join 等待另一个线程，另一个线程执行完后，发起调用的线程能看到完成线程的操作。")])]),s._v(" "),a("p",[s._v("很多机制的实现，都是基于 happens-before 。")]),s._v(" "),a("p",[s._v("final 关键字避免变量的初始化被重排序到构造函数外，但构造器内还是会重排序的。")]),s._v(" "),a("h2",{attrs:{id:"_2-互斥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-互斥"}},[s._v("#")]),s._v(" 2. 互斥")]),s._v(" "),a("p",[s._v("互斥，保证某个资源同一时刻只有一个线程占有，通常是使用锁来实现对资源的保护。")]),s._v(" "),a("p",[s._v("通常一个锁与资源的合理关系是 1 : N，一把锁可以保护多个资源。需要注意的是，"),a("strong",[s._v("两把不同的锁（比如实例对象和类）之间是不互斥的")]),s._v("。")]),s._v(" "),a("p",[s._v("如果一把锁需要保护多个有关联关系的资源，场景通常会较为复杂，对 class 本身进行加锁是最简单的方法（粗粒度，性能差）。")]),s._v(" "),a("p",[s._v("由于对 class 加锁代价较大，因此通常会使用更加细粒度的锁对多个资源加锁，提高并发性能，但往往也容易导致死锁。")]),s._v(" "),a("p",[s._v("死锁指的是，在一个程序中，两个或以上的线程都在等待其他线程释放资源，线程自身不会主动释放资源，资源也无法被其他线程抢占。")]),s._v(" "),a("p",[s._v("死锁在以下几个条件下会出现：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("互斥")]),s._v("，一把锁同一时间只能被一个线程持有；")]),s._v(" "),a("li",[a("strong",[s._v("占有且等待")]),s._v("，线程 T1 已经取得共享资源 X，在等待共享资源 Y 的时候，不会主动释放共享资源 X；")]),s._v(" "),a("li",[a("strong",[s._v("不可抢占")]),s._v("，其他线程不能强行抢占线程 T1 占有的资源；")]),s._v(" "),a("li",[a("strong",[s._v("循环等待")]),s._v("，线程 T1 等待线程 T2 占有的资源，线程 T2 等待线程 T1 占有的资源，就是循环等待。")])]),s._v(" "),a("h3",{attrs:{id:"_2-1-破坏占用且等待条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-破坏占用且等待条件"}},[s._v("#")]),s._v(" 2.1 破坏占用且等待条件")]),s._v(" "),a("p",[s._v("通过一个协调者，由协调者来进行资源的获取，一旦一个线程向协调者同时申请多个资源成功，则另一个线程需要等待原有的线程向协调者发出释放资源的请求：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Allocator")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("List")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" als "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ArrayList")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 一次性申请所有资源")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("contains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("contains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 归还资源")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    als"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// actr应该为单例")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Allocator")]),s._v(" actr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" balance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 转账")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("transfer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 一次性申请转出账户和转入账户，直到成功")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("actr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 锁定转出账户")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("              \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 锁定转入账户")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("           \n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      actr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("h3",{attrs:{id:"_2-2-破坏不可抢占条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-破坏不可抢占条件"}},[s._v("#")]),s._v(" 2.2 破坏不可抢占条件")]),s._v(" "),a("p",[s._v("使用可相应中断的方式。")]),s._v(" "),a("h3",{attrs:{id:"_2-3-破坏循环等待条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-破坏循环等待条件"}},[s._v("#")]),s._v(" 2.3 破坏循环等待条件")]),s._v(" "),a("p",[s._v("两个线程相互循环等待，归根结底为资源的获取顺序问题，可以考虑为每个资源加入一个 id 进行排序，每次获取资源时先对资源进行排序：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" balance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 转账")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("transfer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" left "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),s._v("        ①\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Account")]),s._v(" right "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    ②\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" ③\n      left "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           ④\n      right "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            ⑤\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                          ⑥\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 锁定序号小的账户")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("left"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 锁定序号大的账户")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("right"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("balance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" amt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("但这种方法会对对象造成入侵，不太可取。")]),s._v(" "),a("h3",{attrs:{id:"_2-4-等待-通知机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-等待-通知机制"}},[s._v("#")]),s._v(" 2.4 等待-通知机制")]),s._v(" "),a("p",[s._v("假设一个线程通过 while(...) 请求资源，如果资源的操作是较为耗时的，那么这里的 while(...) 会一直空转，无谓的消耗 CPU 资源。")]),s._v(" "),a("p",[s._v("此处更好的做法是引入 等待-通知 机制，获取锁后当线程发现不满足一定条件时，先让自己进入等待队列释放锁，直到收到唤醒的通知。")]),s._v(" "),a("p",[s._v("Java 可以基于 synchronized 实现 通知-等待 机制，当线程发现某些条件不满足时，会进入锁自己独立的等待队列，进入阻塞状态，等待持有锁的线程的唤醒：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/1b/8c/1b3e999c300166a84f2e8cc7a4b8f78c.png",alt:""}})]),s._v(" "),a("p",[s._v("当需要唤醒其他线程时，可以调用 Java 对象的 "),a("code",[s._v("notify()")]),s._v(" 以及 "),a("code",[s._v("notifyAll()")]),s._v(" 方法，告诉等待队列中的线程，它们的"),a("strong",[s._v("条件曾经满足过")]),s._v("。")]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：线程发起的通知只能保证在发起的那一刻条件是满足的。")])]),s._v(" "),a("p",[s._v("通知-等待机制的一个经典范式是：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("blockquote",[a("p",[s._v("NOTE：使用 notify() 的一个风险在于，有些线程可能一直不会被唤醒。")])]),s._v(" "),a("h2",{attrs:{id:"_3-安全性、活跃性以及性能（宏观）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-安全性、活跃性以及性能（宏观）"}},[s._v("#")]),s._v(" 3. 安全性、活跃性以及性能（宏观）")]),s._v(" "),a("h3",{attrs:{id:"_3-1-安全性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-安全性"}},[s._v("#")]),s._v(" 3.1 安全性")]),s._v(" "),a("p",[a("strong",[s._v("数据竞争")]),s._v("，当多个线程需要访问同一个变量，且变量是可变的。")]),s._v(" "),a("p",[a("strong",[s._v("竞态条件")]),s._v("，多个线程运行的结果依赖于线程之间的执行顺序，常见于多个线程显示/隐式的依赖于某个条件。")]),s._v(" "),a("h3",{attrs:{id:"_3-2-活跃性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-活跃性"}},[s._v("#")]),s._v(" 3.2 活跃性")]),s._v(" "),a("p",[s._v("除了死锁之外，还有活锁以及解锁：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("活锁")]),s._v("：当多个线程需要竞争同一份资源时，彼此都让出资源给对方，持续反复的出现这个现象。\n"),a("ul",[a("li",[s._v("解决方法：每个线程都等待一段随机的时间，错开竞争。")])])]),s._v(" "),a("li",[a("strong",[s._v("饥饿锁")]),s._v("：线程因无法申请到所需资源而无法执行下去。\n"),a("ul",[a("li",[s._v("当高优先级的线程一直无法执行时，低优先级的线程基本无法获取 CPU 资源。")]),s._v(" "),a("li",[s._v("解决方法：①保证资源充足；②公平分配资源（公平锁，先来后到）；③避免持有锁的线程长时间运行。")])])])]),s._v(" "),a("h3",{attrs:{id:"_3-3-性能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-性能"}},[s._v("#")]),s._v(" 3.3 性能")]),s._v(" "),a("p",[s._v("锁会导致串行化，如果锁的粒度过大，会有大范围的串行操作，导致性能退化。")]),s._v(" "),a("p",[s._v("解决方案：")]),s._v(" "),a("ul",[a("li",[s._v("线程本地存储（ThreadLocal）")]),s._v(" "),a("li",[s._v("乐观锁")]),s._v(" "),a("li",[s._v("Copy On Write")]),s._v(" "),a("li",[s._v("无锁结构的原子类")]),s._v(" "),a("li",[s._v("减少持有锁的时间（细粒度的锁）")])]),s._v(" "),a("p",[s._v("性能方面常见三个指标：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("吞吐量")]),s._v("：指的是单位时间内能处理的请求数量。吞吐量越高，说明性能越好。")]),s._v(" "),a("li",[a("strong",[s._v("延迟")]),s._v("：指的是从发出请求到收到响应的时间。延迟越小，说明性能越好。")]),s._v(" "),a("li",[a("strong",[s._v("并发量")]),s._v("：指的是能同时处理的请求数量，一般来说"),a("strong",[s._v("随着并发量的增加、延迟也会增加")]),s._v("。所以延迟这个指标，一般都会是基于并发量来说的。例如并发量是 1000 的时候，延迟是 50 毫秒。")])]),s._v(" "),a("h2",{attrs:{id:"_4-管程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-管程"}},[s._v("#")]),s._v(" 4. 管程")]),s._v(" "),a("p",[s._v("管程是一种编程模型，指的是"),a("strong",[s._v("管理共享变量以及对共享变量的操作过程")]),s._v("，让他们支持并发。")]),s._v(" "),a("p",[s._v("Java 参考了 MESA 模型（"),a("strong",[s._v("条件变量 & 等待队列")]),s._v("）来实现管程，管程主要解决了并发的两个核心问题："),a("strong",[s._v("互斥")]),s._v("、"),a("strong",[s._v("同步")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"_4-1-互斥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-互斥"}},[s._v("#")]),s._v(" 4.1 互斥")]),s._v(" "),a("p",[s._v("管程解决互斥的方式为将变量以及操作统一封装起来（同步代码块）：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/59/c4/592e33c4339c443728cdf82ab3d318c4.png",alt:""}})]),s._v(" "),a("p",[s._v("同一时间只允许一个线程进入管程。")]),s._v(" "),a("h3",{attrs:{id:"_4-2-同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-同步"}},[s._v("#")]),s._v(" 4.2 同步")]),s._v(" "),a("p",[s._v("管程实现同步较为复杂，MESA 模型规定了以下两点：")]),s._v(" "),a("ul",[a("li",[s._v("管程拥有一个等待队列，同一时间只能有一个线程进入管程，其余线程在等待队列中等待；")]),s._v(" "),a("li",[s._v("管程内部可以有多个条件变量，每个条件变量也有各自的等待队列。")])]),s._v(" "),a("p",[s._v("当一个线程进入管程后，如果满足了某个条件变量，就会进入该条件变量的等待队列，此时是允许其他线程进入管程的。")]),s._v(" "),a("p",[s._v("后面进来的线程可以通知前一个线程，此时线程会"),a("strong",[s._v("从条件变量的等待队列转移到管程的等待队列")]),s._v("，重新尝试获取锁：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/83/65/839377608f47e7b3b9c79b8fad144065.png",alt:""}})]),s._v(" "),a("p",[s._v("Java 的管程（synchronized、wait() 等）实现对 MESA 进行了精简，管程内部仅会有一个条件变量。")]),s._v(" "),a("h3",{attrs:{id:"_4-3-wait-的正确姿势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-wait-的正确姿势"}},[s._v("#")]),s._v(" 4.3 wait 的正确姿势")]),s._v(" "),a("p",[s._v("使用 while(...) 循环检测条件是 MESA 模型特有的。MESA 模型的特点就是，当一个线程唤醒了其他线程后，可能还会继续运行一段时间而不是立刻就退出运行状态，经过一段时间后，可能此时的条件已无法满足线程要求。")]),s._v(" "),a("p",[s._v("其他的模型如 Hasen、Hoare 都是一个线程通知另一个线程，然后原本的线程就暂停运行了。")]),s._v(" "),a("h3",{attrs:{id:"_4-4-notify-正确用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-notify-正确用法"}},[s._v("#")]),s._v(" 4.4 notify() 正确用法")]),s._v(" "),a("p",[s._v("在依赖多个条件变量的时候，notify() 可能会导致依赖某个条件的线程不再有机会被唤醒，因此通常提倡使用 notifyAll()。当满足以下三个条件的时候可以使用 notify()：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("所有等待线程等待相同的条件")]),s._v("；")]),s._v(" "),a("li",[a("strong",[s._v("所有等待线程唤醒后执行相同操作")]),s._v("；")]),s._v(" "),a("li",[s._v("只需要唤醒一个线程。")])]),s._v(" "),a("h2",{attrs:{id:"_5-线程生命周期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-线程生命周期"}},[s._v("#")]),s._v(" 5. 线程生命周期")]),s._v(" "),a("p",[s._v("通用的线程生命周期可以用 “五态模型” 来描述：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/9b/e5/9bbc6fa7fb4d631484aa953626cf6ae5.png",alt:""}})]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("初始状态")]),s._v("，线程已经被创建，但还不允许分配 CPU 时间片。这个状态属于"),a("strong",[s._v("编程语言特有")]),s._v("，仅在编程语言层面创建，操作系统中未创建。")]),s._v(" "),a("li",[a("strong",[s._v("可运行状态")]),s._v("，线程在操作系统中真正被创建，已具备分配 CPU 时间片的条件。")]),s._v(" "),a("li",[a("strong",[s._v("运行状态")]),s._v("，分配到 CPU 时间片的线程处于这种状态。")]),s._v(" "),a("li",[a("strong",[s._v("休眠状态")]),s._v("，如果线程调用了一个阻塞的 API （如 BIO）或者等待某个事件（条件变量），那么线程会释放 CPU 使用权，进入该状态。")]),s._v(" "),a("li",[a("strong",[s._v("终止状态")]),s._v("，系统执行完或者运行异常则会进入该状态，这也意味着线程的生命周期结束了。")])]),s._v(" "),a("p",[s._v("Java 中将可运行状态状态与运行状态合并为 RUNNABLE。这两个阶段都是操作系统层面有用，JVM 里并不需要关心这两个状态。")]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：JVM 的线程是调用操作系统提供的线程接口实现的，属于内核线程，交由内核进行调度。")])]),s._v(" "),a("p",[s._v("Java 线程的生命周期如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/3f/8c/3f6c6bf95a6e8627bdf3cb621bbb7f8c.png",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("Java 中的阻塞状态并不是完全的对应操作系统的阻塞状态的")]),s._v("，如果调用了一个阻塞的 API，那么此时线程可能在 Java 中仍是 RUNNABLE 状态，而在系统属于一个阻塞操作，线程进入休眠状态。")]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：我们常说的 Java 调用了一个阻塞操作，指的是操作系统层面。")])]),s._v(" "),a("p",[s._v("RUNNABLE 进入 Blocked 状态，只会发生在 synchronized 临界区。")]),s._v(" "),a("p",[s._v("当需要取消阻塞操作时，Java 可以通过抛出异常，获取 CPU 时间片执行 catch 块中的操作：")]),s._v(" "),a("ul",[a("li",[s._v("如果当某个线程 A 处于 RUNNABLE，并且阻塞在 "),a("code",[s._v("java.nio.channels.InterruptibleChannel")]),s._v(" 时（操作系统上为阻塞状态），当其他线程调用线程 A 的 "),a("code",[s._v("interrupt()")]),s._v(" 方法，线程 A 会抛出 "),a("code",[s._v("java.nio.channels.ClosedByInterruptException")]),s._v(" 异常；")]),s._v(" "),a("li",[s._v("如果线程 A 阻塞在 "),a("code",[s._v("java.nio.channels.Selector")]),s._v(" 上，其他线程调用线程 A 的 "),a("code",[s._v("interrupt()")]),s._v(" 方法，线程 A 的 "),a("code",[s._v("java.nio.channels.Selector")]),s._v(" 会立即返回。")])]),s._v(" "),a("p",[s._v("以上两种情况是通过（检测标志位）抛出异常来检测中断，让线程重新回到 RUNNABLE 状态。")]),s._v(" "),a("p",[s._v("还有一种情况是主动检测，线程处于 RUNNABLE 状态，并且没有阻塞在某个 I/O 操作上，线程可以通过调用 "),a("code",[s._v("Thread.isInterrupted()")]),s._v(" 方法检测自己是否被中断了。")]),s._v(" "),a("blockquote",[a("p",[s._v("NOTE：抛出 InterruptedException 异常后，"),a("strong",[s._v("中断标志位会被清除，无法被 Thread.isInterrupted() 检测到，如果有需要必须重新调用一次 interrupt() 方法")]),s._v("。")])]),s._v(" "),a("h2",{attrs:{id:"_6-创建的线程数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-创建的线程数"}},[s._v("#")]),s._v(" 6. 创建的线程数")]),s._v(" "),a("p",[s._v("使用线程是为了提高性能，尽可能地提升硬件的利用率。")]),s._v(" "),a("p",[s._v("在单核场景下，多线程主要是为了平衡 CPU 与 I/O，当一个线程执行 CPU 计算时，另一个线程可以执行 I/O 操作。")]),s._v(" "),a("p",[s._v("在多核场景下，多线程是为了充分发挥多核的能力，提高吞吐以及降级延迟时间。")]),s._v(" "),a("p",[s._v("线程数计算需要考虑作业属于 CPU 密集型还是 I/O 密集型：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("CPU 密集型：创建于核数相等的线程，避免线程切换的开销通常能发挥最大性能，但实际工程中往往会增加一个线程，在偶尔内存缺页或其他原因导致阻塞时，额外的线程可以顶上。")])]),s._v(" "),a("li",[a("p",[s._v("I/O 密集型：需要根据 I/O 耗时来计算，通常取 CPU 执行时间：I/O 执行时间，如果是 1：1，则取两个线程，如果是 1：2，则取 3 个线程，保证某个线程在执行 I/O 操作时，其他线程的 CPU 运行时段能够覆盖 I/O 阶段。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static001.geekbang.org/resource/image/98/cb/98b71b72f01baf5f0968c7c3a2102fcb.png",alt:""}})])])]),s._v(" "),a("p",[s._v("实际工程中，I/O 与 CPU 执行时间的比例是很难获取的且动态变化的，并且一台服务器也会有多个程序运行，因此在一个界定范围内进行调整即可，还可以考虑从降低修改线程数量成本的方向入手。")])])}),[],!1,null,null,null);t.default=e.exports}}]);