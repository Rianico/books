(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{827:function(s,a,t){"use strict";t.r(a);var n=t(70),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-对象的创建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-对象的创建"}},[s._v("#")]),s._v(" 1. 对象的创建")]),s._v(" "),t("p",[s._v("新建对象的几种方式：")]),s._v(" "),t("ul",[t("li",[s._v("new 和 反射：调用类的构造器。")]),s._v(" "),t("li",[s._v("Object.clone 和反序列化：复制已有数据。")]),s._v(" "),t("li",[s._v("Unsafe.allocateInstance：申请一段内存分配对象，但没有初始化实例字段。")])]),s._v(" "),t("p",[s._v("Java 对类的构造器限制：")]),s._v(" "),t("ul",[t("li",[s._v("如果一个类没有定义任何构造器，Java 编译器会默认添加一个空的构造器。")]),s._v(" "),t("li",[s._v("子类的构造器需要调用父类的构造器：\n"),t("ul",[t("li",[s._v("如果父类存在无参构造器，子类会"),t("strong",[s._v("隐式调用")]),s._v("。")]),s._v(" "),t("li",[s._v("如果父类没有无参构造器，子类必须"),t("strong",[s._v("显式调用父类带参构造器")]),s._v("。")])])]),s._v(" "),t("li",[s._v("调用一个构造器时，会优先调用父类构造器，直至 Object。")]),s._v(" "),t("li",[s._v("子类即使无法访问父类私有非静态字段，仍会为父类私有字段分配内存。")])]),s._v(" "),t("blockquote",[t("p",[s._v("NOTE：子类即使无法访问父类私有非静态字段，仍需为其分配内存，这是因为"),t("strong",[s._v("非静态字段")]),s._v("是绑定到类实例的，一个新的实例应该保存一份。")])]),s._v(" "),t("h2",{attrs:{id:"_2-对象头及指针压缩"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-对象头及指针压缩"}},[s._v("#")]),s._v(" 2. 对象头及指针压缩")]),s._v(" "),t("p",[s._v("每个 Java 对象都有一个对象头（Object Header），包含以下两点：")]),s._v(" "),t("ul",[t("li",[s._v("标记字段（mark word）：存储 JVM 有关该对象的运行数据，如哈希码、GC 信息以及锁信息。")]),s._v(" "),t("li",[s._v("类型指针：指向该对象的类。")])]),s._v(" "),t("p",[s._v("在 64 位 JVM 中，标记字段占 64 bit，类型指针占 64 bit，其中类型指针可以通过**指针压缩（ -XX:+UseCompressedOops，默认开启）**来减少内存消耗，类型指针会被压缩成 32 位。")]),s._v(" "),t("p",[s._v("指针压缩结合内存对齐（"),t("code",[s._v("-XX:ObjectAlignmentInBytes")]),s._v("，默认值 8），每个 Java 对象都会被要求从 8N 的内存地址开始分配，压缩指针时，将其右移三位，解压缩时，将其左移三位，再加上一个固定偏移量（JVM 堆内存的起始地址），便能实现 32 bit 寻址 32GB 地址空间的伪 64 位指针了。")]),s._v(" "),t("blockquote",[t("p",[s._v("NOTE：指针压缩只在 4GB 以上，32G 以下生效。")])]),s._v(" "),t("blockquote",[t("p",[s._v("NOTE：可以通过增加 "),t("code",[s._v("-XX:ObjectAlignmentInBytes")]),s._v(" 来提升寻址范围，但同时也会增加对象间填充，达不到节省内存的目的。")])]),s._v(" "),t("blockquote",[t("p",[s._v("NOTE：当一个对象用不到 8N 的内存空间时，会**填充（padding）**到 8N。如果字段不填充，那么就会出现一个对象横跨两个缓存行的现象，导致伪共享。")])]),s._v(" "),t("h2",{attrs:{id:"_3-字段重排序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-字段重排序"}},[s._v("#")]),s._v(" 3. 字段重排序")]),s._v(" "),t("p",[s._v("JVM 会重新分配字段的先后顺序，已达到内存对齐的效果，有三种排列方法（"),t("code",[s._v("-XX:FieldsAllocationStyle")]),s._v("，默认值为 1，将会在 JDK14 移除，并以 1 为固定方式），但都遵循如下两个原则：")]),s._v(" "),t("ol",[t("li",[s._v("如果规定一个字段 C 个字节，那么该字段的偏移量需要对齐至 NC。这里偏移量指的是字段地址与对象的起始地址差值。")]),s._v(" "),t("li",[s._v("子类所继承字段的偏移量，需要与父类对应字段的偏移量保持一致。")])]),s._v(" "),t("ul",[t("li",[s._v("开启指针压缩：子类第一个字段需要对齐至 4N；")]),s._v(" "),t("li",[s._v("关闭指针压缩：子类第一个字段则需要对齐至 8N。")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i；\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 启用压缩指针时，B类的字段分布")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v(" object internals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n OFFSET  SIZE   TYPE DESCRIPTION\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("i                                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("l                                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("l                                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("i                                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loss due "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" the next object alignment"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 关闭压缩指针时，B类的字段分布")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v(" object internals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n OFFSET  SIZE   TYPE DESCRIPTION\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("l\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("i\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("alignment"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("padding gap"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                  \n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("l\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("i\n     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loss due "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" the next object alignment"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("blockquote",[t("p",[s._v("NOTE：字段重排序 mode 1 的排序方式为先父类后子类，先基本类型，再引用类型。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);