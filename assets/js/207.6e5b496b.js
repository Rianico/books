(window.webpackJsonp=window.webpackJsonp||[]).push([[207],{930:function(s,t,a){"use strict";a.r(t);var n=a(70),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"tcp-分段与-ip-分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp-分段与-ip-分片"}},[s._v("#")]),s._v(" TCP 分段与 IP 分片")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/Avator/image-20210527221917583.png",alt:"image-20210527221917583"}})]),s._v(" "),a("p",[s._v("当数据包太大的时候，需要对其进行拆分，其主要发生在传输层（TCP 协议）以及网络层（IP）。")]),s._v(" "),a("p",[s._v("TCP 层拆分数据称为 "),a("strong",[s._v("TPC 分段")]),s._v("，拆分大小取决于 "),a("strong",[s._v("MSS（Maximum Segment Size）")]),s._v("。")]),s._v(" "),a("p",[s._v("IP 层拆分数据称为 "),a("strong",[s._v("IP 分片")]),s._v("，拆分大小取决于 "),a("strong",[s._v("MTU（Maximum Transmit Unit，最大传输单元）")]),s._v("，该参数表示该设备的传输能力大小，不同网络设备的 MTU 也不一样。")]),s._v(" "),a("p",[s._v("MSS 通常受到 MTU 的限制，通常 MSS = MTU - 20（IP Header）- 20（TCP Header）。")]),s._v(" "),a("p",[s._v("不同网络设备的 MTU 往往也不同，网卡就带有 MTU 属性，可以通过 "),a("code",[s._v("ifconfig")]),s._v(" 查看。")]),s._v(" "),a("p",[s._v("不同两端进行通讯时，如果 MTU 不同，MSS 也不同，两端会在各自的报文中携带 MSS 信息，双方以最小的 MSS 为准。")]),s._v(" "),a("p",[a("strong",[s._v("Q：报文 不携带 MSS 信息时 TCP 协议怎么处理这种情况？")])]),s._v(" "),a("p",[s._v("A：报文中的 MSS 信息为可选项，当一端不传 MSS 信息时，则会以 IP 协议的最小重组缓冲区（576 字节）- 20（TCP Header）- 20（IP Header）得到 537 字节作为 MSS 默认值。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/zhxuankun/Image/raw/master/Avator/image-20210527222340392.png",alt:"image-20210527222340392"}})]),s._v(" "),a("p",[a("strong",[s._v("Q：为什么 MTU 通常是 1500？")])]),s._v(" "),a("p",[s._v("A：其实网络传输中是经常发生问题的，越大的包在网络传输中也越容易发生丢包。MTU 的大小还要考虑到传输效率，由于每个数据包都需要额外 20 字节 TCP 头以及 20 字节 IP 头，当 MTU 过小时，有效传输率会非常低，以 300 为例："),a("code",[s._v("TCP payload = 300 - IP Header - TCP Header = 300 - 20 - 20 = 260 byte")]),s._v("，有效传输率为 86%，而 1500 字节大小的 MTU 有效传输率可以到达 96%。")]),s._v(" "),a("p",[a("strong",[s._v("Q：为什么 IP 层会会分片，TCP 层还要分段？")])]),s._v(" "),a("p",[s._v("A：主要是为了避免 TCP 重传时，需要重传的数据包太大，当 TCP 分段后，如果发生丢包重传，那么只需要重传分段后的部分数据，而不用全部重传，因此 TCP 层需要根据 IP 层的 MTU 大小来调节 MSS 大小，尽可能避免在 IP 层分片。")]),s._v(" "),a("p",[s._v("UDP 由于不会进行重传，因此它是不会进行分段的。")]),s._v(" "),a("p",[a("strong",[s._v("Q：IP 层怎么做到不分片？")])]),s._v(" "),a("p",[s._v("A：在现在的 Linux 系统中，"),a("code",[s._v("/proc/sys/net/ipv4/ip_no_pmtu_disc")]),s._v(" 通常设置为 0，意思是开启 PMTU 功能，当网络设备发现某个数据包的 MSS 大于其 MTU，则会检查其 DF 位：")]),s._v(" "),a("ul",[a("li",[s._v("如果为 0，则将其分片传输到下一个路由")]),s._v(" "),a("li",[s._v("如果为 "),a("code",[s._v("1")]),s._v(" ，则丢弃该数据包，并返回一个带有当前 MTU 的 ICMP 数据包，发送端根据 MTU 调整 MSS")])]),s._v(" "),a("p",[s._v("最后附上 tcpdump 的一段输出：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" tcpdump -i lo -Ss0 -n src "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 and dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 and port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9999")]),s._v("\ntcpdump: verbose output suppressed, use -v or -vv "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on lo, link-type EN10MB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":57:53.589623 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1.60560 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1.9999: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1659164645")]),s._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65495")]),s._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mss "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65495")]),s._v(",sackOK,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1793273290")]),s._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",nop,wscale "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":57:53.589722 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1.9999 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1.60560: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("R."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1659164646")]),s._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("参考：")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/VLHCu6b5Anx8HEj_gQZfOg",target:"_blank",rel:"noopener noreferrer"}},[s._v("动图图解！既然IP层会分片，为什么TCP层也还要分段？"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);