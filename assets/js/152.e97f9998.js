(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{875:function(a,s,e){"use strict";e.r(s);var t=e(70),r=Object(t.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h2",{attrs:{id:"hdfs-balancer-使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#hdfs-balancer-使用"}},[a._v("#")]),a._v(" HDFS Balancer 使用")]),a._v(" "),e("p",[a._v("首先检查 Balancer 的状态，以及限制每个节点的带宽，避免打满网络及占满磁盘 I/O：")]),a._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 如果 balancer 启动失败，则表示有正在运行的 balancer 或者之前的 balancer 运行失败了，确定清楚再决定是否删除")]),a._v("\nhdfs dfs -rmr /system/balancer.id\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置 Balancer 内存")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("HADOOP_HEAPSIZE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("12288")]),a._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置每个 datanode 用于 Balancer 的带宽，此处取 256MB/s")]),a._v("\nhdfs dfsadmin -fs hdfs://nzj-cluster-gdyd -setBalancerBandwidth "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("262144000")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br")])]),e("p",[a._v("执行以下命令进行重平衡：")]),a._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("nohup")]),a._v(" hdfs balancer -Ddfs.balancer.moverThreads"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("4000")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n-Ddfs.datanode.balance.max.concurrent.moves"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("48")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n-Ddfs.balancer.max-size-to-move"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("53687091200")]),a._v(" -threshold "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])]),e("p",[a._v("各参数含义如下：")]),a._v(" "),e("ul",[e("li",[e("p",[e("strong",[a._v("dfs.balancer.moverThreads")]),a._v("：用于"),e("strong",[a._v("整个集群")]),a._v("再平衡的线程数，每个 block 的移动都对应一个线程，默认值 2000")])]),a._v(" "),e("li",[e("p",[e("strong",[a._v("dfs.datanode.balance.max.concurrent.moves")]),a._v("：每个 Datanode 可以并发迁移的 Block，取 Datanode 与 Balancer 的最小值。建议 Datanode 配的非常高，Balancer 指定为磁盘数量的整数倍（建议 4x），默认 5。")]),a._v(" "),e("blockquote",[e("p",[a._v("NOTE： 这个参数设置为磁盘整数倍有个好处，就是在带宽固定的前提下，越多 Block 并发传输，可以越细粒度的将压力分摊到多个磁盘上。")])])]),a._v(" "),e("li",[e("p",[e("strong",[a._v("dfs.balancer.max-size-to-move")]),a._v("：每轮平衡的最大数据量，每轮平衡都会选择出一组节点，当网络与磁盘没有那么紧张的时候，可以适当增大该值。")])]),a._v(" "),e("li",[e("p",[e("strong",[a._v("dfs.datanode.balance.bandwidthPerSec=10737418240")]),a._v(" ：设置 Balancer 带宽，上述命令中并未设置，而是通过 "),e("code",[a._v("setBalancerBandwidth")]),a._v(" 命令在 DataNode 级别限速。")])])]),a._v(" "),e("p",[a._v("启动后日志如下：")]),a._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" over-utilized: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" underutilized: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".1.87:1004:DISK, "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".2.74:1004:DISK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: Need to move "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("27.44")]),a._v(" TB to "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" the cluster balanced.\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" SAME_RACK: overUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" underUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" SAME_RACK: overUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" belowAvgUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" SAME_RACK: underUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" aboveAvgUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" ANY_OTHER: overUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" underUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" ANY_OTHER: overUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" belowAvgUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: chooseStorageGroups "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" ANY_OTHER: underUtilized "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" aboveAvgUtilized\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: Decided to move "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" GB bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".3.110:1004:DISK to "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".1.87:1004:DISK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: Decided to move "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("50")]),a._v(" GB bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".3.29:1004:DISK to "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("173.31")]),a._v(".2.74:1004:DISK\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("21")]),a._v("/06/24 "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49:34 INFO balancer.Balancer: Will move "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),a._v(" GB "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" this iteration\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br")])]),e("h2",{attrs:{id:"节点间不平衡的原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#节点间不平衡的原因"}},[a._v("#")]),a._v(" 节点间不平衡的原因")]),a._v(" "),e("p",[a._v("导致 HDFS 节点间数据不平衡的原因较多，通常有以下几种原因：")]),a._v(" "),e("ul",[e("li",[a._v("新增了 DataNode 节点，已有的 Block 块并不会随之迁移到新增节点上")]),a._v(" "),e("li",[a._v("客户端程序的写入行为，有些客户端写入时会倾向于写入特定机器（如 HBase），并且 DataNode 默认也是i采用一个 rack 存储 1 个副本，另一个机架存储 2 个副本的策略")]),a._v(" "),e("li",[a._v("Block 分配策略，HDFS 会从满足写入要求的节点中随机挑选节点进行数据分发，当随机分发不等于数据分布均匀，这是由于随机性挑选会存在短暂的不平衡，并且也没有考虑到 Block 大小。这种策略大部分情况下不存在问题，但在集群容量快耗尽的时候则会开始暴露出来。")])]),a._v(" "),e("h2",{attrs:{id:"磁盘间不平衡的原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#磁盘间不平衡的原因"}},[a._v("#")]),a._v(" 磁盘间不平衡的原因")]),a._v(" "),e("p",[a._v("磁盘之间数据平衡的原因较简单，原因通常有二：")]),a._v(" "),e("ul",[e("li",[a._v("新增磁盘或者原有坏盘替换")]),a._v(" "),e("li",[a._v("存在不同容量大小的磁盘")])]),a._v(" "),e("p",[a._v("解决的方法也有二：")]),a._v(" "),e("ul",[e("li",[a._v("Hadoop 3.0 的 Balancer 支持磁盘间的数据平衡")]),a._v(" "),e("li",[a._v("调整 HDFS 的磁盘写入策略，设置 "),e("code",[a._v("dfs.datanode.fsdataset.volume.choosing.policy")]),a._v(" 为 "),e("code",[a._v("org.apache.hadoop.hdfs.server.datanode.fsdataset.AvailableSpaceVolumeChoosingPolicy")]),a._v("，该策略会基于磁盘用量差距 "),e("code",[a._v("dfs.datanode.available-space-volume-choosing-policy.balanced-space-threshold")]),a._v("（默认 10G）以及权重 "),e("code",[a._v("dfs.datanode.available-space-volume-choosing-policy.balanced-space-preference-fraction")]),a._v("（默认 0.75f）选择需要写入的磁盘。")])]),a._v(" "),e("p",[e("strong",[a._v("Refs：")])]),a._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/data-storage/content/why_hdfs_data_becomes_unbalanced.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Why HDFS data Becomes unbalanced"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/data-storage/content/properties_for_configuring_the_balancer.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Scaling Namespaces and Optimizing Data Storage"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/data-storage/content/cluster_balancing_algorithm.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Cluster balancing algorithm"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://www.expecc.com/post/increasing-hdfs-balancer-performance",target:"_blank",rel:"noopener noreferrer"}},[a._v("Increasing HDFS Balancer Performance"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);