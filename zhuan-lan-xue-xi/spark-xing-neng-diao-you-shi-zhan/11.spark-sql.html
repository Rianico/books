<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>11.Spark SQL | zxk&#39;s book</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/books/Avatar.jpg">
    <meta name="description" content="兴趣使然的备忘库">
    <link rel="preload" href="/books/assets/css/0.styles.253527df.css" as="style"><link rel="preload" href="/books/assets/js/app.a32f3f13.js" as="script"><link rel="preload" href="/books/assets/js/2.f434c5a6.js" as="script"><link rel="preload" href="/books/assets/js/70.6066afd2.js" as="script"><link rel="prefetch" href="/books/assets/js/10.dceff922.js"><link rel="prefetch" href="/books/assets/js/100.e86d25aa.js"><link rel="prefetch" href="/books/assets/js/101.654d6902.js"><link rel="prefetch" href="/books/assets/js/102.6e048095.js"><link rel="prefetch" href="/books/assets/js/103.26ec951e.js"><link rel="prefetch" href="/books/assets/js/104.f413fdc7.js"><link rel="prefetch" href="/books/assets/js/105.0b5517ef.js"><link rel="prefetch" href="/books/assets/js/106.025ff37f.js"><link rel="prefetch" href="/books/assets/js/107.3fd4a2da.js"><link rel="prefetch" href="/books/assets/js/108.c33413cd.js"><link rel="prefetch" href="/books/assets/js/109.69c58c80.js"><link rel="prefetch" href="/books/assets/js/11.f4ff5e98.js"><link rel="prefetch" href="/books/assets/js/110.da669047.js"><link rel="prefetch" href="/books/assets/js/111.27221683.js"><link rel="prefetch" href="/books/assets/js/112.ae80afd9.js"><link rel="prefetch" href="/books/assets/js/113.d17c58d7.js"><link rel="prefetch" href="/books/assets/js/114.26c4f4c1.js"><link rel="prefetch" href="/books/assets/js/115.5491e5a0.js"><link rel="prefetch" href="/books/assets/js/116.a209ce38.js"><link rel="prefetch" href="/books/assets/js/117.c3a25178.js"><link rel="prefetch" href="/books/assets/js/118.b518ee54.js"><link rel="prefetch" href="/books/assets/js/119.e017c898.js"><link rel="prefetch" href="/books/assets/js/12.6dae06d9.js"><link rel="prefetch" href="/books/assets/js/120.1baf3023.js"><link rel="prefetch" href="/books/assets/js/121.71a13847.js"><link rel="prefetch" href="/books/assets/js/122.e058174e.js"><link rel="prefetch" href="/books/assets/js/123.5252e439.js"><link rel="prefetch" href="/books/assets/js/124.e919844e.js"><link rel="prefetch" href="/books/assets/js/125.b4b936d5.js"><link rel="prefetch" href="/books/assets/js/126.0ff2a40d.js"><link rel="prefetch" href="/books/assets/js/127.0e27fcc5.js"><link rel="prefetch" href="/books/assets/js/128.b0d65cea.js"><link rel="prefetch" href="/books/assets/js/129.3f7c4fb2.js"><link rel="prefetch" href="/books/assets/js/13.fd393096.js"><link rel="prefetch" href="/books/assets/js/130.22907055.js"><link rel="prefetch" href="/books/assets/js/131.9b6a7fa1.js"><link rel="prefetch" href="/books/assets/js/132.0141d721.js"><link rel="prefetch" href="/books/assets/js/133.62368e0f.js"><link rel="prefetch" href="/books/assets/js/134.c22be34f.js"><link rel="prefetch" href="/books/assets/js/135.9c30742f.js"><link rel="prefetch" href="/books/assets/js/136.8e29ebad.js"><link rel="prefetch" href="/books/assets/js/137.9bd0b5ba.js"><link rel="prefetch" href="/books/assets/js/138.41a78831.js"><link rel="prefetch" href="/books/assets/js/139.a9376eeb.js"><link rel="prefetch" href="/books/assets/js/14.208ec185.js"><link rel="prefetch" href="/books/assets/js/140.b4f63a2e.js"><link rel="prefetch" href="/books/assets/js/141.6a4888c7.js"><link rel="prefetch" href="/books/assets/js/142.d675963b.js"><link rel="prefetch" href="/books/assets/js/143.501abfa1.js"><link rel="prefetch" href="/books/assets/js/144.fdbc09d5.js"><link rel="prefetch" href="/books/assets/js/145.5bb6218a.js"><link rel="prefetch" href="/books/assets/js/146.b5ba45c3.js"><link rel="prefetch" href="/books/assets/js/147.e0a80eb4.js"><link rel="prefetch" href="/books/assets/js/148.27910016.js"><link rel="prefetch" href="/books/assets/js/149.013194c7.js"><link rel="prefetch" href="/books/assets/js/15.16c314bd.js"><link rel="prefetch" href="/books/assets/js/150.3154742d.js"><link rel="prefetch" href="/books/assets/js/151.78fc6a13.js"><link rel="prefetch" href="/books/assets/js/152.e97f9998.js"><link rel="prefetch" href="/books/assets/js/153.3d92ef79.js"><link rel="prefetch" href="/books/assets/js/154.70c9f7a4.js"><link rel="prefetch" href="/books/assets/js/155.4b924a86.js"><link rel="prefetch" href="/books/assets/js/156.59e71763.js"><link rel="prefetch" href="/books/assets/js/157.8c8cd5ed.js"><link rel="prefetch" href="/books/assets/js/158.739ecc99.js"><link rel="prefetch" href="/books/assets/js/159.5a22b675.js"><link rel="prefetch" href="/books/assets/js/16.d3259c7f.js"><link rel="prefetch" href="/books/assets/js/160.3cc481bb.js"><link rel="prefetch" href="/books/assets/js/161.5cdebd7a.js"><link rel="prefetch" href="/books/assets/js/162.d56ac8d7.js"><link rel="prefetch" href="/books/assets/js/163.a89f22d0.js"><link rel="prefetch" href="/books/assets/js/164.e5e25ddb.js"><link rel="prefetch" href="/books/assets/js/165.406cc447.js"><link rel="prefetch" href="/books/assets/js/166.0f09d541.js"><link rel="prefetch" href="/books/assets/js/167.afee8669.js"><link rel="prefetch" href="/books/assets/js/168.1ae1f6ce.js"><link rel="prefetch" href="/books/assets/js/169.1bfb929c.js"><link rel="prefetch" href="/books/assets/js/17.6ea641b2.js"><link rel="prefetch" href="/books/assets/js/170.0baab93a.js"><link rel="prefetch" href="/books/assets/js/171.65e2e3b6.js"><link rel="prefetch" href="/books/assets/js/172.9a0d4dfd.js"><link rel="prefetch" href="/books/assets/js/173.0690d3f4.js"><link rel="prefetch" href="/books/assets/js/174.52a3d4eb.js"><link rel="prefetch" href="/books/assets/js/175.33e4696f.js"><link rel="prefetch" href="/books/assets/js/176.6c865e6e.js"><link rel="prefetch" href="/books/assets/js/177.1b2a7c93.js"><link rel="prefetch" href="/books/assets/js/178.37c33f6b.js"><link rel="prefetch" href="/books/assets/js/179.ef76c85c.js"><link rel="prefetch" href="/books/assets/js/18.d3146ce7.js"><link rel="prefetch" href="/books/assets/js/180.0e457253.js"><link rel="prefetch" href="/books/assets/js/181.dee67b63.js"><link rel="prefetch" href="/books/assets/js/182.069a8f30.js"><link rel="prefetch" href="/books/assets/js/183.0330f5ce.js"><link rel="prefetch" href="/books/assets/js/184.efd2fde2.js"><link rel="prefetch" href="/books/assets/js/185.7d64b540.js"><link rel="prefetch" href="/books/assets/js/186.82e60409.js"><link rel="prefetch" href="/books/assets/js/187.0d54afe4.js"><link rel="prefetch" href="/books/assets/js/188.81a9510a.js"><link rel="prefetch" href="/books/assets/js/189.279c7f6f.js"><link rel="prefetch" href="/books/assets/js/19.ef650392.js"><link rel="prefetch" href="/books/assets/js/190.e5a7480c.js"><link rel="prefetch" href="/books/assets/js/191.f365d8de.js"><link rel="prefetch" href="/books/assets/js/192.84ea0f67.js"><link rel="prefetch" href="/books/assets/js/193.bb2e01d9.js"><link rel="prefetch" href="/books/assets/js/194.ef6b690e.js"><link rel="prefetch" href="/books/assets/js/195.1ee66346.js"><link rel="prefetch" href="/books/assets/js/196.f34cbe99.js"><link rel="prefetch" href="/books/assets/js/197.cbbdab75.js"><link rel="prefetch" href="/books/assets/js/198.845810f3.js"><link rel="prefetch" href="/books/assets/js/199.5e1147de.js"><link rel="prefetch" href="/books/assets/js/20.21272222.js"><link rel="prefetch" href="/books/assets/js/200.57f5e124.js"><link rel="prefetch" href="/books/assets/js/201.a572c554.js"><link rel="prefetch" href="/books/assets/js/202.5ce9f4a7.js"><link rel="prefetch" href="/books/assets/js/203.bc6f8876.js"><link rel="prefetch" href="/books/assets/js/204.126953e5.js"><link rel="prefetch" href="/books/assets/js/205.9aeca759.js"><link rel="prefetch" href="/books/assets/js/206.ec099168.js"><link rel="prefetch" href="/books/assets/js/207.6e5b496b.js"><link rel="prefetch" href="/books/assets/js/208.6624d24c.js"><link rel="prefetch" href="/books/assets/js/209.3d8ff15b.js"><link rel="prefetch" href="/books/assets/js/21.a956aa7a.js"><link rel="prefetch" href="/books/assets/js/210.6429663d.js"><link rel="prefetch" href="/books/assets/js/211.1d8725a1.js"><link rel="prefetch" href="/books/assets/js/212.d1ff2873.js"><link rel="prefetch" href="/books/assets/js/213.e213f9d1.js"><link rel="prefetch" href="/books/assets/js/214.a9b5c7ec.js"><link rel="prefetch" href="/books/assets/js/215.fd7a5238.js"><link rel="prefetch" href="/books/assets/js/216.96394ddb.js"><link rel="prefetch" href="/books/assets/js/217.3f41d192.js"><link rel="prefetch" href="/books/assets/js/218.622af412.js"><link rel="prefetch" href="/books/assets/js/219.772992ff.js"><link rel="prefetch" href="/books/assets/js/22.fb2ff9d3.js"><link rel="prefetch" href="/books/assets/js/220.99efbde4.js"><link rel="prefetch" href="/books/assets/js/221.9932f6ce.js"><link rel="prefetch" href="/books/assets/js/222.e9c2624f.js"><link rel="prefetch" href="/books/assets/js/223.c87d79a7.js"><link rel="prefetch" href="/books/assets/js/224.6fc0bed5.js"><link rel="prefetch" href="/books/assets/js/225.443418f3.js"><link rel="prefetch" href="/books/assets/js/226.d0e9e921.js"><link rel="prefetch" href="/books/assets/js/227.b29a9627.js"><link rel="prefetch" href="/books/assets/js/228.6b9c5eb3.js"><link rel="prefetch" href="/books/assets/js/229.a2dee41e.js"><link rel="prefetch" href="/books/assets/js/23.77b92b70.js"><link rel="prefetch" href="/books/assets/js/230.b36a47b9.js"><link rel="prefetch" href="/books/assets/js/231.d7a52023.js"><link rel="prefetch" href="/books/assets/js/232.5c445a90.js"><link rel="prefetch" href="/books/assets/js/233.398e8141.js"><link rel="prefetch" href="/books/assets/js/234.86f5ff7b.js"><link rel="prefetch" href="/books/assets/js/235.d8271e43.js"><link rel="prefetch" href="/books/assets/js/236.41b92eb4.js"><link rel="prefetch" href="/books/assets/js/237.4d52bf88.js"><link rel="prefetch" href="/books/assets/js/238.209dd5d8.js"><link rel="prefetch" href="/books/assets/js/239.a977d564.js"><link rel="prefetch" href="/books/assets/js/24.96161161.js"><link rel="prefetch" href="/books/assets/js/240.56008448.js"><link rel="prefetch" href="/books/assets/js/241.95144dec.js"><link rel="prefetch" href="/books/assets/js/242.deacfcf7.js"><link rel="prefetch" href="/books/assets/js/243.6bd3a203.js"><link rel="prefetch" href="/books/assets/js/244.20662085.js"><link rel="prefetch" href="/books/assets/js/245.3079d8db.js"><link rel="prefetch" href="/books/assets/js/246.59cbb76d.js"><link rel="prefetch" href="/books/assets/js/247.dab4d54b.js"><link rel="prefetch" href="/books/assets/js/248.dd78e28c.js"><link rel="prefetch" href="/books/assets/js/249.47cfb0fb.js"><link rel="prefetch" href="/books/assets/js/25.bb622e2d.js"><link rel="prefetch" href="/books/assets/js/250.8b7c06de.js"><link rel="prefetch" href="/books/assets/js/251.90d4bb83.js"><link rel="prefetch" href="/books/assets/js/252.4b70df27.js"><link rel="prefetch" href="/books/assets/js/253.baa34cc9.js"><link rel="prefetch" href="/books/assets/js/254.64c84394.js"><link rel="prefetch" href="/books/assets/js/255.4245dca1.js"><link rel="prefetch" href="/books/assets/js/256.4bd25081.js"><link rel="prefetch" href="/books/assets/js/257.44a180fd.js"><link rel="prefetch" href="/books/assets/js/258.ef8eb1df.js"><link rel="prefetch" href="/books/assets/js/259.ca38bbda.js"><link rel="prefetch" href="/books/assets/js/26.800c4d14.js"><link rel="prefetch" href="/books/assets/js/260.fc42b0a6.js"><link rel="prefetch" href="/books/assets/js/27.be0559b4.js"><link rel="prefetch" href="/books/assets/js/28.cdb01ee8.js"><link rel="prefetch" href="/books/assets/js/29.27c415ce.js"><link rel="prefetch" href="/books/assets/js/3.7dd1ae11.js"><link rel="prefetch" href="/books/assets/js/30.da6f6371.js"><link rel="prefetch" href="/books/assets/js/31.c824c17b.js"><link rel="prefetch" href="/books/assets/js/32.45c04f7c.js"><link rel="prefetch" href="/books/assets/js/33.315cf7d5.js"><link rel="prefetch" href="/books/assets/js/34.b532da2f.js"><link rel="prefetch" href="/books/assets/js/35.0af657d1.js"><link rel="prefetch" href="/books/assets/js/36.2df4655c.js"><link rel="prefetch" href="/books/assets/js/37.a4887720.js"><link rel="prefetch" href="/books/assets/js/38.68a08b9d.js"><link rel="prefetch" href="/books/assets/js/39.bf63d04a.js"><link rel="prefetch" href="/books/assets/js/4.e8102eb5.js"><link rel="prefetch" href="/books/assets/js/40.a3c5cdd1.js"><link rel="prefetch" href="/books/assets/js/41.116ef3fc.js"><link rel="prefetch" href="/books/assets/js/42.f3b8b588.js"><link rel="prefetch" href="/books/assets/js/43.b1d59c70.js"><link rel="prefetch" href="/books/assets/js/44.579ee856.js"><link rel="prefetch" href="/books/assets/js/45.807bba31.js"><link rel="prefetch" href="/books/assets/js/46.db611eda.js"><link rel="prefetch" href="/books/assets/js/47.d4d02273.js"><link rel="prefetch" href="/books/assets/js/48.7f011fb9.js"><link rel="prefetch" href="/books/assets/js/49.3aac265b.js"><link rel="prefetch" href="/books/assets/js/5.638928ae.js"><link rel="prefetch" href="/books/assets/js/50.8b75be66.js"><link rel="prefetch" href="/books/assets/js/51.576e782b.js"><link rel="prefetch" href="/books/assets/js/52.85987e06.js"><link rel="prefetch" href="/books/assets/js/53.6a8c240c.js"><link rel="prefetch" href="/books/assets/js/54.6a97379c.js"><link rel="prefetch" href="/books/assets/js/55.97955477.js"><link rel="prefetch" href="/books/assets/js/56.3d477c83.js"><link rel="prefetch" href="/books/assets/js/57.56aa4dff.js"><link rel="prefetch" href="/books/assets/js/58.833c8652.js"><link rel="prefetch" href="/books/assets/js/59.24ca7ee9.js"><link rel="prefetch" href="/books/assets/js/6.32ee54fa.js"><link rel="prefetch" href="/books/assets/js/60.1fc1c4a2.js"><link rel="prefetch" href="/books/assets/js/61.14b84590.js"><link rel="prefetch" href="/books/assets/js/62.8a2d2de8.js"><link rel="prefetch" href="/books/assets/js/63.0dcfee0b.js"><link rel="prefetch" href="/books/assets/js/64.8c28a59c.js"><link rel="prefetch" href="/books/assets/js/65.6d1ae46c.js"><link rel="prefetch" href="/books/assets/js/66.5a616c98.js"><link rel="prefetch" href="/books/assets/js/67.bead4bdc.js"><link rel="prefetch" href="/books/assets/js/68.1d20f97a.js"><link rel="prefetch" href="/books/assets/js/69.76ec2223.js"><link rel="prefetch" href="/books/assets/js/7.b59836f2.js"><link rel="prefetch" href="/books/assets/js/71.d25994bf.js"><link rel="prefetch" href="/books/assets/js/72.94ab8cdd.js"><link rel="prefetch" href="/books/assets/js/73.6682438b.js"><link rel="prefetch" href="/books/assets/js/74.d8d9aac9.js"><link rel="prefetch" href="/books/assets/js/75.c178891f.js"><link rel="prefetch" href="/books/assets/js/76.2292d907.js"><link rel="prefetch" href="/books/assets/js/77.940c9473.js"><link rel="prefetch" href="/books/assets/js/78.1e9432ad.js"><link rel="prefetch" href="/books/assets/js/79.f548c8c7.js"><link rel="prefetch" href="/books/assets/js/8.c9e4b615.js"><link rel="prefetch" href="/books/assets/js/80.e03d9a9c.js"><link rel="prefetch" href="/books/assets/js/81.222e5797.js"><link rel="prefetch" href="/books/assets/js/82.bea6ed3c.js"><link rel="prefetch" href="/books/assets/js/83.cb05beb1.js"><link rel="prefetch" href="/books/assets/js/84.6e31c3ad.js"><link rel="prefetch" href="/books/assets/js/85.b0ce07ff.js"><link rel="prefetch" href="/books/assets/js/86.ae6fb79f.js"><link rel="prefetch" href="/books/assets/js/87.6863b804.js"><link rel="prefetch" href="/books/assets/js/88.ba149380.js"><link rel="prefetch" href="/books/assets/js/89.343c2068.js"><link rel="prefetch" href="/books/assets/js/9.61e3915f.js"><link rel="prefetch" href="/books/assets/js/90.8f71cab6.js"><link rel="prefetch" href="/books/assets/js/91.6334c0db.js"><link rel="prefetch" href="/books/assets/js/92.8a7e8c1d.js"><link rel="prefetch" href="/books/assets/js/93.bd68832a.js"><link rel="prefetch" href="/books/assets/js/94.4083af3f.js"><link rel="prefetch" href="/books/assets/js/95.775d1cde.js"><link rel="prefetch" href="/books/assets/js/96.e244a8c4.js"><link rel="prefetch" href="/books/assets/js/97.27aa8f2b.js"><link rel="prefetch" href="/books/assets/js/98.9d03fea6.js"><link rel="prefetch" href="/books/assets/js/99.488c24e9.js">
    <link rel="stylesheet" href="/books/assets/css/0.styles.253527df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/books/" class="router-link-active home-link"><img src="/books/Avatar.jpg" alt="zxk's book" class="logo"> <span class="site-name">zxk's book</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          大数据
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程语言
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程基础
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-submenu-selected"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          专栏学习
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          Linux
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/ruan-jian/">
          软件
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/" class="router-link-active">
          Home
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/Rianico/books" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spark性能调优实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/00.-fu-lu.html" title="00.附录" class="sidebar-link">00.附录</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/" aria-current="page" title="介绍" class="sidebar-link">介绍</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/01.-zong-ti-gai-nian.html" title="01.总体概念" class="sidebar-link">01.总体概念</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/02.-shen-ru-li-jierdd.html" title="02.深入理解 RDD" class="sidebar-link">02.深入理解 RDD</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/03.-diao-du-xi-tong.html" title="03.调度系统" class="sidebar-link">03.调度系统</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/04.-cun-chu-xi-tong.html" title="04.存储系统" class="sidebar-link">04.存储系统</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/05.-nei-cun-guan-li.html" title="05.内存管理" class="sidebar-link">05.内存管理</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/06.-ying-yong-kai-fa-yuan-ze.html" title="06.应用开发原则" class="sidebar-link">06.应用开发原则</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/07.-chang-yong-pei-zhi-xiang.html" title="07.常用配置项" class="sidebar-link">07.常用配置项</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/08.shuffle.html" title="08.Shuffle" class="sidebar-link">08.Shuffle</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/09.-guang-bo-bian-liang.html" title="09.广播变量" class="sidebar-link">09.广播变量</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html" title="10.硬件资源的高效利用" class="sidebar-link">10.硬件资源的高效利用</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html" aria-current="page" title="11.Spark SQL" class="active sidebar-link">11.Spark SQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html#_1-spark-rdd-与-spark-sql" title="1. Spark RDD 与 Spark SQL" class="sidebar-link">1. Spark RDD 与 Spark SQL</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html#_2-spark-sql-核心组件" title="2. Spark SQL 核心组件" class="sidebar-link">2. Spark SQL 核心组件</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html#_3-总结" title="3. 总结" class="sidebar-link">3. 总结</a></li></ul></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/12.spark-zhiaqe.html" title="1. AQE 三特性" class="sidebar-link">1. AQE 三特性</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/13.-you-hua-ce-lue.html" title="13. 实战优化" class="sidebar-link">13. 实战优化</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html" title="/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html" class="sidebar-link">/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h2 id="_1-spark-rdd-与-spark-sql"><a href="#_1-spark-rdd-与-spark-sql" class="header-anchor">#</a> 1. Spark RDD 与 Spark SQL</h2> <p>Spark 3.0 中对 Spark SQL 进行了大量的优化更新：</p> <p><img src="https://static001.geekbang.org/resource/image/47/75/479cd67e687a3a7cdc805b55b5bdef75.jpg" alt=""></p> <p>Spark SQL 取代了 Spark Core，成为了新一代的引擎，其他组件都能从中获的收益。</p> <p>Spark RDD 主要存在以下痛点：</p> <ol><li><strong>优化空间有限</strong>，对于 Spark 来说，它可以感知到我们做了 map、filter 等操作，但我们执行的函数操作，对于 Spark 来说是一个黑盒，只能简单的将其分发到各个 Executor 执行</li> <li><strong>数据元信息过少</strong>，Spark 对 RDD 形式的数据集能感知的信息很少，并且 RDD 能存储各种半结构、非结构化的数据，Spark 无法对其进行优化</li></ol> <p>Spark SQL 中的 DataFrame 中所携带的 Schema 可以让 Spark 根据明确的字段类型设计定制化的数据结构（<strong>Tungsten</strong>），从而大幅提升数据的存储和访问效率，同时也可以让 Spark  基于启发式的规则和策略（<strong>Catalyst</strong>），甚至是动态的运行时信息（<strong>AQE</strong>）去优化 DataFrame 的计算过程。</p> <p>Spark Core 能够提供很灵活的操作，但也正因此 Spark 也无法获取关于数据太多的数据，也就无法针对性的做出优化。</p> <h2 id="_2-spark-sql-核心组件"><a href="#_2-spark-sql-核心组件" class="header-anchor">#</a> 2. Spark SQL 核心组件</h2> <h3 id="_2-1-catalyst"><a href="#_2-1-catalyst" class="header-anchor">#</a> 2.1 Catalyst</h3> <p>Spark 会基于 DataFrame 确切的计算逻辑，使用第三方的 SQL 解析器 ANTLR 来生成抽象语法树（AST，Abstract Syntax Tree），节点记录的是<strong>标量算子（如 select、filter）的处理逻辑</strong>，边携带的是数据信息：<strong>关系表和数据列</strong>。</p> <p><img src="https://static001.geekbang.org/resource/image/1c/6f/1c0a5e8c1ccdc5eb6ecc29cc45d3f96f.jpg" alt=""></p> <p>Spark 中的语法树也称为 <code>Unresolved Logical Plan</code>，是 Catalyst 优化的起点，这个阶段中记录的信息仅仅是一些字符串，这些数据来与 Dataframe 中的 DSL 语句，还未跟实际的数据格式对应起来。</p> <p>Catalyst 分两步走：</p> <p><strong>逻辑计划部分</strong>：</p> <ol><li><strong>逻辑计划解析</strong>：结合 DataFrame 中的 Schema 信息，确认计划中的表名、字段名、字段类型是否与实际一致，经过这个步骤转换后，<code>Unresolved Logical Plan</code> 会转为 <code>Analyzed Logical Plan</code>。</li> <li><strong>逻辑计划优化</strong>，基于解析过后的 <code>Analyzed Logical Plan</code>，Catalyst 会利用<strong>启发式的规则</strong>和<strong>执行策略</strong>，最终把逻辑计划转换为优化后的逻辑计划  <code>Optimized Logical Plan</code>。</li></ol> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token operator">==</span> Parsed Logical Plan <span class="token operator">==</span>
Relation<span class="token punctuation">[</span>age#<span class="token number">7L</span><span class="token punctuation">,</span>name#<span class="token number">8</span><span class="token punctuation">]</span> json

<span class="token operator">==</span> Analyzed Logical Plan <span class="token operator">==</span>
age<span class="token operator">:</span> bigint<span class="token punctuation">,</span> name<span class="token operator">:</span> string
Relation<span class="token punctuation">[</span>age#<span class="token number">7L</span><span class="token punctuation">,</span>name#<span class="token number">8</span><span class="token punctuation">]</span> json

<span class="token operator">==</span> Optimized Logical Plan <span class="token operator">==</span>
Relation<span class="token punctuation">[</span>age#<span class="token number">7L</span><span class="token punctuation">,</span>name#<span class="token number">8</span><span class="token punctuation">]</span> json

<span class="token operator">==</span> Physical Plan <span class="token operator">==</span>
FileScan json <span class="token punctuation">[</span>age#<span class="token number">7L</span><span class="token punctuation">,</span>name#<span class="token number">8</span><span class="token punctuation">]</span> Batched<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> DataFilters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Format<span class="token operator">:</span> JSON<span class="token punctuation">,</span> Location<span class="token operator">:</span> InMemoryFileIndex<span class="token punctuation">[</span>file<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>src<span class="token operator">/</span>spark<span class="token operator">-</span><span class="token number">3.1</span><span class="token number">.1</span><span class="token operator">-</span>bin<span class="token operator">-</span>hadoop3<span class="token punctuation">.</span><span class="token number">2</span><span class="token operator">/</span>examples<span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span>resources<span class="token operator">/</span>peopl<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> PartitionFilters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> PushedFilters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ReadSchema<span class="token operator">:</span> struct<span class="token operator">&lt;</span>age<span class="token operator">:</span>bigint<span class="token punctuation">,</span>name<span class="token operator">:</span>string<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://static001.geekbang.org/resource/image/f3/72/f3ffb5fc43ae3c9bca44c1f4f8b7e872.jpg" alt=""></p> <p><strong>物理计划部分</strong>：</p> <ol><li><strong>优化 Spark Plan</strong>：在优化 Spark Plan 的过程中，Catalyst <strong>基于既定的优化策略</strong>（Strategies），把逻辑计划中的关系操作符一一映射成物理操作符，生成 Spark Plan。</li> <li><strong>生成 Physical Plan</strong>：在生成 Physical Plan 过程中，Catalyst 再<strong>基于事先定义的 Preparation Rules</strong>，对 Spark Plan 做进一步的完善、生成可执行的 Physical Plan。</li></ol> <p>可以看出，Catalyst 的优化操作来源于 Dataframe 的开发方式。</p> <p>对于同样一种计算逻辑，实现方式可以有多种，按照不同的顺序对算子做排列组合，我们就可以演化出不同的实现方式。最好的方式是，我们遵循“能省则省、能拖则拖”的开发原则，去选择所有实现方式中最优的那个。</p> <h4 id="_2-1-1-逻辑计划"><a href="#_2-1-1-逻辑计划" class="header-anchor">#</a> 2.1.1 逻辑计划</h4> <p>Catalyst 在 Spark 3.0 版本中，共有 81 条优化规则（Rules），分为 27 组（Batches），不考虑规则的重复性，27 组共有 129 个优化规则，但主要可以分为三大类：</p> <ul><li><strong>谓词下推</strong>，结合列式存储格式的文件注脚（Footer）中的统计信息，能够大幅度减少扫描数据量，降低 I/O 开销
<ul><li>将过滤规则提前到接近数据源的地方，从源头减少扫描量</li> <li>对一些谓词做优化，如 <code>in</code> 替换为 <code>=</code>，多个谓词进行合并等。</li></ul></li> <li><strong>动态裁剪</strong>，扫描数据源的时候，只读取与查询相关的字段，节省 I/O 开销</li> <li><strong>常量替换</strong>，将查询条件中的一些计算替换为常量</li></ul> <p>Catalyst 除了会基于优化规则进行优化外，还会借助 Cache Manager 中记录的信息减少计算成本。</p> <p>Cache Manager 维护了一个 Mapping 映射字段，字典的 Key 值是逻辑计划，Value 是对应的 Cache 元信息。</p> <p>Catalyst 在对逻辑计划进行优化前，会先从 Cache Manager 中查找当前的逻辑计划或者分支是否存在已被记录，如果可以获取到相应信息，则会采用 <strong>InMemoryRelation</strong> 节点替换整个计划或者计划的一部分，充分利用缓存。</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token operator">==</span> Physical Plan <span class="token operator">==</span>
CollectLimit <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">+</span><span class="token operator">-</span> <span class="token operator">*</span> Project <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
   <span class="token operator">+</span><span class="token operator">-</span> InMemoryTableScan <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token operator">+</span><span class="token operator">-</span> InMemoryRelation <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
               <span class="token operator">+</span><span class="token operator">-</span> Scan json  <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Catalyst 逻辑计划优化的类主要是借助 <strong>QueryPlan</strong> 以及 <strong>TreeNode</strong> 实现的，其中 QueryPlan 是 TreeNode 的子类，TreeNode 中有一个叫做 <strong>children</strong> 的字段，类型为 <strong>Seq[TreeNode]</strong>，从而构成了一个树结构，接着借助 <strong>transformDown</strong> 递归函数不断将各个优化规则作用（Apply）于当前节点，之后再作用到 children 中的子节点，直到整棵树的叶子节点。</p> <p>从 Analyzed Logical Plan 到 Optimized Logical Plan 的转化，其实就是从一个 TreeNode 生成另一个 TreeNode 的过程，不断将各组优化规则作用到整棵树，且结构不再变化为止。</p> <p>以 <code>org.apache.spark.sql.catalyst.expressions.Expression</code> 为例：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//Expression的转换</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>catalyst<span class="token punctuation">.</span>expressions</span><span class="token punctuation">.</span>_
<span class="token keyword">val</span> myExpr<span class="token operator">:</span> Expression <span class="token operator">=</span> Multiply<span class="token punctuation">(</span>Subtract<span class="token punctuation">(</span>Literal<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Literal<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Subtract<span class="token punctuation">(</span>Literal<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Literal<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> transformed<span class="token operator">:</span> Expression <span class="token operator">=</span> myExpr transformDown <span class="token punctuation">{</span>
  <span class="token keyword">case</span> BinaryOperator<span class="token punctuation">(</span>l<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> Add<span class="token punctuation">(</span>l<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
  <span class="token keyword">case</span> IntegerLiteral<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token keyword">=&gt;</span> Literal<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">case</span> IntegerLiteral<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">=&gt;</span> Literal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后将 （（6 - 4）*（1 - 9）） 通过自定义规则转化为了 （（1 + 0）+（0 + 1））。</p> <h4 id="_2-1-2-物理计划"><a href="#_2-1-2-物理计划" class="header-anchor">#</a> 2.1.2 物理计划</h4> <p>在逻辑计划优化完成后，物理计划阶段会以优化后的逻辑计划为起点开始生成。</p> <p>首先在优化 Spark Plan 过程中，Catalyst 共有 14 类优化策略：</p> <p><img src="https://static001.geekbang.org/resource/image/51/56/51ca111dfb9ebd60e2443c86e9b0cb56.jpeg" alt=""></p> <p>同逻辑计划优化类似，优化 Spark Plan 阶段也是基于<strong>偏函数</strong>模式，把逻辑计划中的操作符映射为 Spark Plan 中的物理算子，例如 BasicOperators 策略直接把 Project、Filter、Sort 等逻辑操作符平行地映射为物理操作符。BasicOperators 中包含了一个 Expression CodeGen 优化，各个具体实现类都实现了 <code>org.apache.spark.sql.catalyst.expressions.codegen.GeneratePredicate</code> 特质，在出现 WSCG 后，只会生成部分代码，与其他代码组成 WSCG。</p> <p>优化后的逻辑计划，还并未选择具体的 Join 策略，此处以场景使用最广泛，对执行性能影响大最大的 <strong>JoinSelection</strong> 为例，Catalyst 共有以下几种 Join 策略：</p> <p><img src="https://static001.geekbang.org/resource/image/39/fb/39642808b292abb0b5b37ea69bfb19fb.jpeg" alt=""></p> <p>本质上就是来自 2 种数据分发方式（Boradcast 和 Shuffle）与 3 种 Join 机制实现的组合：</p> <p><img src="https://static001.geekbang.org/resource/image/e9/48/e9bf1720ac13289a9e49e0f33a334548.jpg" alt=""></p> <p>Catalyst 会按照性能从高到低依次选择出符合场景的策略，通过两大类条件做决策：</p> <ol><li>条件性信息：
<ul><li>按照 Join 类型（是否等值、连接形式等），来源于查询语句自身</li> <li>内表尺寸，可以来自于 Hive 的 ANALYZE YZE TABLE 语句、Spark 对于 Parquet、ORC 等文件尺寸的预估，甚至是 AQE 的动态统计信息</li></ul></li> <li>指令型信息，也就是 Join Hints</li></ol> <p>在这之后，Spark Plan 就可以决定使用哪种 Join 策略了，接着 Catalyst 需要对 Spark Plan 作进一步转换为 Physical Plan：</p> <p><img src="https://static001.geekbang.org/resource/image/53/fd/534dd788609386c14d9e977866301dfd.jpg" alt=""></p> <p>Spark Plan 转化为 Physical Plan 需要经过几组 Preparation Rules 的规则，对 Spark Plan 进行细节的补充，这几组规则如下：</p> <p><img src="https://static001.geekbang.org/resource/image/18/f7/187a85d53d585c5b3656353e3304fdf7.jpeg" alt=""></p> <p>以 EnsureRequirements 为例，该规则会对执行计划中的每一个操作节点，使用 4 个属性描述数据输入和数据输出的分布状态：</p> <p><img src="https://static001.geekbang.org/resource/image/f8/yf/f8cae1364372a2a8c034a5ab00850yyf.jpeg" alt=""></p> <p>该规则要求子节点的输出数据要满足父节点的输入要求，假设父节点为 SortMergeJoin：</p> <p><img src="https://static001.geekbang.org/resource/image/05/00/05467eecb3c983d4fc4a3db8a0e7e600.jpg" alt=""></p> <p>此时 Project 节点的输出数据，并没有满足 SortMergeJoin 的要求（数据按照 partition 分区及排序），因此 EnsureRequirements 会介入添加必要的操作符，以满足父节点对子节点数据的要求：</p> <p><img src="https://static001.geekbang.org/resource/image/a8/15/a8c45d1d6ecb6a120205252e21b1b715.jpg" alt=""></p> <p>其中 Exchange 表示 Shuffle 操作，Sort 表示排序，满足了 SortMergeJoin 的要求。</p> <p>之后 Spark 通过调用 Physical Plan 的 doExecute 方法，把结构化查询的计算结果，转换成 <strong>RDD[InternalRow]</strong>（InternalRow 为 Tungsten 定制化的二进制数据结构）。</p> <p>以下图的 Physical Plan 为例：</p> <p><img src="https://static001.geekbang.org/resource/image/65/33/656e29b2d25549488087fc1a4af8cd33.png" alt=""></p> <p>可以看到物理计划添加了 Exchange、Sort 节点，Join 策略为 SortMergeJoin，* 表示 Tungsten 的 WSCG，括号里的数字表示 Stage 编号，括号中相同数字的操作，都会被捏合成一份 “手写代码”，由 Tungsten 的 WSCG 完成。</p> <h3 id="_2-2-tungsten"><a href="#_2-2-tungsten" class="header-anchor">#</a> 2.2 Tungsten</h3> <p>在 Catalyst 生成物理计划后，还会交给 Tungsten 继续进行优化，Tungsten 主要从数据存储以及全阶段代码生成两个方面进行优化。</p> <h4 id="_2-2-1-数据存储"><a href="#_2-2-1-数据存储" class="header-anchor">#</a> 2.2.1 数据存储</h4> <p>Tungsten 在数据存储方面，有两个较大的改进，分别是<strong>紧凑的数据格式 Unsafe Row</strong> 以及<strong>内存页管理</strong>。</p> <p>Tungsten 自定义了 Unsafe Row 数据格式，可以以十分高效的方式存储二进制数据，对比 Java 的数据结构实现，<strong>可以节省大量的内存空间以及对象数量</strong>，大大提高了存储效率以及 GC 效率。</p> <p>Tungsten 依赖于 DataFrame 携带的 Schema 信息，根据 offset 以及 length，高效存储数据：</p> <p><img src="https://static001.geekbang.org/resource/image/20/02/20230c764200cfde05dedec1cae6b702.jpg" alt=""></p> <ul><li>对于定长的字段，直接安插到字节数组中</li> <li>对于变长的字段，则会先在 Schema 的相应位置插入偏移地址，再把字段长度以及字段值存储到字节数组后面</li></ul> <p>也就是说，Tungsten 需要知道每一个字段的数据类型及长度，才能做出高效率的存储。</p> <blockquote><p>NOTE：对于复杂类型，Tungsten 则很难入手优化，这也是 Spark SQL 对比 Spark RDD 高效的原因之一。</p></blockquote> <p>对比原来 JVM 存储多个字段值使用 GenericMutableRow 封装一条数据，Array 存储实际的值的方式，JVM 采取的方式主要存在两个问题：</p> <ol><li><strong>存储开销大</strong>，Java 对象存储字段值，往往会有一定的膨胀，如对象头、指针、哈希码等信息。</li> <li><strong>对象数量多</strong>，为了存储字段值，需要多个对象进行辅助，而 Tungsten 则可以一个字节数组存储多个字段值。</li></ol> <p><img src="https://static001.geekbang.org/resource/image/fd/69/fd00cf1364c800659a7d492cd25c6569.jpg" alt=""></p> <p>由此看来，<strong>Tungsten 字节数组的存储方式在消除存储开销的同时，仅用一个数组对象就能轻松完成一条数据的封装，显著降低 GC 压力</strong>。</p> <p>Tungsten 还采用<strong>基于内存页的内存管理来定位数据</strong>，对比起传统的 Java 标准库 HashMap 来看，降低了存储开销和 GC 负担，同时还能提高 CPU 命中率和访问效率。</p> <p>为了统一管理 Off Heap 和 On Heap 内存空间，Tungsten 定义了统一的 128 位内存地址，简称 Tungsten 地址。Tungsten 地址分为两部分：前 64 位预留给 Java Object，后 64 位是偏移地址 Offset，并且 Off Heap 和 On Heap 的寻址方式也不同。</p> <p><img src="https://static001.geekbang.org/resource/image/90/47/904dc1d1846dddffe363e834ce892347.jpg" alt=""></p> <ul><li>Off Heap：Spark 通过 Java Unsafe API 直接管理操作系统内存，不存在 Java Object 的概念，因此前 64 位为 null，后 64 位则用于在堆外空间中直接寻址操作系统的内存空间，直接定位数据。</li> <li>On Heap：Spark 借助一个叫<strong>页表（Page Table）<strong>的</strong>数组结构</strong>来定位数据，页表记录了一个又一个内存页（Memory Page），内存页的前 64 位记录了 Object 在 JVM 中的地址，后 64 位记录了数据在 Object 中的偏移量。Spark 定位数据的过程如下：
<ol><li>通过页表获取 Object 所在位置</li> <li>通过页表获取数据在该 Object 里的偏移量</li></ol></li></ul> <p>页表管理的方式使用 Java 中的 HashMap 也可以实现，但存在两个问题：</p> <ol><li><strong>存储开销和 GC 负担大</strong>，HashMap 中存储真正数据的对象可能只有一半，其余皆为指针、长度等信息。</li> <li><strong>CPU 缓存命中率低</strong>，HashMap 是以数组 + 链表的方式实现的，链表可以利用零散的内存区域，提升内存利用效率，但在进行扫描的时候，这种零散的存储方式会引入大量的随机内存访问，降低 CPU 缓存命中率。</li></ol> <p><img src="https://static001.geekbang.org/resource/image/1b/84/1bc7f9553dfe7yyb51a641f51093c284.jpg" alt=""></p> <p>因此 Tungsten 采用数组 + 内存页的方式实现了 HashMap 对应的功能，内存页存储的则是 Object 引用以及数据偏移量，并且数组存储内存页的方式还可以充分利用 CPU 缓存，提高命中率。</p> <h4 id="_2-2-2-页表实现"><a href="#_2-2-2-页表实现" class="header-anchor">#</a> 2.2.2 页表实现</h4> <p>Tungsten 管理自定义存储结构的实现在 TaskMemoryManager 中，该类使用了页表的思想对内存块进行了统一管理：</p> <p><img src="https://gitee.com/zhxuankun/Image/raw/5aa6cb7f4ef089ce18aae7493031dc2e34d10452/blog/image-20210508142411733.png" alt=""></p> <p>实际存储数据的是一个内存页数组 <code>pageTable</code>，其类型为 <code>MemoryBlock[]</code>，一个内存页 <code>MemoryBlock</code> 可以存储多条数据。</p> <p>外部需要寻址时需要提供一个 64 bit 的地址，其高 13 bit 用于定位内存页数组下标，低 51 bit 为数据在内存块中的 offset。</p> <p>BytesToByteMap 就是使用了页表的一个例子，key 是哈希码, value 为一个用于寻址的 64 bit 地址，该 map 使用了数组结构，同时又能做 Hash 寻址，遇到冲突时采用<strong>开放定址法</strong>解决。</p> <p>通过 Hash 取得内存页地址后，交给 TaskMemoryManager 就能获取到对应内存页。</p> <h4 id="_2-2-3-wscg"><a href="#_2-2-3-wscg" class="header-anchor">#</a> 2.2.3 WSCG</h4> <p><strong>全阶段代码生成（WSCG，Whole Stage Code Generation），指的是基于同一 Stage 内操作符之间的调用关系，生成一份“手写代码”，真正把所有计算融合为一个统一的函数</strong>。</p> <p>相比 DAGScheduler 对同一 Stage 内函数的合并，DAGScheduler 只是简单地对函数进行了嵌套调用，但这样一来会<strong>涉及多次虚函数调用以及内存的随机访问</strong>，降低 CPU 的缓存命中率：</p> <p><img src="https://static001.geekbang.org/resource/image/03/03/03052d8fc98dcf1740ec4a7c29234403.jpg" alt=""></p> <p>在有 WSCG 之前，Spark 只能使用**火山迭代模型（Volcano Iteration Model，简称 VI）**融合函数，VI 模型依托于 AST 语法树，对所有计算统一进行了封装，所有操作符都需要实现 VI 模型的迭代器抽象（如 hasNext、next 方法），之后只要任何一个算子实现了该抽象，即可加入到语法树种参与计算，灵活组合。</p> <p>VI 模型中，语法树每个操作符都需要完成如下步骤：</p> <ol><li>从内存中读取父操作符的输出结果作为输入数据</li> <li>调用 hasNext、next 方法，以操作符逻辑处理数据，如过滤、投影、聚合等等</li> <li>将处理后的结果以统一的标准形式输出到内存，供下游算子消费</li></ol> <p>任意两个操作符之间的交互都会涉及第 1、 2 点，即内存的随机存取和虚函数调用，导致 CPU 利用率低下。</p> <p>WSCG 正是为了消除函数嵌套调用存在的，通过生成手写代码的方式完成：</p> <p><img src="https://static001.geekbang.org/resource/image/53/e7/5389b8bd80748dcc706b1c3c95ddbce7.jpg" alt=""></p> <p>计算逻辑会一次性的应用到数据上，每条指令也是明确的，可以顺序加载到 CPU 寄存器上。</p> <p>Catalyst 生成 Physical Plan 之前，有一条 Preparation Rules，其中一条 <strong>CollapseCodegenStages</strong> 就是将其交给 Tungsten 生成手写代码，分为两个步骤：</p> <ol><li><strong>从父节点到子节点，递归调用 doProduce，生成代码框架</strong></li> <li><strong>从子节点到父节点，递归调用 doConsume，向框架填充每一个操作符的运算逻辑</strong></li></ol> <p><img src="https://static001.geekbang.org/resource/image/68/2d/68cfc6aec121511303ccec179bd4a32d.jpg" alt=""></p> <p>Tungsten 在 Stage 顶端节点添加 <strong>WholeStageCodeGen</strong> 节点，WholeStageCodeGen 节点调用 doExecute 触发代码生成过程：</p> <ol><li>doExecute 递归调用子节点的 doProduce 函数，直到遇到 Stage 边界，并生成手写代码的框架（图中蓝色代码部分）</li> <li>接下来 doProduce 函数会反向递归调用 doConsume 函数，将关系表达式转化为 Java 代码</li></ol> <p>Tungsten 利用 CollapseCodegenStages 规则，通过两层递归调用，把 Spark Plan 加工成了一份 “手写代码”，并将其交付给 DAGScheduler 执行。</p> <p>WSCG 解决了两个核心痛点：</p> <ol><li>操作符之间频繁的虚函数调用</li> <li>操作符之间数据交换引入的内存随机访问</li></ol> <h2 id="_3-总结"><a href="#_3-总结" class="header-anchor">#</a> 3. 总结</h2> <p>Spark SQL  能够基于 DataFrame 简单的标量算子和明确的 Schema 定义，借助 Catalyst 优化器和 Tungsten，有能力在运行时构建起一套端到端的优化机制。这套机制运用启发式的规则与策略，以及运行时的执行信息，将原本次优、甚至是低效的查询计划转换为高效的执行计划，再从字节码层面生成代码，消除函数与函数之间的开销，从而提升端到端的执行性能。</p> <p>https://www.waitingforcode.com/apache-spark-sql/why-code-generation-apache-spark-sql/read</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/1/2021, 8:31:49 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        10.硬件资源的高效利用
      </a></span> <span class="next"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/12.spark-zhiaqe.html">
        1. AQE 三特性
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/books/assets/js/app.a32f3f13.js" defer></script><script src="/books/assets/js/2.f434c5a6.js" defer></script><script src="/books/assets/js/70.6066afd2.js" defer></script>
  </body>
</html>