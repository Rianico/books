<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>10.硬件资源的高效利用 | zxk&#39;s book</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/books/Avatar.jpg">
    <meta name="description" content="兴趣使然的备忘库">
    <link rel="preload" href="/books/assets/css/0.styles.253527df.css" as="style"><link rel="preload" href="/books/assets/js/app.a32f3f13.js" as="script"><link rel="preload" href="/books/assets/js/2.f434c5a6.js" as="script"><link rel="preload" href="/books/assets/js/69.76ec2223.js" as="script"><link rel="prefetch" href="/books/assets/js/10.dceff922.js"><link rel="prefetch" href="/books/assets/js/100.e86d25aa.js"><link rel="prefetch" href="/books/assets/js/101.654d6902.js"><link rel="prefetch" href="/books/assets/js/102.6e048095.js"><link rel="prefetch" href="/books/assets/js/103.26ec951e.js"><link rel="prefetch" href="/books/assets/js/104.f413fdc7.js"><link rel="prefetch" href="/books/assets/js/105.0b5517ef.js"><link rel="prefetch" href="/books/assets/js/106.025ff37f.js"><link rel="prefetch" href="/books/assets/js/107.3fd4a2da.js"><link rel="prefetch" href="/books/assets/js/108.c33413cd.js"><link rel="prefetch" href="/books/assets/js/109.69c58c80.js"><link rel="prefetch" href="/books/assets/js/11.f4ff5e98.js"><link rel="prefetch" href="/books/assets/js/110.da669047.js"><link rel="prefetch" href="/books/assets/js/111.27221683.js"><link rel="prefetch" href="/books/assets/js/112.ae80afd9.js"><link rel="prefetch" href="/books/assets/js/113.d17c58d7.js"><link rel="prefetch" href="/books/assets/js/114.26c4f4c1.js"><link rel="prefetch" href="/books/assets/js/115.5491e5a0.js"><link rel="prefetch" href="/books/assets/js/116.a209ce38.js"><link rel="prefetch" href="/books/assets/js/117.c3a25178.js"><link rel="prefetch" href="/books/assets/js/118.b518ee54.js"><link rel="prefetch" href="/books/assets/js/119.e017c898.js"><link rel="prefetch" href="/books/assets/js/12.6dae06d9.js"><link rel="prefetch" href="/books/assets/js/120.1baf3023.js"><link rel="prefetch" href="/books/assets/js/121.71a13847.js"><link rel="prefetch" href="/books/assets/js/122.e058174e.js"><link rel="prefetch" href="/books/assets/js/123.5252e439.js"><link rel="prefetch" href="/books/assets/js/124.e919844e.js"><link rel="prefetch" href="/books/assets/js/125.b4b936d5.js"><link rel="prefetch" href="/books/assets/js/126.0ff2a40d.js"><link rel="prefetch" href="/books/assets/js/127.0e27fcc5.js"><link rel="prefetch" href="/books/assets/js/128.b0d65cea.js"><link rel="prefetch" href="/books/assets/js/129.3f7c4fb2.js"><link rel="prefetch" href="/books/assets/js/13.fd393096.js"><link rel="prefetch" href="/books/assets/js/130.22907055.js"><link rel="prefetch" href="/books/assets/js/131.9b6a7fa1.js"><link rel="prefetch" href="/books/assets/js/132.0141d721.js"><link rel="prefetch" href="/books/assets/js/133.62368e0f.js"><link rel="prefetch" href="/books/assets/js/134.c22be34f.js"><link rel="prefetch" href="/books/assets/js/135.9c30742f.js"><link rel="prefetch" href="/books/assets/js/136.8e29ebad.js"><link rel="prefetch" href="/books/assets/js/137.9bd0b5ba.js"><link rel="prefetch" href="/books/assets/js/138.41a78831.js"><link rel="prefetch" href="/books/assets/js/139.a9376eeb.js"><link rel="prefetch" href="/books/assets/js/14.208ec185.js"><link rel="prefetch" href="/books/assets/js/140.b4f63a2e.js"><link rel="prefetch" href="/books/assets/js/141.6a4888c7.js"><link rel="prefetch" href="/books/assets/js/142.d675963b.js"><link rel="prefetch" href="/books/assets/js/143.501abfa1.js"><link rel="prefetch" href="/books/assets/js/144.fdbc09d5.js"><link rel="prefetch" href="/books/assets/js/145.5bb6218a.js"><link rel="prefetch" href="/books/assets/js/146.b5ba45c3.js"><link rel="prefetch" href="/books/assets/js/147.e0a80eb4.js"><link rel="prefetch" href="/books/assets/js/148.27910016.js"><link rel="prefetch" href="/books/assets/js/149.013194c7.js"><link rel="prefetch" href="/books/assets/js/15.16c314bd.js"><link rel="prefetch" href="/books/assets/js/150.3154742d.js"><link rel="prefetch" href="/books/assets/js/151.78fc6a13.js"><link rel="prefetch" href="/books/assets/js/152.e97f9998.js"><link rel="prefetch" href="/books/assets/js/153.3d92ef79.js"><link rel="prefetch" href="/books/assets/js/154.70c9f7a4.js"><link rel="prefetch" href="/books/assets/js/155.4b924a86.js"><link rel="prefetch" href="/books/assets/js/156.59e71763.js"><link rel="prefetch" href="/books/assets/js/157.8c8cd5ed.js"><link rel="prefetch" href="/books/assets/js/158.739ecc99.js"><link rel="prefetch" href="/books/assets/js/159.5a22b675.js"><link rel="prefetch" href="/books/assets/js/16.d3259c7f.js"><link rel="prefetch" href="/books/assets/js/160.3cc481bb.js"><link rel="prefetch" href="/books/assets/js/161.5cdebd7a.js"><link rel="prefetch" href="/books/assets/js/162.d56ac8d7.js"><link rel="prefetch" href="/books/assets/js/163.a89f22d0.js"><link rel="prefetch" href="/books/assets/js/164.e5e25ddb.js"><link rel="prefetch" href="/books/assets/js/165.406cc447.js"><link rel="prefetch" href="/books/assets/js/166.0f09d541.js"><link rel="prefetch" href="/books/assets/js/167.afee8669.js"><link rel="prefetch" href="/books/assets/js/168.1ae1f6ce.js"><link rel="prefetch" href="/books/assets/js/169.1bfb929c.js"><link rel="prefetch" href="/books/assets/js/17.6ea641b2.js"><link rel="prefetch" href="/books/assets/js/170.0baab93a.js"><link rel="prefetch" href="/books/assets/js/171.65e2e3b6.js"><link rel="prefetch" href="/books/assets/js/172.9a0d4dfd.js"><link rel="prefetch" href="/books/assets/js/173.0690d3f4.js"><link rel="prefetch" href="/books/assets/js/174.52a3d4eb.js"><link rel="prefetch" href="/books/assets/js/175.33e4696f.js"><link rel="prefetch" href="/books/assets/js/176.6c865e6e.js"><link rel="prefetch" href="/books/assets/js/177.1b2a7c93.js"><link rel="prefetch" href="/books/assets/js/178.37c33f6b.js"><link rel="prefetch" href="/books/assets/js/179.ef76c85c.js"><link rel="prefetch" href="/books/assets/js/18.d3146ce7.js"><link rel="prefetch" href="/books/assets/js/180.0e457253.js"><link rel="prefetch" href="/books/assets/js/181.dee67b63.js"><link rel="prefetch" href="/books/assets/js/182.069a8f30.js"><link rel="prefetch" href="/books/assets/js/183.0330f5ce.js"><link rel="prefetch" href="/books/assets/js/184.efd2fde2.js"><link rel="prefetch" href="/books/assets/js/185.7d64b540.js"><link rel="prefetch" href="/books/assets/js/186.82e60409.js"><link rel="prefetch" href="/books/assets/js/187.0d54afe4.js"><link rel="prefetch" href="/books/assets/js/188.81a9510a.js"><link rel="prefetch" href="/books/assets/js/189.279c7f6f.js"><link rel="prefetch" href="/books/assets/js/19.ef650392.js"><link rel="prefetch" href="/books/assets/js/190.e5a7480c.js"><link rel="prefetch" href="/books/assets/js/191.f365d8de.js"><link rel="prefetch" href="/books/assets/js/192.84ea0f67.js"><link rel="prefetch" href="/books/assets/js/193.bb2e01d9.js"><link rel="prefetch" href="/books/assets/js/194.ef6b690e.js"><link rel="prefetch" href="/books/assets/js/195.1ee66346.js"><link rel="prefetch" href="/books/assets/js/196.f34cbe99.js"><link rel="prefetch" href="/books/assets/js/197.cbbdab75.js"><link rel="prefetch" href="/books/assets/js/198.845810f3.js"><link rel="prefetch" href="/books/assets/js/199.5e1147de.js"><link rel="prefetch" href="/books/assets/js/20.21272222.js"><link rel="prefetch" href="/books/assets/js/200.57f5e124.js"><link rel="prefetch" href="/books/assets/js/201.a572c554.js"><link rel="prefetch" href="/books/assets/js/202.5ce9f4a7.js"><link rel="prefetch" href="/books/assets/js/203.bc6f8876.js"><link rel="prefetch" href="/books/assets/js/204.126953e5.js"><link rel="prefetch" href="/books/assets/js/205.9aeca759.js"><link rel="prefetch" href="/books/assets/js/206.ec099168.js"><link rel="prefetch" href="/books/assets/js/207.6e5b496b.js"><link rel="prefetch" href="/books/assets/js/208.6624d24c.js"><link rel="prefetch" href="/books/assets/js/209.3d8ff15b.js"><link rel="prefetch" href="/books/assets/js/21.a956aa7a.js"><link rel="prefetch" href="/books/assets/js/210.6429663d.js"><link rel="prefetch" href="/books/assets/js/211.1d8725a1.js"><link rel="prefetch" href="/books/assets/js/212.d1ff2873.js"><link rel="prefetch" href="/books/assets/js/213.e213f9d1.js"><link rel="prefetch" href="/books/assets/js/214.a9b5c7ec.js"><link rel="prefetch" href="/books/assets/js/215.fd7a5238.js"><link rel="prefetch" href="/books/assets/js/216.96394ddb.js"><link rel="prefetch" href="/books/assets/js/217.3f41d192.js"><link rel="prefetch" href="/books/assets/js/218.622af412.js"><link rel="prefetch" href="/books/assets/js/219.772992ff.js"><link rel="prefetch" href="/books/assets/js/22.fb2ff9d3.js"><link rel="prefetch" href="/books/assets/js/220.99efbde4.js"><link rel="prefetch" href="/books/assets/js/221.9932f6ce.js"><link rel="prefetch" href="/books/assets/js/222.e9c2624f.js"><link rel="prefetch" href="/books/assets/js/223.c87d79a7.js"><link rel="prefetch" href="/books/assets/js/224.6fc0bed5.js"><link rel="prefetch" href="/books/assets/js/225.443418f3.js"><link rel="prefetch" href="/books/assets/js/226.d0e9e921.js"><link rel="prefetch" href="/books/assets/js/227.b29a9627.js"><link rel="prefetch" href="/books/assets/js/228.6b9c5eb3.js"><link rel="prefetch" href="/books/assets/js/229.a2dee41e.js"><link rel="prefetch" href="/books/assets/js/23.77b92b70.js"><link rel="prefetch" href="/books/assets/js/230.b36a47b9.js"><link rel="prefetch" href="/books/assets/js/231.d7a52023.js"><link rel="prefetch" href="/books/assets/js/232.5c445a90.js"><link rel="prefetch" href="/books/assets/js/233.398e8141.js"><link rel="prefetch" href="/books/assets/js/234.86f5ff7b.js"><link rel="prefetch" href="/books/assets/js/235.d8271e43.js"><link rel="prefetch" href="/books/assets/js/236.41b92eb4.js"><link rel="prefetch" href="/books/assets/js/237.4d52bf88.js"><link rel="prefetch" href="/books/assets/js/238.209dd5d8.js"><link rel="prefetch" href="/books/assets/js/239.a977d564.js"><link rel="prefetch" href="/books/assets/js/24.96161161.js"><link rel="prefetch" href="/books/assets/js/240.56008448.js"><link rel="prefetch" href="/books/assets/js/241.95144dec.js"><link rel="prefetch" href="/books/assets/js/242.deacfcf7.js"><link rel="prefetch" href="/books/assets/js/243.6bd3a203.js"><link rel="prefetch" href="/books/assets/js/244.20662085.js"><link rel="prefetch" href="/books/assets/js/245.3079d8db.js"><link rel="prefetch" href="/books/assets/js/246.59cbb76d.js"><link rel="prefetch" href="/books/assets/js/247.dab4d54b.js"><link rel="prefetch" href="/books/assets/js/248.dd78e28c.js"><link rel="prefetch" href="/books/assets/js/249.47cfb0fb.js"><link rel="prefetch" href="/books/assets/js/25.bb622e2d.js"><link rel="prefetch" href="/books/assets/js/250.8b7c06de.js"><link rel="prefetch" href="/books/assets/js/251.90d4bb83.js"><link rel="prefetch" href="/books/assets/js/252.4b70df27.js"><link rel="prefetch" href="/books/assets/js/253.baa34cc9.js"><link rel="prefetch" href="/books/assets/js/254.64c84394.js"><link rel="prefetch" href="/books/assets/js/255.4245dca1.js"><link rel="prefetch" href="/books/assets/js/256.4bd25081.js"><link rel="prefetch" href="/books/assets/js/257.44a180fd.js"><link rel="prefetch" href="/books/assets/js/258.ef8eb1df.js"><link rel="prefetch" href="/books/assets/js/259.ca38bbda.js"><link rel="prefetch" href="/books/assets/js/26.800c4d14.js"><link rel="prefetch" href="/books/assets/js/260.fc42b0a6.js"><link rel="prefetch" href="/books/assets/js/27.be0559b4.js"><link rel="prefetch" href="/books/assets/js/28.cdb01ee8.js"><link rel="prefetch" href="/books/assets/js/29.27c415ce.js"><link rel="prefetch" href="/books/assets/js/3.7dd1ae11.js"><link rel="prefetch" href="/books/assets/js/30.da6f6371.js"><link rel="prefetch" href="/books/assets/js/31.c824c17b.js"><link rel="prefetch" href="/books/assets/js/32.45c04f7c.js"><link rel="prefetch" href="/books/assets/js/33.315cf7d5.js"><link rel="prefetch" href="/books/assets/js/34.b532da2f.js"><link rel="prefetch" href="/books/assets/js/35.0af657d1.js"><link rel="prefetch" href="/books/assets/js/36.2df4655c.js"><link rel="prefetch" href="/books/assets/js/37.a4887720.js"><link rel="prefetch" href="/books/assets/js/38.68a08b9d.js"><link rel="prefetch" href="/books/assets/js/39.bf63d04a.js"><link rel="prefetch" href="/books/assets/js/4.e8102eb5.js"><link rel="prefetch" href="/books/assets/js/40.a3c5cdd1.js"><link rel="prefetch" href="/books/assets/js/41.116ef3fc.js"><link rel="prefetch" href="/books/assets/js/42.f3b8b588.js"><link rel="prefetch" href="/books/assets/js/43.b1d59c70.js"><link rel="prefetch" href="/books/assets/js/44.579ee856.js"><link rel="prefetch" href="/books/assets/js/45.807bba31.js"><link rel="prefetch" href="/books/assets/js/46.db611eda.js"><link rel="prefetch" href="/books/assets/js/47.d4d02273.js"><link rel="prefetch" href="/books/assets/js/48.7f011fb9.js"><link rel="prefetch" href="/books/assets/js/49.3aac265b.js"><link rel="prefetch" href="/books/assets/js/5.638928ae.js"><link rel="prefetch" href="/books/assets/js/50.8b75be66.js"><link rel="prefetch" href="/books/assets/js/51.576e782b.js"><link rel="prefetch" href="/books/assets/js/52.85987e06.js"><link rel="prefetch" href="/books/assets/js/53.6a8c240c.js"><link rel="prefetch" href="/books/assets/js/54.6a97379c.js"><link rel="prefetch" href="/books/assets/js/55.97955477.js"><link rel="prefetch" href="/books/assets/js/56.3d477c83.js"><link rel="prefetch" href="/books/assets/js/57.56aa4dff.js"><link rel="prefetch" href="/books/assets/js/58.833c8652.js"><link rel="prefetch" href="/books/assets/js/59.24ca7ee9.js"><link rel="prefetch" href="/books/assets/js/6.32ee54fa.js"><link rel="prefetch" href="/books/assets/js/60.1fc1c4a2.js"><link rel="prefetch" href="/books/assets/js/61.14b84590.js"><link rel="prefetch" href="/books/assets/js/62.8a2d2de8.js"><link rel="prefetch" href="/books/assets/js/63.0dcfee0b.js"><link rel="prefetch" href="/books/assets/js/64.8c28a59c.js"><link rel="prefetch" href="/books/assets/js/65.6d1ae46c.js"><link rel="prefetch" href="/books/assets/js/66.5a616c98.js"><link rel="prefetch" href="/books/assets/js/67.bead4bdc.js"><link rel="prefetch" href="/books/assets/js/68.1d20f97a.js"><link rel="prefetch" href="/books/assets/js/7.b59836f2.js"><link rel="prefetch" href="/books/assets/js/70.6066afd2.js"><link rel="prefetch" href="/books/assets/js/71.d25994bf.js"><link rel="prefetch" href="/books/assets/js/72.94ab8cdd.js"><link rel="prefetch" href="/books/assets/js/73.6682438b.js"><link rel="prefetch" href="/books/assets/js/74.d8d9aac9.js"><link rel="prefetch" href="/books/assets/js/75.c178891f.js"><link rel="prefetch" href="/books/assets/js/76.2292d907.js"><link rel="prefetch" href="/books/assets/js/77.940c9473.js"><link rel="prefetch" href="/books/assets/js/78.1e9432ad.js"><link rel="prefetch" href="/books/assets/js/79.f548c8c7.js"><link rel="prefetch" href="/books/assets/js/8.c9e4b615.js"><link rel="prefetch" href="/books/assets/js/80.e03d9a9c.js"><link rel="prefetch" href="/books/assets/js/81.222e5797.js"><link rel="prefetch" href="/books/assets/js/82.bea6ed3c.js"><link rel="prefetch" href="/books/assets/js/83.cb05beb1.js"><link rel="prefetch" href="/books/assets/js/84.6e31c3ad.js"><link rel="prefetch" href="/books/assets/js/85.b0ce07ff.js"><link rel="prefetch" href="/books/assets/js/86.ae6fb79f.js"><link rel="prefetch" href="/books/assets/js/87.6863b804.js"><link rel="prefetch" href="/books/assets/js/88.ba149380.js"><link rel="prefetch" href="/books/assets/js/89.343c2068.js"><link rel="prefetch" href="/books/assets/js/9.61e3915f.js"><link rel="prefetch" href="/books/assets/js/90.8f71cab6.js"><link rel="prefetch" href="/books/assets/js/91.6334c0db.js"><link rel="prefetch" href="/books/assets/js/92.8a7e8c1d.js"><link rel="prefetch" href="/books/assets/js/93.bd68832a.js"><link rel="prefetch" href="/books/assets/js/94.4083af3f.js"><link rel="prefetch" href="/books/assets/js/95.775d1cde.js"><link rel="prefetch" href="/books/assets/js/96.e244a8c4.js"><link rel="prefetch" href="/books/assets/js/97.27aa8f2b.js"><link rel="prefetch" href="/books/assets/js/98.9d03fea6.js"><link rel="prefetch" href="/books/assets/js/99.488c24e9.js">
    <link rel="stylesheet" href="/books/assets/css/0.styles.253527df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/books/" class="router-link-active home-link"><img src="/books/Avatar.jpg" alt="zxk's book" class="logo"> <span class="site-name">zxk's book</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          大数据
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程语言
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程基础
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-submenu-selected"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          专栏学习
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          Linux
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/ruan-jian/">
          软件
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/" class="router-link-active">
          Home
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/Rianico/books" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spark性能调优实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/00.-fu-lu.html" title="00.附录" class="sidebar-link">00.附录</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/" aria-current="page" title="介绍" class="sidebar-link">介绍</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/01.-zong-ti-gai-nian.html" title="01.总体概念" class="sidebar-link">01.总体概念</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/02.-shen-ru-li-jierdd.html" title="02.深入理解 RDD" class="sidebar-link">02.深入理解 RDD</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/03.-diao-du-xi-tong.html" title="03.调度系统" class="sidebar-link">03.调度系统</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/04.-cun-chu-xi-tong.html" title="04.存储系统" class="sidebar-link">04.存储系统</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/05.-nei-cun-guan-li.html" title="05.内存管理" class="sidebar-link">05.内存管理</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/06.-ying-yong-kai-fa-yuan-ze.html" title="06.应用开发原则" class="sidebar-link">06.应用开发原则</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/07.-chang-yong-pei-zhi-xiang.html" title="07.常用配置项" class="sidebar-link">07.常用配置项</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/08.shuffle.html" title="08.Shuffle" class="sidebar-link">08.Shuffle</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/09.-guang-bo-bian-liang.html" title="09.广播变量" class="sidebar-link">09.广播变量</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html" aria-current="page" title="10.硬件资源的高效利用" class="active sidebar-link">10.硬件资源的高效利用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html#前言" title="前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html#_1-cpu" title="1. CPU" class="sidebar-link">1. CPU</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html#_2-内存" title="2. 内存" class="sidebar-link">2. 内存</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html#_3-磁盘" title="3. 磁盘" class="sidebar-link">3. 磁盘</a></li><li class="sidebar-sub-header"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/10.-ying-jian-zi-yuan-de-gao-xiao-li-yong.html#_4-总结" title="4. 总结" class="sidebar-link">4. 总结</a></li></ul></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html" title="11.Spark SQL" class="sidebar-link">11.Spark SQL</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/12.spark-zhiaqe.html" title="1. AQE 三特性" class="sidebar-link">1. AQE 三特性</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/13.-you-hua-ce-lue.html" title="13. 实战优化" class="sidebar-link">13. 实战优化</a></li><li><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html" title="/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html" class="sidebar-link">/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/14.-ying-yong-kai-fa.html</a></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Spark 的资源调整，本质上就是平衡<strong>并行度、并发度、内存空间</strong>三者之间的关系。</p> <h2 id="_1-cpu"><a href="#_1-cpu" class="header-anchor">#</a> 1. CPU</h2> <h3 id="_1-1-spark-中的-cpu"><a href="#_1-1-spark-中的-cpu" class="header-anchor">#</a> 1.1 Spark 中的 CPU</h3> <p>在 RDD 存储到内存中进行展开之前，RDD 实际占用的还是 Execution Memory，因此 <strong>CPU 与内存的平衡，其实就是 CPU 与执行内存之间的协同与配比</strong>。</p> <p>协调 CPU 与 Execution Memory 的使用分为三类参数，分别控制着<strong>并行度</strong>、<strong>执行内存大小</strong>和<strong>集群的并行计算能力</strong>。</p> <p>并行度明确了数据的划分，并行度越高，数据的分片（partition）越多，可以通过两个参数来设置：</p> <ul><li><strong>spark.default.parallelism</strong>：指定了 RDD 的默认并行度</li> <li><strong>spark.sql.shuffle.partitions</strong>：指定了 Spark SQL 开发框架下，Reduce 阶段默认的并行度。</li></ul> <p>并发度，指一个 Executor 中用于执行 task 的线程数，由 <code>spark.executor.cores</code> 指定，<code>spark.task.cpus</code> 则指定了每个 task 使用的线程数，通常不需要调整，默认为 1。所以并发度基本由 <strong>spark.executor.cores</strong> 进行控制。</p> <p>对于一个 Executor 来说，一个线程同一时间只能计算一个 task。因此，在<strong>运行时</strong>线程、task、partition 是一一对应的。</p> <p>Executor 在接收到 Driver 端分发的任务后，会将其封装为 <code>TaskRunner</code>，交给线程池处理，处理的线程会像 Executor Memory 申请内存，然后开始执行任务。</p> <p>假设有 N 个线程，每个线程可以申请到的内存空间，在 （Execution Memory / N） ~ （Execution Memory / 2N）之间。</p> <h3 id="_1-2-cpu-低效的原因"><a href="#_1-2-cpu-低效的原因" class="header-anchor">#</a> 1.2 CPU 低效的原因</h3> <p>主要原因分为线程挂起与调度开销。</p> <h4 id="_1-2-1-线程挂起"><a href="#_1-2-1-线程挂起" class="header-anchor">#</a> 1.2.1 线程挂起</h4> <p>Spark 使用 HashMap 记录每个线程消耗的内存大小，在给定执行内存总量 M 和线程总数 N 的情况下，，确保每个线程占用的执行内存不超过 M / N。</p> <p>在一些极端情况下，有些线程连 M / 2N 甚至一点内存都申请不到导致挂起，主要原因有以下几个：</p> <ul><li><strong>动态变化的执行内存总量 M</strong>，Storage Memory 与 Execution Memory 是可以相互转化的。</li> <li><strong>动态变化的实际并发度 N~</strong>，当 Executor 刚开始执行 task 时，并不是可以立刻到达最大并发度 N 的，影响的因素有很多，如 task 的先后到来，task 之间的依赖等。但随着任务执行以及调度的推进，N~ 会迅速的趋近于 N，CPU 线程挂起和内存分配也会得到改善。</li> <li>分布式数据集的数据分布，每个数据分片数据量的大小决定了每个 task 需要申请多少内存。</li></ul> <h4 id="_1-2-2-调度开销"><a href="#_1-2-2-调度开销" class="header-anchor">#</a> 1.2.2 调度开销</h4> <p>Spark 可以通过增加并行度，来减少每个数据分片的数据量大小，但也会带来一个副作用：<strong>调度开销骤增</strong>。</p> <p>Driver 会将每个任务封装为 <strong>TaskDescription</strong>，然后分发给各个 Executor。TaskDescription 包含着与任务运行有关的所有信息，如任务 ID、尝试 ID、要处理的数据分片 ID、开发者添加的本地文件和 Jar 包、任务属性、序列化的任务代码等等。Executor 接收到 TaskDescription 之后，首先需要对 TaskDescription 反序列化才能读取任务信息，然后将任务代码再反序列化得到可执行代码，最后再结合其他任务信息创建 TaskRunner。</p> <p>当数据过于分散，分布式任务数量会大幅增加，但每个任务需要处理的数据量却少之又少，CPU 花在数据处理以及任务调度上的开销几乎相同。</p> <h4 id="_1-2-3-优化-cpu-利用率"><a href="#_1-2-3-优化-cpu-利用率" class="header-anchor">#</a> 1.2.3 优化 CPU 利用率</h4> <p>提高 CPU 的利用率，需要设置好一个合适的并行度，需要综合多个方面的考量，并没有一个绝对的设置值。</p> <p>一种常用的手段是先确定每个 Executor 的执行内存总量 M 与并发度 N，去计算一个能够让数据分片平均大小在 （M/2N, M/N）之间的并行度。或者反过来，在确定并行度的大小后调整 Executor 的内存大小。</p> <p><img src="https://static001.geekbang.org/resource/image/4a/ce/4a5dc54813346924ec5611f6d1fa8fce.jpg" alt=""></p> <h2 id="_2-内存"><a href="#_2-内存" class="header-anchor">#</a> 2. 内存</h2> <h3 id="_2-1-内存区域的规划"><a href="#_2-1-内存区域的规划" class="header-anchor">#</a> 2.1 内存区域的规划</h3> <p>用户可以管理的内存有 User Memory、Storage Memory、Execution Memory 三块，需要衡量好三者的比例以充分利用内存。</p> <p>User Memory 主要用于存放用户的自定义数据结构，如果经常分发一个不变的对象到各个 task， Spark 无法识别出该变量是否为同一个，会耗费 User Memory 去存储多个（task 数量）相同内容的变量。这种场景下，通常可以使用广播变量进行优化。</p> <p>使用广播变量后，该变量会存储到 Storage Memory 中，并且一个 Executor 只存储一个，而不会受到 task 数量的影响。</p> <p>为了充分使用 Spark 的内存，需要平衡好不同区域内的消耗占比，具体分为两步：</p> <ol><li>预估内存占用，假设共有 #N 个 Executor：
<ul><li>计算 User Memory 的内存消耗，汇总应用中包含的自定义数据结构，预估其大小并乘以 Executor 的并发度得到该区域的内存消耗 <strong>#User</strong></li> <li>计算 Storage Memory 的内存消耗，每个 Executor 中 Storage Memory 区域的内存消耗为广播变量 + RDD 缓存，即 <strong>#Storage = #bc + #cache / #Executors</strong></li> <li>计算 Execution Memory 的内存消耗，可以根据数据分片的大小得出，即 <strong>#Execution Memory = #threads * #dataset / #partitions</strong></li></ul></li> <li>调整内存配置，根据上述三者的估算大小，对 <code>spark.memory.fraction</code> 和 <code>spark.memory.storageFraction</code></li></ol> <p><strong>内存规划要达到的效果和目的，是确保不同内存区域的占比与不同类型的数据消耗保持一致，从而实现内存利用率的最大化</strong>。</p> <h3 id="_2-2-缓存"><a href="#_2-2-缓存" class="header-anchor">#</a> 2.2 缓存</h3> <p>RDD 的缓存需要关注三点：</p> <ul><li><p><strong>存的存储级别</strong>：限定了数据缓存的存储介质（如内存、磁盘等）、存储形式（序列化、费序列化）以及副本数量（默认 1）。</p> <p><img src="https://static001.geekbang.org/resource/image/4e/e2/4ecdfd4b62b1c6e151d029c38088yye2.jpeg" alt=""></p></li> <li><p><strong>缓存的计算过程</strong>：将 RDD 以 Block Iterator 形式展开，暂存到 ValueHolder 中，然后转化为 MemoryEntry，接着存储到一个 key 为 BlockId 的 LinkedHashMap 中。</p></li> <li><p><strong>缓存的销毁过程</strong>：缓存数据以主动或是被动的方式，被驱逐出内存或是磁盘的过程。</p></li></ul> <p>Spark 使用一个 LinkedHashMap 来记录 RDD 在缓存中的对应信息，在尝试缓存 RDD 却发现内存不足时，会根据 LRU 算法，从头开始扫描 Map 挑选可淘汰的 MemoryEntry，同属于当前 RDD 的 MemoryEntry 则会跳过。当可淘汰的 MemoryEntry 大小超过需要缓存的 RDD 大小，则会淘汰掉那部分 MemoryEntry。</p> <p><img src="https://static001.geekbang.org/resource/image/b7/14/b73308328ef549579d02c72afb2ab114.jpg" alt=""></p> <h3 id="_2-3-缓存的时机"><a href="#_2-3-缓存的时机" class="header-anchor">#</a> 2.3 缓存的时机</h3> <p>对 RDD/DataFrame/Dataset 进行缓存，需要遵循以下 2 条基本原则：</p> <ul><li>如果 RDD/DataFrame/Dataset 在应用中的引用次数为 1，就坚决不使用 Cache</li> <li><strong>如果引用次数大于 1，且运行成本占比超过 30%，应当考虑启用 Cache</strong></li></ul> <p>运行成本占比，<strong>指的是计算某个分布式数据集所消耗的总时间与作业执行时间的比值</strong>。</p> <p>例如，一个作业的执行时间规定为 1 小时，如果某个 DataFrame 需要用到多次，且生成该 DataFrame 需要耗时 12 分钟，那么该 DataFrame 的运行成本占比就是 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="16.717ex" height="2.262ex" viewBox="0 -750 7389 1000" style="vertical-align:-0.566ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500, 0)"></path></g><g data-mml-node="mo" transform="translate(1222.2, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mn" transform="translate(2222.4, 0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(2722.4, 0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mn" transform="translate(3222.4, 0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500, 0)"></path></g><g data-mml-node="mo" transform="translate(4500.2, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(5556, 0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500, 0)"></path></g><g data-mml-node="mi" transform="translate(6556, 0)"><path data-c="25" d="M465 605Q428 605 394 614T340 632T319 641Q332 608 332 548Q332 458 293 403T202 347Q145 347 101 402T56 548Q56 637 101 693T202 750Q241 750 272 719Q359 642 464 642Q580 642 650 732Q662 748 668 749Q670 750 673 750Q682 750 688 743T693 726Q178 -47 170 -52Q166 -56 160 -56Q147 -56 142 -45Q137 -36 142 -27Q143 -24 363 304Q469 462 525 546T581 630Q528 605 465 605ZM207 385Q235 385 263 427T292 548Q292 617 267 664T200 712Q193 712 186 709T167 698T147 668T134 615Q132 595 132 548V527Q132 436 165 403Q183 385 203 385H207ZM500 146Q500 234 544 290T647 347Q699 347 737 292T776 146T737 0T646 -56Q590 -56 545 0T500 146ZM651 -18Q679 -18 707 24T736 146Q736 215 711 262T644 309Q637 309 630 306T611 295T591 265T578 212Q577 200 577 146V124Q577 -18 647 -18H651Z"></path></g></g></g></svg></mjx-container>。</p> <p>在对业务、资源情况还不熟悉时，可以借助 Spark 3.0 的 noop 指令来查询某个 DataFrame 的耗时，该指令只触发计算而不会产生落盘动作：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// 利用 noop 精确计算DataFrame运行时间</span>
df<span class="token punctuation">.</span>write
<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;noop&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-4-缓存的注意事项"><a href="#_2-4-缓存的注意事项" class="header-anchor">#</a> 2.4 缓存的注意事项</h3> <p>缓存操作 .cache() 是一个惰性操作，需要注意触发计算的算子，也会影响实际缓存的数据，如 <code>count</code> 算子会触发缓存的全量物化，而 <code>first</code>、<code>take</code> 和 <code>show</code> 这 3 个算子只会把涉及的数据物化。</p> <p>Cache Manager 要求<strong>两个查询的 Analyzed Logical Plan 必须完全一致</strong>，否则无法复用 cache：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>col2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache
<span class="token comment">//数据分析</span>
df<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>col2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">)</span>
df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>col2 <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Analyzed Logical Plan 是比较初级的逻辑计划，主要负责 AST 查询语法树的语义检查，确保查询中引用的表、列等元信息的有效性。像谓词下推、列剪枝这些比较智能的推理，要等到制定 Optimized Logical Plan 才会生效。</p> <p>因此，即使是同一个查询语句，仅仅是调换了select和filter的顺序，在 Analyzed Logical Plan 阶段也会被判定为不同的逻辑计划。</p> <p><strong>为什么 Cache Manager 不在 Optimized Logical Plan 执行 cache 复用的管理？</strong></p> <blockquote><p>Spark 使用 <code>（LogicalPlan，InMemoryRelation）</code> 来表示 Logical Plan 及其对应的 cache 数据信息，两个执行结果相同的查询能否复用 cache，就转化为了两个查询的 Logical Plan 是否能够一致。</p> <p>Spark 会对不同查询的 AST 进行归一化，尽可能消除一些无关痛痒的小细节。但对于执行结果相同的不同查询，Spark 无法保证归一化后两者完全相同，并且 Spark 需要保证执行结果不同的两个查询的 Logical Plan 必定是不同的，因此只能一并包含进去，统一不做 cache 复用。</p> <p>cache 是否复用的判断越早做越省事。如果使用 Optimized Plan 作为 key，那么到了后面要么很难命中，要么即使命中了发现优化白做了。</p> <p>一个优化思考，社区暂且没有：对 SQL 按照传统 DBMS 进行 SQL Re-write，这样可以很大程度的让执行结果相同的不同查询生成的 Logical Plan 相同。</p></blockquote> <h2 id="_3-磁盘"><a href="#_3-磁盘" class="header-anchor">#</a> 3. 磁盘</h2> <p>磁盘在 Spark 中通常是起到两个作用：</p> <ol><li>溢出临时文件</li> <li>存储 Shuffle 中间文件</li></ol> <p>除了 cache 之外，Shuffle 落盘也能作为计算失败时的一个回溯点，而不必从头计算，减少失败重算的代价。</p> <p><img src="https://static001.geekbang.org/resource/image/35/86/35c13d9f2eba5d23dabe05249ccb9486.jpg" alt=""></p> <p><strong>ReuseExchange</strong> 是 Spark SQL 众多优化策略中的一种，<strong>相同或是相似的物理计划可以共享 Shuffle 计算的中间结果</strong>。</p> <p>使用 ReuseExchange 有两个条件：</p> <ol><li>多个查询所依赖的分区规则要与 Shuffle 中间数据的分区规则保持一致</li> <li>多个查询所涉及的字段（Attributes）要保持一致</li></ol> <p>例如以下代码：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//版本1：分别计算PV、UV，然后合并</span>
<span class="token comment">// Data schema (userId: String, accessTime: Timestamp, page: String)</span>
 
<span class="token keyword">val</span> filePath<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
<span class="token keyword">val</span> df<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
 
<span class="token keyword">val</span> dfPV<span class="token operator">:</span> DataFrame <span class="token operator">=</span> df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">&quot;metrics&quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token string">&quot;PV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> dfUV<span class="token operator">:</span> DataFrame <span class="token operator">=</span> df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>countDistinct<span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">&quot;metrics &quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token string">&quot;UV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
<span class="token keyword">val</span> resultDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> dfPV<span class="token punctuation">.</span>Union<span class="token punctuation">(</span>dfUV<span class="token punctuation">)</span>
 
<span class="token comment">// Result样例</span>
<span class="token operator">|</span> userId <span class="token operator">|</span> metrics <span class="token operator">|</span> value <span class="token operator">|</span>
<span class="token operator">|</span> user0  <span class="token operator">|</span> PV      <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span> user0  <span class="token operator">|</span> UV      <span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>dfPV 与 dfUV 都会有各自的执行路径，两者仅是数据来源一致，可能不同 executor 读取的文件并不一致，Shuffle 的中间数据不一致，无法利用到 ReuseExchange 机制：</p> <p><img src="https://static001.geekbang.org/resource/image/dd/28/dd150e0863812522a6f2ee9102678928.jpg" alt=""></p> <p>修改后如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//版本2：分别计算PV、UV，然后合并</span>
<span class="token comment">// Data schema (userId: String, accessTime: Timestamp, page: String)</span>
 
<span class="token keyword">val</span> filePath<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> _
<span class="token keyword">val</span> df<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span>repartition<span class="token punctuation">(</span>$<span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span>
 
<span class="token keyword">val</span> dfPV<span class="token operator">:</span> DataFrame <span class="token operator">=</span> df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">&quot;metrics&quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token string">&quot;PV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> dfUV<span class="token operator">:</span> DataFrame <span class="token operator">=</span> df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>countDistinct<span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">&quot;metrics &quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token string">&quot;UV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
<span class="token keyword">val</span> resultDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> dfPV<span class="token punctuation">.</span>Union<span class="token punctuation">(</span>dfUV<span class="token punctuation">)</span>
 
<span class="token comment">// Result样例</span>
<span class="token operator">|</span> userId <span class="token operator">|</span> metrics <span class="token operator">|</span> value <span class="token operator">|</span>
<span class="token operator">|</span> user0  <span class="token operator">|</span> PV      <span class="token operator">|</span> <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span> user0  <span class="token operator">|</span> UV      <span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>修改后的执行路径如下：</p> <p><img src="https://static001.geekbang.org/resource/image/00/b2/008e691de73eefc6daa4886017fa33b2.jpg" alt=""></p> <p>这样一来就能充分利用 ReuseExchange 机制，从数据角度来看，ReuseExchange 其实起到了跟持久化到磁盘一致的功能。</p> <p>需要注意的是，如果将 agg 操作中涉及的字段修改为其它字段，由于涉及的字段不一致，也无法使用 ReuseExchange 机制。</p> <h2 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4. 总结</h2> <p>CPU 的充分利用，主要在于调节好<strong>并发度</strong>、<strong>并行度</strong>以及<strong>每个 Executor 的内存大小</strong>。</p> <p>内存方面，需要考虑较多：</p> <ul><li>不同内存区域的划分，其中 Execution Memory 需要根据实际并发度考虑，并且通常 OOM 的原因不是内存不够，而是某个数据分片能超过了线程可用内存</li> <li>缓存需要考虑好时机，某个反复用到的数据分片计算成本大于 30% 即可考虑进行缓存</li></ul> <p>磁盘方面，可以考虑增大一些 buffer 减少落盘次数，同时磁盘的 shuffle 也起到了类似于存档点的作用（如 ReuseExchange 机制）。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/21/2021, 10:56:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/09.-guang-bo-bian-liang.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        09.广播变量
      </a></span> <span class="next"><a href="/books/zhuan-lan-xue-xi/spark-xing-neng-diao-you-shi-zhan/11.spark-sql.html">
        11.Spark SQL
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/books/assets/js/app.a32f3f13.js" defer></script><script src="/books/assets/js/2.f434c5a6.js" defer></script><script src="/books/assets/js/69.76ec2223.js" defer></script>
  </body>
</html>