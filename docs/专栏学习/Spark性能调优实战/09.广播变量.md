---
title: 09.广播变量
date: 2021-04-17
---

## 1. 广播变量介绍

广播变量是一种分发机制，它一次性封装目标数据结构，**以 Executors 为粒度**去做全量的数据分发。

直到 Spark 3.0 为止，所有广播变量的分发，都需要先汇聚到 Driver 端，之后分发到每个 Executor，交给 BlockManager 管理。

![](https://static001.geekbang.org/resource/image/2c/f7/2cfe084a106a01bf14a63466fa2146f7.jpg)

广播变量除了减少经常使用到的变量的传输之外，某些场景下还可以用于消除 Shuffle，如 Broadcast Join。

Broadcast Join 将表以广播变量的方式分发到 Executor 上，避免了另外一个表的 Shuffle行为。

Broadcast Join 也并不是万能的，如果两个表的数据量接近，由于 Shuffle 是传输部分数据，而广播变量是全量传输，因此还需要根据具体场景进行权衡。

## 2. 广播变量使用

广播变量的一个核心配置是 `spark.sql.autoBroadcastJoinThreshold`，定义了广播变量的最大值，默认 10MB（以广播变量在内存中的大小为主）。

当两张表做 Join 操作时，如果其中某张表小于该参数值， 则 Spark 会优先选择 Broadcast Join。

数据在内存中的大小可以通过先将需要预估大小的数据表缓存到内存，借助 Spark SQL 执行计划的统计信息的来获取：

```scala
val df: DataFrame = _
df.cache.count
 
val plan = df.queryExecution.logical
val estimated: BigInt = spark
.sessionState
.executePlan(plan)
.optimizedPlan
.stats
.sizeInBytes
```

> NOTE：AQE 中动态调整为 Broadcast Join 也会取决于该参数值。

使用 Broadcast Join 除了指定参数阈值的方式之外，可以通过 **Join Hints** 以及 **API** 的方式来实现。

### 2.1 Join Hints

Join Hists 是指在编写 SQL 语句时使用特殊的语法，提示 Spark 对指定表进行 Broadcast：

```scala
val table1: DataFrame = spark.read.parquet(path1)
val table2: DataFrame = spark.read.parquet(path2)
table1.createOrReplaceTempView("t1")
table2.createOrReplaceTempView("t2")
 
val query: String = “select /*+ broadcast(t2) */ * from t1 inner join t2 on t1.key = t2.key”
val queryResutls: DataFrame = spark.sql(query)
```

如果不想频繁的在 Spark SQL 上下文注册数据表，也可以使用 DF 的 DSL 语法：

```scala
table1.join(table2.hint(“broadcast”), Seq(“key”), “inner”)
```

Join Hints 让开发者可以灵活地选择运行时的 Join 策略，对于熟悉业务、了解数据的同学来说，Join Hints 允许开发者把专家经验凌驾于 Spark SQL 的优化引擎之上，更好地服务业务。

Join Hints 存在一个问题，就是当关键字编写错误地时候 Spark 不会抛出异常，而是直接忽略，排查较为困难。

### 2.2 API 方式

Spark 也可以使用 Broadcast 函数强制广播，该参数位于 `org.apache.spark.sql.functions` 下，使用方法如下：

```scala
import org.apache.spark.sql.functions.broadcast
table1.join(broadcast(table2), Seq(“key”), “inner”)
```

### 3.3 Broadcast Join 的局限性

虽然可以通过 Join Hints 以及 API 方式强制做 Broadcast Join，但在实际使用中，通常还是**以广播阈值配置为主，以强制广播为辅**。

强制广播只是提供了一个给专家经验灵活运用的机会，两者相辅相成。

功能方面，并不是所有的 Join 都可以转化为 Broadcast Join：

1. Broadcast Join 不支持全连接（Full Outer Joins）
2. 不能广播基表，如做右连接时无法广播右表。