---
title: 06. 门电路
date: 2020-09-01
---

## 1. 门电路

最原始通用的数据传输方式，通常是通过烽火、声音、光等形式，这些方式都只能表示很简单的信息，因此基本可以抽象为 “0” 和 “1” 两种信号。

在出现电报之后，人们可以很方便的通过**门电路**来表示 “0” 和 “1”，电报传输的信号有两种，一种是短促的**点信号**（dot 信号），一种是长一点的**划信号**（dash 信号）。

电报机本质上就是一个“蜂鸣器 + 长长的电线 + 按钮开关”，通电与不通电可以表示 “0” 和 “1” ：

![](https://static001.geekbang.org/resource/image/28/12/283742f3a72eba22f6b4ae97e21c4112.jpg)

当距离一长，电阻也会变大，因此需要一个中间件能够**接力传输**电报信号，即**继电器**（Relay，也称作**电驿**）：

![](https://static001.geekbang.org/resource/image/11/ea/1186a10341202ea36df27cba95f1cbea.jpg)

受益于信号只有两种状态，因此可以**很容易的原样传输信号**。

通过这些线圈和开关，可以很容易地创建出 “与（AND）”、“或（OR）”、“非（NOT）” 的逻辑：

- 在输入端的电路上，提供串联的两个开关，只有两个开关都打开，输出的开关也才能接通，模拟了计算机里面的 “与” 操作。
- 在输入端的电路上，提供并联的两个开关，只要有其中一个开关打开，输出的开关就能接通，模拟了计算机里面的 “或” 操作。
- 提供两个开关，输出端的开关默认打开，在输入端的电路上接通开关的时候，输出端开关会因为磁场而关闭，输出端开和关正好和输入端相反。这个在数字电路中，也叫作**反向器**（Inverter）。

![](https://static001.geekbang.org/resource/image/97/5e/977b09f3a334304c2861c6b420217b5e.jpg)

与、或、非的电路都非常简单，并借助这些简单的门电路，组合出复杂的功能，这也体现了现代计算机体系中一个重要的思想：**通过分层和组合，逐步搭建起更加强大的功能**。

电报是现代计算机的一个最简单的原型，一方面，我们可以通过继电器或者中继，进行长距离的信号传输。另一方面，通过设置不同的线路和开关状态，实现更多不同的信号表示和处理方式。

门电路也是创建 CPU 和内存的基本逻辑单元。各种对于计算机二进制的“0”和“1”的操作，本质就是操作门电路，称为**组合逻辑电路**。

---

## 2. 加法器

加法器是通过几个简单的门电路组成的，各个门电路标识如下：

![](https://static001.geekbang.org/resource/image/94/f6/94194480bcfd3b5366e4649ee80de4f6.jpg)

二进制加法各场景如下：

![](https://static001.geekbang.org/resource/image/18/d1/1854b98fcac2c6bf4949ac5e2247d9d1.jpg)

可以看到，求进位其实就是做**与门（AND）**，求和则是做**异或门（XOR）**，也就是说一个加法用到了两个门电路，我们将这两个门电路打包成一个**半加器（Half Adder）**：

![](https://static001.geekbang.org/resource/image/58/1e/5860fd8c4ace079b40e66b9568d2b81e.jpg)

全加器是由**两个半加器** + **一个或门**组成的：

![](https://static001.geekbang.org/resource/image/3f/2a/3f11f278ba8f24209a56fb3ee1ca9e2a.jpg)

全加器可用于做加法运算，比如两个数相加，在二位上先对加数与被加数使用半加器进行计算，得到进位标志 **X** 以及和 **Y**，接着 **Y** 与前一位的进位信号信号在经过半加器，得到最终的和 **W** 以及一个进位信号，再将该进位信号与 **X** 经过或门得出最终的进位信号 **V**，后面的计算则如此反复。

有了全加器，一旦我们需要对两个 8 bit 的数求和，则串联 8 个全加器即可：

![](https://static001.geekbang.org/resource/image/68/a1/68cd38910f526c149d232720b82b6ca1.jpeg)

需要注意的是，个位只需要一个半加器即可。

> NOTE：实际上，也可以让个位的全加器的进位信号为 0 ，进位信号则表示当前位是否发生溢出，并可以将最后一位的进位信号，输出到硬件中，能够让计算机直到是否发生溢出，现代计算机也是这么做的。
>
> 真实的加法器，使用的是一种叫作超前进位加法器的东西。你可以找到北京大学在 Coursera 上开设的《计算机组成》课程中的 Video-306 “加法器优化”一节，了解一下超前进位加法器的实现原理，以及我们为什么要使用它

硬件层面，通过门电路 -> 半加器 -> 全加器 一层层搭出了加法器这样的功能组件，这类用来做算术逻辑计算的组件叫作 ALU，也就是算术逻辑单元。

---

## 3. 乘法的实现

二进制做乘法，跟十进制做乘法类似，且结算更简单，因为只有 0 跟 1 两种结果：

![](https://static001.geekbang.org/resource/image/49/4b/498fdfa2dc95631068d65e0ff5769c4b.jpg)

可以看到，乘法也是可以使用加法器来实现的，并不需要额外构造其他更复杂的新东西。

### 3.1 顺序乘法

为了节约晶体管数量，我们并不需要将 4 次单位相乘的结果存储起来，而是用 1 组开关来实现，这种方法称为**顺序乘法**。

首先我们将乘数与被乘数的第一组结果写入一组结果里，接下来我们将**乘数左移一位，被乘数右移一位**，得到的第二组结果直接加到第一组结果里，如此反复，直到无法再左移与右移。这样一来，只需要一个可以左移的电路、右移的电路以及加法器即可实现：

![](https://static001.geekbang.org/resource/image/cb/e9/cb809de19088d08767279715f07482e9.jpg)

![](https://static001.geekbang.org/resource/image/06/71/0615e5e4406617ee6584adbb929f9571.jpeg)

这种方式存在一个缺点，就是慢。乘法展开被转化为”**加法 + 位移**“的方式来实现，且每一组计算依赖于上一组的计算结果，导致 4 组运算无法同时进行。

这样一来，一个顺序乘法的时间复杂度为 $O(N)$ ，N 取决于乘法里的**位数**。

### 3.2 并行加速

在顺序乘法中，每次只能进行一组结果的计算：

![](https://static001.geekbang.org/resource/image/07/ef/07f7b0eedbf1a00fc72be7e2bd0d96ef.jpg)

加速的办法，就是通过使用更多的开关来同时进行好几组运算，从而将时间复杂度变为 $O(log_2N)$：

![](https://static001.geekbang.org/resource/image/66/98/6646b90ea563c6b87dc20bbd81c54b98.jpeg) 

即**通过并联更多的 ALU，加上更多的寄存器加速乘法**，但这种方式又需要较多的开关，较为笨重。

### 3.3 电路并行

顺序惩罚中，每一个全加器，都要等待上一个全加器，把对应的进入输入结果算出来，才能算下一位的输出。位数越多，越往高位走，等待前面的步骤就越多，这个等待的时间有个专门的名词，叫作**门延迟**（Gate Delay）。

一个全加器的门延迟为 3T，当我们进行 64 位乘法运算的时候，最后一位要等待的门延迟为 63*3T=189T。

除了门延迟之外，还存在**时钟频率**的问题，当我们需要将中间结果存到寄存器中时，需要等待下一个时钟周期的到来，这个延迟比门延迟更大。

可以从这个角度出发，一旦两个数是固定的，那么高位的进位也是固定，我们不需要按照人脑的方式来进行顺序计算，而是可以通过将电路连得更复杂，将进位部分的电路完全展开，利用电路天然的并行性进行加速：

![](https://static001.geekbang.org/resource/image/6e/a8/6e9f630389c566d72f57f5b196a711a8.jpeg)

上述这个门电路可以直接获得前 4 位是否需要进位。

> NOTE：这个优化，本质上是利用了电路天然的并行性。电路只要接通，输入的信号自动传播到了所有接通的线路里面，这其实也是硬件和软件最大的不同。

这里更复杂的电路也意味着，需要用到的晶体管更多了，通过更多的晶体管，就可以拿到更低的门延迟，以及用更少的时钟周期完成一个计算指令。

指令也存在着两种争执：是用更少更简单的电路，但是需要更长的门延迟和时钟周期；还是用更复杂的电路，但是更短的门延迟和时钟周期来计算一个复杂的指令，这之间的权衡，其实就是计算机体系结构中 RISC 和 CISC 的经典历史路线之争。

