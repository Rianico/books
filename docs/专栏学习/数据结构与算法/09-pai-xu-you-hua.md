---
title: 09-pai-xu-you-hua
date: 2020-07-22 14:48:49
permalink: /pages/81d135/
categories: 
  - Algorithm
  - 数据结构与算法（专栏学习）
tags: 
  - 
---
# 09 | 排序优化

几乎所有语言都会提供排序方法，比如 C 语言中 qsort\(\)，C++ STL 中的 sort\(\)、stable\_sort\(\)，还有 Java 语言中的 Collections.sort\(\)，**如何实现一个通用的、高性能的工业级排序函数**？

Java中使用的排序算法为堆排序，而C语言则是使用快速排序，那么这些语言是基于什么标准来选择排序算法的？

![&#x5404;&#x7B97;&#x6CD5;&#x5BF9;&#x6BD4;](https://static001.geekbang.org/resource/image/1f/fd/1f6ef7e0a5365d6e9d68f0ccc71755fd.jpg)

先从我们前面学习过的排序算法中选择一个通用高效的排序算法，需要从各个维度来进行筛选。首先，桶排序、计数排序、计数排序由于对使用场景较为苛刻，因此可以排除掉。其次，从空间复杂度来看，由于归并排序为O\(n\)级别，当数据量一大的时候，需要的内存空间是翻倍的，因此也可以排除。最后，再从时间复杂度来看，时间复杂度为O\(nlogn\)的快速排序无疑是比较合适的。

## 1. 如何优化快速排序

快速排序在某些场景（数据已经有序）会退化为$O\(n^2\)$，其本质原因还是**因为我们的分区点选择的不合理**。最理想的分区点是，能够分布在两端的数据量差不多，但这个往往是很难实现的。

如果只是随意的选择一个点，那么肯定会出现前面提到的场景，为了提高算法的**平均性能**，可以采用以下两种方法来降低这个概率。

### 1.1 三数取中法

从区间的首中尾取出三个数，然后将3个数的中间值作为分区点，这样一来肯定比单独取一个数好。当数据规模较大的时候，可能也需要扩大取值范围，如五数取中法，十数取中法等。

### 1.2 随机法

随机法就是每次都从要排序的区间里随机选取一个分区数，从概率上来看，选到的分区数可能不会太好，但同样的一般也不会太差。

## 2. 举例分析排序函数

接下来以Glibc 中的 qsort\(\) 函数举例说明，虽然从名字看来，会角色这个算法是使用快速排序，但实际上是由多个算法杂糅在一起的。

**qsort\(\) 会优先使用归并排序来排序输入数据**，虽然归并排序的空间复杂度为O\(n\)，但是在数据规模很小（比如1KB，2KB）的时候，归并排序的空间复杂度并不会有太大的性能问题，这里就是典型的空间换时间技巧。

当数据量太大（比如100MB）的时候，这时候使用归并排序就不合适了，而是会**改为使用快速排序算法**，并且也是使用三数取中法来选取分区点。

为了处理堆栈溢出问题，当快速排序的区间大小小于4的时候，qsort\(\) 会改为**使用插入排序**，从而减少栈深度。

在某些场景下，时间复杂度为$O\(n^2\)$的算法性能并不一定比$O\(nlogn\)$差，虽然从趋势图上看，$O\(n^2\)$的趋势更抖一些，但在n很小的时候，时间复杂度的低阶，常数等就无法忽略了，这时候反而是这些参数代表了算法的性能，如下：

> knlogn+c = 1000  _100_  log100 + 200 远大于10000
>
> n^2 = 100\*100 = 10000

所以，对于小规模数据的排序，O\(n2\) 的排序算法并不一定比 O\(nlogn\) 排序算法执行的时间长。对于小数据量的排序，我们选择比较简单、不需要递归的插入排序算法。

