---
title: 07. Kafka 分区迁移脚本
date: 2021-05-13
---

## Kafka 分区迁移脚本

基于 Kafka 0.11 开发，该版本尚不支持同个机器内磁盘的再平衡。

```bash
#!/bin/bash
###################说明###################
# @author:zhengxuankun@haohandata.com.cn
# @date:2019-11-05
# 1. 此脚本用于封装kafka partition的过程
# 2. 同一时间最好只有一个topic进行迁移，避免对集群网络，磁盘等造成太大压力，或者在 zk 中添加限速
# 3. 尽量避开高峰期进行kafka的partition迁移
###################说明###################

# 初始化各种环境信息
cur_dir=$(pwd)
zookeeper=''
zkCli='/opt/cloudera/parcels/CDH/lib/zookeeper/bin/zkCli.sh'
JAVA_HOME="$JAVA_HOME"
kafkaPath='/opt/cloudera/parcels/KAFKA/bin/'
topic=''

# args-list
ARGUMENT_LIST=(
    "zookeeper"
    "topic"
    "zkCli"
    "JAVA_HOME"
    "kafkaPath"
)

ARGS=$(getopt --longoptions "$(printf "%s:," "${ARGUMENT_LIST[@]}")" --name "$(basename "$0")" --options "" -- "$@")

if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi

eval set -- "$ARGS"

while true ; do
  case "$1" in
    --zookeeper) zookeeper="$2"; shift 2 ;;
    --topic)     topic="$2"; shift 2 ;;
    --zkCli)     zkCli="$2";     shift 2 ;;
    --JAVA_HOME) JAVA_HOME="$2"; shift 2 ;;
    --kafkaPath)  kafkaPath="$2";  shift 2 ;;
    --) shift ; break ;;
    *) echo "Internal error!" ; exit 1 ;;
  esac
done

# 校验各项环境变量
if [ ! -n "$zookeeper" ]; then echo '[ERROR] zookeeper must not be null' >&2 ; exit 1 ; fi
if [ ! -n "$topic" ]; then echo '[ERROR] topic must not be null' >&2 ; exit 1 ; fi
if [ ! -n "$JAVA_HOME" ]; then echo '[ERROR] JAVA_HOME must not be null' >&2 ; exit 1 ; fi

echo "======================================================[Env]======================================================"
echo "topic: $topic"
echo "zookeeper server: $zookeeper"
echo "JAVA_HOME PATH: $JAVA_HOME"
echo "kafkaPath: $kafkaPath"
echo "zkCli Path: $zkCli"
echo "======================================================[Env]======================================================"
echo ""

while true; do
	read -r -p "Are You Sure? [Y/n] " input
	case $input in
		[yY][eE][sS]|[yY]) echo "Start reassigning $topic partitions..."; break; ;;
		[nN][oO]|[nN]) echo "Terminating..."; exit 0;;
		*) echo "Invalid input..."; ;;
	esac
done


# 生成要迁移的topic的执行计划
function generate_topic_to_move_json_file {
  # 1. 首先生成迁移topic的相关信息
  topic_dir=$cur_dir/$topic
  topic_json=$topic_dir/$topic.json
  old_topic_json=$topic_dir/old_$topic.json
  new_topic_json=$topic_dir/new_$topic.json

  mkdir -p $topic_dir
  # 若要迁移的topic相关文件已存在，则需要先确认下当前topic状态
  if [ -e $topic_json ];then
    echo "迁移topic:$1已存在，请在确认该topic不在迁移过程后，并删除相关目录:$topic_dir"
    exit 1
  fi
  echo "{\"topics\": [{\"topic\": \"$topic\"}],\"version\": 1}" > $topic_json

  # 2. 通过zk获取所有Kafka节点
  kafka_broker_list=$($zkCli -server $zookeeper ls /brokers/ids|grep -e '\[.*\]$'|sed -e "s/["]"| |"["]//g")

  # 3. 生成迁移topic的新旧分区信息文件
  echo "Generating kafka reassign plan..."
  plan=$(echo -e $($kafkaPath/kafka-reassign-partitions -zookeeper $zookeeper --topics-to-move-json-file $topic_json --broker-list $kafka_broker_list --generate)|sed 's/\<Current partition replica assignment\> //g;s/\<Proposed partition reassignment configuration\> /\n/g')

  echo "Generate topic ${topic}'s old partition plan file: $old_topic_json"
  printf "$plan"|head -n 1 > $old_topic_json
  echo "Generate topic ${topic}'s new partition plan file: $new_topic_json"
  printf "$plan"|tail -n 1 > $new_topic_json
}


# 执行kafka迁移计划并监控进度
function execute_reassign {
  # 1. 首先设置topic的最大数据保留时间，此处为20分钟
  retention=1200000
  echo "set topic's config retention.ms=$retention"
  $kafkaPath/kafka-topics --zookeeper $zookeeper --alter --topic $topic --config retention.ms=$retention

  # 2. 开始执行迁移计划
  nohup $kafkaPath/kafka-reassign-partitions --zookeeper $zookeeper -reassignment-json-file $new_topic_json --execute 2>/dev/null &

  # 3. 监控迁移进度
  i=0
  sp='/-\|'
  n=${#sp}
  while [ true ]
  do
    rate_of_progress=$(printf "$($kafkaPath/kafka-reassign-partitions --zookeeper $zookeeper -reassignment-json-file $new_topic_json --verify 2>/dev/null)")
    total=$(printf "$rate_of_progress"|grep -E -v 'ERROR|Status.*'|wc -l)
    complete=$(printf "$rate_of_progress"|grep 'successfully'|wc -l)
    printf "Reassigning: $complete/$total %s\r" "${sp:i++%n:1}"
    if [ "$complete" -eq "$total" ]; then
      printf "Reassigning: $complete/$total %s\n" "${sp:i++%n:1}"
      break
    fi
    sleep 10
  done

  # 4. 迁移完成后清除最大数据保留时间配置
  echo "delete topic's config retention.ms=$retention"
  $kafkaPath/kafka-topics --zookeeper $zookeeper --alter --topic $topic --delete-config retention.ms

  echo "$topic reassign partitions complete !"
}

generate_topic_to_move_json_file
execute_reassign
```

