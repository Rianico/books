---
title: 修改表字段类型后旧分区字段不更新类型
date: 2020-07-21 09:06:19
---
# 修改表字段类型后旧分区字段不更新类型

Hive在修改、新增字段的时候，若表是分区表，那么做出的改动只对新分区生效，而旧分区无效，导致这个现象的原因是**旧分区的metadata没有跟着修改**。

## 1. 通过partition修改

从Hive0.14开始，修改、新增字段可以通过提供部分partition来进行批量修改，但要将`hive.exec.dynamic.partition`修改为true。

一个一个partition修改：

```sql
ALTER TABLE foo PARTITION (ds='2008-04-08', hr=11) CHANGE COLUMN dec_column_name dec_column_name DECIMAL(38,18);
ALTER TABLE foo PARTITION (ds='2008-04-08', hr=12) CHANGE COLUMN dec_column_name dec_column_name DECIMAL(38,18);
...
```

提供部分partition批量修改：

```sql
// hive.exec.dynamic.partition needs to be set to true to enable dynamic partitioning with ALTER PARTITION
SET hive.exec.dynamic.partition = true;

// This will alter all existing partitions in the table with ds='2008-04-08' -- be sure you know what you are doing!
ALTER TABLE foo PARTITION (ds='2008-04-08', hr) CHANGE COLUMN dec_column_name dec_column_name DECIMAL(38,18);

// This will alter all existing partitions in the table -- be sure you know what you are doing!
ALTER TABLE foo PARTITION (ds, hr) CHANGE COLUMN dec_column_name dec_column_name DECIMAL(38,18);
```

> As of Hive 0.14 \(HIVE-8411\), users are able to provide a partial partition spec for certain above alter column statements, similar to dynamic partitioning. So rather than having to issue an alter column statement for each partition that needs to be changed.

## 2. 通过CASCADE关键字更新

从Hive 1.1.0 开始，Hive允许通过关键字`CASCADE`以级联方式更改表以及**所有分区**的metadata：

```sql
ALTER TABLE table_name CHANGE [COLUMN] col_old_name col_new_name column_type [COMMENT col_comment] [FIRST|AFTER column_name] [CASCADE|RESTRICT];
```

默认模式是`RESTRICT`，只修改表的元数据，**不更新旧分区**的metadata。

官方文档：[LanguageManualDDL-PartialPartitionSpecification](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-PartialPartitionSpecification)

