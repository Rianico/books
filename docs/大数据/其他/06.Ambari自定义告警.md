---
title: 06. Ambari 自定义告警
date: 2021-07-02
---

## Ambari 自定义告警

Ambari 的告警体系，首先要明确三个概念：

- **Alert**：定义了监控的方式，包括 alert 类型、检查间隔以及阈值，用于监控集群组件、机器的状态。如果满足条件，则会产生一个 alert 实例 ，不包含推送动作。
  - **alert 的几种状态**：OK、 WARNING、 CRITICAL、 UNKNOWN（少见，通常在服务安装过程中才会见到）。
  - **alert 的几种类型**：web、port、metric、aggreate、script、server、recover。
- **Notification**：对 alert 实例进行推送，支持 EMAIL/SNMP/自定义脚本方式推送 alert。
- **Group**：分组，一个分组可以关联多个 alert 及多个 notification。

举例：定义一个 hdfs 相关的 gourp；group关联多个 hdfs 相关的 alert 类型；group 关联多个 notification，每个 notification 推送对象为 hdfs 维护人员，从而实现按需通知。

alerts, notifications 以及 notification 这三个抽象可以让必要的人员只关注必要的告警。

通常只有在状态发生变化时，才会产生推送动作，这个取决于 notification 关注哪些 alert 状态。

## Alert Type

alert 的几种状态：OK、 WARNING、 CRITICAL、 UNKNOWN。 alert 支持以下几种监控方式：

- web：监控组件的 web 状态，alert 的状态取决于 web 的响应码：
  - OK：web 响应码 < 400.
  - WARNING：web 响应码 ≥ 400.
  - CRITICAL：无法连接上 web 或者连接超时，单位为秒。
- port：测试端口是否连通，超时时间单位为秒。
- metric：可以检查一个或者多个 metric (需要定义计算方式)，这些 metric 可以从一个组件暴露的端点获取（比如 JMX）。当获取 metric 超市的时候 alert 状态为 CRITICAL 。不同的 metric 单位也不同，比如 CPU 利用率的 alert 单位为百分比，RPC 延迟的 alert 单位为毫秒。
- aggregate：聚合多个 alert 实例，并计算出所占百分比，比如聚合所有 HDFS 进程的 alert，并统计出处于各个 alert 状态的百分比。
- script：通过执行一个脚本并返回如 OK、WARNING 或者 CRITICAL 状态，同时也可以自定义脚本返回的响应内容、properties、阈值。
- server：会执行服务端的一个 class，这个类会返回如 OK、WARNING 或者 CRITICAL 状态。
- recovery：由 Ambari Agents 监控服务进程重启的时候触发。alert 状态中的 OK、WARNING 或者 CRITICAL 取决于进程自动重启的次数。可以用于了解进程挂掉的时间点以及 Ambari 自动拉起服务的时间点。

## Alert 相关 API

Alert 提供了一套查询 alert 的 API：

```bash
# 查询所有的 alert 定义
# curl -u ${ambari_user}:${ambari_passwd} -H "X-Requested-By: ambari" -X GET http://${ambari_host}:8080/api/v1/clusters/${cluster_name}/alert_definitions
curl -u admin:admin -H "X-Requested-By: ambari" -X GET http://server1:8080/api/v1/clusters/cluster1/alert_definitions

# 根据服务组件查询 alert 定义
curl -u admin:admin -H "X-Requested-By: ambari" -X GET http://server1:8080/api/v1/clusters/cluster1/alert_definitions?AlertDefinition/service_name=MAPREDUCE2
```

其余更加详细的 API 详见 [github](https://github.com/apache/ambari/blob/trunk/ambari-server/docs/api/v1/index.md)。

## Alert 的定义

Ambari 自身集成的组件都已经预定义了一套 alert，详见 [Predefined Alerts](https://docs.cloudera.com/HDPDocuments/Ambari-2.7.5.0/managing-and-monitoring-ambari/content/amb_predefined_alerts.html)。

如果需要注册自定义脚本 alert，可以参考：[How to create and register custom ambari alerts ?](https://community.cloudera.com/t5/Community-Articles/How-to-create-and-register-custom-ambari-alerts/ta-p/246436)

通常服务的相关 alert，在开发集成插件的时候就需要定义 alert 了，这里详见 [Custom Services](https://cwiki.apache.org/confluence/display/AMBARI/Custom+Services)

## 自定义 Notification 脚本

Notification 默认支持 EMAIL/SNMP/Script 方式，其中 EMAIL 跟 SNMP 按照界面填写即可，较为简单，这里不做介绍，而且也不符合我们当前现网的告警场景，这里主要介绍如何通过自定义脚本，调用我们的巡检接口。

通过自定义脚本也可以达到解耦的目的，一旦注册了自定义脚本后，后续可以灵活修改脚本内容，而无需其他操作，参考 [Apache Ambari - Custom Alert Dispatch Script](https://risdenk.github.io/2018/03/25/apache-ambari-custom-alert-dispatch-script.html)。

1. 首先定义一个脚本 `vim /path/to/alert1.py`，并定义告警内容输出到 `/var/log/ambari-server/ambari-alerts-custom.log`，内容如下：

```python
#!/usr/bin/env python

from datetime import datetime
import sys
import os
import logging

def handle_alert():
    '''
     # handle_alert method which is called from Ambari
     # :param definitionName: the alert definition unique ID
     # :param definitionLabel: the human readable alert definition label
     # :param serviceName: the service that the alert definition belongs to
     # :param alertState: the state of the alert (OK, WARNING, etc)
     # :param alertText: the text of the alert
     # :param alertTimestamp: the timestamp the alert went off - Added in AMBARI-20291
     # :param hostname: the hostname the alert fired off for - Added in AMBARI-20291
     '''

    definitionName = sys.argv[1]
    definitionLabel = sys.argv[2]
    serviceName = sys.argv[3]
    alertState = sys.argv[4]
    alertText = sys.argv[5]
    # AMBARI-20291
    if len(sys.argv) == 8:
        alertTimestamp = sys.argv[6]
        hostname = sys.argv[7]
        else:
            alertTimestamp = 'N/A'
            hostname = 'N/A'

            # set logging config
            logging.basicConfig(filename='/var/log/ambari-server/ambari-alerts-custom.log', format='[%(asctime)s-%(filename)s-%(levelname)s]: %(message)s', level=logging.INFO, filemode='a', datefmt='%Y-%m-%d %H:%M:%S')

            # Add custom logic here to handle the alert
            logging.info(sys.argv)
            logging.info("definitionName:%s, definitionLabel:%s, serviceName:%s, alertState:%s, alertText:%s, alertTimestamp:%s, hostname:%s", definitionName, definitionLabel, serviceName, alertState, alertText, alertTimestamp, hostname)


if __name__ == '__main__':
	if len(sys.argv) >= 6:
    	handle_alert()
    else:
    	print("Incorrect number of arguments")
        sys.exit(1)
```

1. 编辑 ambari-server 属性文件，添加一个自定义属性，并指向我们的自定义脚本文件：

```
   cn.com.haohan.alert.test.script=/path/to/alert1.py
```

2. 重启 Ambari：`ambari-server restart`。

3. 进入 Ambari 的告警配置界面：*Alerts-Actions-Manage Alert Groups*：

![image-20210702103146557](https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103146557.png)

4. 添加 group，并在 group 下添加关注的 alert：

![image-20210702103216265](https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103216265.png)

5. 点击*Alerts-Actions-Manage Notifications*

![image-20210702103238560](https://gitee.com/zhxuankun/Image/raw/master/blog/image-20210702103238560.png)

6. 点击 *+* 添加 notification 方式，这里选择脚本方式（Alert Script），并在 Script Dispatch Property 处填入我们前面自定义的属性 `cn.com.haohan.alert.test.script`：

![img](https://gitee.com/zhxuankun/Image/raw/master/blog/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_16251931783567.png)

7. 接着我们去到 SamrtSense 部署的机器上，kill 掉 9000 端口上的 SmartSense 进程。

8. 查看 `/var/log/ambari-server/ambari-alerts-custom.log`，发现脚本的告警内容已输出

```bash
[2020-10-22 11:37:19-alert1.py-INFO]: ['/home/ambari-qa/alert_scripts/alert1.py', 'smartsense_gateway_status', 'SmartSense Gateway Status', 'SMARTSENSE', 'UNKNOWN', '[Alert][smartsense_gateway_status] Unable to extract JSON from JMX response', '1603337720095', 'server1']
[2020-10-22 11:37:19-alert1.py-INFO]: definitionName:smartsense_gateway_status, definitionLabel:SmartSense Gateway Status, serviceName:SMARTSENSE, alertState:UNKNOWN, alertText:[Alert][smartsense_gateway_status] Unable to extract JSON from JMX response, alertTimestamp:1603337720095, hostname:server1
[2020-10-22 11:37:19-alert1.py-INFO]: ['/home/ambari-qa/alert_scripts/alert1.py', 'smartsense_server_process', 'SmartSense Server Process', 'SMARTSENSE', 'CRITICAL', 'SmartSense HST Server connection failed: [Errno 111] Connection refused to server1:9000', '1603337720166', 'server1']
[2020-10-22 11:37:19-alert1.py-INFO]: definitionName:smartsense_server_process, definitionLabel:SmartSense Server Process, serviceName:SMARTSENSE, alertState:CRITICAL, alertText
```

