---
title: 01.编译Hue-4.8.0
date: 2020-11-18
---

## 1. 部署环境

- Python： 2.7.5
- Nodejs： 10.23.0
- Java： openjdk-1.8.0_181
- OS： CentOs 7.6

## 3.1 制作 rpm 包

安装必备组件：

```bash
yum -y install libffi-devel make gcc gcc-c++ ant asciidoc cyrus-sasl-devel cyrus-sasl-gssapi cyrus-sasl-plain krb5-devel libtidy libxml2-devel libxslt-devel openldap-devel python-devel sqlite-devel openssl-devel mysql-devel openldap-devel python-devel sqlite-devel gmp-devel maven wget rpmdevtools pip

# 如果系统没有安装 pip，则执行 yum -y install pip
pip install --upgrade pip
pip install wheel
# pip install daemon
pip install logilab-astng
pip install 'ipython<6.0'
```

为 maven 添加阿里云镜像：

```bash
# vim /etc/maven/settings.xml 
<mirror>
  <id>nexus-aliyun</id>
  <mirrorOf>central</mirrorOf>
  <name>Nexus aliyun</name>
  <url>http://maven.aliyun.com/nexus/content/groups/public</url>
</mirror>
```

配置 npm 为华为镜像源，并升级 node 到 10.23.0 版本：

```bash
npm config set registry https://mirrors.huaweicloud.com/repository/npm/
npm install -g n
yum -y remove npm
n 10.23.0
```

生成 rpm 构建目录：`rpmdev-setuptree && cd ~/rpmbuild `，会在当前用户的 $HOME 目录下生成一个 `rpmbuild` 文件夹，结构如下：

```bash
../rpmbuild/
├── BUILD
├── BUILDROOT
├── RPMS
├── SOURCES
├── SPECS
└── SRPMS
```

下载 hue 源码到 SOURCES 文件夹下：`wget --no-check-certificate -P ~/rpmbuild/SOURCES https://github.com/cloudera/hue/archive/release-4.8.0.tar.gz`。

编写构建相关的描述文件 `vim ~/rpmbuild/SPECS/hue.spec`，内容如下：

```bash
%define __os_install_post %{!?__debug_package:/usr/lib/rpm/brp-strip %{__strip}} %{nil}

%define __debug_install_post %{_rpmconfigdir}/find-debuginfo.sh %{?_find_debuginfo_opts} "%{_builddir}/%{?buildsubdir}" %{nil}

%define _python_bytecompile_errors_terminate_build 0

%define debug_package %{nil}

%define _unpackaged_files_terminate_build 0

%define _use_internal_dependency_generator 0

%define __jar_repack %{nil}

%define __prelink_undo_cmd %{nil}

Name:           hue
Version:        4.8.0
Release:        1%{?dist}
Summary:        Hue is a graphical user interface to operate and develop applications for Apache Hadoop.

License:        GPLv3
URL:            https://github.com/cloudera/hue
Source0:        %{name}-%{version}.tgz
AutoReqProv:    no
Prefix:        /usr/hdp/current

%description
Hue is a graphical user interface to operate and develop applications for Apache Hadoop.

%prep
tar -zxf %{_sourcedir}/%{name}-%{version}.tgz -C %{prefix}
rm -rf %{prefix}/%{name}
mv -f %{prefix}/%{name}-%{version}  %{prefix}/%{name}

%build
source /etc/profile
export PATH=$PATH:/usr/local/bin
# export SYS_PYTHON=`which python`
# export SKIP_PYTHONDEV_CHECK=true  
npm config set registry https://mirrors.huaweicloud.com/repository/npm/
cd %{prefix}/%{name}
make apps

%install
rm -rf $RPM_BUILD_ROOT/*
mkdir -p $RPM_BUILD_ROOT%{prefix}
cp -rf %{prefix}/%{name} $RPM_BUILD_ROOT%{prefix}/%{name}

%files
%{prefix}/%{name}

%changelog
- 2020/11/05 [NEW] 初次构建 hue rpm 包。
```

去掉 rpath 检查：

```bash
# vim ~/.rpmmacros
case "${QA_CHECK_RPATHS:-}" in [1yY]*) /usr/lib/rpm/check-rpaths ;; esac \
# 注释该代码，位于倒数第二行：
# case "${QA_CHECK_RPATHS:-}" in [1yY]*) /usr/lib/rpm/check-rpaths ;; esac \
```

编写脚本 `vim ~/rpmbuild/build.sh`：

```bash
#!/usr/bin/env bash
rpmbuild -bs ~/rpmbuild/SPECS/hue.spec
QA_RPATHS=$[ 0x0001|0x0002 ] rpmbuild --nodeps --rebuild ~/rpmbuild/SRPMS/hue-4.8.0-1.el7.src.rpm 
```

执行脚本 `nohup sh ./build.sh &`，等待编译完成，过程一般需要持续两三个小时。

编译后的目录结构如下：

```bash
../rpmbuild/
├── BUILD
├── BUILDROOT
├── build.sh
├── nohup.out
├── RPMS
│   └── x86_64
│       └── hue-4.8.0-1.el7.x86_64.rpm
├── SOURCES
│   └── hue-4.8.0.tgz
├── SPECS
│   └── hue.spec
└── SRPMS
    └── hue-4.8.0-1.el7.src.rpm
```

其中 `hue-4.8.0-1.el7.x86_64.rpm` 就是 hue 的 rpm ，安装后位于 `/usr/hdp/current/hue` 。

> NOTE：由于 hue 在编译的时候，使用了内置的虚拟环境，会根据编译时的位置，将路径写死在编译出来后的文件里（包括编译后的二进制二建），因此这样也导致了按照网上的教程走下来， 很多地方都出现了问题。hue 安装后是不能移动位置的，官方给出的解决方案也只是删除目录下的 apps.reg 文件以及 apps 文件夹，然后重新编译。

> NOTE： Nodejs 版本一定要保证是 10.23.0，官方文档只宣称需要 node v10+ ，但实际测试的时候，使用 v10 的第一个版本，会与其中的某个依赖产生冲突，从而导致编译失败！

参考教程：

- [RPM Packaging Guide](https://rpm-packaging-guide.github.io/)
- [RPM打包流程、示例及常见问题](https://bbs.huaweicloud.com/forum/thread-38327-1-1.html)

最后将 `hue-4.8.0-1.el7.x86_64.rpm` 放置于任意一个 yum 源仓库，即可通过 `yum -y install hue` 安装。