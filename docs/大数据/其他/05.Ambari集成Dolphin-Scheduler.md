---
title: 05.Ambari集成Dolphin-Scheduler
date: 2021-06-21
---

## dolphinscheduler-mpack

![standard-readme compliant](https://img.shields.io/badge/standard--readme-OK-green.svg?style=flat-square)

Ambari 2.7.3 集成 dolphinscheduler 1.3.3。

基于 [dolphinscheduler 1.3.3 分支](https://github.com/apache/incubator-dolphinscheduler/tree/1.3.3-release/ambari_plugin) 的官方插件修改而来，改动如下：

1. 修改 dolphinscheduler 安装方式为 rpm 形式。
2. 统一修改 dolphinscheduler 安装路径为 `/usr/hdp/current` 下。
3. 修改 `dolphin-env` 下的 `dolphinscheduler-env-content` 属性，以适配 hdp 默认环境。
4. 修改部分其中部分过时的 ambari API（官方插件基于 Ambari 2.5.2 开发）。

项目地址：[zxk/Ambari-Plugins](https://gitee.com/zhxuankun/ambari-plugins)。

## 编译环境

- 操作系统：CentOS 7.6.1810
- 内核：4.14.0-115.el7a.0.1.aarch64
- Java： openjdk-1.8.0_181

## 制作 rpm 包

安装必备组件：

```
yum -y install libffi-devel make gcc gcc-c++ ant asciidoc cyrus-sasl-devel cyrus-sasl-gssapi cyrus-sasl-plain krb5-devel libtidy libxml2-devel libxslt-devel openldap-devel python-devel sqlite-devel openssl-devel mysql-devel openldap-devel python-devel sqlite-devel gmp-devel maven wget rpmdevtools pip

# 如果系统没有安装 pip，则执行 yum -y install pip
pip install --upgrade pip
```

生成 rpm 构建目录：`rpmdev-setuptree && cd ~/rpmbuild`，会在当前用户的 $HOME 目录下生成一个 `rpmbuild` 文件夹，结构如下：

```
../rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
├── SPECS
└── SRPMS
```

鉴于网络问题，不同地区下载 dolphinscheduler 的节点会有所不同，这里建议先在浏览器打开此[链接](https://www.apache.org/dyn/closer.cgi/incubator/dolphinscheduler/1.3.3/apache-dolphinscheduler-incubating-1.3.3-dolphinscheduler-bin.tar.gz)，可以看到如下截图：



[![image-20210126155810038](https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210127164304.png)](https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210127164304.png)

这里建议使用第一个链接，正常情况下应该是一个一百多 M 的压缩包，如果不行，再一个个链接尝试。

这里以第一个链接为例，下载 dolphinscheduler 1.3.3 版本的二进制包到 SOURCES 文件夹下：

```bash
wget --no-check-certificate -P ~/rpmbuild/SOURCES https://mirrors.bfsu.edu.cn/apache/incubator/dolphinscheduler/1.3.3/apache-dolphinscheduler-incubating-1.3.3-dolphinscheduler-bin.tar.gz
```

下载 mysql 驱动包到 SOURCES 文件夹下

```bash
wget --no-check-certificate -P ~/rpmbuild/SOURCES  https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.47/mysql-connector-java-5.1.47.jar
```

编写构建相关的描述文件 `vim ~/rpmbuild/SPECS/dolphinscheduler.spec`，内容如下：

```
%define __os_install_post %{!?__debug_package:/usr/lib/rpm/brp-strip %{__strip}} %{nil}

%define __debug_install_post %{_rpmconfigdir}/find-debuginfo.sh %{?_find_debuginfo_opts} "%{_builddir}/%{?buildsubdir}" %{nil}

%define _python_bytecompile_errors_terminate_build 0

%define debug_package %{nil}

%define _unpackaged_files_terminate_build 0

%define _use_internal_dependency_generator 0

%define __jar_repack %{nil}

%define __prelink_undo_cmd %{nil}

Name:           dolphinscheduler
Version:        1.3.3
Release:        1%{?dist}
Summary:        A distributed and easy-to-extend visual DAG workflow scheduling system. Dedicated to solving the complex dependencies in data processing, making the scheduling system `out of the box` for data processing.

License:        Apache License 2.0
URL:            https://github.com/apache/incubator-dolphinscheduler
Source0:        apache-%{name}-incubating-%{version}-%{name}-bin.tar.gz
AutoReqProv:    no
Prefix:        /usr/hdp/current

%description
A distributed and easy-to-extend visual DAG workflow scheduling system. Dedicated to solving the complex dependencies in data processing, making the scheduling system `out of the box` for data processing.

%prep
%setup -q -n apache-%{name}-incubating-1.3.3-%{name}-bin
cp -rf %{_sourcedir}/mysql-connector-java-5.1.47.jar %{_builddir}/apache-%{name}-incubating-%{version}-%{name}-bin/lib/

%build

%install
mkdir -p %{buildroot}%{prefix}
cp -rf %{_builddir}/apache-%{name}-incubating-%{version}-%{name}-bin %{buildroot}%{prefix}/%{name}

%files
%{prefix}/%{name}
```

编译过程需要去掉 rpath 检查，执行 `vim ~/.rpmmacros`，找到下列代码，将其注释掉，通常位于倒数第二行：

```
# case "${QA_CHECK_RPATHS:-}" in [1yY]*) /usr/lib/rpm/check-rpaths ;; esac \
```

编写脚本 `vim ~/rpmbuild/build.sh`：

```
#!/usr/bin/env bash
rpmbuild -bs ~/rpmbuild/SPECS/dolphinscheduler.spec
QA_RPATHS=$[ 0x0001|0x0002 ] rpmbuild --nodeps --rebuild ~/rpmbuild/SRPMS/dolphinscheduler-1.3.3-1.el7.src.rpm
```

执行脚本 `nohup sh ./build.sh &`，等待编译完成。

编译后的目录结构如下：

```
.
├── BUILD
├── BUILDROOT
├── build.sh
├── RPMS
│   └── aarch64
│       └── dolphinscheduler-1.3.3-1.el7.aarch64.rpm
├── SOURCES
│   └── mysql-connector-java-5.1.47.jar
├── SPECS
└── SRPMS
    └── dolphinscheduler-1.3.3-1.el7.src.rpm
```

其中 `dolphinscheduler-1.3.3-1.el7.aarch64.rpm`（x86 服务器下则是 `dolphinscheduler-1.3.3-1.el7.x86_64.rpm`） 就是 dolphinscheduler 的 rpm ，安装后位于 `/usr/hdp/current/dolphinscheduler` 。

最后将 `dolphinscheduler-1.3.3-1.el7.aarch64.rpm` 放置于任意一个可访问的 yum 仓库路径下。

假设路径为 `/var/www/html/entry/hdp/3.1/centos7/aarch64/`，则执行如下步骤：

1.  `createrepo /var/www/html/entry/hdp/3.1/centos7` 更新 repodata
2. 更新各个节点的 yum 缓存：`yum clean all && yum makecache` 
3. 执行 `yum list dolphinscheduler` 验证是否可以看到 dolphinscheduler 的相关 rpm 包。

> NOTE：在 /var/www/html/entry/hdp/3.1/centos7/aarch64/ 多层目录中，只能其中一层有 repodata，否则会导致 yum 安装 rpm 时异常。

## 安装

如果使用外部数据库，还需要先建立 dolphinscheduler 的 database，接着进行远程授权，此处推荐统一使用 ambari 用户，假设密码为 amabri123

```sql
-- 如果使用 Postgresql，另外还需配置 Postgresql 支持远程访问
CREATE DATABASE dolphinscheduler;
GRANT ALL PRIVILEGES ON DATABASE dolphinscheduler TO ambari;

-- 如果使用 Mysql
CREATE DATABASE dolphinscheduler DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
grant all privileges on dolphinscheduler.* to 'ambari'@'%' identified by 'ambari123';
flush privileges;
```

安装 dolphinscheduler-mpack 详见顶级 README。

编译参考教程：

- [RPM Packaging Guide](https://rpm-packaging-guide.github.io/)
- [RPM打包流程、示例及常见问题](https://bbs.huaweicloud.com/forum/thread-38327-1-1.html)

