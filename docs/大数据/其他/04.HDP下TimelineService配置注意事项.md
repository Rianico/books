---
title: 04.HDP 下 TimelineService 配置注意事项
date: 2021-06-10
---

## HDP下 Timeline Service 配置注意事项

如果 Yarn 的 Timeline Service 切换为外部 Hbase，需要先关闭集群默认 ats-hbase，参考 [Remove ats-hbase before switching between clusters](https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.0.1/data-operating-system/content/remove_ats_hbase_before_switching_between_clusters.html)。

之后按照如下步骤进行切换：

1. 在 Timeline Service 所在节点备份 hbase 配置：`mv /usr/hdp/3.1.0.0-78/hadoop/conf/embedded-yarn-ats-hbase/hbase-site.xml /usr/hdp/3.1.0.0-78/hadoop/conf/embedded-yarn-ats-hbase/hbase-site.xml.bak`。

2. Yarn 服务下配置开启外部 Hbase，并修改 `hbase.master.info.bindAddress` 为外部 Hbase 所在节点。

3. Yarn 服务下修改 `zookeeper.znode.parent` 为 `hbase-unsecure`。

4. 创建 Timeline Service 所需要的 Hbase 表：

   ```bash
   export HBASE_CLASSPATH_PREFIX=/usr/hdp/current/hadoop-yarn-client/timelineservice/*;/usr/hdp/current/hbase-client/bin/hbase org.apache.hadoop.yarn.server.timelineservice.storage.TimelineSchemaCreator -Dhbase.client.retries.number=35 -create -s
   ```

5. 去 Hbase 服务下开启简单认证并重启:

   ![image-20210610224821620](https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210610224821620.png)

6. 以 hbase 超级用户启动 Hbase Shell：`sudo -u hbase hbase shell`，执行以下语句授权：

   ```sql
   grant 'yarn',  'RWXCA'
   grant 'yarn-ats',  'RWXCA'
   ```

7. 在 Timeline Service 节点上手动复制 Hbase 配置文件：`cp /etc/hbase/conf/hbase-site.xml /usr/hdp/3.1.0.0-78/hadoop/conf/embedded-yarn-ats-hbase/`。

8. 重启 Yarn。

### 安全集群环境下切换

如果是在安全集群下 timeservice 切换为外部 Hbase，还需要进行一些清理工作，参考官网链接：https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.0.1/data-operating-system/content/remove_ats_hbase_before_switching_between_clusters.html。

开启安全集群后，Ambari 默认会给 timeservice 配置内置 Hbase 的 keytab 以及 principal ，这个会导致 timeservice 与外部 Hbase 连接认证错误，需要手动修改：

1. Yarn 服务建立新的配置组。
2. 修改 Yarn 服务下的 `zookeeper.znode.parent ` 为 Hbase 的 `ZooKeeper Znode Parent `（PS：开启安全后，Hbase 的 znode 会有变化）。
3. 修改 Yarn 服务下的 Hbase 安全配置：
   - hbase.master.kerberos.principal ：hbase/_HOST@HAOHAN.COM
   - hbase.master.keytab.file ：/etc/security/keytabs/hbase.service.keytab
   - /etc/security/keytabs/hbase.service.keytab：hbase/_HOST@HAOHAN.COM
   - hbase.regionserver.keytab.file ：hbase.regionserver.keytab.file 

之后 `yarn` 以及 `yarn-ats` 的授权需要先 kinit 为 hbase 的用户：`kinit -kt /etc/security/keytabs/hbase.service.keytab  hbase/server.haohan.com@HAOHAN.COM`，然后进入 hbase shell 进行授权，或者开启 Ranger 插件，在 Ranger 中授权。

### 安全集群下 Hbase + Ranger

安全集群下，需要为 Hbase 创建一个用户，用于在 Ranger 管理 Hbase 的 repository。

这里以 Freeipa 为例，首先使用 Freeipa 创建一个 `rangerhbaselookup` 用户，密码为 `12345678` ，并要确保该用户已经同步到 Ranger 中。

接着在 Hbase 服务下配置一下几个参数：

- Enable Ranger for HBASE：勾选

- Ranger repository config user：rangerhbaselookup@example.com
- Ranger repository config password：12345678

保存并重启 Hbase 服务。

参考官网：https://docs.cloudera.com/HDPDocuments/HDP2/HDP-2.3.0/bk_Ranger_Install_Guide/content/hbase_plugin_kerberos.html。

同时发现，HDFS/HIVE 也需要进行类似配置，这一步应该是为了组件能够自动在 Ranger 建立对应的 repository。
