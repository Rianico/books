---
title: cdh 集群修改 IP 為私網 IP
date: 2020-07-22 10:57:04
---
# cdh 集群修改 IP 為私網 IP

## 设置私网地址

最近因为网络改造，需要将集群节点内部通讯方式改为私网通讯，因此需要对集群配置做出更改，过程如下：

1. cm 界面上所有服务都勾选 **通配符** 选项，开启多网卡监听。如果外部 client 仍需通过公网通信，还需设置 `dfs.client.use.datanode.hostname` 为 true 以使用 hostname 而非私网 IP 通信。（详见[HDFS Support for Multihomed Networks](https://hadoop.apache.org/docs/r2.6.0/hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html)\)

2. 暂停所有节点上的 `cloudera-scm-agent` 服务，暂停cm主节点的 `cloudera-scm-server` 服务。

3. 批量修改所有节点上的 `/etc/cloudera-scm-agent/config.ini` 配置，将 `server_host` 为cm主节点的 IP 或者 hostname（推荐）：

   ```vim
    server_host=cm.stidc.gdyd
   ```

4. 分发私网 IP 的hosts 到各节点下，记得先备份。

5. 重启直接点上的 `cloudera-scm-server-db`服务。

6. 启动 `cloudera-scm-server` 以及 `cloudera-scm-agent` 服务。

7. 重启集群。

8. cm 上查看服务器，可以发现 IP 属性已变为私网 IP。

## 绑定多网卡

从 Hadoop2.6 开始支持多网段通讯，主要是通过在 server 端绑定 host 到 0.0.0.0 ，从而能够通过不同网段进行服务/客户端之间的通信。

应用场景主要是：出于安全考虑，客户端通过公网与 Hadoop 集群进行外部通信，Hadoop 集群内部则通过内网进行数据交互，从而减少公网 IP 的占用，并且内网往往网络资源也更加充足。

具体配置可以参考：

[https://hadoop.apache.org/docs/r2.6.0/hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html](

