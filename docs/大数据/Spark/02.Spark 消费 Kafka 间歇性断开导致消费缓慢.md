---
title: Spark 消费 Kafka 间歇性断开导致消费缓慢
date: 2020-07-22 15:41:30
---
# Spark 消费 Kafka 间歇性断开导致消费缓慢

## 1. 背景

最近新部署了一个新版本（spark-core\_2.11-2.1.0.cloudera1）的 Spark Streaming 作业，发现在消费 Kafka 阶段时快时慢，如下：

![image](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/before_modify.png)

因此决定对其排查。

## 2. 分析

### 2.1 排查机器问题

点进 stage 查看运行最慢的那几个 executor，发现每次都是随机几个 executor 特别慢，并不固定，因此首先可以排除是机器问题。

### 2.2 排查数据及资源问题

查看消费缓慢时作业的各项性能指标，GC 时间并不算长，并且最慢的几个 executor 也不是 GC 时间最久的，数据分布也很均匀，因此可以排除是资源以及数据倾斜问题。

### 2.3 开启 debug 日志分析

查看 executor 日志，发现出现问题的 executor 都是在拉取 Kafka 数据的时候莫名的久，但当前Kafka集群负载非常低，继续日志，发现以下这段日志：

```vim
 2019-12-26 16:55:00,400 [Executor task launch worker for task 17610] INFO  org.apache.spark.streaming.kafka010.KafkaRDD  - Computing topic CY_HTTP_JY_XDR, partition 177 offsets 248338 -> 248701
 2019-12-26 16:55:00,401 [Executor task launch worker for task 17610] INFO  org.apache.kafka.clients.consumer.internals.AbstractCoordinator  - Marking the coordinator kafka41.nzj.gdyd:9092 (id: 2147483606 rack: null) dead for group spark-executor-CY_HTTP_JY_XDR_GROUP
 2019-12-26 16:55:00,403 [Executor task launch worker for task 17610] INFO  org.apache.kafka.clients.consumer.internals.AbstractCoordinator  - Discovered coordinator kafka41.nzj.gdyd:9092 (id: 2147483606 rack: null) for group spark-executor-CY_HTTP_JY_XDR_GROUP.
 2019-12-26 16:55:00,403 [Executor task launch worker for task 17610] INFO  org.apache.kafka.clients.consumer.internals.AbstractCoordinator  - Marking the coordinator kafka41.nzj.gdyd:9092 (id: 2147483606 rack: null) dead for group spark-executor-CY_HTTP_JY_XDR_GROUP
 2019-12-26 16:55:00,505 [Executor task launch worker for task 17610] INFO  org.apache.kafka.clients.consumer.internals.AbstractCoordinator  - Discovered coordinator kafka41.nzj.gdyd:9092 (id: 2147483606 rack: null) for group spark-executor-CY_HTTP_JY_XDR_GROUP.
```

网上很多资料都说是 Kafka 解析 IP 的问题，但 Kafka 集群已经配置了 `advertised.listener` 参数，并且每台机器的 host 配置文件都确认过没问题。因此决定对 spark 作业开启 debug 再进行观察。

开启debug后查看到如下日志：

```vim
 2019-12-26 17:40:01,539 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.NetworkClient  - Disconnecting from node 25 due to request timeout.
 2019-12-26 17:40:01,539 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient  - Cancelled FETCH request ClientRequest(expectResponse=true, callback=org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler@61159d52, request=RequestSend(header={api_key=1,api_version=2,correlation_id=19,client_id=consumer-1}, body={replica_id=-1,max_wait_time=500,min_bytes=1,topics=[{topic=CY_HTTP_JY_XDR,partitions=[{partition=198,fetch_offset=251621,max_bytes=10485760}]}]}), createdTimeMs=1577352954399, sendTimeMs=1577352954400) with correlation id 19 due to node 25 being disconnected
 2019-12-26 17:40:01,539 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.Fetcher  - Fetch failed
 org.apache.kafka.common.errors.DisconnectException
 2019-12-26 17:40:01,539 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.NetworkClient  - Sending metadata request {topics=[CY_HTTP_JY_XDR]} to node 41
 2019-12-26 17:40:01,540 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient  - Cancelled FETCH request ClientRequest(expectResponse=true, callback=org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler@7a4edeb3, request=RequestSend(header={api_key=1,api_version=2,correlation_id=20,client_id=consumer-1}, body={replica_id=-1,max_wait_time=500,min_bytes=1,topics=[{topic=CY_HTTP_JY_XDR,partitions=[{partition=198,fetch_offset=251621,max_bytes=10485760}]}]}), createdTimeMs=1577353201539, sendTimeMs=0) with correlation id 20 due to node 25 being disconnected
 2019-12-26 17:40:01,540 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.Fetcher  - Fetch failed
 org.apache.kafka.common.errors.DisconnectException
 2019-12-26 17:40:01,547 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.Metadata  - Updated cluster metadata version 3 to Cluster(nodes = [kafka25.nzj.gdyd:9092 (id: 25 rack: null), kafka24.nzj.gdyd:9092 (id: 24 rack: null), kafka34.nzj.gdyd:9092 (id: 34 rack: null), kafka9.nzj.gdyd:9092 (id: 9 rack: null), kafka36.nzj.gdyd:9092 (id: 36 rack: null), kafka37.nzj.gdyd:9092 (id: 37 rack: null), kafka3.nzj.gdyd:9092 (id: 3 rack: null), kafka44.nzj.gdyd:9092 (id: 44 rack: null), kafka4.nzj.gdyd:9092 (id: 4 rack: null), kafka10.nzj.gdyd:9092 (id: 10 rack: null), kafka1.nzj.gdyd:9092 (id: 1 rack: null), kafka20.nzj.gdyd:9092 (id: 20 rack: null), kafka38.nzj.gdyd:9092 (id: 38 rack: null), kafka22.nzj.gdyd:9092 (id: 22 rack: null), kafka23.nzj.gdyd:9092 (id: 23 rack: null), kafka39.nzj.gdyd:9092 (id: 39 rack: null), kafka12.nzj.gdyd:9092 (id: 12 rack: null), kafka41.nzj.gdyd:9092 (id: 41 rack: null), kafka28.nzj.gdyd:9092 (id: 28 rack: null), kafka2.nzj.gdyd:9092 (id: 2 rack: null), kafka15.nzj.gdyd:9092 (id: 15 rack: null), kafka19.nzj.gdyd:9092 (id: 19 rack: null), kafka27.nzj.gdyd:9092 (id: 27 rack: null), kafka18.nzj.gdyd:9092 (id: 18 rack: null), kafka42.nzj.gdyd:9092 (id: 42 rack: null), kafka33.nzj.gdyd:9092 (id: 33 rack: null), kafka43.nzj.gdyd:9092 (id: 43 rack: null), kafka40.nzj.gdyd:9092 (id: 40 rack: null), kafka5.nzj.gdyd:9092 (id: 5 rack: null), kafka31.nzj.gdyd:9092 (id: 31 rack: null), kafka6.nzj.gdyd:9092 (id: 6 rack: null), kafka26.nzj.gdyd:9092 (id: 26 rack: null), kafka14.nzj.gdyd:9092 (id: 14 rack: null), kafka8.nzj.gdyd:9092 (id: 8 rack: null), kafka30.nzj.gdyd:9092 (id: 30 rack: null), kafka29.nzj.gdyd:9092 (id: 29 rack: null), kafka16.nzj.gdyd:9092 (id: 16 rack: null), kafka7.nzj.gdyd:9092 (id: 7 rack: null), kafka35.nzj.gdyd:9092 (id: 35 rack: null), kafka11.nzj.gdyd:9092 (id: 11 rack: null), kafka21.nzj.gdyd:9092 (id: 21 rack: null), kafka17.nzj.gdyd:9092 (id: 17 rack: null), kafka32.nzj.gdyd:9092 (id: 32 rack: null)], partitions = [Partition(topic = CY_HTTP_JY_XDR, partition = 180, leader = 6, replicas = [6,44,1,], isr = [6,44,1,], Partition(topic = CY_HTTP_JY_XDR, partition = 22, leader = 15, replicas = [15,3,4,], isr = [15,3,4,], Partition(topic = CY_HTTP_JY_XDR, partition = 57, leader = 6, replicas = [6,39,40,], isr = [6,39,40,], Partition(topic = CY_HTTP_JY_XDR, partition = 59, leader = 8, replicas = [8,41,42,], isr = [8,42,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 145, leader = 6, replicas = [6,44,1,], isr = [6,44,1,], Partition(topic = CY_HTTP_JY_XDR, partition = 201, leader = 23, replicas = [23,16,17,], isr = [23,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 94, leader = 43, replicas = [43,33,34,], isr = [43,33,34,], Partition(topic = CY_HTTP_JY_XDR, partition = 4, leader = 41, replicas = [41,29,30,], isr = [29,30,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 164, leader = 25, replicas = [25,19,20,], isr = [25,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 110, leader = 15, replicas = [15,5,6,], isr = [15,5,6,], Partition(topic = CY_HTTP_JY_XDR, partition = 75, leader = 24, replicas = [24,13,14,], isr = [24,14,], Partition(topic = CY_HTTP_JY_XDR, partition = 129, leader = 34, replicas = [34,24,25,], isr = [34,24,25,], Partition(topic = CY_HTTP_JY_XDR, partition = 218, leader = 40, replicas = [40,34,35,], isr = [40,34,35,], Partition(topic = CY_HTTP_JY_XDR, partition = 40, leader = 33, replicas = [33,21,22,], isr = [33,21,22,], Partition(topic = CY_HTTP_JY_XDR, partition = 93, leader = 42, replicas = [42,32,33,], isr = [42,32,33,], Partition(topic = CY_HTTP_JY_XDR, partition = 181, leader = 7, replicas = [7,1,2,], isr = [7,1,2,], Partition(topic = CY_HTTP_JY_XDR, partition = 146, leader = 7, replicas = [7,1,2,], isr = [7,1,2,], Partition(topic = CY_HTTP_JY_XDR, partition = 202, leader = 24, replicas = [24,17,18,], isr = [24,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 56, leader = 5, replicas = [5,38,39,], isr = [5,38,39,], Partition(topic = CY_HTTP_JY_XDR, partition = 5, leader = 42, replicas = [42,30,31,], isr = [42,30,31,], Partition(topic = CY_HTTP_JY_XDR, partition = 58, leader = 7, replicas = [7,40,41,], isr = [7,40,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 6, leader = 43, replicas = [43,31,32,], isr = [43,31,32,], Partition(topic = CY_HTTP_JY_XDR, partition = 163, leader = 24, replicas = [24,18,19,], isr = [24,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 128, leader = 33, replicas = [33,23,24,], isr = [33,23,24,], Partition(topic = CY_HTTP_JY_XDR, partition = 111, leader = 16, replicas = [16,6,7,], isr = [16,6,7,], Partition(topic = CY_HTTP_JY_XDR, partition = 217, leader = 39, replicas = [39,33,34,], isr = [39,33,34,], Partition(topic = CY_HTTP_JY_XDR, partition = 76, leader = 25, replicas = [25,14,15,], isr = [25,14,15,], Partition(topic = CY_HTTP_JY_XDR, partition = 21, leader = 14, replicas = [14,2,3,], isr = [14,2,3,], Partition(topic = CY_HTTP_JY_XDR, partition = 41, leader = 34, replicas = [34,22,23,], isr = [34,22,23,], Partition(topic = CY_HTTP_JY_XDR, partition = 24, leader = 17, replicas = [17,5,6,], isr = [17,5,6,], Partition(topic = CY_HTTP_JY_XDR, partition = 178, leader = 4, replicas = [4,42,43,], isr = [4,42,43,], Partition(topic = CY_HTTP_JY_XDR, partition = 37, leader = 30, replicas = [30,18,19,], isr = [30,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 92, leader = 41, replicas = [41,31,32,], isr = [31,32,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 199, leader = 26, replicas = [26,20,21,], isr = [26,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 61, leader = 10, replicas = [10,43,44,], isr = [10,43,44,], Partition(topic = CY_HTTP_JY_XDR, partition = 55, leader = 4, replicas = [4,37,38,], isr = [4,37,38,], Partition(topic = CY_HTTP_JY_XDR, partition = 147, leader = 8, replicas = [8,2,3,], isr = [8,2,3,], Partition(topic = CY_HTTP_JY_XDR, partition = 108, leader = 3, replicas = [13,3,4,], isr = [3,4,], Partition(topic = CY_HTTP_JY_XDR, partition = 162, leader = 23, replicas = [23,17,18,], isr = [23,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 7, leader = 44, replicas = [44,32,33,], isr = [44,32,33,], Partition(topic = CY_HTTP_JY_XDR, partition = 38, leader = 31, replicas = [31,19,20,], isr = [31,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 131, leader = 36, replicas = [36,26,27,], isr = [36,26,27,], Partition(topic = CY_HTTP_JY_XDR, partition = 77, leader = 26, replicas = [26,15,16,], isr = [26,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 216, leader = 38, replicas = [38,32,33,], isr = [38,32,33,], Partition(topic = CY_HTTP_JY_XDR, partition = 179, leader = 5, replicas = [5,43,44,], isr = [5,43,44,], Partition(topic = CY_HTTP_JY_XDR, partition = 23, leader = 16, replicas = [16,4,5,], isr = [16,4,5,], Partition(topic = CY_HTTP_JY_XDR, partition = 91, leader = 40, replicas = [40,30,31,], isr = [40,30,31,], Partition(topic = CY_HTTP_JY_XDR, partition = 60, leader = 9, replicas = [9,42,43,], isr = [9,42,43,], Partition(topic = CY_HTTP_JY_XDR, partition = 200, leader = 22, replicas = [22,15,16,], isr = [22,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 54, leader = 3, replicas = [3,36,37,], isr = [3,36,37,], Partition(topic = CY_HTTP_JY_XDR, partition = 148, leader = 9, replicas = [9,3,4,], isr = [9,3,4,], Partition(topic = CY_HTTP_JY_XDR, partition = 78, leader = 27, replicas = [27,16,17,], isr = [27,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 161, leader = 22, replicas = [22,16,17,], isr = [22,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 109, leader = 14, replicas = [14,4,5,], isr = [14,4,5,], Partition(topic = CY_HTTP_JY_XDR, partition = 8, leader = 1, replicas = [1,33,34,], isr = [1,33,34,], Partition(topic = CY_HTTP_JY_XDR, partition = 130, leader = 35, replicas = [35,25,26,], isr = [35,25,26,], Partition(topic = CY_HTTP_JY_XDR, partition = 39, leader = 32, replicas = [32,20,21,], isr = [32,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 215, leader = 37, replicas = [37,31,32,], isr = [37,31,32,], Partition(topic = CY_HTTP_JY_XDR, partition = 98, leader = 3, replicas = [3,37,38,], isr = [3,37,38,], Partition(topic = CY_HTTP_JY_XDR, partition = 205, leader = 27, replicas = [27,20,21,], isr = [27,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 0, leader = 37, replicas = [37,25,26,], isr = [37,25,26,], Partition(topic = CY_HTTP_JY_XDR, partition = 176, leader = 2, replicas = [2,39,40,], isr = [2,39,40,], Partition(topic = CY_HTTP_JY_XDR, partition = 35, leader = 28, replicas = [28,16,17,], isr = [28,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 141, leader = 2, replicas = [2,40,41,], isr = [2,40,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 63, leader = 12, replicas = [12,1,2,], isr = [12,1,2,], Partition(topic = CY_HTTP_JY_XDR, partition = 18, leader = 11, replicas = [11,43,44,], isr = [11,43,44,], Partition(topic = CY_HTTP_JY_XDR, partition = 114, leader = 19, replicas = [19,9,10,], isr = [19,9,10,], Partition(topic = CY_HTTP_JY_XDR, partition = 53, leader = 2, replicas = [2,35,36,], isr = [2,35,36,], Partition(topic = CY_HTTP_JY_XDR, partition = 125, leader = 30, replicas = [30,20,21,], isr = [30,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 79, leader = 28, replicas = [28,17,18,], isr = [28,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 160, leader = 21, replicas = [21,15,16,], isr = [21,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 1, leader = 38, replicas = [38,26,27,], isr = [38,26,27,], Partition(topic = CY_HTTP_JY_XDR, partition = 142, leader = 3, replicas = [3,41,42,], isr = [3,42,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 97, leader = 2, replicas = [2,36,37,], isr = [2,36,37,], Partition(topic = CY_HTTP_JY_XDR, partition = 36, leader = 29, replicas = [29,17,18,], isr = [29,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 62, leader = 11, replicas = [11,44,1,], isr = [11,44,1,], Partition(topic = CY_HTTP_JY_XDR, partition = 177, leader = 3, replicas = [3,40,42,], isr = [3,40,42,], Partition(topic = CY_HTTP_JY_XDR, partition = 206, leader = 28, replicas = [28,21,22,], isr = [28,21,22,], Partition(topic = CY_HTTP_JY_XDR, partition = 115, leader = 20, replicas = [20,10,11,], isr = [20,10,11,], Partition(topic = CY_HTTP_JY_XDR, partition = 17, leader = 10, replicas = [10,42,43,], isr = [10,42,43,], Partition(topic = CY_HTTP_JY_XDR, partition = 124, leader = 29, replicas = [29,19,20,], isr = [29,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 159, leader = 20, replicas = [20,14,15,], isr = [20,14,15,], Partition(topic = CY_HTTP_JY_XDR, partition = 80, leader = 29, replicas = [29,18,19,], isr = [29,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 52, leader = 1, replicas = [1,34,35,], isr = [1,34,35,], Partition(topic = CY_HTTP_JY_XDR, partition = 2, leader = 39, replicas = [39,27,28,], isr = [39,27,28,], Partition(topic = CY_HTTP_JY_XDR, partition = 96, leader = 1, replicas = [1,35,36,], isr = [1,35,36,], Partition(topic = CY_HTTP_JY_XDR, partition = 143, leader = 4, replicas = [4,42,43,], isr = [4,42,43,], Partition(topic = CY_HTTP_JY_XDR, partition = 203, leader = 25, replicas = [25,18,19,], isr = [25,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 33, leader = 26, replicas = [26,14,15,], isr = [26,14,15,], Partition(topic = CY_HTTP_JY_XDR, partition = 174, leader = 35, replicas = [35,29,30,], isr = [35,29,30,], Partition(topic = CY_HTTP_JY_XDR, partition = 65, leader = 14, replicas = [14,3,4,], isr = [14,3,4,], Partition(topic = CY_HTTP_JY_XDR, partition = 127, leader = 32, replicas = [32,22,23,], isr = [32,22,23,], Partition(topic = CY_HTTP_JY_XDR, partition = 20, leader = 1, replicas = [13,1,2,], isr = [1,2,], Partition(topic = CY_HTTP_JY_XDR, partition = 112, leader = 17, replicas = [17,7,8,], isr = [17,7,8,], Partition(topic = CY_HTTP_JY_XDR, partition = 81, leader = 30, replicas = [30,19,20,], isr = [30,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 158, leader = 19, replicas = [19,13,14,], isr = [19,14,], Partition(topic = CY_HTTP_JY_XDR, partition = 51, leader = 44, replicas = [44,33,34,], isr = [44,33,34,], Partition(topic = CY_HTTP_JY_XDR, partition = 144, leader = 5, replicas = [5,43,44,], isr = [5,43,44,], Partition(topic = CY_HTTP_JY_XDR, partition = 3, leader = 40, replicas = [40,28,29,], isr = [40,28,29,], Partition(topic = CY_HTTP_JY_XDR, partition = 95, leader = 44, replicas = [44,34,35,], isr = [44,34,35,], Partition(topic = CY_HTTP_JY_XDR, partition = 204, leader = 26, replicas = [26,19,20,], isr = [26,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 64, leader = 2, replicas = [13,2,3,], isr = [2,3,], Partition(topic = CY_HTTP_JY_XDR, partition = 175, leader = 36, replicas = [36,30,31,], isr = [36,30,31,], Partition(topic = CY_HTTP_JY_XDR, partition = 34, leader = 27, replicas = [27,15,16,], isr = [27,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 219, leader = 41, replicas = [41,35,36,], isr = [41,35,36,], Partition(topic = CY_HTTP_JY_XDR, partition = 157, leader = 18, replicas = [18,12,13,], isr = [18,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 19, leader = 12, replicas = [12,44,1,], isr = [12,44,1,], Partition(topic = CY_HTTP_JY_XDR, partition = 113, leader = 18, replicas = [18,8,9,], isr = [18,8,9,], Partition(topic = CY_HTTP_JY_XDR, partition = 126, leader = 31, replicas = [31,21,22,], isr = [31,21,22,], Partition(topic = CY_HTTP_JY_XDR, partition = 50, leader = 43, replicas = [43,32,33,], isr = [43,32,33,], Partition(topic = CY_HTTP_JY_XDR, partition = 82, leader = 31, replicas = [31,20,21,], isr = [31,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 83, leader = 32, replicas = [32,21,22,], isr = [32,21,22,], Partition(topic = CY_HTTP_JY_XDR, partition = 49, leader = 42, replicas = [42,31,32,], isr = [42,31,32,], Partition(topic = CY_HTTP_JY_XDR, partition = 192, leader = 19, replicas = [19,12,14,], isr = [19,12,14,], Partition(topic = CY_HTTP_JY_XDR, partition = 103, leader = 8, replicas = [8,42,43,], isr = [8,42,43,], Partition(topic = CY_HTTP_JY_XDR, partition = 153, leader = 14, replicas = [14,8,9,], isr = [14,8,9,], Partition(topic = CY_HTTP_JY_XDR, partition = 14, leader = 7, replicas = [7,39,40,], isr = [7,39,40,], Partition(topic = CY_HTTP_JY_XDR, partition = 188, leader = 15, replicas = [15,8,9,], isr = [15,8,9,], Partition(topic = CY_HTTP_JY_XDR, partition = 118, leader = 23, replicas = [23,13,14,], isr = [23,14,], Partition(topic = CY_HTTP_JY_XDR, partition = 67, leader = 16, replicas = [16,5,6,], isr = [16,5,6,], Partition(topic = CY_HTTP_JY_XDR, partition = 31, leader = 24, replicas = [24,12,13,], isr = [24,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 138, leader = 43, replicas = [43,37,38,], isr = [43,37,38,], Partition(topic = CY_HTTP_JY_XDR, partition = 210, leader = 32, replicas = [32,25,26,], isr = [32,25,26,], Partition(topic = CY_HTTP_JY_XDR, partition = 173, leader = 34, replicas = [34,28,29,], isr = [34,28,29,], Partition(topic = CY_HTTP_JY_XDR, partition = 84, leader = 33, replicas = [33,22,23,], isr = [33,22,23,], Partition(topic = CY_HTTP_JY_XDR, partition = 48, leader = 41, replicas = [41,30,31,], isr = [30,31,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 13, leader = 6, replicas = [6,38,39,], isr = [6,38,39,], Partition(topic = CY_HTTP_JY_XDR, partition = 154, leader = 15, replicas = [15,9,10,], isr = [15,9,10,], Partition(topic = CY_HTTP_JY_XDR, partition = 102, leader = 7, replicas = [7,41,42,], isr = [7,42,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 193, leader = 20, replicas = [20,14,15,], isr = [20,14,15,], Partition(topic = CY_HTTP_JY_XDR, partition = 189, leader = 16, replicas = [16,9,10,], isr = [16,9,10,], Partition(topic = CY_HTTP_JY_XDR, partition = 137, leader = 42, replicas = [42,36,37,], isr = [42,36,37,], Partition(topic = CY_HTTP_JY_XDR, partition = 209, leader = 31, replicas = [31,24,25,], isr = [31,24,25,], Partition(topic = CY_HTTP_JY_XDR, partition = 119, leader = 24, replicas = [24,14,15,], isr = [24,14,15,], Partition(topic = CY_HTTP_JY_XDR, partition = 66, leader = 15, replicas = [15,4,5,], isr = [15,4,5,], Partition(topic = CY_HTTP_JY_XDR, partition = 32, leader = 25, replicas = [25,13,14,], isr = [25,14,], Partition(topic = CY_HTTP_JY_XDR, partition = 101, leader = 6, replicas = [6,40,41,], isr = [6,40,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 172, leader = 33, replicas = [33,27,28,], isr = [33,27,28,], Partition(topic = CY_HTTP_JY_XDR, partition = 190, leader = 17, replicas = [17,10,11,], isr = [17,10,11,], Partition(topic = CY_HTTP_JY_XDR, partition = 155, leader = 16, replicas = [16,10,11,], isr = [16,10,11,], Partition(topic = CY_HTTP_JY_XDR, partition = 47, leader = 40, replicas = [40,29,30,], isr = [40,29,30,], Partition(topic = CY_HTTP_JY_XDR, partition = 85, leader = 34, replicas = [34,23,24,], isr = [34,23,24,], Partition(topic = CY_HTTP_JY_XDR, partition = 186, leader = 12, replicas = [12,6,7,], isr = [12,6,7,], Partition(topic = CY_HTTP_JY_XDR, partition = 116, leader = 21, replicas = [21,11,12,], isr = [21,11,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 16, leader = 9, replicas = [9,41,42,], isr = [9,42,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 70, leader = 19, replicas = [19,8,9,], isr = [19,8,9,], Partition(topic = CY_HTTP_JY_XDR, partition = 69, leader = 18, replicas = [18,7,8,], isr = [18,7,8,], Partition(topic = CY_HTTP_JY_XDR, partition = 140, leader = 1, replicas = [1,39,40,], isr = [1,39,40,], Partition(topic = CY_HTTP_JY_XDR, partition = 208, leader = 30, replicas = [30,23,24,], isr = [30,23,24,], Partition(topic = CY_HTTP_JY_XDR, partition = 29, leader = 22, replicas = [22,10,11,], isr = [22,10,11,], Partition(topic = CY_HTTP_JY_XDR, partition = 100, leader = 5, replicas = [5,39,40,], isr = [5,39,40,], Partition(topic = CY_HTTP_JY_XDR, partition = 171, leader = 32, replicas = [32,26,27,], isr = [32,26,27,], Partition(topic = CY_HTTP_JY_XDR, partition = 191, leader = 18, replicas = [18,11,12,], isr = [18,11,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 156, leader = 17, replicas = [17,11,12,], isr = [17,11,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 46, leader = 39, replicas = [39,28,29,], isr = [39,28,29,], Partition(topic = CY_HTTP_JY_XDR, partition = 117, leader = 22, replicas = [22,12,13,], isr = [22,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 15, leader = 8, replicas = [8,40,41,], isr = [8,40,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 187, leader = 14, replicas = [14,7,8,], isr = [14,7,8,], Partition(topic = CY_HTTP_JY_XDR, partition = 139, leader = 44, replicas = [44,38,39,], isr = [44,38,39,], Partition(topic = CY_HTTP_JY_XDR, partition = 30, leader = 23, replicas = [23,11,12,], isr = [23,11,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 68, leader = 17, replicas = [17,6,7,], isr = [17,6,7,], Partition(topic = CY_HTTP_JY_XDR, partition = 207, leader = 29, replicas = [29,22,23,], isr = [29,22,23,], Partition(topic = CY_HTTP_JY_XDR, partition = 86, leader = 35, replicas = [35,24,25,], isr = [35,24,25,], Partition(topic = CY_HTTP_JY_XDR, partition = 99, leader = 4, replicas = [4,38,39,], isr = [4,38,39,], Partition(topic = CY_HTTP_JY_XDR, partition = 170, leader = 31, replicas = [31,25,26,], isr = [31,25,26,], Partition(topic = CY_HTTP_JY_XDR, partition = 72, leader = 21, replicas = [21,10,11,], isr = [21,10,11,], Partition(topic = CY_HTTP_JY_XDR, partition = 184, leader = 10, replicas = [10,4,5,], isr = [10,4,5,], Partition(topic = CY_HTTP_JY_XDR, partition = 214, leader = 36, replicas = [36,29,30,], isr = [36,29,30,], Partition(topic = CY_HTTP_JY_XDR, partition = 133, leader = 38, replicas = [38,32,33,], isr = [38,32,33,], Partition(topic = CY_HTTP_JY_XDR, partition = 45, leader = 38, replicas = [38,27,28,], isr = [38,27,28,], Partition(topic = CY_HTTP_JY_XDR, partition = 10, leader = 3, replicas = [3,35,36,], isr = [3,35,36,], Partition(topic = CY_HTTP_JY_XDR, partition = 107, leader = 12, replicas = [12,2,3,], isr = [12,2,3,], Partition(topic = CY_HTTP_JY_XDR, partition = 196, leader = 23, replicas = [23,17,18,], isr = [23,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 149, leader = 10, replicas = [10,4,5,], isr = [10,4,5,], Partition(topic = CY_HTTP_JY_XDR, partition = 27, leader = 20, replicas = [20,8,9,], isr = [20,8,9,], Partition(topic = CY_HTTP_JY_XDR, partition = 169, leader = 30, replicas = [30,24,25,], isr = [30,24,25,], Partition(topic = CY_HTTP_JY_XDR, partition = 87, leader = 36, replicas = [36,25,26,], isr = [36,25,26,], Partition(topic = CY_HTTP_JY_XDR, partition = 134, leader = 39, replicas = [39,33,34,], isr = [39,33,34,], Partition(topic = CY_HTTP_JY_XDR, partition = 122, leader = 27, replicas = [27,17,18,], isr = [27,17,18,], Partition(topic = CY_HTTP_JY_XDR, partition = 185, leader = 11, replicas = [11,5,6,], isr = [11,5,6,], Partition(topic = CY_HTTP_JY_XDR, partition = 71, leader = 20, replicas = [20,9,10,], isr = [20,9,10,], Partition(topic = CY_HTTP_JY_XDR, partition = 44, leader = 37, replicas = [37,26,27,], isr = [37,26,27,], Partition(topic = CY_HTTP_JY_XDR, partition = 132, leader = 37, replicas = [37,31,32,], isr = [37,31,32,], Partition(topic = CY_HTTP_JY_XDR, partition = 197, leader = 24, replicas = [24,18,19,], isr = [24,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 106, leader = 11, replicas = [11,1,2,], isr = [11,1,2,], Partition(topic = CY_HTTP_JY_XDR, partition = 9, leader = 2, replicas = [2,34,35,], isr = [2,34,35,], Partition(topic = CY_HTTP_JY_XDR, partition = 150, leader = 11, replicas = [11,5,6,], isr = [11,5,6,], Partition(topic = CY_HTTP_JY_XDR, partition = 28, leader = 21, replicas = [21,9,10,], isr = [21,9,10,], Partition(topic = CY_HTTP_JY_XDR, partition = 88, leader = 37, replicas = [37,27,28,], isr = [37,27,28,], Partition(topic = CY_HTTP_JY_XDR, partition = 198, leader = 25, replicas = [25,19,20,], isr = [25,19,20,], Partition(topic = CY_HTTP_JY_XDR, partition = 168, leader = 29, replicas = [29,23,24,], isr = [29,23,24,], Partition(topic = CY_HTTP_JY_XDR, partition = 213, leader = 35, replicas = [35,28,29,], isr = [35,28,29,], Partition(topic = CY_HTTP_JY_XDR, partition = 123, leader = 28, replicas = [28,18,19,], isr = [28,18,19,], Partition(topic = CY_HTTP_JY_XDR, partition = 43, leader = 36, replicas = [36,24,25,], isr = [36,24,25,], Partition(topic = CY_HTTP_JY_XDR, partition = 74, leader = 23, replicas = [23,12,13,], isr = [23,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 182, leader = 8, replicas = [8,2,3,], isr = [8,2,3,], Partition(topic = CY_HTTP_JY_XDR, partition = 151, leader = 12, replicas = [12,6,7,], isr = [12,6,7,], Partition(topic = CY_HTTP_JY_XDR, partition = 105, leader = 10, replicas = [10,44,1,], isr = [10,44,1,], Partition(topic = CY_HTTP_JY_XDR, partition = 194, leader = 21, replicas = [21,15,16,], isr = [21,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 12, leader = 5, replicas = [5,37,38,], isr = [5,37,38,], Partition(topic = CY_HTTP_JY_XDR, partition = 25, leader = 18, replicas = [18,6,7,], isr = [18,6,7,], Partition(topic = CY_HTTP_JY_XDR, partition = 167, leader = 28, replicas = [28,22,23,], isr = [28,22,23,], Partition(topic = CY_HTTP_JY_XDR, partition = 89, leader = 38, replicas = [38,28,29,], isr = [38,28,29,], Partition(topic = CY_HTTP_JY_XDR, partition = 212, leader = 34, replicas = [34,27,28,], isr = [34,27,28,], Partition(topic = CY_HTTP_JY_XDR, partition = 136, leader = 41, replicas = [41,35,36,], isr = [35,36,41,], Partition(topic = CY_HTTP_JY_XDR, partition = 120, leader = 25, replicas = [25,15,16,], isr = [25,15,16,], Partition(topic = CY_HTTP_JY_XDR, partition = 42, leader = 35, replicas = [35,23,24,], isr = [35,23,24,], Partition(topic = CY_HTTP_JY_XDR, partition = 73, leader = 22, replicas = [22,11,12,], isr = [22,11,12,], Partition(topic = CY_HTTP_JY_XDR, partition = 183, leader = 9, replicas = [9,3,4,], isr = [9,3,4,], Partition(topic = CY_HTTP_JY_XDR, partition = 152, leader = 7, replicas = [13,7,8,], isr = [7,8,], Partition(topic = CY_HTTP_JY_XDR, partition = 104, leader = 9, replicas = [9,43,44,], isr = [9,43,44,], Partition(topic = CY_HTTP_JY_XDR, partition = 11, leader = 4, replicas = [4,36,37,], isr = [4,36,37,], Partition(topic = CY_HTTP_JY_XDR, partition = 165, leader = 26, replicas = [26,20,21,], isr = [26,20,21,], Partition(topic = CY_HTTP_JY_XDR, partition = 195, leader = 22, replicas = [22,16,17,], isr = [22,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 166, leader = 27, replicas = [27,21,22,], isr = [27,21,22,], Partition(topic = CY_HTTP_JY_XDR, partition = 26, leader = 19, replicas = [19,7,8,], isr = [19,7,8,], Partition(topic = CY_HTTP_JY_XDR, partition = 90, leader = 39, replicas = [39,29,30,], isr = [39,29,30,], Partition(topic = CY_HTTP_JY_XDR, partition = 211, leader = 33, replicas = [33,26,27,], isr = [33,26,27,], Partition(topic = CY_HTTP_JY_XDR, partition = 121, leader = 26, replicas = [26,16,17,], isr = [26,16,17,], Partition(topic = CY_HTTP_JY_XDR, partition = 135, leader = 40, replicas = [40,34,35,], isr = [40,34,35,]])
 2019-12-26 17:40:01,547 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient  - Cancelled FETCH request ClientRequest(expectResponse=true, callback=org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler@4ffef880, request=RequestSend(header={api_key=1,api_version=2,correlation_id=22,client_id=consumer-1}, body={replica_id=-1,max_wait_time=500,min_bytes=1,topics=[{topic=CY_HTTP_JY_XDR,partitions=[{partition=198,fetch_offset=251621,max_bytes=10485760}]}]}), createdTimeMs=1577353201540, sendTimeMs=0) with correlation id 22 due to node 25 being disconnected
 2019-12-26 17:40:01,547 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.Fetcher  - Fetch failed
 org.apache.kafka.common.errors.DisconnectException
 2019-12-26 17:40:41,562 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient  - Cancelled FETCH request ClientRequest(expectResponse=true, callback=org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient$RequestFutureCompletionHandler@5eed4655, request=RequestSend(header={api_key=1,api_version=2,correlation_id=23,client_id=consumer-1}, body={replica_id=-1,max_wait_time=500,min_bytes=1,topics=[{topic=CY_HTTP_JY_XDR,partitions=[{partition=198,fetch_offset=251621,max_bytes=10485760}]}]}), createdTimeMs=1577353201547, sendTimeMs=0) with correlation id 23 due to node 25 being disconnected
 2019-12-26 17:40:41,562 [Executor task launch worker for task 1310] DEBUG org.apache.kafka.clients.consumer.internals.Fetcher  - Fetch failed
 org.apache.kafka.common.errors.DisconnectException
```

可以发现，Spark 消费 Kafka 的时候，总是会报 `Disconnecting from node 25 due to request timeout.` 错误，之后导致 Fetch 失败，这个过程起码持续 40s 之久。

进入 `NetworkClient` 查看源码，发现 Kafka 判断连接超时的代码如下：

```java
private void handleTimedOutRequests(List<ClientResponse> responses, long now) {
    List<String> nodeIds = this.inFlightRequests.getNodesWithTimedOutRequests(now, this.requestTimeoutMs);
    for (String nodeId : nodeIds) {
        // close connection to the node
        this.selector.close(nodeId);
        log.debug("Disconnecting from node {} due to request timeout.", nodeId);
        processDisconnection(responses, nodeId, now);
    }
    // we disconnected, so we should probably refresh our metadata
    if (nodeIds.size() > 0)
        metadataUpdater.requestUpdate();
}
```

`this.inFlightRequests.getNodesWithTimedOutRequests(now, this.requestTimeoutMs)` 会返回超时节点，因此继续查看该方法中的代码：

```java
public List<String> getNodesWithTimedOutRequests(long now, int requestTimeout) {
    List<String> nodeIds = new LinkedList<String>();
    for (String nodeId : requests.keySet()) {
        if (inFlightRequestCount(nodeId) > 0) {
            ClientRequest request = requests.get(nodeId).peekLast();
            long timeSinceSend = now - request.sendTimeMs();
            if (timeSinceSend > requestTimeout) {
                nodeIds.add(nodeId);
            }
        }
    }
    return nodeIds;
}
```

从代码 `long timeSinceSend = now - request.sendTimeMs();` 可以看出，会先求一个当前时间与上一次发送请求的时间间隔，并与 `requestTimeout` 进行比较，超过 `requestTimeout` 则判断为超时。

一层层追踪，最终定位到 `CommonClientConfigs` ，可以看到 `requestTimeout` 是由以下参数确定的：

```vim
 public static final String REQUEST_TIMEOUT_MS_CONFIG = "request.timeout.ms";
```

然后在 `org.apache.kafka.clients.consumer.ConsumerConfig` 中可以看到一个静态代码块指定了默认值：

```java
static {
    CONFIG = new ConfigDef().define(BOOTSTRAP_SERVERS_CONFIG,
                                    Type.LIST,
                                    Importance.HIGH,
                                    CommonClientConfigs.BOOSTRAP_SERVERS_DOC)
        .define(GROUP_ID_CONFIG, Type.STRING, "", Importance.HIGH, GROUP_ID_DOC)
        // ...省略部分代码
        .define(REQUEST_TIMEOUT_MS_CONFIG,
                Type.INT,
                40 * 1000,
                atLeast(0),
                Importance.MEDIUM,
                REQUEST_TIMEOUT_MS_DOC)
        //...省略部分代码
```

也就是默认 40s ，然而我们的作业间隔为 5min ，在闲时可能 1~2 分钟就跑完了，此时新的 batch 开始时 Consumer 减去上次发送 request 的时间戳就会大于 40s 。因此将 Consumer 的  `request.timeout.ms` 设定为 5min ，重启作业观察，问题解决。

![image](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/after_modify.png)

## 3. 总结

这次排查花费了较长时间，源于对源码并不是太熟悉，同时在 Spark 官方文档有这么一段话：

> For possible kafkaParams, see [Kafka consumer config docs](http://kafka.apache.org/documentation.html#newconsumerconfigs). If your Spark batch duration is larger than the default Kafka heartbeat session timeout \(30 seconds\), increase heartbeat.interval.ms and session.timeout.ms appropriately. For batches larger than 5 minutes, this will require changing group.max.session.timeout.ms on the broker. Note that the example sets enable.auto.commit to false, for discussion see [Storing Offsets](https://spark.apache.org/docs/latest/streaming-kafka-0-10-integration.html#storing-offsets) below.

大意是在作业的间隔超过 5min 的时候，需要适当调大`heartbeat.interval.ms`  和 `session.timeout.ms` ，虽然没有提到 `request.timeout.ms` 要调整，但是一般调整 `session.timeout.ms` 的时候也会涉及到这个参数。

