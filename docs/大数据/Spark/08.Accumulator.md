---
title: 08.Accumulator
date: 2021-05-11
---

## Accumulator

自定义的一套 Accumulator 使用方式，但将下标以及枚举类强绑定在了一起，后续仍需考虑改进（如使用 map）。

创建枚举类，枚举类关联业务含义

```java
/**
 * 计数器枚举类
 *
 * @author zhengxuankun
 */
public enum Accumulation {
    // 字段长度错误数
    FiledLenErrorCount(0),
    // 消费Message数
    ConsumeMessageCount(1);
    private int idx;
    Accumulation(int idx) {
        this.idx = idx;
    }
    public int idx() {
        return this.idx;
    }
}
```

定义 AccmulatorExtension 提供扩展辅助功能

```scala
import org.apache.spark.util.LongAccumulator
/**
 * @author: zhengxuankun
 * @create: 2020-03-23 17:20
 * @description: ${description}
 */
package object AccmulatorExtension {
  /**
   * 扩展LongAccumulator
   *
   * @param acc
   */
  implicit class longAccumulator(acc: LongAccumulator) {
    def increaseOne = acc.add(1L)
    def increaseTwo = acc.add(2L)
    def increaseThree = acc.add(3L)
    def increaseFour = acc.add(4L)
    def result: String = {
      acc.name.getOrElse("Undefined") + ":" + acc.value
    }
  }
}
```

定义 Accumulator 工具类

```scala
import org.apache.spark.SparkContext
import org.apache.spark.util.LongAccumulator
/**
 * @author: zhengxuankun
 * @create: 2020-03-31 15:36
 * @description: ${description}
 */
object AccumulatorUtil {
  import AccmulatorExtension._
  /**
   * 初始化accumulator
   *
   * @param sc
   * @return
   */
  def initLongAccArray(sc: SparkContext): Array[LongAccumulator] = {
    Accumulation.values().map(acc => sc.longAccumulator(acc.name))
  }
  /**
   * 计数器 + 1
   *
   * @param accArray
   * @param accumulation
   */
  def increaseOne(accArray: Array[LongAccumulator], accumulation: Accumulation) = {
    accArray(accumulation.idx).increaseOne
  }
  /**
   * 计数器 + 指定value
   *
   * @param accArray
   * @param accumulation
   * @param value
   */
  def increase(accArray: Array[LongAccumulator], accumulation: Accumulation, value: Long) = {
    accArray(accumulation.idx).add(value)
  }
  def toString(accmulators: Array[LongAccumulator]): String = {
    accmulators.map(_.result).mkString("\n")
  }
  /**
   * 清空指定计数器
   *
   * @param accArray
   * @param accumulation
   */
  def clear(accArray: Array[LongAccumulator], accumulation: Accumulation): Unit = {
    accArray(accumulation.idx()).reset()
  }
  /**
   * 获取指定 accumulator
   */
  def get(accArray: Array[LongAccumulator], accumulation: Accumulation): LongAccumulator = {
    accArray(accumulation.idx())
  }
  /**
   * 清空所有计数器
   *
   * @param accArray
   */
  def clearall(accArray: Array[LongAccumulator]): Unit = {
    accArray.foreach(_.reset())
  }
}
```

使用方式：

```scala
...
rdd.foreachRDD((rdd, time) => {
	// accumulator
	val accumulators: Array[LongAccumulator] = AccumulatorUtil.initLongAccArray(sc) 
    ...
    rdd.mapPartitions { ite => {
        val _accumulators = accumulators
    	AccumulatorUtil.increaseOne(_accumulators, Accumulation.FiledLenErrorCount)
        ...
    }}
    ...
}
```

