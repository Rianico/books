---
title: 15. 编译 Spark 发布包
date: 2021-08-16
---

## 编译 Spark 发布包

Spark 在源码包提供了 `./dev/make-distribution.sh` 用于构建 Spark 发布包，并且还可以指定各个组件，组件版本，例如：

```bash
# 指定 hadoop2.6.0-cdh5.12.1 
./dev/make-distribution.sh --name hadoop2.6.0-cdh5.12.1 --tgz -Phive -Phive-thriftserver -Pyarn -Dhadoop.version=2.6.0-cdh5.12.1
```

还可以添加额外支持：

- –pip： 添加 python 支持
- -r： 添加 R 支持

由于国内网络环境问题，还有许多地方需要修改。

### 1. make-distribution 文件

这个文件有段代码会下载一个 maven 插件：`maven-help-plugin`，在没有修改 maven 镜像的时候巨慢无比，可以通过见下面代码改为手动赋值：

```bash
# 需要修改的代码
VERSION=$("$MVN" help:evaluate -Dexpression=project.version $@ 2>/dev/null\
| grep -v "INFO"\
| grep -v "WARNING"\
| tail -n 1)
SCALA_VERSION=$("$MVN" help:evaluate -Dexpression=scala.binary.version $@ 2>/dev/null\
| grep -v "INFO"\
| grep -v "WARNING"\
| tail -n 1)
SPARK_HADOOP_VERSION=$("$MVN" help:evaluate -Dexpression=hadoop.version $@ 2>/dev/null\
| grep -v "INFO"\
| grep -v "WARNING"\
| tail -n 1)
SPARK_HIVE=$("$MVN" help:evaluate -Dexpression=project.activeProfiles -pl sql/hive $@ 2>/dev/null\
| grep -v "INFO"\
| grep -v "WARNING"\
| fgrep --count "<id>hive</id>";\
# Reset exit status to 0, otherwise the script stops here if the last grep finds nothing\
# because we use "set -o pipefail"
echo -n)

# 修改为
VERSION=3.0.3
SCALA_VERSION=2.12
SPARK_HADOOP_VERSION=2.6.0-cdh5.12.1
SPARK_HIVE=1
```

### 2. pom 文件

maven 里的仓库地址配置了谷歌以及 Maven 官方的仓库，国内是基本拉不了的，将 `<repositories/>` 标签内的替换为如下内容：

```xml
        <repository>
                <id>public</id>
                    <url>https://maven.aliyun.com/repository/public</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
        <repository>
                <id>apache</id>
                    <url>https://maven.aliyun.com/repository/apache-snapshots</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
        <repository>
                <id>jcenter</id>
                    <url>https://maven.aliyun.com/repository/jcenter</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
        <repository>
                <id>spring</id>
                    <url>https://maven.aliyun.com/repository/spring</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
        <repository>
                <id>spring-plugin</id>
                    <url>https://maven.aliyun.com/repository/spring-plugin</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
        <repository>
                <id>gradle-plugin</id>
                    <url>https://maven.aliyun.com/repository/gradle-plugin</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
        </repository>
		<repository>
				<id>cloudera</id>
				<url>https://repository.cloudera.com/artifactory/cloudera-repos/</url>
		</repository>
```

并将 `<pluginRepositories/>`  里 id 为 `gcs-maven-central-mirror` 以及 `central` 的 `<pluginRepository/>` 删除。
