---
title: 13. Spark解析json
date: 2021-06-29
---

## Spark 解析 Json

Spark 解析 json 的方式十分简单，如下：

```scala
val jsonstr = "xxx"
val df = spark.read.json(sc.parallel(jsonstr::Nil))
```

在实际场景中，经常遇到 Spark 需要解析某个元素，并将其打平为多行的场景，并且还经常是不定数量。

Spark SQL 中提供了一个  explode 函数用于打平数组，因此我们可以考虑将其转化为数组后使用 explode 实现业务要求。但存在一个问题，就是如果 array 中，key 值不是固定的，那么 array 里的全部元素会被 Spark 解析为一个 Struct，因此最佳实践时不要将业务值作为 key 值。

对于 array 里 key 值统一的 json，Spark 能够按照预期的 Struct 进行解析：

```scala
val jsonstr = """{
  "name": "John",
  "age": 30,
  "bike": [
    {
      "key": "key1",
      "value": [
        "Dominor1",
        "Dominor2"
      ]
    },
    {
      "key": "key2",
      "value": [
        "Pulsar1",
        "Pulsar2"
      ]
    }
  ]
}"""

val df = spark.read.json(sc.parallelize(jsonstr::Nil))

df.select($"bike").printSchema
root
 |-- bike: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- key: string (nullable = true)
 |    |    |-- value: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)

df.select(explode($"bike")).show
+--------------------+
|                 col|
+--------------------+
|[key1, [Dominor1,...|
|[key2, [Pulsar1, ...|
+--------------------+
```

对于 array 里 key 值不统一的 json，Spark 只能将所有出现过的 key 值合并到 Struct 中应用到每一行，value 也合并为一个数组，对应不上 key 的则留空，但 value 格式仍为原来的格式：

```scala
val jsonstr = """{
  "name": "John",
  "age": 30,
  "bike": [
    {
      "key1": "key1",
      "value1": [
        "Dominor1",
        "Dominor2"
      ]
    },
    {
      "key2": "key2",
      "value2": [
        "Pulsar1",
        "Pulsar2"
      ]
    }
  ]
}"""

val df = spark.read.json(sc.parallelize(jsonstr::Nil))

df.select($"bike").printSchema
root
 |-- bike: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- key: string (nullable = true)
 |    |    |-- key2: string (nullable = true)
 |    |    |-- value: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)
 |    |    |-- value2: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)

df.select(explode($"bike")).printSchema
root
 |-- col: struct (nullable = true)
 |    |-- key: string (nullable = true)
 |    |-- key2: string (nullable = true)
 |    |-- value: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- value2: array (nullable = true)
 |    |    |-- element: string (containsNull = true)

df.select(explode($"bike")).show(false)
+------------------------------+
|col                           |
+------------------------------+
|[key1,, [Dominor1, Dominor2],]|
|[, key2,, [Pulsar1, Pulsar2]] |
+------------------------------+
```

