---
title: JMH - Java 微基准测试框架
date: 2020-07-22 10:57:05
---
# JMH - Java 微基准测试框架

JMH 是 Java Microbenchmark Harness（微基准测试）框架的缩写，可以用于 Java 性能测试。

详细用法参照:

* 语法：[http://www.jiangxinlingdu.com/practice/2019/06/05/jmh.html](http://www.jiangxinlingdu.com/practice/2019/06/05/jmh.html)
* 进阶：[https://www.cnkirito.moe/java-jmh/](https://www.cnkirito.moe/java-jmh/)

使用 JMH 有很多注意事项，比如 死码消除、循环、内联等。

```java
package my.zxk;

import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.infra.Blackhole;
import org.openjdk.jmh.runner.Runner;
import org.openjdk.jmh.runner.RunnerException;
import org.openjdk.jmh.runner.options.Options;
import org.openjdk.jmh.runner.options.OptionsBuilder;

import java.util.Deque;
import java.util.LinkedList;
import java.util.concurrent.TimeUnit;

/**
 * @author zxk
 * @date 2020年05月02日 11:20:00
 */
// 代码预热5轮，每轮间隔1s
@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)
// 预热结束后执行5轮测试，每轮测试间隔1s
@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)
// 测试校准为每个操作耗时
@BenchmarkMode({Mode.AverageTime})
// 输出结果的时间粒度
@OutputTimeUnit(TimeUnit.MILLISECONDS)
// 作用域范围
@State(Scope.Thread)
public class JmhTest {

    @Param({"100", "1000", "10000"})
    int size;
    int[] xs;
    LiteList lite = new LiteList<Integer>();
    LinkedList link = new LinkedList<Integer>();

    @Setup
    public void setup() {
        link.clear();
        lite.clear();
        xs = new int[size];
        for (int c = 0; c < size; c++) {
            xs[c] = c;
        }
    }

    static boolean work(Deque<Integer> queue, int value) {
        return queue.add(value);
    }

    @Benchmark
    public void liteListTest_100(Blackhole hole) {
        for (int x : xs) {
            hole.consume(work(lite, x));
        }
    }

    @Benchmark
    public void linkedListTest_100(Blackhole hole) {
        for (int x : xs) {
            hole.consume(work(link, x));
        }
    }

    public static void main(String[] args) throws RunnerException {
        Options opt = new OptionsBuilder()
                .include(JmhTest.class.getSimpleName())
                .forks(3)    // 每个Benchmark都fork出3个一样的环境进行测试
                .build();
        new Runner(opt).run();
    }

}

```

