---
title: StringBuilder 的一些使用事项
date: 2020-07-20 17:45:41
---
# StringBuilder 的一些使用事项

关于StringBuilder，有几个需要注意的使用特性： 

1. **非线程安全\(重要\)**，使用到StringBuffer的场景很少，因为几个线程轮流append的场景以目前的工作经验来看并没遇到，而且方法间并不保障线程安全。

```scala
object PathUtil {

    val buffer = new StringBuffer()

    def buildPath(time: String): String = {
      // 多线程调用buildPath时，append之间的操作也不是线程安全的
      buffer.append(time)
      buffer.append(time)
      buffer.toString()
    }

}
```

2. Java中**一次性**使用多个`+`拼接字符串时，会自动优化为**一个**`StringBUilder()`拼接多个字符串，分为多条语句使用`+`则会有多个StringBilder\(可查看编译后的字节码\)。

3. 设定好`StringBuilder(int length)`的初始长度，可以避免发生内部`char[]`数组发生扩容（类似ArrayList扩容）。**eg：假如使用StringBuilder的默认长度，会为129长度的字符串拼接，合共申请625字符的数组**。

4. 重用StringBuilder\(\)，可以使用`clear()`方法，进行重用，StringBuilder的toString\(\)源码为`return new String(value, 0, count)`，clear\(\)方法本质上是将count置为0。重用的时候要注意线程安全，使用ThreadLocal，但要权衡使用的代价。

此处可以参考BigDecimal源码的写法：

```java
public class BigDecimal extends Number implements Comparable<BigDecimal> {

    // ......

    private static final ThreadLocal<StringBuilderHelper>
            threadLocalStringBuilderHelper = new ThreadLocal<StringBuilderHelper>() {
            @Override
            protected StringBuilderHelper initialValue() {
                return new StringBuilderHelper();
            }
    };

    // ......
}
```

**参考**：

* [StringBuilder在高性能场景下的正确用法](http://calvin1978.blogcn.com/articles/stringbuilder.html)
* [springside/springside4](https://github.com/springside/springside4/blob/master/modules/utils/src/main/java/org/springside/modules/utils/text/StringBuilderHolder.java)

