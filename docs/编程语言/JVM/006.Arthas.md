---
title: 006.Arthas
date: 2021-06-23
---

## Arthas

`Arthas` 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。在线排查问题，无需重启；动态跟踪 Java 代码；实时监控 JVM 状态。

`Arthas` 支持JDK 6+，支持Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 `Tab` 自动补全功能，进一步方便进行问题的定位和诊断。

- Github: https://github.com/alibaba/arthas
- 文档: https://arthas.aliyun.com/doc/
- 官方教程：[Java 诊断工具 Arthas 入门教程](https://start.aliyun.com/course?spm=a2ck6.17690074.0.0.241e2e7d4XgYyy&id=qDlgqpBT)

## 1. Quick Start

首先启动一个不断打印随机数的 Java 进程：

```bash
wget https://arthas.aliyun.com/arthas-demo.jar;java -jar arthas-demo.jar
```

下载`arthas-boot.jar`，再用`java -jar`命令启动 Arthas：

```bash
wget https://arthas.aliyun.com/arthas-boot.jar;java -jar arthas-boot.jar
```

`arthas-boot`是`Arthas`的启动程序，它启动后，会列出所有的Java进程，用户可以输入序号选择需要诊断的目标进程。

选择好目标进程后，就会进入与该进程的交互式节点，输入 help 获取帮助，也可以输入 dashboard 查看进程面板：

```bash
ID  NAME                     GROUP       PRIORIT STATE   %CPU    DELTA_TI TIME    INTERRU DAEMON  
-1  C2 CompilerThread0       -           -1      -       0.21    0.010    0:0.673 false   true    
-1  VM Periodic Task Thread  -           -1      -       0.09    0.004    0:0.246 false   true    
22  Timer-for-arthas-dashboa system      5       RUNNABL 0.08    0.004    0:0.127 false   true    
-1  C1 CompilerThread1       -           -1      -       0.07    0.003    0:0.584 false   true    
20  arthas-NettyHttpTelnetBo system      5       RUNNABL 0.03    0.001    0:0.148 false   true    
1   main                     main        5       TIMED_W 0.02    0.001    0:0.156 false   false   
-1  VM Thread                -           -1      -       0.0     0.000    0:0.108 false   true    
2   Reference Handler        system      10      WAITING 0.0     0.000    0:0.001 false   true    
3   Finalizer                system      8       WAITING 0.0     0.000    0:0.002 false   true    
4   Signal Dispatcher        system      9       RUNNABL 0.0     0.000    0:0.000 false   true    
8   Attach Listener          system      9       RUNNABL 0.0     0.000    0:0.027 false   true    
10  arthas-timer             system      9       WAITING 0.0     0.000    0:0.000 false   true    
13  arthas-NettyHttpTelnetBo system      5       RUNNABL 0.0     0.000    0:0.029 false   true    
14  arthas-NettyWebsocketTty system      5       RUNNABL 0.0     0.000    0:0.001 false   true    
Memory               used   total  max    usage  GC                                               
heap                 27M    41M    444M   6.19%  gc.copy.count            8                       
eden_space           10M    11M    122M   8.57%  gc.copy.time(ms)         58                      
survivor_space       0K     1408K  15680K 0.00%                           1                       
tenured_gen          17M    28M    306M   5.55%  gc.marksweepcompact.time 30                      
nonheap              28M    29M    -1     96.40% (ms)                                             
code_cache           5M     5M     240M   2.21%                                                   
metaspace            20M    21M    -1     96.21%                                                  
compressed_class_spa 2M     2M     1024M  0.25%                                                   
ce                                                                                                
direct               8K     8K     -                                                              
Runtime                                                                                           
os.name                                          Linux                                            
os.version                                       3.10.0-957.21.3.el7.x86_64                       
java.version                                     1.8.0_282                                        
java.home                                        /usr/lib/jvm/java-8-openjdk-amd64/jre            
systemload.average                               0.20                                             
processors                                       1                                                
timestamp/uptime                                 Wed Jun 23 15:31:08 CST 2021/244s                
```

可以输入 `thread xxx` 查看某个线程的栈信息，同时也支持管道：

```bash
[arthas@1287]$ thread 1
"main" Id=1 TIMED_WAITING
    at java.lang.Thread.sleep(Native Method)
    at java.lang.Thread.sleep(Thread.java:340)
    at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:386)
    at demo.MathGame.main(MathGame.java:17)

[arthas@1287]$ thread 1 | grep 'main'
"main" Id=1 TIMED_WAITING
    at demo.MathGame.main(MathGame.java:17)
```

可以输出 `sc -d xxx` 搜索类的相关信息：

```bash
[arthas@1287]$ sc -d *MathGame
 class-info        demo.MathGame                                                                  
 code-source       /home/shell/arthas-demo.jar                                                    
 name              demo.MathGame                                                                  
 isInterface       false                                                                          
 isAnnotation      false                                                                          
 isEnum            false                                                                          
 isAnonymousClass  false                                                                          
 isArray           false                                                                          
 isLocalClass      false                                                                          
 isMemberClass     false                                                                          
 isPrimitive       false                                                                          
 isSynthetic       false                                                                          
 simple-name       MathGame                                                                       
 modifier          public                                                                         
 annotation                                                                                       
 interfaces                                                                                       
 super-class       +-java.lang.Object                                                             
 class-loader      +-sun.misc.Launcher$AppClassLoader@1b6d3586                                    
                     +-sun.misc.Launcher$ExtClassLoader@55c7032e                                  
 classLoaderHash   1b6d3586                                                                       

Affect(row-cnt:1) cost in 44 ms.
```

可以通过 `jad xxx` 反编译指定类：

```java
[arthas@1287]$ jad demo.MathGame

ClassLoader:                                                                                      
+-sun.misc.Launcher$AppClassLoader@1b6d3586                                                       
  +-sun.misc.Launcher$ExtClassLoader@55c7032e                                                     

Location:                                                                                         
/home/shell/arthas-demo.jar                                                                       

       /*
        * Decompiled with CFR.
        */
       package demo;
       
       import java.util.ArrayList;
       import java.util.List;
       import java.util.Random;
       import java.util.concurrent.TimeUnit;
       
       public class MathGame {
           private static Random random = new Random();
           private int illegalArgumentCount = 0;
       
           public List<Integer> primeFactors(int number) {
/*44*/         if (number < 2) {
/*45*/             ++this.illegalArgumentCount;
                   throw new IllegalArgumentException("number is: " + number + ", need >= 2");
               }
               ArrayList<Integer> result = new ArrayList<Integer>();
/*50*/         int i = 2;
/*51*/         while (i <= number) {
/*52*/             if (number % i == 0) {
/*53*/                 result.add(i);
/*54*/                 number /= i;
/*55*/                 i = 2;
                       continue;
                   }
/*57*/             ++i;
               }
/*61*/         return result;
           }
       
           public static void main(String[] args) throws InterruptedException {
               MathGame game = new MathGame();
               while (true) {
/*16*/             game.run();
/*17*/             TimeUnit.SECONDS.sleep(1L);
               }
           }
       
           public void run() throws InterruptedException {
               try {
/*23*/             int number = random.nextInt() / 10000;
/*24*/             List<Integer> primeFactors = this.primeFactors(number);
/*25*/             MathGame.print(number, primeFactors);
               }
               catch (Exception e) {
/*28*/             System.out.println(String.format("illegalArgumentCount:%3d, ", this.illegalArgumentCount) + e.getMessage());
               }
           }
       
           public static void print(int number, List<Integer> primeFactors) {
               StringBuffer sb = new StringBuffer(number + "=");
/*34*/         for (int factor : primeFactors) {
/*35*/             sb.append(factor).append('*');
               }
/*37*/         if (sb.charAt(sb.length() - 1) == '*') {
/*38*/             sb.deleteCharAt(sb.length() - 1);
               }
/*40*/         System.out.println(sb);
           }
       }

Affect(row-cnt:1) cost in 1336 ms.
```

输入 `watch <class> <method> <>` ：

```bash
[arthas@1287]$ watch demo.MathGame primeFactors returnObj
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 295 ms, listenerId: 1
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2021-06-23 15:36:20; [cost=1.186264ms] result=null
method=demo.MathGame.primeFactors location=AtExit
ts=2021-06-23 15:36:21; [cost=0.300809ms] result=@ArrayList[
    @Integer[2],
    @Integer[13],
    @Integer[6841],
]
```

可以输出 `exit` 或者 `Ctrl + C` 退出 Arthas，可以通过 `java -jar arthas-boot.jar` 再次进入交互式界面。

退出 Arthas 后只是断开 session，Arthas 进程本身还在，可以通过输入 `stop` 结束 Arthas 进程。

## 2. 常用技巧

- **查看总览面板**：dashboard

- **查看环境信息**：jvm、sysprop、sysenv

- **查找类信息**：`sc -d <class>`

- **显示类的函数**：`sm -d <class>`

- **反编译**：`jdk <class>`

- **观察函数的接收、返回值等**：`watch <class> <method> '{params, throwExp}'`，第二个参数可以指定方法名，第三个参数可以指定观察对象，支持如下选项：

  - loader
  - clazz
  - method
  - target
  - params
  - returnObj
  - throwExp
  - isBefore
  - isThrow
  - isReturn

  watch 还支持以下形式：

  - 指定条件：`watch <class> <method> returnObj 'params[0] > 100'`
  - 只捕获抛出异常的请求：`watch <class> <method> returnObj -e`
  - 根据耗时：`watch <class> <method> returnObj '#cost>200'`

- **查看线程**：thread，除此之外，还支持以下格式：

  - 查看线程ID 16的栈：`thread 16`
  - 查看 CPU 利用率 top N 的线程：`thread -n 3`
  - 查看 5s 内 CPU 利用率 top N 的线程：`thread -n 3 -i 5000`
  - 查看是否有阻塞线程：`thread -b`、`thread --state BLOCKED`

- **跟踪性能消耗**：`trace <class> <method>`，可以添加 `--skipJDKMethod false` 打印出 JDK 调用：

  ```bash
  `---ts=2021-06-28 16:49:06;thread_name=Executor task launch worker for task 1723591;id=cea;is_daemon=true;priority=5;TCCL=org.apache.spark.util.MutableURLClassLoader@4a7a0133
      `---[0.898893ms] framework.logmodel.text.v2.TextLogModelV2Cacher:updateFromCache()
          +---[0.003161ms] java.util.Map:get() #77
          +---[0.002479ms] framework.logmodel.config.TextLogModelConfig:getCachedFieldNamesIdx() #57
          +---[min=0.001759ms,max=0.003394ms,total=0.154761ms,count=77] java.util.Set:contains() #79
          +---[min=0.00195ms,max=0.004501ms,total=0.135366ms,count=62] java.lang.String:intern() #80
          +---[min=0.00179ms,max=0.00253ms,total=0.028961ms,count=15] java.util.Set:contains() #81
          `---[min=0.002515ms,max=0.008391ms,total=0.024895ms,count=6] com.github.benmanes.caffeine.cache.LoadingCache:get() #82
  ```

- **生成火焰图**：profiler，语法格式为`profiler action [actionArg]`

  - 查看支持的 action：`profiler actions`，其中 start 为启动 profiler，可以**通过 -e 指定采集的事件**，默认为 CPU。
  - **查看支持的事件**：profiler list
  - 开始采样：profiler start
  - 采样数量：profiler getSamples
  - 停止采样：profiler stop，还可以指定采样文件格式为 html（默认 svg）：--format html
  - 指定采样文件路径：profiler stop --file /tmp/output.svg

## 3. 现网案例

