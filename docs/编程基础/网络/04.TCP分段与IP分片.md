---
title: 04. TCP 分段与 IP 分片
date: 2021-05-27
---

## TCP 分段与 IP 分片

![image-20210527221917583](https://gitee.com/zhxuankun/Image/raw/master/Avator/image-20210527221917583.png)

当数据包太大的时候，需要对其进行拆分，其主要发生在传输层（TCP 协议）以及网络层（IP）。

TCP 层拆分数据称为 **TPC 分段**，拆分大小取决于 **MSS（Maximum Segment Size）**。

IP 层拆分数据称为 **IP 分片**，拆分大小取决于 **MTU（Maximum Transmit Unit，最大传输单元）**，该参数表示该设备的传输能力大小，不同网络设备的 MTU 也不一样。

MSS 通常受到 MTU 的限制，通常 MSS = MTU - 20（IP Header）- 20（TCP Header）。

不同网络设备的 MTU 往往也不同，网卡就带有 MTU 属性，可以通过 `ifconfig` 查看。

不同两端进行通讯时，如果 MTU 不同，MSS 也不同，两端会在各自的报文中携带 MSS 信息，双方以最小的 MSS 为准。

**Q：报文 不携带 MSS 信息时 TCP 协议怎么处理这种情况？**

A：报文中的 MSS 信息为可选项，当一端不传 MSS 信息时，则会以 IP 协议的最小重组缓冲区（576 字节）- 20（TCP Header）- 20（IP Header）得到 537 字节作为 MSS 默认值。

![image-20210527222340392](https://gitee.com/zhxuankun/Image/raw/master/Avator/image-20210527222340392.png)

**Q：为什么 MTU 通常是 1500？**

A：其实网络传输中是经常发生问题的，越大的包在网络传输中也越容易发生丢包。MTU 的大小还要考虑到传输效率，由于每个数据包都需要额外 20 字节 TCP 头以及 20 字节 IP 头，当 MTU 过小时，有效传输率会非常低，以 300 为例：`TCP payload = 300 - IP Header - TCP Header = 300 - 20 - 20 = 260 byte`，有效传输率为 86%，而 1500 字节大小的 MTU 有效传输率可以到达 96%。

**Q：为什么 IP 层会会分片，TCP 层还要分段？**

A：主要是为了避免 TCP 重传时，需要重传的数据包太大，当 TCP 分段后，如果发生丢包重传，那么只需要重传分段后的部分数据，而不用全部重传，因此 TCP 层需要根据 IP 层的 MTU 大小来调节 MSS 大小，尽可能避免在 IP 层分片。

UDP 由于不会进行重传，因此它是不会进行分段的。

**Q：IP 层怎么做到不分片？**

A：在现在的 Linux 系统中，`/proc/sys/net/ipv4/ip_no_pmtu_disc` 通常设置为 0，意思是开启 PMTU 功能，当网络设备发现某个数据包的 MSS 大于其 MTU，则会检查其 DF 位：

- 如果为 0，则将其分片传输到下一个路由
- 如果为 `1` ，则丢弃该数据包，并返回一个带有当前 MTU 的 ICMP 数据包，发送端根据 MTU 调整 MSS

最后附上 tcpdump 的一段输出：

```bash
sudo tcpdump -i lo -Ss0 -n src 127.0.0.1 and dst 127.0.0.1 and port 9999
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
21:57:53.589623 IP 127.0.0.1.60560 > 127.0.0.1.9999: Flags [S], seq 1659164645, win 65495, options [mss 65495,sackOK,TS val 1793273290 ecr 0,nop,wscale 7], length 0
21:57:53.589722 IP 127.0.0.1.9999 > 127.0.0.1.60560: Flags [R.], seq 0, ack 1659164646, win 0, length 0
```

参考：

- [动图图解！既然IP层会分片，为什么TCP层也还要分段？](https://mp.weixin.qq.com/s/VLHCu6b5Anx8HEj_gQZfOg)

