---
title: DNS 解析原理
date: 2020-07-26
---

# DNS 解析原理

## 1. DNS 解析过程

当我们访问一个域名（e.g. www.google.com）的时候，实际上域名会被解析成一个 IP 地址，然后我们再去访问那个 IP 地址，这个过程称为**域名解析**。

域名解析也分为多个阶段，如果该阶段无法解析，变前往下一个阶段：

1. 浏览器缓存，浏览器通常会缓存域名以及 IP 的映射关系，此处优先级最高；

2. 本机 Host 解析，根据本机 Host 配置进行映射；

   > DNS 劫持也是利用这个原理，通过非法修改本机 Host 映射，从而将用户正常访问的域名导向虚假 IP 地址。

3. 本地域名解析服务器，通常是离自己位置最近的域名解析服务器；

   > Windows 通过 ipconfig 可以查询到服务器地址；Linux 则是通过 cat /etc/resolv.conf 来查看。

4. 如果仍无法解析，则进入根域名解析，**本地域名解析服务器**通过 UDP 协议向 **13根** （指 13 个根服务器）发起域名解析请求；

5. **根域名解析服务器**返回  `gTLD (Generic top-level domain)` 给本地解析服务器，即该域名所属的**顶级域**及其所在的服务器（e.g. `.com` `.cn`, and etc）；

6. **本地域名解析服务器**得到顶级域名解析服务器地址后，向顶级域名解析服务器发起解析请求；

7. **顶级域名解析服务器**返回权限域名服务器信息（e.g. `google.com` ,and etc.）给本地域名解析服务器；

8. **本地域名服务器**得到权限域名解析服务器信息后，向权限域名解析服务器发起解析请求；

9. 权限域名服务器返回域名对应的 IP 地址给本地解析服务器；

10. 本地解析服务器缓存相关信息，并返回给用户。

流程图如下：

![DNS 解析流程](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/Snipaste_2020-07-26_14-39-58.png)

## 2. DNS 轮询以及反向代理

随着数据的爆炸式增长以及摩尔定律的失效，很多场景已经无法单靠传统的单机应用解决，当前主流的解决方式之一就是水平扩展。

传统的单机部署如下：

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/24a1c9812372981e89bbda7659b6c5bce9725242.png)

### 2.1 DNS 轮询

DNS 轮询，在域名解析服务器对同个域名配置多个 IP ，这样一来，每次解析轮流返回不同的 IP：

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/ded420a32a0b2309ccce75e8bb6b63e5d4599f62.png)

优点：

- **零成本**：在域名解析服务器上多配几个 IP 即可；
- **部署简单**：多部署几个 server 即可。
- **负载均衡**：变成了多个 server，负载也是均衡的。

缺点：

- **非高可用**：域名解析服务器只负责解析域名，并不保证底下的 server 可用。
- **扩容非实时**：DNS 解析有一个生命周期。
- **暴露了太多外网 IP**。

### 2.2 单点 Nginx

反向代理，目前基本都是使用 nginx 来实现，一个 nginx 下可以部署多个 server，而对外只需要暴露一个 nginx 服务器即可：

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/f269d7edb0c677e2ebefa712dfb254fd6097e131.png)

优点：

- 对底下的 server 无侵入；
- **负载均衡**：通过 nginx 保证。
- 只暴露必要的 IP；
- **扩容实时**：nginx 内部可控，可随时扩容 server；
- **保障高可用**：nginx 能够检测 server 的可用状态并在故障时将其流量转移到其他 server。

缺点：

- **时延增加 + 架构复杂**：中间多了一层代理层；
- nginx 成了单点，存在单点故障，存在单台性能上线。

### 2.3 Nginx + Keepalived

为了解决 nginx 的单点高可用问题，可以同过 `keepalived + nginx` 的架构来解决。

Keepalived 是一种高性能的服务器高可用或热备解决方案，以 VRRP 协议为实现基础，用 VRRP 协议来实现高可用性(HA)。

> VRRP 协议使用多播数据来传输 VRRP 数据，VRRP 数据使用特殊的虚拟源 MAC 地址发送数据而不是自身网卡的 MAC 地址，VRRP 运行时只有 MASTER 路由器定时发送 VRRP 通告信息， 表示 MASTER 工作正常以及虚拟路由器 IP(组)，BACKUP 只接收 VRRP 数据，不发送数据，如果一定时间内没有接收到 MASTER 的通告信息，各 BACKUP 将宣告自己成为 MASTER， 发送通告信息，重新进行 MASTER 选举状态。

Keepalived 将多台 nginx 虚拟成一个服务，对外提供一个**虚拟 IP**，持有这个对外 IP 的路由器会成为 MASTER，提供实际的服务，其它的则是 BACKUP 状态，在 MASTER 故障时尝试接管成为 MASTER。

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/7d22b40f3306dacf13555673298593e7b4ea319c.png)

优点：

- 解决了高可用问题。

缺点：

- 资源利用率只有 50%；
- nginx 提供服务时仍是单点，存在瓶颈。

### 2.4 LVS + Keepalived + Nginx

LVS（Linux Virtual Server ），Linux 虚拟服务器，属于 Linux 标准内核的一部分，性能极高，具有负载均衡的功能。

通过 `LVS + nginx` 实现 nginx  的负载均衡及可扩展性，而 `Keepalived + LVS` 则用于避免 LVS 的单点故障问题：

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/8d0f9793fe5867d9b9860435593f3149ec906b38.png)

至此，基本 99.9999% 的公司都能够满足其要求了。

### 2.5 DNS 轮询 + LVS + Keepalived + Nginx

如果 `LVS + Keepalived + Nginx` 中的  `LVS + nginx`  仍存在瓶颈，那么可以结合 DNS 轮询来解决：

![](https://raw.githubusercontent.com/Rianico/Image/master/ARTS_Tips/68c92bbe7f850d799826cf48586510e2ebf5e862.png)

### 2.6 总结

1. 架构通常需要考虑：高可用性、可扩展性、反向代理、负载均衡这几个问题；
2. Nginx、keepalived、LVS（OS 层面）、f5（硬件层面）可以很好的解决高可用、扩展性、反向代理、负载均衡的问题；
3. 水平扩展时解决可扩展性问题的根本方案，DNS 轮询与 Nginx、LVS、f5 并不冲突，而是属于互补关系。

## 3. 思考

1. 为什么只有 13 台 根服务器？

   根域名服务器使用 UDP 协议传输 DNS 消息，而 UDP 协议传输的消息最大长度被限制在 512 字节。IP 数据报文理论最大长度为 65535字节（包含头部和数据），但是以前的机器并无法处理如此大的数据报文，因此规定了**每台主机必须准备好接收总长度最多为576字节（即最小 MTU）的IP数据报**。

   选择576是为了允许使用合理的数据块大小传输IP头部以外的信息，常用的 IP 头部是 20字节，最大长度为 60 字节，保留了部分空间给其他高层协议头部。

   DNS 响应报文的计算方式：

   - DNS头部是固定的12字节。

   - 问题区段是1字节的根域0 + 2字节查询类型 + 2字节查询类一共是5字节。

   - 回答区段的每个NS记录都会在额外信息区段添加对应的A记录。NS记录为1字节根域0 + 2字节类型 + 2字节类 + 4字节TTL + 2字节资源数据长度 + 不定长度的根服务器域名，一共是11字节固定部分 + 不定长度数据。

   - A记录是2字节的压缩标签（指向NS记录中的根服务器域名） + 10字节资源记录固定部分（类型、类、TTL、资源数据长度）+ 4字节IPv4地址，一共是16字节。

   因此 12 + 5 + 11n + 16n + 所有根服务器域名的数据标签的长度总和，得到结果为 DNS 响应报文总长度，n 为根服务器数量。

2. 为什么 DNS 解析请求使用 UDP 协议？

   为了让响应时间尽可能小，使用 UDP 是一种较为合适的方法（虽然不是可靠传输）。而域名解析服务器之间的交流记录则是使用 TCP 保障可靠传输。
   
   

## 4. 参考

- [“反向代理层”绝不能替代“DNS轮询”！](https://yq.aliyun.com/articles/674437)
- [High Availability Support for NGINX Plus in On-Premises Deployments](https://docs.nginx.com/nginx/admin-guide/high-availability/ha-keepalived/)
- [根域名服务器只有13台？](https://zhuanlan.zhihu.com/p/107492241)
- [为什么DNS使用UDP而不是TCP？]([https://www.zhihu.com/question/310145373#:~:text=%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E6%97%B6%E4%BD%BF%E7%94%A8UDP,%E4%BB%85%E6%94%AF%E6%8C%81UDP%E6%9F%A5%E8%AF%A2%E5%8C%85%E3%80%82](https://www.zhihu.com/question/310145373#:~:text=域名解析时使用UDP,仅支持UDP查询包。))