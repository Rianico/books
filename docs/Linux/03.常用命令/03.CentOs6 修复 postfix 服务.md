---
title: CentOs6 修复 postfix 服务
date: 2020-07-23 09:53:20
---
# CentOs6下修复postfix邮件服务

由于CDH集群的Alert Publisher服务依赖于操作系统的postfix服务，然而在按照网上教程配置并启动postfix服务后，Alert Publisher服务输出日志如下：

```bash
2019-04-01 17:43:15,174 ERROR org.apache.camel.processor.DefaultErrorHandler: Failed delivery for exchangeId: ID-xx-xx-xxxx-44049-1553768893026-0-177733. Exhausted after delivery attempt: 1 caught: org.springframework.mail.MailSendException: Mail server connection failed; nested exception is javax.mail.MessagingException: Could not connect to SMTP host: localhost, port: 25;
  nested exception is:
        java.net.ConnectException: 拒绝连接. Failed messages: javax.mail.MessagingException: Could not connect to SMTP host: localhost, port: 25;
...
2019-05-30 02:21:22,415 ERROR com.cloudera.enterprise.SafeAvroResponderServlet: Error procesing Avro request
java.io.IOException: Unexpected length (too long): 1010792557, max:10485760
        at com.cloudera.enterprise.SafeAvroHttpTransceiver.checkLength(SafeAvroHttpTransceiver.java:137)
...
```

从日志可以看出，Alert Publisher会对本地25端口发送请求消息，但在多次失败后，最终导致请求消息累积过长，从而抛出异常，服务停止输出日志。

查看25端口占用，发现没有任何服务，因此postfix服务实质上没有启动成功，在`/var/log/mail.log`下有没有看到任何关于启动相关的日志，最后通过启动`rsyslog`服务来监听25端口的相关日志，可以看到日志以下输出：

```vim
cm postfix[4322]: fatal: file /etc/postfix/main.cf: parameter default_privs: unknown user name value: nobody
```

其实就是由于没有`nobody`用户，执行`postfix check`命令也可以看到这个报错，再结合这篇文章[Gitlab - postfix setup issues](https://amoldighe.github.io/2016/09/14/gitlab-postfix-issue/)，在`/etc/passd`中添加如下用户：

```vim
nobody:x:99:99:Nobody:/:/sbin/nologin
```

再次启动postfix服务，启动成功。

### xfs VS ext4

最新搭建Hadoop集群，了解到了xfs文件系统，官网地址：[https://xfs.org/index.php/Main\_Page](https://xfs.org/index.php/Main_Page)

这里先记录下xfs的相关安装。

服务器单机磁盘环境：从`/dev/sdb`开始，直到`/dev/sdm`，共12个盘

1.首先安装xfs

```bash
yum -y install xfsprogs
```

2.对磁盘进行分区，可参考下列脚本，注意parted的时候使用`mkpart primary 1 100%`达到逻辑分区对齐的作用

```bash
#! /bin/bash
i=1
while [ $i -le 12 ]
do
j=`echo $i|awk '{printf "%c",97+$i}'`
umount /data$i
parted /dev/sd$j <<FORMAT
rm 1
mklabel gpt
Ignore
Yes
mkpart primary 1 100%
quit
FORMAT
let i=i+1
done
```

3.格式化分区并挂载

```bash
#! /bin/bash
i=1
while [ $i -le 12 ]
do
j=`echo $i|awk '{printf "%c",97+$i}'`
mkfs.xfs -f /dev/sd${j}1
mkdir -p /data$i
mount /dev/sd${j}1 /data$i
FORMAT
let i=i+1
done
```

4.修改`/etc/fstab`添加以下配置

```vim
/dev/sdb1              /data1                  xfs    defaults        1 2
/dev/sdc1              /data2                  xfs    defaults        1 2
/dev/sdd1              /data3                  xfs    defaults        1 2
/dev/sde1              /data4                  xfs    defaults        1 2
/dev/sdf1              /data5                  xfs    defaults        1 2
/dev/sdg1              /data6                  xfs    defaults        1 2
/dev/sdh1              /data7                  xfs    defaults        1 2
/dev/sdi1              /data8                  xfs    defaults        1 2
/dev/sdj1              /data9                  xfs    defaults        1 2
/dev/sdk1              /data10                  xfs    defaults        1 2
/dev/sdl1              /data11                  xfs    defaults        1 2
/dev/sdm1              /data12                  xfs    defaults        1 2
```

1. 执行`df -Th`检查挂载以及格式化

```vim
/dev/sdb1      xfs    5.5T   34M  5.5T   1% /data1
/dev/sdc1      xfs    5.5T   34M  5.5T   1% /data2
/dev/sdd1      xfs    5.5T   34M  5.5T   1% /data3
/dev/sde1      xfs    5.5T   34M  5.5T   1% /data4
/dev/sdf1      xfs    5.5T   34M  5.5T   1% /data5
/dev/sdg1      xfs    5.5T   34M  5.5T   1% /data6
/dev/sdh1      xfs    5.5T   34M  5.5T   1% /data7
/dev/sdi1      xfs    5.5T   34M  5.5T   1% /data8
/dev/sdj1      xfs    5.5T   34M  5.5T   1% /data9
/dev/sdk1      xfs    5.5T   34M  5.5T   1% /data10
/dev/sdl1      xfs    5.5T   34M  5.5T   1% /data11
/dev/sdm1      xfs    5.5T   34M  5.5T   1% /data12
```

关于xfs以及ext4的对比网上有很多资料，以下两篇是个人认为比较有说服力的文章。

[XFS vs EXT4 – Comparing MongoDB Performance on AWS EC2](https://scalegrid.io/blog/xfs-vs-ext4-comparing-mongodb-performance-on-aws-ec2)：文章大致表达的意思是：在高性能磁盘下，xfs对比ext4，性能上高了一个级别，而在中小型机器下，xfs并没法带来肉眼可见的提升。

再结合知乎的一个问答[为什么CENTOS 7.0开始选择XFS作为默认的文件系统？XFS相比ext有什么优点？](https://www.zhihu.com/question/24413471/answer/38883787)，个人认为，在未来数据量未来越大的情况下，ext4的单个文件大小最大只支持到16T，因此xfs从扩展性上来看会更好。

