---
title: 鲲鹏与x86异构服务器混搭
date: 2021-01-23
---

## 1. 机器 host 分布

```bash
192.168.1.167 server1.haohan.com
192.168.1.38 server2.haohan.com
192.168.1.168 agent1.haohan.com
192.168.1.39 agent2.haohan.com
192.168.1.169 agent3.haohan.com
192.168.1.41 ipa.haohan.com
```

## 2. 登录信息

操作系统登录账号密码：root/123456。

Ambari Server 地址：http://server1.haohan.com:8080/ ，账号密码：admin/admin。

Postgresql 部署机器：server1.haohan.com，账号密码：postgres/postgres、ambari/ambari123。

Ansible 接口机：server1.haohan.com。

Yum 源仓库机器：server1.haohan.com

硬盘：

- 鲲鹏：/data1 ~ /data24
- x86：/data1 ~ /data11

## 3. 搭建异构本地 yum 仓库

思路：这里选取一台能够通公网的机器 server1.haohan.com（鲲鹏），拉取远程 yum 仓库并制作为本地仓库，供集群服务器使用。

### 3.1 配置机器网络 yum 源

如果 server1.haohan.com 属于 x86 架构：

```bash
cp -a /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo
```

如果 server1.haohan.com 属于鲲鹏 arm 架构：

```bash
cp -a /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-AltArch-7.repo
```

这里我们是鲲鹏服务器，选择后者，之后执行 `yum clean all && yum makecache && yum -y install httpd createrepo` 安装好 httpd 以及 createrepo 服务。

### 3.2 格式化本机磁盘（可选）

**谨慎操作：如果磁盘未格式化挂载才需要做这一步**，磁盘格式化建议由专门的运维人员进行操作，因为需要根据不同的服务器，不同的硬盘数量做适配。

以下仅给出当前测试环境的示例：

- 鲲鹏服务器：/dev/sda ~ /dev/sdx 作为数据盘，每个盘 1.2 T，共 24 个盘，使用 xfs 作为磁盘文件系统
- x86 服务器：/dev/sdb ~ /dev/sdl 作为数据盘，/dev/sda 为系统盘，因此脚本中排除掉了，每个盘 4 T，共 11 个盘，使用 xfs 作为磁盘文件系统

针对鲲鹏服务器的磁盘格式化脚本： `vim /opt/install/parted_aarch64.sh` 并添加如下内容

```bash
#/usr/bin/env bash
##########################################################
# @author: zhengxuankun@haohan.com.cn
# @description: 鲲鹏服务器磁盘格式化，过滤所有 1.2T 的磁盘设备并挂载到 /data*，* 为递增序号，从 1 开始
# @date: 2020/01/26
##########################################################
function format {
  local disk=$1
  bh=${disk: -1}
  disk_xh=$(expr $(printf "%d" "'$bh") - 96)
  umount /data${disk_xh}
  parted $disk <<FORMAT
  rm 1
  mklabel gpt
  Yes
  mkpart primary 1 100%
  quit
FORMAT

  mkfs.xfs -f ${disk}1 -b size=8192
  mkdir -p /data${disk_xh}
  mount -o nobarrier ${disk}1 /data${disk_xh}
  sed -i 's@'$disk'.*@@g' /etc/fstab
  sed -i -e '/^$/d' /etc/fstab 
  echo ${disk}"1 /data"${disk_xh}" xfs nobarrier 0 0" >> /etc/fstab
  wait
}



for disk in `fdisk -l 2>/dev/null|grep 1200.2|awk '{print $2}'|awk -F ':' '{print $1}'|sort`
do
  format $disk
done
wait
```

针对 x86 服务器的磁盘格式化脚本： `vim /opt/install/parted_x86_64.sh` 并添加如下内容

```bash
#/usr/bin/env bash
##########################################################
# @author: zhengxuankun@haohan.com.cn
# @description: x86服务器磁盘格式化，过滤所有 4t 的磁盘设备并挂载到 /data*，* 为递增序号，从 1 开始
# @date: 2020/01/26
##########################################################

function format {
  local disk=$1
  bh=${disk: -1}
  disk_xh=$(expr $(printf "%d" "'$bh") - 97)
  umount /data${disk_xh}
  parted $disk <<FORMAT
  rm 1
  mklabel gpt
  Yes
  mkpart primary 1 100%
  quit
FORMAT

  mkfs.xfs -f ${disk}1 -b size=4096
  mkdir -p /data${disk_xh}
  mount -o nobarrier ${disk}1 /data${disk_xh}
  sed -i 's@'$disk'.*@@g' /etc/fstab
  sed -i -e '/^$/d' /etc/fstab 
  echo ${disk}"1 /data"${disk_xh}" xfs nobarrier 0 0" >> /etc/fstab
  wait
}



for disk in `fdisk -l 2>/dev/null|grep 4000.2|awk '{print $2}'|grep -v /dev/sda|awk -F ':' '{print $1}'|sort`
do
  format $disk
done
wait
```

然后根据系统具体选择执行哪个脚本即可，此处 server1.haohan.com 属于鲲鹏服务器，执行第一个脚本。

### 3.3 拉取 yum 源

拉取的 yum 仓库体积十分巨大，因此建议提前规划好磁盘空间。这里假设 `/data1` 挂载在一个足够大的数据盘，`/var/www/html` 作为 httpd 服务的默认路径：

```bash
# 通过软连接链接到数据盘
mkdir -p /data1/html && rm -rf /var/www/html && ln -s /data1/html  /var/www/html
```

关闭该机器的防火墙：

```bash
# CentOS 7
systemctl stop firewalld
```

开启 httpd 服务：

```bash
# CentOS 7
systemctl start httpd
```

### 3.1 制作操作系统 yum 源

```bash
# 下载华为云的 CentOS7.6 的两种镜像
mkdir -p /data1/install/iso && cd /data1/install/iso
## arm 架构
wget https://mirrors.huaweicloud.com/centos-vault/altarch/7.6.1810/isos/aarch64/CentOS-7-aarch64-Everything-1810.iso
## x86 架构
wget https://mirrors.huaweicloud.com/centos-vault/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-Everything-1810.iso

# 挂载镜像
## arm 架构
mkdir /var/www/html/Centos-7.6-aarch64
mount -o loop /data1/install/iso/CentOS-7-aarch64-Everything-1810.iso /var/www/html/Centos-7.6-aarch64
## x86 架构
mkdir /var/www/html/Centos-7.6-x86_64
mount -o loop /data1/install/iso/CentOS-7-x86_64-Everything-1810.iso /var/www/html/Centos-7.6-x86_64
```

### 3.2 制作 epel yum 源

1. 安装华为云 epel 镜像

```bash
yum install https://repo.huaweicloud.com/epel/epel-release-latest-7.noarch.rpm
sed -i "s/#baseurl/baseurl/g" /etc/yum.repos.d/epel.repo
sed -i "s/metalink/#metalink/g" /etc/yum.repos.d/epel.repo
sed -i "s@https\?://download.fedoraproject.org/pub@https://repo.huaweicloud.com@g" /etc/yum.repos.d/epel.repo
```

2. 修改 epel 仓库配置为 x86 架构，并同步仓库到本地

```bash
mkdir -p /data1/install/repo

# 同步 x86 仓库到本地
sed -i 's@\$basearch@x86_64@g' /etc/yum.repos.d/epel.repo
yum clean all && yum makecache
reposync -r epel -a x86_64 -p /var/www/html/

# 同步 arm 仓库到本地
sed -i 's@x86_64@aarch64@g' /etc/yum.repos.d/epel.repo
yum clean all && yum makecache
reposync -r epel -a aarch64 -p /var/www/html/
```

> NOTE：每一次同步都需要耗费较长时间，请耐心等待。

3. 创建本地仓库

```bash
cd /var/www/html/epel && createrepo .
```

### 3.3 搭建 ambari 以及 HDP yum 源

- 下载鲲鹏（CentOS 7.6）相关包到 `/data1/install/hdp/kunpeng`  ：

https://mirrors.huaweicloud.com/kunpeng/yum/el/7/bigdata/HDP-UTILS-1.1.0.22/repos/HDP-UTILS-1.1.0.22-centos7.tar.gz

https://mirrors.huaweicloud.com/kunpeng/yum/el/7/bigdata/HDP-GPL/3.x/updates/3.1.0.0/HDP-GPL-3.1.0.0-centos7-gpl.tar.gz

https://mirrors.huaweicloud.com/kunpeng/yum/el/7/bigdata/ambari/2.x/updates/2.7.3.0/ambari-2.7.3.0-centos7.tar.gz

https://mirrors.huaweicloud.com/kunpeng/yum/el/7/bigdata/HDP/3.x/updates/3.1.0.0/HDP-3.1.0.0-centos7-rpm.tar.gz

- 下载 x86（CentOS 7.6） 相关包到 `/data1/install/hdp/x86`：

https://public-repo-1.hortonworks.com/HDP-GPL/centos7/3.x/updates/3.1.0.0/HDP-GPL-3.1.0.0-centos7-gpl.tar.gz

https://public-repo-1.hortonworks.com/HDP/centos7/3.x/updates/3.1.0.0/HDP-3.1.0.0-centos7-rpm.tar.gz

https://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz

https://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.7.3.0/ambari-2.7.3.0-centos7.tar.gz

- 创建下列路径：

  ```bash
  mkdir -p /var/www/html/entry/ambari/2.7.3.0.0/centos7/aarch64
  mkdir -p /var/www/html/entry/ambari/2.7.3.0.0/centos7/x86_64
  mkdir -p /var/www/html/entry/ambari/2.7.3.0.0/centos7/noarch
  mkdir -p /var/www/html/entry/hdp/3.1/centos7/aarch64
  mkdir -p /var/www/html/entry/hdp/3.1/centos7/x86_64
  mkdir -p /var/www/html/entry/hdp/3.1/centos7/noarch
  ```

- 解压鲲鹏的相关包并移动到仓库路径下：

  ```bash
  cd /data1/install/hdp/kunpeng/
  tar -zxf ambari-2.7.3.0-centos7.tar.gz && tar -zxf HDP-3.1.0.0-centos7-rpm.tar.gz && tar -zxf HDP-GPL-3.1.0.0-centos7-gpl.tar.gz && tar -zxf HDP-UTILS-1.1.0.22-centos7.tar.gz
  mv -f ambari/centos7/2.7.3.0-139/*/*aarch64.rpm /var/www/html/entry/ambari/2.7.3.0.0/centos7/aarch64/
  mv -f ambari/centos7/2.7.3.0-139/*/*noarch.rpm /var/www/html/entry/ambari/2.7.3.0.0/centos7/noarch/
  mv -f HDP*/centos7/*/*/*aarch64.rpm /var/www/html/entry/hdp/3.1/centos7/aarch64/
  mv -f HDP*/centos7/*/*/*noarch.rpm /var/www/html/entry/hdp/3.1/centos7/noarch/
  ```

- 解压 x86 的相关包并移动到仓库路径下：

  ```bash
  cd /data1/install/hdp/x86/
  tar -zxf ambari-2.7.3.0-centos7.tar.gz && tar -zxf HDP-3.1.0.0-centos7-rpm.tar.gz && tar -zxf HDP-GPL-3.1.0.0-centos7-gpl.tar.gz && tar -zxf HDP-UTILS-1.1.0.22-centos7.tar.gz
  mv -f ambari/centos7/2.7.3.0-139/*/*x86_64.rpm /var/www/html/entry/ambari/2.7.3.0.0/centos7/x86_64/
  mv -f ambari/centos7/2.7.3.0-139/*/*noarch.rpm /var/www/html/entry/ambari/2.7.3.0.0/centos7/noarch/
  mv -f HDP*/centos7/*/*/*x86_64.rpm /var/www/html/entry/hdp/3.1/centos7/x86_64/
  mv -f HDP*/centos7/*/*/*noarch.rpm /var/www/html/entry/hdp/3.1/centos7/noarch/
  ```

- 创建本地仓库

  ```bash
  cd /var/www/html/entry/ambari/2.7.3.0.0/centos7 && createrepo .
  cd /var/www/html/entry/hdp/3.1/centos7 && createrepo .
  ```

- 编辑 repo 配置文件



## 4 配置系统基础环境

### 4.1 搭建 ansible 管理节点

登录 server1.haohan.com，在 server1.haohan.com 上配置仓库镜像。

备份原始 repo 配置：

```bash
mkdir /etc/yum.repos.d/bak
mv /etc/yum.repos.d/Cent*  mkdir /etc/yum.repos.d/bak/
```

配置 epel 仓库 `vim /etc/yum.repos.d/epel.repo`，添加如下内容：

```properties
[epel]
name=Extra Packages for Enterprise Linux 7 - $basearch
baseurl=http://server1.haohan.com/epel
#metalink=https://mirrors.fedoraproject.org/#metalink?repo=epel-7&arch=x86_64&infra=$infra&content=$contentdir
failovermethod=priority
enabled=1
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
```

配置系统镜像仓库 `vim /etc/yum.repos.d/Centos-7.6.repo `，添加如下内容：

```properties
[base]
name=CentOS-$releasever-$basearch - Base
baseurl=http://server1.haohan.com/Centos-7.6-$basearch
failovermethod=priority
enabled=1
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
```

配置 amabri 仓库 `vim /etc/yum.repos.d/ambari.repo`，添加如下内容：

```properties
[ambari]
name=ambari-repo
baseurl=http://server1.haohan.com/entry/ambari/2.7.3.0.0/centos7
enabled=1
gpgcheck=0
```

配置 amabri 仓库 `vim /etc/yum.repos.d/hdp.repo`，添加如下内容：

```properties
[hdp]
name=hdp-repo
baseurl=http://server1.haohan.com/entry/hdp/3.1/centos7
enabled=1
gpgcheck=0
```

编辑 ansible 的 host 配置文件 `/etc/ansible/hosts` 内容如下：

```properties
[ansible]
server1.haohan.com.192.168.1.167 hostname=server1.haohan.com ansible_host=192.168.1.167 ansible_user=root ansible_ssh_pass="123456"

[no_ansible]
server2.haohan.com.192.168.1.38 hostname=server2.haohan.com ansible_host=192.168.1.38 ansible_user=root ansible_ssh_pass="123456"
agent1.haohan.com.192.168.1.168 hostname=agent1.haohan.com ansible_host=192.168.1.168 ansible_user=root ansible_ssh_pass="123456"
agent2.haohan.com.192.168.1.39 hostname=agent2.haohan.com ansible_host=192.168.1.39 ansible_user=root ansible_ssh_pass="123456"
agent3.haohan.com.192.168.1.169 hostname=agent3.haohan.com ansible_host=192.168.1.169 ansible_user=root ansible_ssh_pass="123456"
ipa.haohan.com.192.168.1.41 hostname=ipa.haohan.com ansible_host=192.168.1.41 ansible_user=root ansible_ssh_pass="123456"

[service]
server2.haohan.com.192.168.1.38 hostname=server2.haohan.com ansible_host=192.168.1.38 ansible_user=root ansible_ssh_pass="123456"

[agent]
agent1.haohan.com.192.168.1.168 hostname=agent1.haohan.com ansible_host=192.168.1.168 ansible_user=root ansible_ssh_pass="123456"
agent2.haohan.com.192.168.1.39 hostname=agent2.haohan.com ansible_host=192.168.1.39 ansible_user=root ansible_ssh_pass="123456"
agent3.haohan.com.192.168.1.169 hostname=agent3.haohan.com ansible_host=192.168.1.169 ansible_user=root ansible_ssh_pass="123456"

[ipa]
ipa.haohan.com.192.168.1.41 hostname=ipa.haohan.com ansible_host=192.168.1.41 ansible_user=root ansible_ssh_pass="123456"
```

关闭 ansible 的 ssh key 检查：

```bash
$ vim /etc/ansible/ansible.cfg
# 去掉 host_key_checking 的注释，并确认值为 False
host_key_checking = False
```

### 4.2 配置系统基础环境

```bash
mkdir -p /opt/install && cd /opt/install

# 分发 repo 文件到各个节点
## 备份系统原始仓库配置
ansible all -m shell -a 'mkdir -p /etc/yum.repos.d/bak && mv -f /etc/yum.repos.d/CentOS* /etc/yum.repos.d/bak/'
## 分发系统仓库配置
ansible all -m copy -a 'dest=/etc/yum.repos.d/Centos-7.6.repo src=/etc/yum.repos.d/Centos-7.6.repo owner=root mode=0644 group=root'
## 分发 epel 仓库配置
ansible all -m copy -a 'dest=/etc/yum.repos.d/epel.repo src=/etc/yum.repos.d/epel.repo owner=root mode=0644 group=root'
# 分发 ambari 仓库配置
ansible all -m copy -a 'dest=/etc/yum.repos.d/ambari.repo src=/etc/yum.repos.d/ambari.repo owner=root mode=0644 group=root'
# 分发 hdp 仓库配置
ansible all -m copy -a 'dest=/etc/yum.repos.d/hdp.repo src=/etc/yum.repos.d/hdp.repo owner=root mode=0644 group=root'
# 重建 yum 缓存
ansible all -m shell -a 'yum clean all && yum makecache'

# 分发 host 文件
ansible all -m copy -a "src=/etc/hosts dest=/etc/hosts owner=root group=root mode=0644"

# 设置机器 hostname
ansible all -m hostname -a "name={{ hostname }}"

# 设置域名解析
ansible all -m blockinfile -a "dest=/etc/sysconfig/network marker='设置域名解析 #{mark}' block=NETWORKING=yes\nHOSTNAME={{hostname}}"

# 关闭 selinux
ansible all -m selinux -a 'state=disabled'

# 关闭交换内存
ansible all -m sysctl -a 'name=vm.swappiness value=0 state=present'

# 批量修改时区
ansible all -m timezone -a 'name=Asia/Shanghai'

# 关闭防火墙
ansible all -m shell -a 'systemctl stop firewalld'
ansible all -m shell -a 'systemctl disable firewalld'

# 设置 umask
ansible all -m blockinfile -a 'dest=/etc/profile marker="# set umask to 0022 {mark}" block="umask 0022"'

# 关闭 NetworkManager
ansible all -m shell -a 'systemctl stop NetworkManager &&  systemctl disable NetworkManager'

# 设置 builderNumber，Ambari会使用到
ansible all -m blockinfile -a 'dest=/etc/profile marker="# set buildNumber {mark}" block="export buildNumber=2.7.3.0.0"'
```

安装 OpenJDK 8 并设置 JAVA_HOME，` vim /opt/install/install_jdk8.yml` 添加如下内容：

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install jdk8
      yum:
        name: "java-1.8.0-openjdk*"

    - name: set JAVA_HOME
      blockinfile:
        dest: "/etc/profile"
        marker: "# JAVA_HOME {mark}"
        block: |
          export JAVA_HOME=/usr/lib/jvm/java
          export PATH=$JAVA_HOME/bin:$PATH
```

执行命令全节点安装：`ansible-playbook /opt/install/install_jdk8.yml -e '{"host":"all"}'`。

配置 `server1.haohan.com` 到各节点免密：

1. server1.haohan.com 节点生成密钥：`ssh-keygen -t rsa`，一路回车确定即可。

2. 分发密钥到各个 agent 配置免密：`ansible all -m authorized_key -a "user=root state=present key=\"{{ lookup('file', '/root/.ssh/id_rsa.pub') }}\""`。

> NOTE： 后续安装 Ambari 时需要获取 server1.haohan.com 节点密钥：`cat ~/.ssh/id_rsa`。

### 4.3 格式化磁盘（谨慎操作）

**如果磁盘未格式化挂载才需要做这一步**，则磁盘格式化建议由专门的运维人员进行操作，因为需要根据不同的服务器，不同的硬盘数量做适配。

以下仅给出当前测试环境的示例：

- 鲲鹏服务器：/dev/sda ~ /dev/sdx 作为数据盘，每个盘 1.2 T，共 24 个盘，使用 xfs 作为磁盘文件系统
- x86 服务器：/dev/sdb ~ /dev/sdl 作为数据盘，/dev/sda 为系统盘，因此脚本中排除掉了，每个盘 4 T，共 11 个盘，使用 xfs 作为磁盘文件系统

针对鲲鹏服务器的磁盘格式化脚本（如果前面已经做过可忽略）： `vim /opt/install/parted_aarch64.sh` 并添加如下内容

```bash
#/usr/bin/env bash
##########################################################
# @author: zhengxuankun@haohan.com.cn
# @description: 鲲鹏服务器磁盘格式化，过滤所有 1.2T 的磁盘设备并挂载到 /data*，* 为递增序号，从 1 开始
# @date: 2020/01/26
##########################################################
function format {
  local disk=$1
  bh=${disk: -1}
  disk_xh=$(expr $(printf "%d" "'$bh") - 96)
  umount /data${disk_xh}
  parted $disk <<FORMAT
  rm 1
  mklabel gpt
  Yes
  mkpart primary 1 100%
  quit
FORMAT

  mkfs.xfs -f ${disk}1 -b size=8192
  mkdir -p /data${disk_xh}
  mount -o nobarrier ${disk}1 /data${disk_xh}
  sed -i 's@'$disk'.*@@g' /etc/fstab
  sed -i -e '/^$/d' /etc/fstab 
  echo ${disk}"1 /data"${disk_xh}" xfs nobarrier 0 0" >> /etc/fstab
  wait
}



for disk in `fdisk -l 2>/dev/null|grep 1200.2|awk '{print $2}'|awk -F ':' '{print $1}'|sort`
do
  format $disk
done
wait
```

针对 x86 服务器的磁盘格式化脚本（如果前面已经做过可忽略）： `vim /opt/install/parted_x86_64.sh` 并添加如下内容

```bash
#/usr/bin/env bash
##########################################################
# @author: zhengxuankun@haohan.com.cn
# @description: x86服务器磁盘格式化，过滤所有 4t 的磁盘设备并挂载到 /data*，* 为递增序号，从 1 开始
# @date: 2020/01/26
##########################################################

function format {
  local disk=$1
  bh=${disk: -1}
  disk_xh=$(expr $(printf "%d" "'$bh") - 97)
  umount /data${disk_xh}
  parted $disk <<FORMAT
  rm 1
  mklabel gpt
  Yes
  mkpart primary 1 100%
  quit
FORMAT

  mkfs.xfs -f ${disk}1 -b size=4096
  mkdir -p /data${disk_xh}
  mount -o nobarrier ${disk}1 /data${disk_xh}
  sed -i 's@'$disk'.*@@g' /etc/fstab
  sed -i -e '/^$/d' /etc/fstab 
  echo ${disk}"1 /data"${disk_xh}" xfs nobarrier 0 0" >> /etc/fstab
  wait
}



for disk in `fdisk -l 2>/dev/null|grep 4000.2|awk '{print $2}'|grep -v /dev/sda|awk -F ':' '{print $1}'|sort`
do
  format $disk
done
wait
```

`vim /opt/install/parted.yml`，添加如下内容

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:

    - name: "创建安装文件夹"
      file:
        path: /opt/install
        state: directory

    - name: "获取机器架构"
      shell: arch
      register: arch_result

    - name: "分发x86磁盘格式化脚本"
      copy:
        src: /opt/install/parted_x86_64.sh
        dest: /opt/install/parted.sh
        owner: root
        group: root
        mode: '0644'
      when: arch_result.stdout == "x86_64"

    - name: "分发 aarch64 磁盘格式化脚本"
      copy:
        src: /opt/install/parted_aarch64.sh
        dest: /opt/install/parted.sh
        owner: root
        group: root
        mode: '0644'
      when: arch_result.stdout == "aarch64"

    - name: "执行磁盘格式化脚本"
      shell: sh /opt/install/parted.sh
      async: 600
```

执行命令：`ansible-playbook ./parted.yml -e '{"host":"no_ansible"}'`，等待 ansible 配置的全部机器磁盘格式化完成。

> NOTE：no_ansible 剔除了 server1.haohan.com 这台机器，因为前面搭建本地仓库的时候已经格式化过磁盘了。

### 4.4 ntp 同步

- server1.haohan.com 设置外部 ntp 时间源。
- 其余服务器以 server1.haohan.com 做为时间源。

如果 server1.haohan.com 可以访问公网，则使用阿里云提供的 [ntp 服务器](https://help.aliyun.com/document_detail/92704.html)： `ntp.aliyun.com`、`ntp1.aliyun.com`、`ntp2.aliyun.com`、`ntp3.aliyun.com`。如果 server1.haohan.com 处于内网环境无法访问公网，请咨询运维人员具体的内网 ntp 服务器地址。

在 server1.haohan.com 执行以下命令：

```bash
# 在所有机器安装 ntp 服务
ansible all -m yum -a "name=ntp"
```

设置阿里云 ntp 时间源：

```bash
sed -i -e 's@^server 0.*@server ntp.aliyun.com@g' /etc/ntp.conf
sed -i -e 's@^server 1.*@server ntp1.aliyun.com@g' /etc/ntp.conf
sed -i -e 's@^server 2.*@server ntp2.aliyun.com@g' /etc/ntp.conf
sed -i -e 's@^server 3.*@server ntp3.aliyun.com@g' /etc/ntp.conf
```

其余服务器将 server1.haohan.com 指定为集群的时间源：

```bash
ansible no_ansible -m shell -a "sed -i -e 's@^server 0.*@server server1.haohan.com@g' /etc/ntp.conf"
ansible no_ansible -m shell -a "sed -i '/^server 1\..*/d' /etc/ntp.conf"
ansible no_ansible -m shell -a "sed -i '/^server 2\..*/d' /etc/ntp.conf"
ansible no_ansible -m shell -a "sed -i '/^server 3\..*/d' /etc/ntp.conf"
```

先同步时间并启动 ntp 服务：`ansible no_ansible -m shell -a 'ntpdate -u server1.haohan.com && systemctl restart ntpd && systemctl enable ntpd'`。

## 5. 安装 Ambari

### 5.1 安装 postgresql

在 server1.haohan.com 上安装 pg：

```
 yum -y install postgresql-server postgresql-contrib postgresql-jdbc
```

安装后的 pg 版本为 9.2.24，不同版本可能略有差异，这里以 9.2.24 为例。

在数据盘下创建 pg 的数据存储文件：

```bash
mkdir -p /data1/pg_data
chown -R postgres:postgres /data1/pg_data
chmod -R 700 /data1/pg_data
```

修改 pg 的数据目录为上述创建路径 `vim /usr/lib/systemd/system/postgresql.service` ：

```bash
# 找到如下配置
Environment=PGDATA=/var/lib/pgsql/data

# 修改为
Environment=PGDATA=/data1/pg_data
```

初始化 pg 并启动：

```bash
postgresql-setup initdb && systemctl start postgresql && systemctl enable postgresql
```

开启 pg 远程登录 `vim /data1/pg_data/pg_hba.conf`，之后找到如下配置（通常在配置文件末尾）：

```bash
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     peer
# IPv4 local connections:
host    all             all             127.0.0.1/32            ident
```
将其修改为如下内容：

```bash
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             192.168.1.0/24          md5
```

> NOTE：这里的 192.168.1.0/24 是当前环境的一个网段，不同网络需要配置的网段不同，具体网段请咨询运维人员。

修改 pg 一些必要配置 `vim /data1/pg_data/postgresql.conf`，找到如下配置：

```bash
#listen_addresses = 'localhost'         # what IP address(es) to listen on;

max_connections = 100
```

修改为如下内容：

```bash
listen_addresses = '*'         # what IP address(es) to listen on;
max_connections = 10000
```

修改系统信号量 `vim /etc/sysctl.conf` ，在末尾添加如下内容：

```bash
kernel.sem='250 250000 32 1000'
```

登录 pg 数据库 `sudo -u postgres psql`，执行下列命令：

```sql
ALTER USER postgres WITH PASSWORD 'postgres';
create USER ambari with PASSWORD 'ambari123';
create database ambari;
GRANT ALL PRIVILEGES ON DATABASE ambari TO ambari;  
```

之后 `Ctrl + D` 退出 pg，重启 pg：`systemctl restart postgresql`。

### 5.2 安装 Ambari

在 server1.haohan.com 上安装 Ambari Server

```bash
yum install ambari-server.aarch64 -y
```

初始化 ambari 的数据库连接，这里使用 postgres，执行 `ambari-server setup --jdbc-db=postgres --jdbc-driver=/usr/share/java/postgresql-jdbc.jar`，输出如下内容：

```bash
Using python  /usr/bin/python
Setup ambari-server
Copying /usr/share/java/postgresql-jdbc.jar to /var/lib/ambari-server/resources/postgresql-jdbc.jar
If you are updating existing jdbc driver jar for postgres with postgresql-jdbc.jar. Please remove the old driver jar, from all hosts. Restarting services that need the driver, will automatically copy the new jar to the hosts.
JDBC driver was successfully initialized.
Ambari Server 'setup' completed successfully.
```

执行 `ambari-server setup`进入交互式命令行，按照下面加粗内容输入即可：

```bash
Using python  /usr/bin/python
Setup ambari-server
Checking SELinux...
SELinux status is 'enabled'
SELinux mode is 'permissive'
WARNING: SELinux is set to 'permissive' mode and temporarily disabled.
OK to continue [y/n] (y)? y
Customize user account for ambari-server daemon [y/n] (n)? n
Adjusting ambari-server permissions and ownership...
Checking firewall status...
Checking JDK...
[1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8
[2] Custom JDK
Enter choice (1): 2
WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.
WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.
Path to JAVA_HOME: /usr/lib/jvm/java
Validating JDK on Ambari Server...done.
Check JDK version for Ambari Server...
JDK version found: 8
Minimum JDK version is 8 for Ambari. Skipping to setup different JDK for Ambari Server.
Checking GPL software agreement...
GPL License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html
Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? y
Completing setup...
Configuring database...
Enter advanced database configuration [y/n] (n)? y

Configuring database...

Choose one of the following options:
[1] - PostgreSQL (Embedded)
[2] - Oracle
[3] - MySQL / MariaDB
[4] - PostgreSQL
[5] - Microsoft SQL Server (Tech Preview)
[6] - SQL Anywhere
[7] - BDB
Enter choice (1): 4
Hostname (localhost): server1.haohan.com
Port (5432): 5432
Database name (ambari): ambari
Postgres schema (ambari): ambari
Username (ambari): ambari
Enter Database Password (bigdata): ambari123
Re-enter password: ambari123
Configuring ambari database...
Configuring remote database connection properties...
WARNING: Before starting Ambari Server, you must run the following DDL directly from the database shell to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-Postgres-CREATE.sql
Proceed with configuring remote database connection properties [y/n] (y)? y
Extracting system views...
ambari-admin-2.7.3.0.139.jar
....
Ambari repo file doesn't contain latest json url, skipping repoinfos modification
Adjusting ambari-server permissions and ownership...
Ambari Server 'setup' completed successfully.
```

登录 pg：`psql -h server1.haohan.com -U ambari`，执行如下命令：

```sql
\c ambari;
\i /var/lib/ambari-server/resources/Ambari-DDL-Postgres-CREATE.sql;
```

启动 Ambari Server：`ambari-server start`，登录 `http://server1.haohan.com:8080/#/login`（需本地先配好映射），即可看到登录界面：

![image-20210127102448726](https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/20210127102725.png)