---
title: ansible-playbook
date: 2020-07-23 09:52:14
---

[TOC]

## 1. 介绍

执行一个 playbook:

```bash
# -B200
# -P 1 
ansible-playbook playbook.yml -f 10 -e "{'host':'interface'}"
```

- `-f` ：并发度 10
- `-e` or  `--extra-vars` ：对 `vars` 追加额外参数。
- `-B`：开启异步模式，200s 为超时时间
- `-P`：轮训 job 状态的时间间隔，单位：s。

```yaml
---
- hosts: webservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  sudo: yes
  sudo_user: zxk
  tasks:
  - name: ensure apache is at the latest version
    yum: pkg=httpd state=latest
    sudo: yes
  - name: write the apache config file
    template: src=/srv/httpd.j2 dest=/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running
    service: name=httpd state=started
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
```

### 1.1. 远程用户

* remote\_user：指定远程主机用户
* sudo\_user：指定登录远程主机后要切换的用户，可选
* sudo：是否使用sudo执行，可以指定全局，也可以指定某个task下，如果在使用 sudo 时指定密码,可在运行 ansible-playbook 命令时加上选项 --ask-sudo-pass \(-K\)。

### 1.2. Tasks

tasks 下可以指定多个module执行命令，如果在 `vars` 有指定变量，也可以通过 `{{ variable }}` 来使用，通常格式为：

```yaml
tasks:
  - name: make sure apache is running
    service: name=httpd state=running
  - name: Copy ansible inventory file to client
    copy: src=/etc/ansible/hosts dest=/etc/ansible/hosts owner=root group=root mode=0644
  - name: create a virtual host file for {{ vhost }}
    template: src=somefile.j2 dest=/etc/httpd/conf.d/{{ vhost }}
```

比较特别的两个 modudle 是 command 和 shell ,它们不使用 key=value 格式的参数,而是这样:

```yaml
tasks:
  - name: disable selinux
    command: /sbin/setenforce 0
  - name: run this command and ignore the result
    shell: /usr/bin/somecommand
    ignore_errors: True
```

### 1.3. Facts

facts 默认开启，用于收集远程主机信息，并且可以作为参数使用。 执行 `ansible hostname -m setup` 获取相关信息，比如：

```json
"ansible_default_ipv6": {},
"ansible_devices": {
    "sda": {
        "holders": [],
        "host": "SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)",
        "model": "VMware Virtual S",
        "partitions": {
            "sda1": {
                "sectors": "39843840",
                "sectorsize": 512,
                "size": "19.00 GB",
                "start": "2048"
            }
        }
      }
......
```

接着在 playbook 可以这样使用：

```yaml
{{ ansible_devices.sda.model }}
```

如果不需要这些信息，关闭可以有利于提高 ansible 执行效率：

```yaml
- hosts: webservers
  gather_facts: no
```

### 1.4. 标准循环

可以通过 `with_items` 对 module 循环执行，同时通过 `item.xxx` 引用循环体中的变量：

```yaml
- name: add several users
  user: name={{ item.name }} state=present groups={{ item.groups }}
  with_items:
    - { name: 'testuser1', groups: 'wheel' }
    - { name: 'testuser2', groups: 'root' }
```

## 2. ansible-playbook 常用模块

| module | comment | link |
| :---: | :---: | :---: |
| template | 用于生成**本机模板文件**并分发到远程主机 | [template – Template a file out to a remote server](https://docs.ansible.com/ansible/latest/modules/template_module.html#template-template-a-file-out-to-a-remote-server) |
| synchronize | 对 rsync 的一层封装 | [synchronize – A wrapper around rsync to make common tasks in your playbooks quick and easy](https://docs.ansible.com/ansible/latest/modules/synchronize_module.html#synchronize-a-wrapper-around-rsync-to-make-common-tasks-in-your-playbooks-quick-and-easy) |

### when 模块

```
---   
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: "获取机器厂商"
      shell: cat /sys/class/dmi/id/board_vendor
      register: result
      
    - name: "拷贝xx到远端机器"
      copy:
        src: /home/xx
        dest: /home/xx
        owner: root
        group: root
        mode: '0777'
      when: result.stdout == "HP"
```

### copy 模块

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: "拷贝复制磁盘格式化脚本"
      copy:
        src: /home/zxk/repairdisk.sh
        dest: /home/zxk/repairdisk.sh
        owner: root
        group: root
        mode: '0644'
```

### pam\_limits 模块

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: "配置目标机器全局环境limit.conf"
      pam_limits:
          dest: "{{ item.dest }}"
          domain: '*'
          limit_type: "{{ item.limit_type }}"
          limit_item: "{{ item.limit_item }}"
          value: "{{ item.value }}"
      with_items:
          - { dest: '/etc/security/limits.conf', limit_type: 'soft', limit_item: 'nproc', value: '65535' }
          - { dest: '/etc/security/limits.conf', limit_type: 'hard', limit_item: 'nproc', value: '65535' }
          - { dest: '/etc/security/limits.conf', limit_type: 'soft', limit_item: 'nofile', value: '65535' }
          - { dest: '/etc/security/limits.conf', limit_type: 'hard', limit_item: 'nofile', value: '65535' }
          - { dest: '/etc/security/limits.conf', limit_type: '-', limit_item: 'nofile', value: '65535' }

    - name: "配置目标机器limit.d下配置"
      pam_limits:
          dest: "{{ item.dest }}"
          domain: 'cloudera-scm'
          limit_type: "{{ item.limit_type }}"
          limit_item: "{{ item.limit_item }}"
          value: "{{ item.value }}"
      with_items:
          - { dest: '/etc/security/limits.d/cloudera-scm.conf', limit_type: 'soft', limit_item: 'nproc', value: '65535' }
          - { dest: '/etc/security/limits.d/cloudera-scm.conf', limit_type: 'hard', limit_item: 'nproc', value: '65535' }
          - { dest: '/etc/security/limits.d/cloudera-scm.conf', limit_type: 'soft', limit_item: 'nofile', value: '65535' }
          - { dest: '/etc/security/limits.d/cloudera-scm.conf', limit_type: 'hard', limit_item: 'nofile', value: '65535' }
```

### Shell 模块

```yaml
- hosts: "{{ host }}"
  vars:
    http_port: 80
    max_clients: 200
  tasks:
    - shell: echo {{ ansible_nodename }} {{ ansible_eth5.ipv4.address }}
      register: shell_result
    - debug: var=shell_result.stdout_lines
```

若需要获取 ansible 执行命令后的标准输出，需要配置 `-debug` 以及在 `shell` 下配置`register` 。

### sysctl 模块

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: '修改net.core.somaxconn'
      sysctl:
        name: net.core.somaxconn
        value: 4096
        state: present
        ignoreerrors: yes
    - name: '修改net.core.somaxconn'
      sysctl:
        name: net.ipv4.tcp_max_syn_backlog
        value: 4096
        state: present
    - name: '删除vm.swappiness '
      sysctl:
        name: vm.swappiness
        state: absent
        reload: yes
```

### hostname 模块

```bash
[agent]
agent1.192.168.1.1 hostname=agent1 ansible_host=192.168.1.1 ansible_user=root ansible_ssh_pass="passwd"
```

批量设置机器hostname，注意文件中需要配置上：

```bash
ansible agent -m hostname -a "name={{ hostname }}" 
```

### selinux 模块

```bash
# Enable SELinux
- selinux:
    policy: targeted
    state: enforcing

# Put SELinux in permissive mode, logging actions that would be blocked.
- selinux:
    policy: targeted
    state: permissive

# Disable SELinux
- selinux:
    state: disabled
```

### blockinfile

```yaml
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
    - name: "网络配置文件"
      blockinfile:
          dest: "/etc/sysconfig/network"
          marker: "# 设置域名解析 {mark}"
          block: |
            NETWORKING=yes
            HOSTNAME={{hostname}}
```

### authorized_key 模块

[authorized_key - Adds or removes an SSH authorized key](https://docs.ansible.com/ansible/2.4/authorized_key_module.html)

批量推送公钥到远程节点，从而实现免密，先本机生成公钥：`ssh-keygen -t rsa`，接着批量推送：

```bash
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
  - name: Set authorized key took from file
    authorized_key:
      user: root
      state: present
      key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"
```

> NOTE：SSH 进行认证的过程中除了对用户目录有权限要求外，对 **.ssh** 文件夹和 **authorized_keys** 文件同样也要限制为 755。

### yum 安装软件

[ansible.builtin.yum – Manages packages with the *yum* package manager](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/yum_module.html)

```
---
- hosts: "{{ host }}"
  remote_user: root
  gather_facts: no
  tasks:
	- name: Install jdk8
	  yum:
    	name: java-1.8.0-openjdk
	    state: latest
```

