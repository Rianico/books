---
title: 08.iostat 磁盘分析工具
date: 2021-03-17
---

## iostat 磁盘分析工具

iostat是I/O statistics（输入/输出统计）的缩写，用来动态监视系统的磁盘操作活动。

iostat 命令语法：`iostat [参数] [时间间隔] [次数]`

通过 iostat 方便查看 CPU、网卡、tty设备、磁盘、CD-ROM 等设备的活动情况,及负载信息。

- -C 显示CPU使用情况
- -d 显示磁盘使用情况
- -k 以 KB 为单位显示
- -m 以 M 为单位显示
- -N 显示磁盘阵列(LVM) 信息
- -n 显示NFS 使用情况
- -p[磁盘] 显示磁盘和分区的情况
- -t 显示终端和CPU的信息
- -x 显示详细信息
- -V 显示版本信息

**常用命令**：

```bash
# 查看 I/O 具体信息
[root@localhost ~]# iostat -x
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.07    0.00    0.33    0.46    0.00   97.14

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sdv               0.00     0.00   74.00    0.00 11680.00     0.00   315.68     1.09   15.74   15.74    0.00   1.89  14.00
sdw               0.00     0.00  106.00    0.00 16704.00     0.00   315.17     1.80   18.25   18.25    0.00   1.65  17.50

# 查看磁盘吞吐
[root@localhost ~]# iostat -mtx 1 1
```

**磁盘负载信息的一些经验**：

- 如果 %iowait 的值过高，表示硬盘存在 I/O 瓶颈；
- 如果 %idle 值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量；
- 如果 %idle 值如果持续低于 10，表明系统中最需要解决的资源是 CPU。

**各项参数的解释**：

- tps：该设备每秒的传输次数。多个逻辑请求可能会被合并为 “一次 I/O 请求”，“一次传输”请求的大小是未知的
- rrqm/s、wrqm/s: 每秒进行 merge 的读、写操作数目，如果两个 I/O 发生在相邻区域，可以合并为一个 I/O
  - 当前磁盘常见有三种调度算法：noop（固态）、deadline 和 cfq，可以通过 `/sys/block/磁盘设备/queue/scheduler  ` 查看
- r/s、w/s: 每秒完成的读、写 I/O 设备次数。即 rio/s
- rsec/s、wsec/s: 每秒读、写扇区数
- rkB/s、wkB/s: 每秒读、写的 KB 字节数。是 rsect/s、wsec/s 的一半，因为每扇区大小为512字节
- **avgrq-sz**: 平均每次设备 I/O 操作扇区数目，反应了是大 I/O 还是小 I/O，上限值取决于 `/sys/block/sdc/queue/max_sectors_kb`  除以扇区大小（512 bytes）。
- **avgqu-sz**: 平均 I/O 队列长度，可以反映出当前磁盘的负载
  - 队列长度可以通过 `/sys/block/磁盘设备/queue/nr_requests` 修改
- await: 平均每次设备 I/O 操作的等待时间 (毫秒)。
- svctm: 平均每次设备 I/O 操作的服务时间 (毫秒)，有争议的指标。
- **%util**: 一秒中有百分之多少的时间用于 I/O 操作，即被 io 消耗的 cpu 百分比 。
  - 这个指标不能说明磁盘的极限，当采样时间为 1s，假设每个 I/O 需要 0.1s，并发提交（处理）与串行提交（处理）得到的分别为 10% 与 100%

常用的一些磁盘优化手段：

1. 增大队列长度可以提高合并 I/O，但会增加内存占用，`/sys/block/磁盘设备/queue/nr_requests`

2. 增大预读，默认 128 KB，通常较小

   ```bash
   os_dev=`df |grep boot|sed -n '1p'|awk -F '/' '{print $3}'|awk '{print $1}'|sed 's![0-9]!!g'`
   
   disk_List=`lsscsi | awk -F "/" '{print $NF}'|grep -vi Expander|grep -v $os_dev`
   echo disk_List=$disk_List
   
   for i in $disk_List
   do
     echo 8192 > /sys/block/$i/queue/read_ahead_kb
   done
   ```


参考：

- [深入理解iostat](https://bean-li.github.io/dive-into-iostat/)
- [Linux IO Scheduler（Linux IO 调度器）](https://www.cnblogs.com/cobbliu/p/5389556.html)