---
title: 01. 常用命令
date: 2020-07-23 09:52:31
---
## 1. awk

1. 统计网络连接各状态数目

   ```bash
   netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
   ```

2. 查看 HDFS 异常文件

   - OFS：指定输出结果的分隔符，默认空格。
   - FS：指定输入结果的分隔符。

   ```bash
   export HADOOP_CLIENT_OPTS="-XX:-UseGCOverheadLimit -Xmx10240m"
   hadoop fs -du -s /data/20200917/2*/*/*/* | awk 'BEGIN{ OFS="|" }{print $1,$2,$3}' | grep "^0|"|awk -F'|' '{system("sudo -u hdfs hadoop fs -rm -f " $3)}' 
   ```

3. awk 对列求和：

   ```shell
   echo -e '1\n2'|awk '{sum += $1};END {print sum}'
   ```

## 2. xargs

1. 递归改名

   ```bash
   # -n1 表示最多读取一个参数
   find / -name 'part*'|xargs -n1 rename 'part' 'jiake-part'
   ```

## 3. vim

1. 设置中文

   ```bash
   echo 'set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936\nset termencoding=utf-8\nset encoding=utf-8"' > ~/.vimrc
   ```

## 4. sed

1. 强制替换文本内容

   ```bash
   sed -i 's/aaa/bbb/g' xxx.log
   ```

2. 结合 grep 批量修改文件内容

   ```bash
   # -i：允许直接修改文件
   # -r：递归    -l：只输出match到的文件名
   sed -i "s/原字符串/新字符串/g" `grep 匹配文件名 -rl 所在目录`
   ```

3. 搜索匹配的文本

   ```bash
   # -n 不输出原文本内容
   # p 指定匹配模式，输出匹配行
   # = 输出行号
   sed -n '/search/p' file.txt
   ```


## 5. 交换内存

swap分区是在系统内存不足时，转而利用磁盘空间作为内存使用的一种机制。

`swappiness`的值决定了Linux在使用了多少内存之后就会开始使用磁盘的swap分区，默认值通常为60，也就是说，Linux在剩下 $$100\% - 60\% = 40\%$$ 内存的时候，系统便会开始使用swap分区。

由于swap分区位于磁盘上，速度肯定是不如内存的，因此通常会把这个值调小到1~10之间：

```bash
# 查看swappiness
sysctl -q vm.swappiness

# 临时修改swappiness，重启后失效
sysctl -w vm.swappiness=1

# 查看swap空间所在设备
swapon -s

# 关闭swap并重新打开，将swap的数据清空
swapoff -a && swapon -a

# 永久修改swappiness
echo 'vm.swappiness = 1' >> /etc/sysctl.conf && sysctl -p
```

## 6. 系统信息

### 6.1 CPU 信息

* 物理 CPU ：服务器插槽上的 CPU 个数，可以通过不重复的 physical id 得知有几个。
* CPU 核心数：每个物理 CPU 都可以有多个 core。
* CPU 逻辑核心数：若处理器支持超线程技术，还可以在物理 CPU 核心数的基础上再乘以一个倍数（通常为 2）。

```shell
# 查看 CPU 型号
$ cat /proc/cpuinfo | grep "model name" | uniq

# 查看 CPU 频率
$ cat /proc/cpuinfo | grep "cpu MHz" | uniq

# 服务器的物理 CPU 数量
$ cat /proc/cpuinfo | grep "physical id" | sort | uniq|wc -l
2
# 每个 CPU 的核心数
$ cat /proc/cpuinfo | grep "cores"|uniq
cpu cores       : 8
# 查看总的核心数*超线程数
$ cat /proc/cpuinfo | grep "processor" |wc -l
32
# 查看每个 CPU 的核心数以及超线程
$ cat /proc/cpuinfo | grep -e "cpu cores"  -e "siblings" | sort | uniq

# 查看CPU三级缓存
$ lscpu
# 查看缓存行单位大小
$ cat /sys/devices/system/cpu/cpu1/cache/index0/coherency_line_size
```

鲲鹏服务器（arm 架构，920 处理器）是没有超线程概念的，通过 `/proc/cpuinfo` 也仅能看到总的核心数，可以通过下列命令查看物理 cpu 信息以及核心数：

```bash
dmidecode -t processor
```

### 6.2 查看操作系统版本

```bash
cat /etc/issue
cat /etc/redhat-release
```

### 6.3 查看内核版本

```bash
uname -smr
Linux 3.10.0-957.12.2.el7.x86_64 x86_64
3 - 内核版本.
10 - 主修订版本.
0-957 - 次要修订版本.
12 - 补丁版本.
```

### 6.4 查看bios版本信息及内存信息、服务器型号

```bash
# 查看服务器厂商
dmesg | grep -i DMI
dmidecode -t system | grep "Manufacturer\|Product Name\|Version\|Serial Number"
cat /sys/class/dmi/id/board_vendor

# 查看bios信息
dmidecode -t bios
```

### 6.5 查看环境变量，字符集（LANG）

```bash
env
```

有时候由于升级 glib 后某些文件的权限不正确，会让不同用户能读取的系统关键文件不一样，从而导致一些异常问题（e.g. 不同用户时区不一致）。

### 6.6 查看系统架构

```bash
aarch
```

## 7. 查看网络

### 7.1 netstat

### 7.2 ss

```bash
-s：显示摘要信息
-n：不解析服务名称，以数字方式显示；
-a：显示所有的套接字；
-l：显示处于监听状态的套接字；

-p：显示使用套接字的进程信息；
-o：显示计时器信息；
-m：显示套接字的内存使用情况；
-i：显示内部的TCP信息；

-4：只显示ipv4的套接字；
-6：只显示ipv6的套接字；

-t：只显示tcp套接字；
-u：只显示udp套接字；

-d：只显示DCCP套接字；
-w：仅显示RAW套接字；
-x：仅显示UNIX域套接字。
```

1. 查看网络统计（e.g. tcp 连接数、udp 连接数等）

   ```bash
   ss -s
   ```

2. 查看 socket 使用的 rmem、wmem：

   ```bash
   ss -ntm
   ```

### 7.3 查看 tcp rmem/wmem

```bash
$ sysctl -a | egrep "rmem|wmem|adv_win|moderate"
net.core.rmem_default = 212992
net.core.rmem_max = 212992
net.core.wmem_default = 212992
net.core.wmem_max = 212992
net.ipv4.tcp_adv_win_scale = 1
# 自动调整 tcp (rw)mem
net.ipv4.tcp_moderate_rcvbuf = 1
net.ipv4.tcp_rmem = 4096    87380   6291456
net.ipv4.tcp_wmem = 4096    16384   4194304
net.ipv4.udp_rmem_min = 4096
net.ipv4.udp_wmem_min = 4096
vm.lowmem_reserve_ratio = 256   256 32
```

`net.ipv4.tcp_(rw)mem` 优先于 `net.core.(rw)mem_max`，在不指定 `SO_SNDBUF` 以及 `SO_RCVBUF` 的时候，内核会默认在 `net.ipv4.tcp_(rw)mem` 范围动态调整。

(rw)mem 的大小通常可以通过 RTT * （带宽 / 8）来计算得出，在数据发送出去后，直到收到 ack 之前，数据所占用的内存是不会释放的，此时 CPU 也无法继续发送数据，造成资源浪费。

### 7.4 dstat

dstat 可以同时查看磁盘、带宽的吞吐量

```bash
dstat

----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw 
  4   0  96   0   0   0|3056k   15M|   0     0 |   0     0 |2116  2664 
  0   0 100   0   0   0|   0     0 | 771B 7652B|   0     0 | 816  1178 ^C
```

## 8. lsof

1. 使用 lsof 统计进程打开文件数

   ```bash
   lsof -n | awk '{print $2}' | sort | uniq -c | sort -nr | more
   ```

## 9. sort

## 10. mount

1. 将一个文件当做当成硬盘分区挂载到目录下

   ```bash
   mount -o loop /opt/centos7.6.iso /var/www/html
   # ro：采用只读方bai式挂接设备
   # rw：采用读写方式挂接设备
   # iocharset：指定访问文件系统所用字符集
   # 在类 UNIX 系统里，loop 设备是一种伪设备(pseudo-device)，或者也可以说是仿真设备。它能使我们像块设备一样访问一个文件。
   ```

## 11. wget

1. 使用 wget 拉取阿里云 yum 仓库

   ```bash
   wget -r -p -np -k http://mirrors.aliyun.com/epel/7/x86_64/ -e robots=off --no-check-certificate
   # -r 递归
   # -p 下载所有用于显示 HTML 页面的图片之类的元素。
   # -np 不追溯父目录
   # -k 让下载得到的 HTML 或 CSS 中的链接指向本地文件。
   # --no-check-certificate   不要验证服务器的证书。
   ```

2. 同步 yum 仓库还可以使用 reposync 命令完成

   ```bash
   # 配置华为云 epel 的 CentOS-7 镜像
   yum install https://repo.huaweicloud.com/epel/epel-release-latest-7.noarch.rpm
   sed -i "s/#baseurl/baseurl/g" /etc/yum.repos.d/epel.repo
   sed -i "s/metalink/#metalink/g" /etc/yum.repos.d/epel.repo
   sed -i "s@https\?://download.fedoraproject.org/pub@https://repo.huaweicloud.com@g" /etc/yum.repos.d/epel.repo
   
   # 如果想要拉取 x86 架构的库，则将 baseurl=https://repo.huaweicloud.com/epel/7/$basearch 修改为如下
   baseurl=https://repo.huaweicloud.com/epel/7/x86_64
   
   # 更新 yum cache
   yum clean all && yum makecache
   
   # 之后执行 reposync 命令，最后可以见到 /data3/zxk/repo/epel 目录
   reposync -r epel -a x86_64 -p /data3/zxk/repo/
   # 创建 yum 仓库的 repo
   createrepo  /data3/zxk/repo/epel
   ```


## 12. 多进程

shell 中通过 `&` 启动后台子任务后，如果是一个比较耗时的操作，则需要使用 `wait` 来等待其完成，否则操作将不完整，且在不同地方调用 wait，wait 的作用域也不同。

在函数中调用 wait，会等待当前函数中未完成的子任务，在 shell 中调用 wait，会等待当前 shell 的 子任务，而不会等待函数中的子任务。因此要达到类似同步的效果，通常需要在函数以及 shell 中一起调用 wait。

```bash
#!/usr/bin/env bash
fun(){
  sleep 5 &
  # 会等待5s
  wait
}

fun &
# 会等待fun完成
wait
```

## 13. ps

ps 提供了 sort 进行排序：

```bash
# 根据 pid、运行时间排序
# -o：自定义格式
## lstart 开始时间
## etime 运行时间
ps eo pid,lstart,etime --sort=pid,lstart,etime

# 可排序的参数
## rss：真实使用的内存
## vsz：使用的虚拟内存
## %cpu：使用的 cpu 比例
## %mem：使用的内存比例
ps aux --sort=%cpu
```

如果排序需要倒序，添加 `-` 即可，例如 `--sort=-%cpu`。

## 14. 磁盘相关

重新扫描磁盘设备：

```bash
for host in `ls /sys/class/scsi_host/`;do echo '- - -'  > /sys/class/scsi_host/$host/scan;done 
```

查看磁盘是否为固态（rota 为 0）：

```bash
lsblk -d -o name,rota
```

查看磁盘接口：

```bash
lsscsi -vv

 sysfsroot: /sys
[0:2:0:0]    disk    DELL     PERC H730 Adp    4.25  /dev/sda 
  dir: /sys/bus/scsi/devices/0:2:0:0  [/sys/devices/pci0000:00/0000:00:03.0/0000:03:00.0/host0/target0:2:0/0:2:0:0]
  
# PERC H730 Adp 表示做了 raid，否则会是磁盘型号
```

## 15 split 切割文件

语法格式：`Usage: split [OPTION]... [FILE [PREFIX]]`

```bash
# -a：指定后缀数字长度
# -d：指定后缀从数字 0 开始计数，--numeric-suffixes[=FROM] 允许指定初始值
split -a 2 -d -n 2 sf-fire-calls.csv sf-fire-calls.csv
```

- -n：指定目标切割数
- -b：按照字节数切割，单位：k、m
- -C：按照字节数切割，但会尽可能保持完整的一行记录，单位：k、m
- -l：按照行来切割

## 16. CentOS 禁止远程 root 登录

1.修改配置文件

```bash
# 修改配置文件
vim /etc/ssh/sshd_config 
# 修改 PermitRootLogin 为 no 禁止远程 root 登录
PermitRootLogin no
```

2.重新加载配置文件或者重启服务

```bash
# 重新加载配置文件
/etc/rc.d/init.d/sshd reload
# 重启 ssh 服务
/etc/rc.d/init.d/sshd restart
```

## 17. 关闭透明大页

cdh官方文档推荐在集群的服务器上关闭透明大页，关闭命令如下：

```bash
echo never > /sys/kernel/mm/transparent_hugepage/enabled && echo never > /sys/kernel/mm/transparent_hugepage/defrag && echo 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' >> /etc/rc.local && echo 'echo never > /sys/kernel/mm/transparent_hugepage/defrag' >> /etc/rc.local
```

可以结合ansible进行批量执行。

