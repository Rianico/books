---
title:  ulimit 修改最打开文件数
date: 2020-07-23 09:55:29
---
# ulimit修改最大打开文件数

当一个系统有较多socket连接，或者需要打开很多文件时，若某个用户允许打开的最大文件数以及进程数不足，将会导致还用户的任务阻塞。

用户最大打开文件数以及进程数受到系统两个参数制约：

```bash
# 所有进程总的最大打开文件数
cat /proc/sys/fs/file-max
# 单个进程的最大进程数
cat /proc/sys/fs/nr_open

# 系统能够分配的最大 pid
cat /proc/sys/kernel/pid_max 
```

查看当前进程打开的文件数以及进程数：

```bash
# 最大文件数
ulimit -n
# 最大进程数
ulimit -u
```

编辑`/etc/security/limits.conf`，修改允许打开的最大文件数：

```bash
# 文件打开数
* soft nofile 655350
* hard nofile 655350
# 进程数
* soft proc 655350
* hard proc 655350
```

`*`代表所有用户，但如果没有指定特定用户，则`/etc/security/limits.conf`会被子目录下的`/etc/security/limits.d/90-nproc.conf`下指定的用户覆盖。因此，为了能够让配置真正的生效，还需要对该文件进行配置：

```bash
# 进程数
* soft proc 655350
* hard proc 655350
```

验证配置是否生效，可以先找到进程的 pid，然后到 `/proc/{pid}/limits` 下查看：

```bash
limit                     Soft Limit           Hard Limit           Units     
......    
Max stack size            10485760             unlimited            bytes     
Max core file size        0                    unlimited            bytes     
Max resident set          unlimited            unlimited            bytes     
Max processes             65536                65536                processes 
Max open files            32768                32768                files     
......       
```

参考：[https://feichashao.com/ulimit\_demo/](https://feichashao.com/ulimit_demo/)

