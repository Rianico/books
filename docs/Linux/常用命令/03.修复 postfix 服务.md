---
title: 修复 postfix 服务
date: 2020-07-23 09:53:20
---
# 修复postfix邮件服务

由于CDH集群的Alert Publisher服务依赖于操作系统的postfix服务，然而在按照网上教程配置并启动postfix服务后，Alert Publisher服务输出日志如下：

```bash
2019-04-01 17:43:15,174 ERROR org.apache.camel.processor.DefaultErrorHandler: Failed delivery for exchangeId: ID-xx-xx-xxxx-44049-1553768893026-0-177733. Exhausted after delivery attempt: 1 caught: org.springframework.mail.MailSendException: Mail server connection failed; nested exception is javax.mail.MessagingException: Could not connect to SMTP host: localhost, port: 25;
  nested exception is:
        java.net.ConnectException: 拒绝连接. Failed messages: javax.mail.MessagingException: Could not connect to SMTP host: localhost, port: 25;
...
2019-05-30 02:21:22,415 ERROR com.cloudera.enterprise.SafeAvroResponderServlet: Error procesing Avro request
java.io.IOException: Unexpected length (too long): 1010792557, max:10485760
        at com.cloudera.enterprise.SafeAvroHttpTransceiver.checkLength(SafeAvroHttpTransceiver.java:137)
...
```

从日志可以看出，Alert Publisher会对本地25端口发送请求消息，但在多次失败后，最终导致请求消息累积过长，从而抛出异常，服务停止输出日志。

查看25端口占用，发现没有任何服务，因此postfix服务实质上没有启动成功，在`/var/log/mail.log`下有没有看到任何关于启动相关的日志，最后通过启动`rsyslog`服务来监听25端口的相关日志，可以看到日志以下输出：

```vim
cm postfix[4322]: fatal: file /etc/postfix/main.cf: parameter default_privs: unknown user name value: nobody
```

其实就是由于没有`nobody`用户，执行`postfix check`命令也可以看到这个报错，再结合这篇文章[Gitlab - postfix setup issues](https://amoldighe.github.io/2016/09/14/gitlab-postfix-issue/)，在`/etc/passd`中添加如下用户：

```vim
nobody:x:99:99:Nobody:/:/sbin/nologin
```

再次启动postfix服务，启动成功。
