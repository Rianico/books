---
title: 查看网卡的 bond
date: 2020-07-23 09:52:02
---
## 1. 查看 bond

bond 是将多张物理网卡绑定为一张逻辑网卡，有多个 mode 可选。

```bash
# cat /proc/net/bonding/bond0
Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup)
...
```

其中括号内的 active-backup 代表 mode1，代表主备高可用。

**bond的模式常用的有两种：**

**mode=0（balance-rr）**：负载分担 round-robin，以轮询方式走多个网卡，直到数据包发送完毕。

- 优点：流量提高。 
- 缺点：需要接入交换机做端口聚合，否则可能无法使用。

**mode=1（active-backup）**：主备模式，同一时间只有1块网卡在工作。 

- 优点：冗余性高。
- 缺点：链路利用率低，两块网卡只有1块在工作

**mode=2 (balance-xor，平衡策略)**：以XOR Hash 负载均衡，和交换机的聚合强制不协商方式配合。（需要xmit\_hash\_policy，需要交换机配置port channel）。

- 特点：基于指定的传输HASH策略传输数据包。缺省的策略是：\(源MAC地址 XOR 目标MAC地址\) % slave数量。其他的传输策略可以通过xmit\_hash\_policy选项指定，此模式提供负载平衡和容错能力

**mode=3 (broadcast，广播策略)**：表示所有包从所有网络接口发出，这个不均衡，只有冗余机制，但过于浪费资源。此模式适用于金融行业，因为他们需要高可靠性的网络，不允许出现任何问题。需要和交换机的聚合强制不协商方式配合。

- 特点：在每个slave接口上传输每个数据包，此模式提供了容错能力

**mode=4 (802.3ad，IEEE 802.3ad 动态链接聚合)**：表示支持802.3ad协议，和交换机的聚合LACP方式配合（需要 xmit_hash_policy） 标准要求所有设备在聚合操作时，要在同样的速率和双工模式，而且，和除了balance-rr模式外的其它bonding负载均衡模式一样，任何连接都不能使用多于一个接口的带宽。

- 特点：创建一个聚合组，它们共享同样的速率和双工设定。根据802.3ad规范将多个slave工作在同一个激活的聚合体下。出口流量的 slave 选举是基于传输 hash 策略，该策略可以通过 xmit_hash_policy 选项从缺省的 XOR 策略改变到其他策略。需要注意的是，并不是所有的传输策略都是802.3ad适应的，尤其考虑到 802.3ad 标准的包乱序问题。不同的实现可能会有不同的适应性。

- 必要条件1：ethtool 支持获取每个slave的速率和双工设定 
- 必要条件2：switch\(交换机\) 支持IEEE802.3ad Dynamic link aggregation 条件3：大多数switch\(交换机\)需要经过特定配置才能支持802.3ad模式

**mode=5 (balance-tlb，适配器传输负载均衡)**：根据每个 slave 的负载情况选择 slave 进行发送，接收时使用当前轮到的slave。该模式要求slave接口的网络设备驱动有某种ethtool支持；而且ARP监控不可用。

- 特点：不需要任何特别的 switch(交换机) 支持的 bonding。在每个slave上根据当前的负载（根据速度计算）分配外出流量。如果正在接受数据的slave出故障了，另一个slave接管失败的slave的MAC地址。

- 必要条件：ethtool 支持获取每个 slave 的速率

**mode=6 (balance-alb，适配器适应性负载均衡)**：在 mode5 的 tlb 基础上增加了 rlb (接收负载均衡，receiveload balance\).不需要任何switch\(交换机) 的支持。接收负载均衡是通过 ARP 协商实现的.

- 特点：该模式包含了 balance-tlb 模式，同时加上针对 IPV4 流量的接收负载均衡\(receiveload balance, rlb\)，而且不需要任何交换机的支持。接收负载均衡是通过 ARP 协商实现的。bonding 驱动截获本机发送的 ARP 应答，并把源硬件地址改写为 bond 中某个 slave 的唯一硬件地址，从而使得**不同的对端使用不同的硬件地址进行通信**，来自服务器端的接收流量也会被均衡。当本机发送 ARP 请求时，bonding 驱动把对端的 IP 信息从 ARP 包中复制并保存下来。当 ARP 应答从对端到达时，bonding 驱动把它的硬件地址提取出来，并发起一个 ARP 应答给 bond 中的某个 slave。使用 ARP 协商进行负载均衡的一个问题是：每次广播 ARP请求时都会使用 bond 的硬件地址，因此对端学习到这个硬件地址后，接收流量将会全部流向当前的 slave。这个问题可以通过给所有的对端发送更新（ARP应答）来解决，应答中包含他们独一无二的硬件地址，从而导致流量重新分布。当新的 slave 加入到 bond中时，或者某个未激活的 slave 重新激活时，接收流量也要重新分布。接收的负载被顺序地分布（round robin）在 bond 中最高速的 slave 上当某个链路被重新接上，或者一个新的 slave 加入到 bond 中，接收流量在所有当前激活的 slave 中全部重新分配，通过使用指定的 MAC 地址给每个 client 发起 ARP 应答。下面介绍的 updelay 参数必须被设置为某个大于等于 switch\(交换机\) 转发延时的值，从而保证发往对端的ARP 应答不会被 switch\(交换机\) 阻截。

| Mode |            Policy             |                         How it works                         |                       Fault Tolerance                        | Load balancing |
| :--: | :---------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :------------: |
|  0   |          Round Robin          | packets are sequentially transmitted/received through each interfaces one by one. |                              No                              |      Yes       |
|  1   |         Active Backup         | one NIC active while another NIC is asleep. If the active NIC goes down, another NIC becomes active. only supported in |                      x86 environments.                       |      Yes       |
|  2   |      XOR [exclusive OR]       | In this mode the, the MAC address of the slave NIC is matched up against the incoming request’s MAC and once this | connection is established same NIC is used to transmit/receive for the destination MAC. |      Yes       |
|  3   |           Broadcast           |           All transmissions are sent on all slaves           |                             Yes                              |       No       |
|  4   |   Dynamic Link Aggregation    | aggregated NICs act as one NIC which results in a higher throughput, but also provides failover in the case | that a NIC fails. Dynamic Link Aggregation requires a switch that supports IEEE 802.3ad. |      Yes       |
|  5   | Transmit Load Balancing (TLB) | The outgoing traffic is distributed depending on the current load on each slave interface. Incoming | traffic is received by the current slave. If the receiving slave fails, another slave takes over the MAC address of the failed |     slave.     |
|  6   | Adaptive Load Balancing (ALB) | Unlike Dynamic Link Aggregation, Adaptive Load Balancing does not require any particular switch configuration. Adaptive Load Balancing is only supported in x86 environments. The receiving packets are load balanced through ARP negotiation. |                             Yes                              |      Yes       |

---

## 2. 配置 bond

假设对两个网卡 eth0、eth1 做 bond

### 2.1 CentOs 6 配置方式

1. 创建 `/etc/sysconfig/network-scripts/ifcfg-bond0` 文件，内容如下：

   ```properties
   DEVICE=bond0
   TYPE=Bond
   NAME=bond0
   BOOTPROTO=static
   USERCTL=no
   ONBOOT=yes
   IPADDR=192.168.2.1
   NETMASK=255.255.255.0
   ```

2. 分别编辑 `/etc/sysconfig/network-scripts/ifcfg-eth0` 以及 `/etc/sysconfig/network-scripts/ifcfg-eth1` 两张网卡：

   ```properties
   # eth0
   DEVICE=eth0
   TYPE=Ethernet
   ONBOOT=yes
   MASTER=bond0
   
   # eth1
   DEVICE=eth1
   TYPE=Ethernet
   ONBOOT=yes
   MASTER=bond0
   ```

3. 编辑 `/etc/modprobe.d/bonding.conf` 文件并指定 mode：

   ```properties
   alias bond0 bonding
   options bond0 miimon=100 mode=5
   ```

4. 重启网络服务，并查看 bond 状态。

### 2.2 CentOs 7 配置方式

CentOs 7 的配置方式大体与 CentOs 6 一致，只不过不需要编辑 `/etc/modprobe.d/bonding.conf` 文件指定 mode，而是在 `/etc/sysconfig/network-scripts/ifcfg-bond0` 中一并指定：

```properties
DEVICE=bond0
TYPE=Bond
NAME=bond0
BOOTPROTO=static
USERCTL=no
ONBOOT=yes
IPADDR=192.168.2.1
NETMASK=255.255.255.0
BONDING_OPTS="mode=5 miimon=100"
```

## 3. 开启路由转发

