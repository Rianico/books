---
title: NTP 服务
date: 2020-07-23 09:51:49
---
# NTP 服务

Linux 系统远程同步时间的方式主要有 ntp 和 ntpdate 两种方式：

* ntp：渐进式同步时间，跨度平滑（推荐）。
* ntpdate：立刻校准时间，存在较大跨度。

ntp 在时间差距较大的时候，校准需要花费较长时间，因此通常都是先使用 ntpdate 强制同步到最新时间，再开启 ntp 服务持续校准时间。

ntp 服务配置位于 `/etc/ntp.conf`，默认内容如下：

```vim
 # For more information about this file, see the man pages
 # ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).

 driftfile /var/lib/ntp/drift

 # Permit time synchronization with our time source, but do not
 # permit the source to query or modify the service on this system.
 restrict default kod nomodify notrap nopeer noquery
 restrict -6 default kod nomodify notrap nopeer noquery

 # Permit all access over the loopback interface.  This could
 # be tightened as well, but to do so would effect some of
 # the administrative functions.
 restrict 127.0.0.1
 restrict -6 ::1

 # Hosts on local network are less restricted.
 #restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap

 # Use public servers from the pool.ntp.org project.
 # Please consider joining the pool (http://www.pool.ntp.org/join.html).
 server 0.rhel.pool.ntp.org iburst
 server 1.rhel.pool.ntp.org iburst
 server 2.rhel.pool.ntp.org iburst
 server 3.rhel.pool.ntp.org iburst


 #broadcast 192.168.1.255 autokey        # broadcast server
 #broadcastclient                        # broadcast client
 #broadcast 224.0.1.1 autokey            # multicast server
 #multicastclient 224.0.1.1              # multicast client
 #manycastserver 239.255.254.254         # manycast server
 #manycastclient 239.255.254.254 autokey # manycast client

 # Enable public key cryptography.
 #crypto

 includefile /etc/ntp/crypto/pw

 # Key file containing the keys and key identifiers used when operating
 # with symmetric key cryptography.
 keys /etc/ntp/keys

 # Specify the key identifiers which are trusted.
 #trustedkey 4 8 42

 # Specify the key identifier to use with the ntpdc utility.
 #requestkey 8

 # Specify the key identifier to use with the ntpq utility.
 #controlkey 8

 # Enable writing of statistics records.
 #statistics clockstats cryptostats loopstats peerstats
```

### 1. restrict

restrict 表示权限控制，语法：`restrict [IP] mask [IP MASK] [options]`， `default` 表示所有 IP，此时可以省略 IP 以及 IP 掩码。

各个参数的选项如下：

* ignore：拒绝连接到NTP服务器
* nomodiy： 忽略所有改变NTP服务器配置的报文，但可以查询配置信息
* noquery： 忽略所有mode字段为6或7的报文，客户端不能改变NTP服务器配置，也不能查询配置信息
* notrap： 不提供trap远程登录功能，trap服务是一种远程时间日志服务。
* notrust： 不作为同步的时钟源。
* nopeer： 提供时间服务，但不作为对等体。
* kod： 向不安全的访问者发送Kiss-Of-Death报文

### 2. server

server 指定了远程同步的宿主机，可以指定多个，语法：**server host \[ key n \] \[ version n \] \[ prefer \] \[ mode n \] \[ minpoll n \] \[ maxpoll n \] \[ iburst \]**，各参数含义如下：

* key： 表示所有发往服务器的报文包含有秘钥加密的认证信息，n 是 32 位的整数，表示秘钥号。
* version： 表示发往上层服务器的报文使用的版本号，n 默认是 3，可以是 1 或者 2。
* prefer： 如果有多个 server 选项，具有该参数的服务器有限使用。
* mode： 指定数据报文 mode 字段的值。
* minpoll： 指定与查询该服务器的最小时间间隔为 2 的 n 次方秒，n 默认为 6，范围为 4 -14。
* maxpoll： 指定与查询该服务器的最大时间间隔为 2 的 n 次方秒，n 默认为 10，范围为 4 - 14。
* iburst： 当初始同步请求时，采用突发方式接连发送 8 个报文，时间间隔为 2 秒。

如果需要以本地机器作为时间源，则可以配置为 `server 127.127.1.0 iburst`

### 3. 检查

可以执行 `ntpq -p` 或者 `watch 'ntpq -p'` 来查看 ntp 服务同步情况：

```vim
 remote           refid            st t when poll reach   delay   offset  jitter
 ==============================================================================
  LOCAL(0)        .LOCL.           5 l  164   64   74    0.000    0.000   0.000
 *ip1.com         192.168.1.115    4 u   23   64   77    0.052    3.411   2.093
 +ip2.com         192.168.1.116    3 u   28   64   77    0.065    1.210   2.234
```

| remote | refid | st | when | poll | reach | delay | offset | jitter |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 同步的远程主机，\* 表示优先，+ 表示次优先 | 参考的上一层ntp主机地址 | 正在响应ntp请求的主机级别 | 多少秒前曾经同步过时间 | ntp同步隔 | 八进制，表示最近接受的8个packet情况，通常为 377，否则表示最近有packet丢失 | ntp往返的网络延迟 | 时间补偿 | 表示offset方差，越小代表越稳定 |

