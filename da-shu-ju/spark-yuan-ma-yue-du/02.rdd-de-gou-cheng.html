<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>02. RDD 的构成 | zxk&#39;s book</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/books/Avatar.jpg">
    <meta name="description" content="兴趣使然的备忘库">
    <link rel="preload" href="/books/assets/css/0.styles.253527df.css" as="style"><link rel="preload" href="/books/assets/js/app.a32f3f13.js" as="script"><link rel="preload" href="/books/assets/js/2.f434c5a6.js" as="script"><link rel="preload" href="/books/assets/js/189.279c7f6f.js" as="script"><link rel="prefetch" href="/books/assets/js/10.dceff922.js"><link rel="prefetch" href="/books/assets/js/100.e86d25aa.js"><link rel="prefetch" href="/books/assets/js/101.654d6902.js"><link rel="prefetch" href="/books/assets/js/102.6e048095.js"><link rel="prefetch" href="/books/assets/js/103.26ec951e.js"><link rel="prefetch" href="/books/assets/js/104.f413fdc7.js"><link rel="prefetch" href="/books/assets/js/105.0b5517ef.js"><link rel="prefetch" href="/books/assets/js/106.025ff37f.js"><link rel="prefetch" href="/books/assets/js/107.3fd4a2da.js"><link rel="prefetch" href="/books/assets/js/108.c33413cd.js"><link rel="prefetch" href="/books/assets/js/109.69c58c80.js"><link rel="prefetch" href="/books/assets/js/11.f4ff5e98.js"><link rel="prefetch" href="/books/assets/js/110.da669047.js"><link rel="prefetch" href="/books/assets/js/111.27221683.js"><link rel="prefetch" href="/books/assets/js/112.ae80afd9.js"><link rel="prefetch" href="/books/assets/js/113.d17c58d7.js"><link rel="prefetch" href="/books/assets/js/114.26c4f4c1.js"><link rel="prefetch" href="/books/assets/js/115.5491e5a0.js"><link rel="prefetch" href="/books/assets/js/116.a209ce38.js"><link rel="prefetch" href="/books/assets/js/117.c3a25178.js"><link rel="prefetch" href="/books/assets/js/118.b518ee54.js"><link rel="prefetch" href="/books/assets/js/119.e017c898.js"><link rel="prefetch" href="/books/assets/js/12.6dae06d9.js"><link rel="prefetch" href="/books/assets/js/120.1baf3023.js"><link rel="prefetch" href="/books/assets/js/121.71a13847.js"><link rel="prefetch" href="/books/assets/js/122.e058174e.js"><link rel="prefetch" href="/books/assets/js/123.5252e439.js"><link rel="prefetch" href="/books/assets/js/124.e919844e.js"><link rel="prefetch" href="/books/assets/js/125.b4b936d5.js"><link rel="prefetch" href="/books/assets/js/126.0ff2a40d.js"><link rel="prefetch" href="/books/assets/js/127.0e27fcc5.js"><link rel="prefetch" href="/books/assets/js/128.b0d65cea.js"><link rel="prefetch" href="/books/assets/js/129.3f7c4fb2.js"><link rel="prefetch" href="/books/assets/js/13.fd393096.js"><link rel="prefetch" href="/books/assets/js/130.22907055.js"><link rel="prefetch" href="/books/assets/js/131.9b6a7fa1.js"><link rel="prefetch" href="/books/assets/js/132.0141d721.js"><link rel="prefetch" href="/books/assets/js/133.62368e0f.js"><link rel="prefetch" href="/books/assets/js/134.c22be34f.js"><link rel="prefetch" href="/books/assets/js/135.9c30742f.js"><link rel="prefetch" href="/books/assets/js/136.8e29ebad.js"><link rel="prefetch" href="/books/assets/js/137.9bd0b5ba.js"><link rel="prefetch" href="/books/assets/js/138.41a78831.js"><link rel="prefetch" href="/books/assets/js/139.a9376eeb.js"><link rel="prefetch" href="/books/assets/js/14.208ec185.js"><link rel="prefetch" href="/books/assets/js/140.b4f63a2e.js"><link rel="prefetch" href="/books/assets/js/141.6a4888c7.js"><link rel="prefetch" href="/books/assets/js/142.d675963b.js"><link rel="prefetch" href="/books/assets/js/143.501abfa1.js"><link rel="prefetch" href="/books/assets/js/144.fdbc09d5.js"><link rel="prefetch" href="/books/assets/js/145.5bb6218a.js"><link rel="prefetch" href="/books/assets/js/146.b5ba45c3.js"><link rel="prefetch" href="/books/assets/js/147.e0a80eb4.js"><link rel="prefetch" href="/books/assets/js/148.27910016.js"><link rel="prefetch" href="/books/assets/js/149.013194c7.js"><link rel="prefetch" href="/books/assets/js/15.16c314bd.js"><link rel="prefetch" href="/books/assets/js/150.3154742d.js"><link rel="prefetch" href="/books/assets/js/151.78fc6a13.js"><link rel="prefetch" href="/books/assets/js/152.e97f9998.js"><link rel="prefetch" href="/books/assets/js/153.3d92ef79.js"><link rel="prefetch" href="/books/assets/js/154.70c9f7a4.js"><link rel="prefetch" href="/books/assets/js/155.4b924a86.js"><link rel="prefetch" href="/books/assets/js/156.59e71763.js"><link rel="prefetch" href="/books/assets/js/157.8c8cd5ed.js"><link rel="prefetch" href="/books/assets/js/158.739ecc99.js"><link rel="prefetch" href="/books/assets/js/159.5a22b675.js"><link rel="prefetch" href="/books/assets/js/16.d3259c7f.js"><link rel="prefetch" href="/books/assets/js/160.3cc481bb.js"><link rel="prefetch" href="/books/assets/js/161.5cdebd7a.js"><link rel="prefetch" href="/books/assets/js/162.d56ac8d7.js"><link rel="prefetch" href="/books/assets/js/163.a89f22d0.js"><link rel="prefetch" href="/books/assets/js/164.e5e25ddb.js"><link rel="prefetch" href="/books/assets/js/165.406cc447.js"><link rel="prefetch" href="/books/assets/js/166.0f09d541.js"><link rel="prefetch" href="/books/assets/js/167.afee8669.js"><link rel="prefetch" href="/books/assets/js/168.1ae1f6ce.js"><link rel="prefetch" href="/books/assets/js/169.1bfb929c.js"><link rel="prefetch" href="/books/assets/js/17.6ea641b2.js"><link rel="prefetch" href="/books/assets/js/170.0baab93a.js"><link rel="prefetch" href="/books/assets/js/171.65e2e3b6.js"><link rel="prefetch" href="/books/assets/js/172.9a0d4dfd.js"><link rel="prefetch" href="/books/assets/js/173.0690d3f4.js"><link rel="prefetch" href="/books/assets/js/174.52a3d4eb.js"><link rel="prefetch" href="/books/assets/js/175.33e4696f.js"><link rel="prefetch" href="/books/assets/js/176.6c865e6e.js"><link rel="prefetch" href="/books/assets/js/177.1b2a7c93.js"><link rel="prefetch" href="/books/assets/js/178.37c33f6b.js"><link rel="prefetch" href="/books/assets/js/179.ef76c85c.js"><link rel="prefetch" href="/books/assets/js/18.d3146ce7.js"><link rel="prefetch" href="/books/assets/js/180.0e457253.js"><link rel="prefetch" href="/books/assets/js/181.dee67b63.js"><link rel="prefetch" href="/books/assets/js/182.069a8f30.js"><link rel="prefetch" href="/books/assets/js/183.0330f5ce.js"><link rel="prefetch" href="/books/assets/js/184.efd2fde2.js"><link rel="prefetch" href="/books/assets/js/185.7d64b540.js"><link rel="prefetch" href="/books/assets/js/186.82e60409.js"><link rel="prefetch" href="/books/assets/js/187.0d54afe4.js"><link rel="prefetch" href="/books/assets/js/188.81a9510a.js"><link rel="prefetch" href="/books/assets/js/19.ef650392.js"><link rel="prefetch" href="/books/assets/js/190.e5a7480c.js"><link rel="prefetch" href="/books/assets/js/191.f365d8de.js"><link rel="prefetch" href="/books/assets/js/192.84ea0f67.js"><link rel="prefetch" href="/books/assets/js/193.bb2e01d9.js"><link rel="prefetch" href="/books/assets/js/194.ef6b690e.js"><link rel="prefetch" href="/books/assets/js/195.1ee66346.js"><link rel="prefetch" href="/books/assets/js/196.f34cbe99.js"><link rel="prefetch" href="/books/assets/js/197.cbbdab75.js"><link rel="prefetch" href="/books/assets/js/198.845810f3.js"><link rel="prefetch" href="/books/assets/js/199.5e1147de.js"><link rel="prefetch" href="/books/assets/js/20.21272222.js"><link rel="prefetch" href="/books/assets/js/200.57f5e124.js"><link rel="prefetch" href="/books/assets/js/201.a572c554.js"><link rel="prefetch" href="/books/assets/js/202.5ce9f4a7.js"><link rel="prefetch" href="/books/assets/js/203.bc6f8876.js"><link rel="prefetch" href="/books/assets/js/204.126953e5.js"><link rel="prefetch" href="/books/assets/js/205.9aeca759.js"><link rel="prefetch" href="/books/assets/js/206.ec099168.js"><link rel="prefetch" href="/books/assets/js/207.6e5b496b.js"><link rel="prefetch" href="/books/assets/js/208.6624d24c.js"><link rel="prefetch" href="/books/assets/js/209.3d8ff15b.js"><link rel="prefetch" href="/books/assets/js/21.a956aa7a.js"><link rel="prefetch" href="/books/assets/js/210.6429663d.js"><link rel="prefetch" href="/books/assets/js/211.1d8725a1.js"><link rel="prefetch" href="/books/assets/js/212.d1ff2873.js"><link rel="prefetch" href="/books/assets/js/213.e213f9d1.js"><link rel="prefetch" href="/books/assets/js/214.a9b5c7ec.js"><link rel="prefetch" href="/books/assets/js/215.fd7a5238.js"><link rel="prefetch" href="/books/assets/js/216.96394ddb.js"><link rel="prefetch" href="/books/assets/js/217.3f41d192.js"><link rel="prefetch" href="/books/assets/js/218.622af412.js"><link rel="prefetch" href="/books/assets/js/219.772992ff.js"><link rel="prefetch" href="/books/assets/js/22.fb2ff9d3.js"><link rel="prefetch" href="/books/assets/js/220.99efbde4.js"><link rel="prefetch" href="/books/assets/js/221.9932f6ce.js"><link rel="prefetch" href="/books/assets/js/222.e9c2624f.js"><link rel="prefetch" href="/books/assets/js/223.c87d79a7.js"><link rel="prefetch" href="/books/assets/js/224.6fc0bed5.js"><link rel="prefetch" href="/books/assets/js/225.443418f3.js"><link rel="prefetch" href="/books/assets/js/226.d0e9e921.js"><link rel="prefetch" href="/books/assets/js/227.b29a9627.js"><link rel="prefetch" href="/books/assets/js/228.6b9c5eb3.js"><link rel="prefetch" href="/books/assets/js/229.a2dee41e.js"><link rel="prefetch" href="/books/assets/js/23.77b92b70.js"><link rel="prefetch" href="/books/assets/js/230.b36a47b9.js"><link rel="prefetch" href="/books/assets/js/231.d7a52023.js"><link rel="prefetch" href="/books/assets/js/232.5c445a90.js"><link rel="prefetch" href="/books/assets/js/233.398e8141.js"><link rel="prefetch" href="/books/assets/js/234.86f5ff7b.js"><link rel="prefetch" href="/books/assets/js/235.d8271e43.js"><link rel="prefetch" href="/books/assets/js/236.41b92eb4.js"><link rel="prefetch" href="/books/assets/js/237.4d52bf88.js"><link rel="prefetch" href="/books/assets/js/238.209dd5d8.js"><link rel="prefetch" href="/books/assets/js/239.a977d564.js"><link rel="prefetch" href="/books/assets/js/24.96161161.js"><link rel="prefetch" href="/books/assets/js/240.56008448.js"><link rel="prefetch" href="/books/assets/js/241.95144dec.js"><link rel="prefetch" href="/books/assets/js/242.deacfcf7.js"><link rel="prefetch" href="/books/assets/js/243.6bd3a203.js"><link rel="prefetch" href="/books/assets/js/244.20662085.js"><link rel="prefetch" href="/books/assets/js/245.3079d8db.js"><link rel="prefetch" href="/books/assets/js/246.59cbb76d.js"><link rel="prefetch" href="/books/assets/js/247.dab4d54b.js"><link rel="prefetch" href="/books/assets/js/248.dd78e28c.js"><link rel="prefetch" href="/books/assets/js/249.47cfb0fb.js"><link rel="prefetch" href="/books/assets/js/25.bb622e2d.js"><link rel="prefetch" href="/books/assets/js/250.8b7c06de.js"><link rel="prefetch" href="/books/assets/js/251.90d4bb83.js"><link rel="prefetch" href="/books/assets/js/252.4b70df27.js"><link rel="prefetch" href="/books/assets/js/253.baa34cc9.js"><link rel="prefetch" href="/books/assets/js/254.64c84394.js"><link rel="prefetch" href="/books/assets/js/255.4245dca1.js"><link rel="prefetch" href="/books/assets/js/256.4bd25081.js"><link rel="prefetch" href="/books/assets/js/257.44a180fd.js"><link rel="prefetch" href="/books/assets/js/258.ef8eb1df.js"><link rel="prefetch" href="/books/assets/js/259.ca38bbda.js"><link rel="prefetch" href="/books/assets/js/26.800c4d14.js"><link rel="prefetch" href="/books/assets/js/260.fc42b0a6.js"><link rel="prefetch" href="/books/assets/js/27.be0559b4.js"><link rel="prefetch" href="/books/assets/js/28.cdb01ee8.js"><link rel="prefetch" href="/books/assets/js/29.27c415ce.js"><link rel="prefetch" href="/books/assets/js/3.7dd1ae11.js"><link rel="prefetch" href="/books/assets/js/30.da6f6371.js"><link rel="prefetch" href="/books/assets/js/31.c824c17b.js"><link rel="prefetch" href="/books/assets/js/32.45c04f7c.js"><link rel="prefetch" href="/books/assets/js/33.315cf7d5.js"><link rel="prefetch" href="/books/assets/js/34.b532da2f.js"><link rel="prefetch" href="/books/assets/js/35.0af657d1.js"><link rel="prefetch" href="/books/assets/js/36.2df4655c.js"><link rel="prefetch" href="/books/assets/js/37.a4887720.js"><link rel="prefetch" href="/books/assets/js/38.68a08b9d.js"><link rel="prefetch" href="/books/assets/js/39.bf63d04a.js"><link rel="prefetch" href="/books/assets/js/4.e8102eb5.js"><link rel="prefetch" href="/books/assets/js/40.a3c5cdd1.js"><link rel="prefetch" href="/books/assets/js/41.116ef3fc.js"><link rel="prefetch" href="/books/assets/js/42.f3b8b588.js"><link rel="prefetch" href="/books/assets/js/43.b1d59c70.js"><link rel="prefetch" href="/books/assets/js/44.579ee856.js"><link rel="prefetch" href="/books/assets/js/45.807bba31.js"><link rel="prefetch" href="/books/assets/js/46.db611eda.js"><link rel="prefetch" href="/books/assets/js/47.d4d02273.js"><link rel="prefetch" href="/books/assets/js/48.7f011fb9.js"><link rel="prefetch" href="/books/assets/js/49.3aac265b.js"><link rel="prefetch" href="/books/assets/js/5.638928ae.js"><link rel="prefetch" href="/books/assets/js/50.8b75be66.js"><link rel="prefetch" href="/books/assets/js/51.576e782b.js"><link rel="prefetch" href="/books/assets/js/52.85987e06.js"><link rel="prefetch" href="/books/assets/js/53.6a8c240c.js"><link rel="prefetch" href="/books/assets/js/54.6a97379c.js"><link rel="prefetch" href="/books/assets/js/55.97955477.js"><link rel="prefetch" href="/books/assets/js/56.3d477c83.js"><link rel="prefetch" href="/books/assets/js/57.56aa4dff.js"><link rel="prefetch" href="/books/assets/js/58.833c8652.js"><link rel="prefetch" href="/books/assets/js/59.24ca7ee9.js"><link rel="prefetch" href="/books/assets/js/6.32ee54fa.js"><link rel="prefetch" href="/books/assets/js/60.1fc1c4a2.js"><link rel="prefetch" href="/books/assets/js/61.14b84590.js"><link rel="prefetch" href="/books/assets/js/62.8a2d2de8.js"><link rel="prefetch" href="/books/assets/js/63.0dcfee0b.js"><link rel="prefetch" href="/books/assets/js/64.8c28a59c.js"><link rel="prefetch" href="/books/assets/js/65.6d1ae46c.js"><link rel="prefetch" href="/books/assets/js/66.5a616c98.js"><link rel="prefetch" href="/books/assets/js/67.bead4bdc.js"><link rel="prefetch" href="/books/assets/js/68.1d20f97a.js"><link rel="prefetch" href="/books/assets/js/69.76ec2223.js"><link rel="prefetch" href="/books/assets/js/7.b59836f2.js"><link rel="prefetch" href="/books/assets/js/70.6066afd2.js"><link rel="prefetch" href="/books/assets/js/71.d25994bf.js"><link rel="prefetch" href="/books/assets/js/72.94ab8cdd.js"><link rel="prefetch" href="/books/assets/js/73.6682438b.js"><link rel="prefetch" href="/books/assets/js/74.d8d9aac9.js"><link rel="prefetch" href="/books/assets/js/75.c178891f.js"><link rel="prefetch" href="/books/assets/js/76.2292d907.js"><link rel="prefetch" href="/books/assets/js/77.940c9473.js"><link rel="prefetch" href="/books/assets/js/78.1e9432ad.js"><link rel="prefetch" href="/books/assets/js/79.f548c8c7.js"><link rel="prefetch" href="/books/assets/js/8.c9e4b615.js"><link rel="prefetch" href="/books/assets/js/80.e03d9a9c.js"><link rel="prefetch" href="/books/assets/js/81.222e5797.js"><link rel="prefetch" href="/books/assets/js/82.bea6ed3c.js"><link rel="prefetch" href="/books/assets/js/83.cb05beb1.js"><link rel="prefetch" href="/books/assets/js/84.6e31c3ad.js"><link rel="prefetch" href="/books/assets/js/85.b0ce07ff.js"><link rel="prefetch" href="/books/assets/js/86.ae6fb79f.js"><link rel="prefetch" href="/books/assets/js/87.6863b804.js"><link rel="prefetch" href="/books/assets/js/88.ba149380.js"><link rel="prefetch" href="/books/assets/js/89.343c2068.js"><link rel="prefetch" href="/books/assets/js/9.61e3915f.js"><link rel="prefetch" href="/books/assets/js/90.8f71cab6.js"><link rel="prefetch" href="/books/assets/js/91.6334c0db.js"><link rel="prefetch" href="/books/assets/js/92.8a7e8c1d.js"><link rel="prefetch" href="/books/assets/js/93.bd68832a.js"><link rel="prefetch" href="/books/assets/js/94.4083af3f.js"><link rel="prefetch" href="/books/assets/js/95.775d1cde.js"><link rel="prefetch" href="/books/assets/js/96.e244a8c4.js"><link rel="prefetch" href="/books/assets/js/97.27aa8f2b.js"><link rel="prefetch" href="/books/assets/js/98.9d03fea6.js"><link rel="prefetch" href="/books/assets/js/99.488c24e9.js">
    <link rel="stylesheet" href="/books/assets/css/0.styles.253527df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/books/" class="router-link-active home-link"><img src="/books/Avatar.jpg" alt="zxk's book" class="logo"> <span class="site-name">zxk's book</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          大数据
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程语言
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          编程基础
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          专栏学习
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          Linux
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/ruan-jian/">
          软件
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/books/" class="router-link-active">
          Home
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/Rianico/books" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spark源码阅读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/01.listenerbus-xiao-xi-zong-xian.html" title="01.ListenerBus 消息总线" class="sidebar-link">01.ListenerBus 消息总线</a></li><li><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/02.rdd-de-gou-cheng.html" aria-current="page" title="02. RDD 的构成" class="active sidebar-link">02. RDD 的构成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/02.rdd-de-gou-cheng.html#_1-rdd-的定义" title="1. RDD 的定义" class="sidebar-link">1. RDD 的定义</a></li><li class="sidebar-sub-header"><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/02.rdd-de-gou-cheng.html#_2-源码解读" title="2. 源码解读" class="sidebar-link">2. 源码解读</a></li><li class="sidebar-sub-header"><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/02.rdd-de-gou-cheng.html#_3-扩展" title="3. 扩展" class="sidebar-link">3. 扩展</a></li></ul></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h2 id="_1-rdd-的定义"><a href="#_1-rdd-的定义" class="header-anchor">#</a> 1. RDD 的定义</h2> <p>RDD ，是 Spark 对一组数据集合的抽象描述，用于表示一个弹性的、可容错的分布式数据集合。RDD 可以从纵向与横向划分出四个属性：</p> <ul><li>纵向：Dependency、Compute</li> <li>横向：Partitioner、Partitions</li></ul> <p>Spark 基于 Dependency 构建血缘关系，并生成一张有向无环图，有向无环图可以根据 Shuffle 划分为多个 Stage，每个 Stage 都可以转化多个 Compute 任务，并分发到各个 Partition 上，Partitioner 则决定了数据应该去往哪个 Partition。</p> <h2 id="_2-源码解读"><a href="#_2-源码解读" class="header-anchor">#</a> 2. 源码解读</h2> <h3 id="_2-1-rdd-的构造"><a href="#_2-1-rdd-的构造" class="header-anchor">#</a> 2.1 RDD 的构造</h3> <p>RDD 的构造函数如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> RDD<span class="token punctuation">[</span>T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@transient</span> <span class="token keyword">private</span> <span class="token keyword">var</span> _sc<span class="token operator">:</span> SparkContext<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@transient</span> <span class="token keyword">private</span> <span class="token keyword">var</span> deps<span class="token operator">:</span> Seq<span class="token punctuation">[</span>Dependency<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable <span class="token keyword">with</span> Logging <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
  <span class="token comment">/** Construct an RDD with just a one-to-one dependency on one parent */</span>
  <span class="token keyword">def</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token annotation punctuation">@transient</span> oneParent<span class="token operator">:</span> RDD<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>oneParent<span class="token punctuation">.</span>context<span class="token punctuation">,</span> List<span class="token punctuation">(</span><span class="token keyword">new</span> OneToOneDependency<span class="token punctuation">(</span>oneParent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// ......</span>
  <span class="token comment">/**
   * :: DeveloperApi ::
   * Implemented by subclasses to compute a given partition.
   */</span>
  <span class="token annotation punctuation">@DeveloperApi</span>
  <span class="token keyword">def</span> compute<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span>

  <span class="token comment">/**
   * Implemented by subclasses to return the set of partitions in this RDD. This method will only
   * be called once, so it is safe to implement a time-consuming computation in it.
   *
   * The partitions in this array must satisfy the following property:
   *   `rdd.partitions.zipWithIndex.forall { case (partition, index) =&gt; partition.index == index }`
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">def</span> getPartitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span>

  <span class="token comment">/**
   * Implemented by subclasses to return how this RDD depends on parent RDDs. This method will only
   * be called once, so it is safe to implement a time-consuming computation in it.
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">def</span> getDependencies<span class="token operator">:</span> Seq<span class="token punctuation">[</span>Dependency<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> deps

  <span class="token comment">/**
   * Optionally overridden by subclasses to specify placement preferences.
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">def</span> getPreferredLocations<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">)</span><span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> Nil

  <span class="token comment">/** Optionally overridden by subclasses to specify how they are partitioned. */</span>
  <span class="token annotation punctuation">@transient</span> <span class="token keyword">val</span> partitioner<span class="token operator">:</span> Option<span class="token punctuation">[</span>Partitioner<span class="token punctuation">]</span> <span class="token operator">=</span> None
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>各构造参数的含义如下：</p> <ul><li><code>_sc</code>： SparkContext，存储了 Spark 的上下文信息</li> <li><code>deps</code>： 表示 RDD 依赖链，RDD 正是依赖 Dependency 序列构建血缘，并进行回溯的；数组类型意味着一个 RDD 可能有多条依赖链，如 ZippedPartitionsRDD2</li></ul> <p>同时还有一些重要的内部变量及方法：</p> <ul><li>compute： 计算逻辑，由子类具体实现</li> <li>getPartitions：获取分区数组，仅会被调用一次（如触发 action 时，此处暂不详细展开）</li> <li>getDependencies： 获取依赖的父 RDD，同样进会被调用一次</li> <li>partitioner，定义了数据 Shuffle 时的规则，需要由子类具体去实现</li></ul> <p>可以看到，RDD 里的变量以及方法也对应了 Dependency、Compute、Partitions、Partitioner 。</p> <p>RDD 使用泛型来表示任意数据类型，这使得 RDD 十分灵活，允许在内部存储任意结构的数据。</p> <p>RDD 有许多子类实现，这里暂且以构造初始数据的 <code>org.apache.spark.rdd.ParallelCollectionRDD</code>（复杂点的还有 HadoopRDD 等） 为例，有如下代码：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> rdd1 <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 <code>makeRDD(...)</code> 方法会创建一个 ParallelCollectionRDD：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">def</span> makeRDD<span class="token punctuation">[</span>T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
      seq<span class="token operator">:</span> Seq<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
      numSlices<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> defaultParallelism<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> withScope <span class="token punctuation">{</span>
    <span class="token comment">// 传入数据序列以及指定分片</span>
    parallelize<span class="token punctuation">(</span>seq<span class="token punctuation">,</span> numSlices<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> parallelize<span class="token punctuation">[</span>T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
      seq<span class="token operator">:</span> Seq<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
      numSlices<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> defaultParallelism<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> withScope <span class="token punctuation">{</span>
    assertNotStopped<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 创建并返回一个 ParallelCollectionRDD</span>
    <span class="token keyword">new</span> ParallelCollectionRDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> numSlices<span class="token punctuation">,</span> Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> Seq<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其中 <code>withScope</code> 主要适用于记录一些 RDD 构造过程中的上下文信息（如调用的方法名，状态变化等），这里并非重点，不做详细赘述。</p> <p>查看 ParallelCollectionRDD 的构造函数如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">private</span><span class="token punctuation">[</span>spark<span class="token punctuation">]</span> <span class="token keyword">class</span> ParallelCollectionRDD<span class="token punctuation">[</span>T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
    sc<span class="token operator">:</span> SparkContext<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@transient</span> <span class="token keyword">private</span> <span class="token keyword">val</span> data<span class="token operator">:</span> Seq<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
    numSlices<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>
    locationPrefs<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> Seq<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">extends</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> Nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
  <span class="token comment">// 存储了 partition 信息，每个 partition 代表一个分片的数据</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getPartitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> slices <span class="token operator">=</span> ParallelCollectionRDD<span class="token punctuation">.</span>slice<span class="token punctuation">(</span>data<span class="token punctuation">,</span> numSlices<span class="token punctuation">)</span><span class="token punctuation">.</span>toArray
    slices<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>map<span class="token punctuation">(</span>i <span class="token keyword">=&gt;</span> <span class="token keyword">new</span> ParallelCollectionPartition<span class="token punctuation">(</span>id<span class="token punctuation">,</span> i<span class="token punctuation">,</span> slices<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toArray
  <span class="token punctuation">}</span>

  <span class="token comment">// 具体计算逻辑，可以接收一个具体的 parition 并封装为一个 Iterator</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> compute<span class="token punctuation">(</span>s<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> InterruptibleIterator<span class="token punctuation">(</span>context<span class="token punctuation">,</span> s<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>ParallelCollectionPartition<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iterator<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 存储了数据本地性的相关信息，不同 RDD 有不同的实现，HadoopRDD 则是存储在 split 中</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getPreferredLocations<span class="token punctuation">(</span>s<span class="token operator">:</span> Partition<span class="token punctuation">)</span><span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    locationPrefs<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>s<span class="token punctuation">.</span>index<span class="token punctuation">,</span> Nil<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>可以看到，ParallelCollectionRDD 会将接收到的 SparkContext 传递给 RDD 接口，同时将一个 <code>Nil</code> 对象传递给 RDD 接口记录到 <code>deps</code> 中，这是由于当前 RDD 属于最起始的 RDD，并没有依赖的父 RDD。至此，一个 ParallelCollectionRDD 的构造便结束了。</p> <h3 id="_2-2-transformation"><a href="#_2-2-transformation" class="header-anchor">#</a> 2.2 Transformation</h3> <p>Transformation 算子，可以从一个 RDD 生成另一个 RDD，构造计算逻辑，但不触发真正的计算。</p> <p>对前面定义的 <code>rdd1</code> 执行 Transformation 操作，代码如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> rdd2 <span class="token operator">=</span> rdd1<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>以下分别为 <code>flatMap</code> 以及 <code>map</code> 方法的源码：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">def</span> flatMap<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> T <span class="token keyword">=&gt;</span> TraversableOnce<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> withScope <span class="token punctuation">{</span>
    <span class="token keyword">val</span> cleanF <span class="token operator">=</span> sc<span class="token punctuation">.</span>clean<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">new</span> MapPartitionsRDD<span class="token punctuation">[</span>U<span class="token punctuation">,</span> T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> iter<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> iter<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>cleanF<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">def</span> map<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> T <span class="token keyword">=&gt;</span> U<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> withScope <span class="token punctuation">{</span>
    <span class="token keyword">val</span> cleanF <span class="token operator">=</span> sc<span class="token punctuation">.</span>clean<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">new</span> MapPartitionsRDD<span class="token punctuation">[</span>U<span class="token punctuation">,</span> T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> iter<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>cleanF<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到两个方法都是构造一个 <code>org.apache.spark.rdd.MapPartitionsRDD</code>，RDD 调用这些高阶函数，并将自身 <code>this</code> 以及接收到的方法 <code>f</code> 作为 MapPartitionsRDD 构造参数。</p> <p>MapPartitionsRDD 的构造函数如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">private</span><span class="token punctuation">[</span>spark<span class="token punctuation">]</span> <span class="token keyword">class</span> MapPartitionsRDD<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">,</span> T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token keyword">var</span> prev<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
    f<span class="token operator">:</span> <span class="token punctuation">(</span>TaskContext<span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> Iterator<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// (TaskContext, partition index, iterator)</span>
    preservesPartitioning<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isFromBarrier<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isOrderSensitive<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">override</span> <span class="token keyword">val</span> partitioner <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>preservesPartitioning<span class="token punctuation">)</span> firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>partitioner <span class="token keyword">else</span> None

  <span class="token keyword">override</span> <span class="token keyword">def</span> getPartitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span> <span class="token operator">=</span> firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>partitions

  <span class="token keyword">override</span> <span class="token keyword">def</span> compute<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span>
    f<span class="token punctuation">(</span>context<span class="token punctuation">,</span> split<span class="token punctuation">.</span>index<span class="token punctuation">,</span> firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>可以看到，RDD 将自身传入 MapPartitionsRDD 后，MapPartitionsRDD 又通过 <code>RDD[U](prev)</code> 将其传递给 RDD 接口，由前面对 RDD 源码的解析可知，这个 <code>poev</code> 会被构造为一个 Dependency 记录起来：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">def</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token annotation punctuation">@transient</span> oneParent<span class="token operator">:</span> RDD<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>oneParent<span class="token punctuation">.</span>context<span class="token punctuation">,</span> List<span class="token punctuation">(</span><span class="token keyword">new</span> OneToOneDependency<span class="token punctuation">(</span>oneParent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>至此，RDD 之间的 Dependency 构造大致是理清了：一个 RDD 生成新的 RDD，新的 RDD 会将把父 RDD 构造为 Dependency 保存起来。</p> <h3 id="_2-3-action"><a href="#_2-3-action" class="header-anchor">#</a> 2.3 Action</h3> <p>Action 会真正触发 RDD 的计算逻辑，执行前面指定的 Transformation   算子。</p> <p>对 <code>rdd2</code> 执行 Action 算子，代码如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>rdd2<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看 <code>foreach</code> 代码：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">def</span> foreach<span class="token punctuation">(</span>f<span class="token operator">:</span> T <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> withScope <span class="token punctuation">{</span>
    <span class="token keyword">val</span> cleanF <span class="token operator">=</span> sc<span class="token punctuation">.</span>clean<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>runJob<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>iter<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> iter<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>cleanF<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> func<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    runJob<span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token number">0</span> until rdd<span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到，RDD 通过 <code>foreach</code> 调用 <code>sc.runJob()</code> 方法，将自身传以及一个函数传递进去，并且还会通过 <code>rdd.partitions</code> 访问 RDD 的 partition 信息。</p> <p><strong>从这里，会开始借助前面构造的 Dependency 信息，一层一层的追溯父 RDD 的 partition 信息，其实现如下</strong>：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">// rdd.partitions</span>
  <span class="token keyword">final</span> <span class="token keyword">def</span> partitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    checkpointRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>partitions<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrElse <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>partitions_ <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stateLock<span class="token punctuation">.</span>synchronized <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>partitions_ <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用 RDD 的 getPartitions</span>
            partitions_ <span class="token operator">=</span> getPartitions
            partitions_<span class="token punctuation">.</span>zipWithIndex<span class="token punctuation">.</span>foreach <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>partition<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
              require<span class="token punctuation">(</span>partition<span class="token punctuation">.</span>index <span class="token operator">==</span> index<span class="token punctuation">,</span>
                s<span class="token string">&quot;partitions($index).partition == ${partition.index}, but it should equal $index&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      partitions_
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>此处的 <code>rdd.partitions</code> 内部会调用其 <code>getPartitions</code> 方法，根据之前的源码解析，可以知道这是 RDD 的一个抽象方法，在 MapPartitionsRDD 中的实现及调用如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">// org.apache.spark.rdd.MapPartitionsRDD#getPartitions</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getPartitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span> <span class="token operator">=</span> firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>partitions

  <span class="token comment">// org.apache.spark.rdd.RDD#firstParent</span>
  <span class="token keyword">protected</span><span class="token punctuation">[</span>spark<span class="token punctuation">]</span> <span class="token keyword">def</span> firstParent<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    dependencies<span class="token punctuation">.</span>head<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// org.apache.spark.rdd.RDD#dependencies</span>
  <span class="token keyword">final</span> <span class="token keyword">def</span> dependencies<span class="token operator">:</span> Seq<span class="token punctuation">[</span>Dependency<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    checkpointRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>r <span class="token keyword">=&gt;</span> List<span class="token punctuation">(</span><span class="token keyword">new</span> OneToOneDependency<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getOrElse <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dependencies_ <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stateLock<span class="token punctuation">.</span>synchronized <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>dependencies_ <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取 denpendency 序列</span>
            dependencies_ <span class="token operator">=</span> getDependencies
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      dependencies_
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// org.apache.spark.rdd.RDD#getDependencies</span>
  <span class="token keyword">protected</span> <span class="token keyword">def</span> getDependencies<span class="token operator">:</span> Seq<span class="token punctuation">[</span>Dependency<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> deps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>可以看到，MapPartitionsRDD 通过调用链  <code>org.apache.spark.rdd.RDD#firstParent</code>  -&gt; <code>org.apache.spark.rdd.RDD#dependencies</code> -&gt; <code>org.apache.spark.rdd.RDD#getDependencies</code>，从 Dependency 获取到父 RDD，接着父 RDD 也会调用 <code>partitions</code> 方法，再次重复上述步骤直到（当前 Stage）最顶级的 RDD。</p> <p>按照例子中 RDD 的构建顺序，最终会追溯到 <code>ParallelCollectionRDD</code>，其 <code>getPartitions</code> 实现如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">override</span> <span class="token keyword">def</span> getPartitions<span class="token operator">:</span> Array<span class="token punctuation">[</span>Partition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> slices <span class="token operator">=</span> ParallelCollectionRDD<span class="token punctuation">.</span>slice<span class="token punctuation">(</span>data<span class="token punctuation">,</span> numSlices<span class="token punctuation">)</span><span class="token punctuation">.</span>toArray
    slices<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>map<span class="token punctuation">(</span>i <span class="token keyword">=&gt;</span> <span class="token keyword">new</span> ParallelCollectionPartition<span class="token punctuation">(</span>id<span class="token punctuation">,</span> i<span class="token punctuation">,</span> slices<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toArray
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到，这里构造了 ParallelCollectionRDD 的 Parititon 数组，partition 在最初构造的时候就已经决定了，之后逐级回到之前的 <code>org.apache.spark.SparkContext#runJob</code> 方法中，继续往下走：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">def</span> runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> func<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    runJob<span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token number">0</span> until rdd<span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">def</span> runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
      rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
      func<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">,</span>
      partitions<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> cleanedFunc <span class="token operator">=</span> clean<span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    runJob<span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> TaskContext<span class="token punctuation">,</span> it<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> cleanedFunc<span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span> partitions<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">def</span> runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
      rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
      func<span class="token operator">:</span> <span class="token punctuation">(</span>TaskContext<span class="token punctuation">,</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">,</span>
      partitions<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> results <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">(</span>partitions<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
    runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token punctuation">]</span><span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> func<span class="token punctuation">,</span> partitions<span class="token punctuation">,</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> results<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>
    results
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> runJob<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
      rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
      func<span class="token operator">:</span> <span class="token punctuation">(</span>TaskContext<span class="token punctuation">,</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">,</span>
      partitions<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      resultHandler<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> U<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stopped<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalStateException<span class="token punctuation">(</span><span class="token string">&quot;SparkContext has been shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> callSite <span class="token operator">=</span> getCallSite
    <span class="token keyword">val</span> cleanedFunc <span class="token operator">=</span> clean<span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    logInfo<span class="token punctuation">(</span><span class="token string">&quot;Starting job: &quot;</span> <span class="token operator">+</span> callSite<span class="token punctuation">.</span>shortForm<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span>getBoolean<span class="token punctuation">(</span><span class="token string">&quot;spark.logLineage&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logInfo<span class="token punctuation">(</span><span class="token string">&quot;RDD's recursive dependencies:\n&quot;</span> <span class="token operator">+</span> rdd<span class="token punctuation">.</span>toDebugString<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// DAGScheduler 负责构造 taskset 并结合 taskScheduler、SchedulerBackend 分发任务</span>
    dagScheduler<span class="token punctuation">.</span>runJob<span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> cleanedFunc<span class="token punctuation">,</span> partitions<span class="token punctuation">,</span> callSite<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> localProperties<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
    progressBar<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>_<span class="token punctuation">.</span>finishAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rdd<span class="token punctuation">.</span>doCheckpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>经过多个函数调用后，会走到 DAGScheduler 那里真正的提交任务。调度模块的源码不属于此次解读范围，暂不详细展开，这部分主要工作是构造 task 的相关信息，最终将 task 以 RPC 的方式推送到各个 Executor 端。</p> <p>与 RDD 获取 partitions 信息一样，RDD 的 Compute 同样是借助 Dependency 嵌套执行（Volcano 模型） 的。Executor  在接收到调度器发来的 task 时，会对其进行处理并封装为 Runnable 放入线程池执行：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// org.apache.spark.scheduler.cluster.CoarseGrainedClusterMessages.LaunchTask$#unapply</span>
<span class="token keyword">case</span> LaunchTask<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exitExecutor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Received LaunchTask command but executor was null&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 反序列化 task</span>
        <span class="token keyword">val</span> taskDesc <span class="token operator">=</span> TaskDescription<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>data<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        logInfo<span class="token punctuation">(</span><span class="token string">&quot;Got assigned task &quot;</span> <span class="token operator">+</span> taskDesc<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span>
        taskResources<span class="token punctuation">(</span>taskDesc<span class="token punctuation">.</span>taskId<span class="token punctuation">)</span> <span class="token operator">=</span> taskDesc<span class="token punctuation">.</span>resources
        <span class="token comment">// 启动一个 task</span>
        executor<span class="token punctuation">.</span>launchTask<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> taskDesc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token keyword">def</span> launchTask<span class="token punctuation">(</span>context<span class="token operator">:</span> ExecutorBackend<span class="token punctuation">,</span> taskDescription<span class="token operator">:</span> TaskDescription<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 task 封装为实现了 Runnable 接口的 TaskRunner</span>
    <span class="token keyword">val</span> tr <span class="token operator">=</span> <span class="token keyword">new</span> TaskRunner<span class="token punctuation">(</span>context<span class="token punctuation">,</span> taskDescription<span class="token punctuation">)</span>
    runningTasks<span class="token punctuation">.</span>put<span class="token punctuation">(</span>taskDescription<span class="token punctuation">.</span>taskId<span class="token punctuation">,</span> tr<span class="token punctuation">)</span>
    <span class="token comment">// 放入线程池执行</span>
    threadPool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>tr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>org.apache.spark.executor.Executor.TaskRunner</code> 的 run 方法定义如下：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>    <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ......</span>
        <span class="token keyword">val</span> res <span class="token operator">=</span> task<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            taskAttemptId <span class="token operator">=</span> taskId<span class="token punctuation">,</span>
            attemptNumber <span class="token operator">=</span> taskDescription<span class="token punctuation">.</span>attemptNumber<span class="token punctuation">,</span>
            metricsSystem <span class="token operator">=</span> env<span class="token punctuation">.</span>metricsSystem<span class="token punctuation">,</span>
            resources <span class="token operator">=</span> taskDescription<span class="token punctuation">.</span>resources<span class="token punctuation">)</span>
    <span class="token comment">// ......</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>最终调用会走到 <code>org.apache.spark.scheduler.ResultTask#runTask</code> 里：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">override</span> <span class="token keyword">def</span> runTask<span class="token punctuation">(</span>context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> U <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// Deserialize the RDD and the func using the broadcast variables.</span>
    <span class="token keyword">val</span> threadMXBean <span class="token operator">=</span> ManagementFactory<span class="token punctuation">.</span>getThreadMXBean
    <span class="token keyword">val</span> deserializeStartTimeNs <span class="token operator">=</span> System<span class="token punctuation">.</span>nanoTime<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> deserializeStartCpuTime <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>threadMXBean<span class="token punctuation">.</span>isCurrentThreadCpuTimeSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      threadMXBean<span class="token punctuation">.</span>getCurrentThreadCpuTime
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token number">0L</span>
    <span class="token keyword">val</span> ser <span class="token operator">=</span> SparkEnv<span class="token punctuation">.</span>get<span class="token punctuation">.</span>closureSerializer<span class="token punctuation">.</span>newInstance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> <span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> func<span class="token punctuation">)</span> <span class="token operator">=</span> ser<span class="token punctuation">.</span>deserialize<span class="token punctuation">[</span><span class="token punctuation">(</span>RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>TaskContext<span class="token punctuation">,</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> U<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
      ByteBuffer<span class="token punctuation">.</span>wrap<span class="token punctuation">(</span>taskBinary<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">.</span>getContextClassLoader<span class="token punctuation">)</span>
    _executorDeserializeTimeNs <span class="token operator">=</span> System<span class="token punctuation">.</span>nanoTime<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> deserializeStartTimeNs
    _executorDeserializeCpuTime <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>threadMXBean<span class="token punctuation">.</span>isCurrentThreadCpuTimeSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      threadMXBean<span class="token punctuation">.</span>getCurrentThreadCpuTime <span class="token operator">-</span> deserializeStartCpuTime
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token number">0L</span>

    func<span class="token punctuation">(</span>context<span class="token punctuation">,</span> rdd<span class="token punctuation">.</span>iterator<span class="token punctuation">(</span>partition<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>方法最后一行 <code>rdd.iterator</code> 又会触发父 RDD 的溯源：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">// org.apache.spark.rdd.RDD#iterator</span>
  <span class="token keyword">final</span> <span class="token keyword">def</span> iterator<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>storageLevel <span class="token operator">!=</span> StorageLevel<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      getOrCompute<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 并未进行持久化，走下面的逻辑</span>
      computeOrReadCheckpoint<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// org.apache.spark.rdd.RDD#computeOrReadCheckpoint</span>
  <span class="token keyword">private</span><span class="token punctuation">[</span>spark<span class="token punctuation">]</span> <span class="token keyword">def</span> computeOrReadCheckpoint<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheckpointedAndMaterialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 RDD 的 compute 方法</span>
      compute<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token punctuation">[</span>spark<span class="token punctuation">]</span> <span class="token keyword">class</span> MapPartitionsRDD<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">,</span> T<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token keyword">var</span> prev<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span>
    f<span class="token operator">:</span> <span class="token punctuation">(</span>TaskContext<span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> Iterator<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// (TaskContext, partition index, iterator)</span>
    preservesPartitioning<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isFromBarrier<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isOrderSensitive<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">extends</span> RDD<span class="token punctuation">[</span>U<span class="token punctuation">]</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> compute<span class="token punctuation">(</span>split<span class="token operator">:</span> Partition<span class="token punctuation">,</span> context<span class="token operator">:</span> TaskContext<span class="token punctuation">)</span><span class="token operator">:</span> Iterator<span class="token punctuation">[</span>U<span class="token punctuation">]</span> <span class="token operator">=</span>
    f<span class="token punctuation">(</span>context<span class="token punctuation">,</span> split<span class="token punctuation">.</span>index<span class="token punctuation">,</span> firstParent<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span>split<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>可以看到最终又回到各个 RDD 自行实现的 copmute 函数并通过 <code>firstParent</code> 追溯父 RDD 直到（当前 Stage）最顶级的 RDD。</p> <p>可以看到，<code>compute</code> 方法是将一个方法作用在一个 Iterator 上，并返回一个新的 Iterator，层层嵌套调用执行计算的。</p> <p>在 Iterator 上嵌套计算完成后，Executor 返回结果信息给 Driver。至此，RDD 的整个计算流程结束。</p> <h2 id="_3-扩展"><a href="#_3-扩展" class="header-anchor">#</a> 3. 扩展</h2> <p>在 <code>org.apache.spark.SparkContext#hadoopFile</code> 看到这样一行注释：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// This is a hack to enforce loading hdfs-site.xml.</span>
<span class="token comment">// See SPARK-11227 for details.</span>
FileSystem<span class="token punctuation">.</span>getLocal<span class="token punctuation">(</span>hadoopConfiguration<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>大意是会强制加载 hdfs-site.xml 配置文件的一个操作。但为什么需要这样做？</p> <p>Congiguration 在新建时，默认会从加载本地配置文件。在 Spark 中，Congiguration 实例化完成后需要经过序列化-反序列传输到各个 Executor 上，这样一来，每个 Executor 反序列化新建 Configuration 时又需要从磁盘加载一次配置文件。</p> <p>为了节省这个开销（详见 <a href="https://issues.apache.org/jira/browse/SPARK-8135" target="_blank" rel="noopener noreferrer">SPARK-8135<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，Spark 1.5 修改了 SerializableWritable （实际使用的是 SerializableConfiguration，但逻辑基本一样）的反序列化代码，在反序列化生成 Configuration 时不会再重新加载本地配置文件：</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">class</span> SerializableWritable<span class="token punctuation">[</span>T <span class="token operator">&lt;</span><span class="token operator">:</span> Writable<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token annotation punctuation">@transient</span> <span class="token keyword">var</span> t<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable <span class="token punctuation">{</span>

  <span class="token keyword">def</span> value<span class="token operator">:</span> T <span class="token operator">=</span> t

  <span class="token keyword">override</span> <span class="token keyword">def</span> toString<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>toString

  <span class="token keyword">private</span> <span class="token keyword">def</span> writeObject<span class="token punctuation">(</span>out<span class="token operator">:</span> ObjectOutputStream<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> Utils<span class="token punctuation">.</span>tryOrIOException <span class="token punctuation">{</span>
    out<span class="token punctuation">.</span>defaultWriteObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> ObjectWritable<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">def</span> readObject<span class="token punctuation">(</span>in<span class="token operator">:</span> ObjectInputStream<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> Utils<span class="token punctuation">.</span>tryOrIOException <span class="token punctuation">{</span>
    in<span class="token punctuation">.</span>defaultReadObject<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> ow <span class="token operator">=</span> <span class="token keyword">new</span> ObjectWritable<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置 false 不再从磁盘上读取配置文件</span>
    ow<span class="token punctuation">.</span>setConf<span class="token punctuation">(</span><span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ow<span class="token punctuation">.</span>readFields<span class="token punctuation">(</span>in<span class="token punctuation">)</span>
    t <span class="token operator">=</span> ow<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>但这样存在一个问题，如果在传输到 Executor 之前，Configuration 没有先添加好完整信息的话，会导致 Executor 端的 Configuration 并不完整导致异常的发生。</p> <p>因此此处执行了 <code>FileSystem.getLocal(hadoopConfiguration)</code> ，先在 Driver 端强制读取本地配置文件构造完整的 Configuration，再通过广播变量发送到 Executor 端。执行前后 Configuration 内容变化如下：</p> <p><img src="https://gitee.com/zhxuankun/Image/raw/master/ARTS_Tips/image-20210817221214342.png" alt="image-20210817221214342"></p> <p>详细的官方 issue 详见：<a href="https://github.com/apache/spark/pull/13738" target="_blank" rel="noopener noreferrer">[SPARK-11227][CORE] UnknownHostException can be thrown when NameNode HA is enabled. <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/21/2021, 10:56:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/books/da-shu-ju/spark-yuan-ma-yue-du/01.listenerbus-xiao-xi-zong-xian.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        01.ListenerBus 消息总线
      </a></span> <!----></p></div> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/books/assets/js/app.a32f3f13.js" defer></script><script src="/books/assets/js/2.f434c5a6.js" defer></script><script src="/books/assets/js/189.279c7f6f.js" defer></script>
  </body>
</html>